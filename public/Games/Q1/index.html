<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Quake | TUGH</title>
		<style>
			canvas{position:fixed;left:0;top:0;display:none}
			#loading{display:none;position:fixed}
			#end{color:white;font-family:monospace;text-align:center}
			#end1,#end2{background-color:maroon;white-space:pre;display:none}
		</style>
	</head>
	<body>
		<div>
			<span id="progress">Starting Quake...</span>
			<canvas id="mainwindow"></canvas>
			<img id="loading" alt="Loading" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wsOBg4sY924cQAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAADUlEQVQI12P4//8/AwAI/AL+XJ/P2gAAAABJRU5ErkJggg==">
		</div>
		<div class="gui_download" onclick="downloadSaveGame()"></div>

		<script>
			// CDAudio.js
			CDAudio={},CDAudio.known=[],CDAudio.Play=function(o,d){!0===CDAudio.initialized&&!0===CDAudio.enabled&&(o-=2,CDAudio.playTrack!==o?o<0||o>=CDAudio.known.length?Con.DPrint("CDAudio.Play: Bad track number "+(o+2)+".\n"):(CDAudio.Stop(),CDAudio.playTrack=o,CDAudio.cd=new Audio(CDAudio.known[o]),CDAudio.cd.loop=d,CDAudio.cd.volume=CDAudio.cdvolume,CDAudio.cd.play()):null!=CDAudio.cd&&(CDAudio.cd.loop=d,!0===d&&!0===CDAudio.cd.paused&&CDAudio.cd.play()))},CDAudio.Stop=function(){!0===CDAudio.initialized&&!0===CDAudio.enabled&&(null!=CDAudio.cd&&CDAudio.cd.pause(),CDAudio.playTrack=null,CDAudio.cd=null)},CDAudio.Pause=function(){!0===CDAudio.initialized&&!0===CDAudio.enabled&&null!=CDAudio.cd&&CDAudio.cd.pause()},CDAudio.Resume=function(){!0===CDAudio.initialized&&!0===CDAudio.enabled&&null!=CDAudio.cd&&CDAudio.cd.play()},CDAudio.CD_f=function(){if(!(!0!==CDAudio.initialized||Cmd.argv.length<=1))switch(Cmd.argv[1].toLowerCase()){case"on":return void(CDAudio.enabled=!0);case"off":return CDAudio.Stop(),void(CDAudio.enabled=!1);case"play":return void CDAudio.Play(Q.atoi(Cmd.argv[2]),!1);case"loop":return void CDAudio.Play(Q.atoi(Cmd.argv[2]),!0);case"stop":return void CDAudio.Stop();case"pause":return void CDAudio.Pause();case"resume":return void CDAudio.Resume();case"info":return Con.Print(CDAudio.known.length+" tracks\n"),null!=CDAudio.cd&&!0!==CDAudio.cd.paused&&Con.Print("Currently "+(!0===CDAudio.cd.loop?"looping":"playing")+" track "+(CDAudio.playTrack+2)+"\n"),void Con.Print("Volume is "+CDAudio.cdvolume+"\n")}},CDAudio.Update=function(){!0===CDAudio.initialized&&!0===CDAudio.enabled&&S.bgmvolume.value!==CDAudio.cdvolume&&(S.bgmvolume.value<0?Cvar.SetValue("bgmvolume",0):S.bgmvolume.value>1&&Cvar.SetValue("bgmvolume",1),CDAudio.cdvolume=S.bgmvolume.value,null!=CDAudio.cd&&(CDAudio.cd.volume=CDAudio.cdvolume))},CDAudio.Init=function(){if(Cmd.AddCommand("cd",CDAudio.CD_f),null==COM.CheckParm("-nocdaudio")){var o,d,i,u=new XMLHttpRequest;for(o=1;o<=99;++o){for(i="/media/quake"+(o<=9?"0":"")+o+".ogg",d=COM.searchpaths.length-1;d>=0;--d)if(u.open("HEAD",COM.searchpaths[d].filename+i,!1),u.send(),u.status>=200&&u.status<=299){CDAudio.known[o-1]=COM.searchpaths[d].filename+i;break}if(d<0)break}0!==CDAudio.known.length&&(CDAudio.initialized=CDAudio.enabled=!0,CDAudio.Update(),Con.Print("CD Audio Initialized\n"))}};

			// Chase.js
			Chase={},Chase.Init=function(){Chase.back=Cvar.RegisterVariable("chase_back","100"),Chase.up=Cvar.RegisterVariable("chase_up","16"),Chase.right=Cvar.RegisterVariable("chase_right","0"),Chase.active=Cvar.RegisterVariable("chase_active","0")},Chase.Update=function(){var e=[],a=[];Vec.AngleVectors(CL.state.viewangles,e,a);var s={plane:{}},r=R.refdef.vieworg;SV.RecursiveHullCheck(CL.state.worldmodel.hulls[0],0,0,1,r,[r[0]+4096*e[0],r[1]+4096*e[1],r[2]+4096*e[2]],s);var h=s.endpos;h[2]-=r[2];var t=(h[0]-r[0])*e[0]+(h[1]-r[1])*e[1]+h[2]*e[2];t<1&&(t=1),R.refdef.viewangles[0]=Math.atan(h[2]/t)/Math.PI*-180,r[0]-=e[0]*Chase.back.value+a[0]*Chase.right.value,r[1]-=e[1]*Chase.back.value+a[1]*Chase.right.value,r[2]+=Chase.up.value};

			// CL.js MODIFIED
			CL={},CL.cshift={contents:0,damage:1,bonus:2,powerup:3},CL.active={disconnected:0,connecting:1,connected:2},CL.StopPlayback=function(){!0===CL.cls.demoplayback&&(CL.cls.demoplayback=!1,CL.cls.demofile=null,CL.cls.state=CL.active.disconnected,!0===CL.cls.timedemo&&CL.FinishTimeDemo())},CL.WriteDemoMessage=function(){var e=CL.cls.demoofs+16+NET.message.cursize;if(CL.cls.demofile.byteLength<e){var t=new Uint8Array(CL.cls.demofile,0,CL.cls.demoofs);CL.cls.demofile=new ArrayBuffer(CL.cls.demofile.byteLength+16384),new Uint8Array(CL.cls.demofile).set(t)}var s=new DataView(CL.cls.demofile,CL.cls.demoofs,16);s.setInt32(0,NET.message.cursize,!0),s.setFloat32(4,CL.state.viewangles[0],!0),s.setFloat32(8,CL.state.viewangles[1],!0),s.setFloat32(12,CL.state.viewangles[2],!0),new Uint8Array(CL.cls.demofile).set(new Uint8Array(NET.message.data,0,NET.message.cursize),CL.cls.demoofs+16),CL.cls.demoofs=e},CL.GetMessage=function(){if(!0===CL.cls.demoplayback){if(4===CL.cls.signon)if(!0===CL.cls.timedemo){if(Host.framecount===CL.cls.td_lastframe)return 0;CL.cls.td_lastframe=Host.framecount,Host.framecount===CL.cls.td_startframe+1&&(CL.cls.td_starttime=Host.realtime)}else if(CL.state.time<=CL.state.mtime[0])return 0;if(CL.cls.demoofs+16>=CL.cls.demosize)return CL.StopPlayback(),0;var e=new DataView(CL.cls.demofile);if(NET.message.cursize=e.getUint32(CL.cls.demoofs,!0),NET.message.cursize>8e3&&Sys.Error("Demo message > MAX_MSGLEN"),CL.state.mviewangles[1]=CL.state.mviewangles[0],CL.state.mviewangles[0]=[e.getFloat32(CL.cls.demoofs+4,!0),e.getFloat32(CL.cls.demoofs+8,!0),e.getFloat32(CL.cls.demoofs+12,!0)],CL.cls.demoofs+=16,CL.cls.demoofs+NET.message.cursize>CL.cls.demosize)return CL.StopPlayback(),0;var t,s=new Uint8Array(CL.cls.demofile,CL.cls.demoofs,NET.message.cursize),o=new Uint8Array(NET.message.data,0,NET.message.cursize);for(t=0;t<NET.message.cursize;++t)o[t]=s[t];return CL.cls.demoofs+=NET.message.cursize,1}for(var a;;){if(1!==(a=NET.GetMessage(CL.cls.netcon))&&2!==a)return a;if(1!==NET.message.cursize||new Uint8Array(NET.message.data,0,1)[0]!==Protocol.svc.nop)break;Con.Print("<-- server to client keepalive\n")}return!0===CL.cls.demorecording&&CL.WriteDemoMessage(),a},CL.Stop_f=function(){!0!==Cmd.client&&(!0===CL.cls.demorecording?(NET.message.cursize=0,MSG.WriteByte(NET.message,Protocol.svc.disconnect),CL.WriteDemoMessage(),!0!==COM.WriteFile(CL.cls.demoname,new Uint8Array(CL.cls.demofile),CL.cls.demoofs)&&Con.Print("ERROR: couldn't open.\n"),CL.cls.demofile=null,CL.cls.demorecording=!1,Con.Print("Completed demo\n")):Con.Print("Not recording a demo.\n"))},CL.Record_f=function(){var e=Cmd.argv.length;if(e<=1||e>=5)Con.Print("record <demoname> [<map> [cd track]]\n");else if(-1===Cmd.argv[1].indexOf(".."))if(2!==e||CL.cls.state!==CL.active.connected){4===e?(CL.cls.forcetrack=Q.atoi(Cmd.argv[3]),Con.Print("Forcing CD track to "+CL.cls.forcetrack)):CL.cls.forcetrack=-1,CL.cls.demoname=COM.DefaultExtension(Cmd.argv[1],".dem"),e>=3&&Cmd.ExecuteString("map "+Cmd.argv[2]),Con.Print("recording to "+CL.cls.demoname+".\n"),CL.cls.demofile=new ArrayBuffer(16384);var t,s=CL.cls.forcetrack.toString()+"\n",o=new Uint8Array(CL.cls.demofile,0,s.length);for(t=0;t<s.length;++t)o[t]=s.charCodeAt(t);CL.cls.demoofs=s.length,CL.cls.demorecording=!0}else Con.Print("Can not record - already connected to server\nClient demo recording must be started before connecting\n");else Con.Print("Relative pathnames are not allowed.\n")},CL.PlayDemo_f=function(){if(!0!==Cmd.client)if(2===Cmd.argv.length){CL.Disconnect();var e=COM.DefaultExtension(Cmd.argv[1],".dem");Con.Print("Playing demo from "+e+".\n");var t,s,o,a=COM.LoadFile(e);if(null==a)return Con.Print("ERROR: couldn't open.\n"),CL.cls.demonum=-1,void(SCR.disabled_for_loading=!1);for(CL.cls.demofile=a,a=new Uint8Array(a),CL.cls.demosize=a.length,CL.cls.demoplayback=!0,CL.cls.state=CL.active.connected,CL.cls.forcetrack=0,t=0;t<a.length&&10!==(s=a[t]);++t)45===s?o=!0:CL.cls.forcetrack=10*CL.cls.forcetrack+s-48;!0===o&&(CL.cls.forcetrack=-CL.cls.forcetrack),CL.cls.demoofs=t+1}else Con.Print("playdemo <demoname> : plays a demo\n")},CL.FinishTimeDemo=function(){CL.cls.timedemo=!1;var e=Host.framecount-CL.cls.td_startframe-1,t=Host.realtime-CL.cls.td_starttime;0===t&&(t=1),Con.Print(e+" frames "+t.toFixed(1)+" seconds "+(e/t).toFixed(1)+" fps\n")},CL.TimeDemo_f=function(){!0!==Cmd.client&&(2===Cmd.argv.length?(CL.PlayDemo_f(),CL.cls.timedemo=!0,CL.cls.td_startframe=Host.framecount,CL.cls.td_lastframe=-1):Con.Print("timedemo <demoname> : gets demo speeds\n"))},CL.kbutton={mlook:0,klook:1,left:2,right:3,forward:4,back:5,lookup:6,lookdown:7,moveleft:8,moveright:9,strafe:10,speed:11,use:12,jump:13,attack:14,moveup:15,movedown:16,num:17},CL.kbuttons=[],CL.KeyDown=function(){var e,t=CL.kbutton[Cmd.argv[0].substring(1)];if(null!=t&&(t=CL.kbuttons[t],(e=null!=Cmd.argv[1]?Q.atoi(Cmd.argv[1]):-1)!==t.down[0]&&e!==t.down[1])){if(0===t.down[0])t.down[0]=e;else{if(0!==t.down[1])return void Con.Print("Three keys down for a button!\n");t.down[1]=e}0==(1&t.state)&&(t.state|=3)}},CL.KeyUp=function(){var e=CL.kbutton[Cmd.argv[0].substring(1)];if(null!=e){var t;if(e=CL.kbuttons[e],null==Cmd.argv[1])return e.down[0]=e.down[1]=0,void(e.state=4);if(t=Q.atoi(Cmd.argv[1]),e.down[0]===t)e.down[0]=0;else{if(e.down[1]!==t)return;e.down[1]=0}0===e.down[0]&&0===e.down[1]&&0!=(1&e.state)&&(e.state=e.state-1|4)}},CL.MLookUp=function(){CL.KeyUp(),0==(1&CL.kbuttons[CL.kbutton.mlook].state)&&0!==CL.lookspring.value&&V.StartPitchDrift()},CL.Impulse=function(){CL.impulse=Q.atoi(Cmd.argv[1])},CL.KeyState=function(e){var t=1&(e=CL.kbuttons[e]).state;return e.state&=1,0!=(2&e.state)?0!=(4&e.state)?0!==t?.75:.25:0!==t?.5:0:0!=(4&e.state)?0:0!==t?1:0},CL.AdjustAngles=function(){var e=Host.frametime;0!=(1&CL.kbuttons[CL.kbutton.speed].state)&&(e*=CL.anglespeedkey.value);var t=CL.state.viewangles;0==(1&CL.kbuttons[CL.kbutton.strafe].state)&&(t[1]+=e*CL.yawspeed.value*(CL.KeyState(CL.kbutton.left)-CL.KeyState(CL.kbutton.right)),t[1]=Vec.Anglemod(t[1])),0!=(1&CL.kbuttons[CL.kbutton.klook].state)&&(V.StopPitchDrift(),t[0]+=e*CL.pitchspeed.value*(CL.KeyState(CL.kbutton.back)-CL.KeyState(CL.kbutton.forward)));var s=CL.KeyState(CL.kbutton.lookup),o=CL.KeyState(CL.kbutton.lookdown);0===s&&0===o||(t[0]+=e*CL.pitchspeed.value*(o-s),V.StopPitchDrift()),t[0]>80?t[0]=80:t[0]<-70&&(t[0]=-70),t[2]>50?t[2]=50:t[2]<-50&&(t[2]=-50)},CL.BaseMove=function(){if(4===CL.cls.signon){CL.AdjustAngles();var e=CL.state.cmd;e.sidemove=CL.sidespeed.value*(CL.KeyState(CL.kbutton.moveright)-CL.KeyState(CL.kbutton.moveleft)),0!=(1&CL.kbuttons[CL.kbutton.strafe].state)&&(e.sidemove+=CL.sidespeed.value*(CL.KeyState(CL.kbutton.right)-CL.KeyState(CL.kbutton.left))),e.upmove=CL.upspeed.value*(CL.KeyState(CL.kbutton.moveup)-CL.KeyState(CL.kbutton.movedown)),0==(1&CL.kbuttons[CL.kbutton.klook].state)?e.forwardmove=CL.forwardspeed.value*CL.KeyState(CL.kbutton.forward)-CL.backspeed.value*CL.KeyState(CL.kbutton.back):e.forwardmove=0,0!=(1&CL.kbuttons[CL.kbutton.speed].state)&&(e.forwardmove*=CL.movespeedkey.value,e.sidemove*=CL.movespeedkey.value,e.upmove*=CL.movespeedkey.value)}},CL.sendmovebuf={data:new ArrayBuffer(16),cursize:0},CL.SendMove=function(){var e=CL.sendmovebuf;e.cursize=0,MSG.WriteByte(e,Protocol.clc.move),MSG.WriteFloat(e,CL.state.mtime[0]),MSG.WriteAngle(e,CL.state.viewangles[0]),MSG.WriteAngle(e,CL.state.viewangles[1]),MSG.WriteAngle(e,CL.state.viewangles[2]),MSG.WriteShort(e,CL.state.cmd.forwardmove),MSG.WriteShort(e,CL.state.cmd.sidemove),MSG.WriteShort(e,CL.state.cmd.upmove);var t=0;0!=(3&CL.kbuttons[CL.kbutton.attack].state)&&(t+=1),CL.kbuttons[CL.kbutton.attack].state&=5,0!=(3&CL.kbuttons[CL.kbutton.jump].state)&&(t+=2),CL.kbuttons[CL.kbutton.jump].state&=5,MSG.WriteByte(e,t),MSG.WriteByte(e,CL.impulse),CL.impulse=0,!0!==CL.cls.demoplayback&&(++CL.state.movemessages<=2||-1===NET.SendUnreliableMessage(CL.cls.netcon,e)&&(Con.Print("CL.SendMove: lost server connection\n"),CL.Disconnect()))},CL.InitInput=function(){var e,t=["moveup","movedown","left","right","forward","back","lookup","lookdown","strafe","moveleft","moveright","speed","attack","use","jump","klook"];for(e=0;e<t.length;++e)Cmd.AddCommand("+"+t[e],CL.KeyDown),Cmd.AddCommand("-"+t[e],CL.KeyUp);for(Cmd.AddCommand("impulse",CL.Impulse),Cmd.AddCommand("+mlook",CL.KeyDown),Cmd.AddCommand("-mlook",CL.MLookUp),e=0;e<CL.kbutton.num;++e)CL.kbuttons[e]={down:[0,0],state:0}},CL.cls={state:0,spawnparms:"",demonum:0,message:{data:new ArrayBuffer(8192),cursize:0}},CL.static_entities=[],CL.visedicts=[],CL.Rcon_f=function(){if(0!==CL.rcon_password.string.length){var e,t;if(CL.cls.state===CL.active.connected&&null!=CL.cls.netcon&&NET.drivers[CL.cls.netcon.driver]===WEBS&&(e=CL.cls.netcon.address.substring(5)),null==e){if(0===CL.rcon_address.string.length)return void Con.Print("You must either be connected,\nor set the 'rcon_address' cvar\nto issue rcon commands\n");e=CL.rcon_address.string}try{t=btoa("quake:"+CL.rcon_password.string)}catch(e){return}var s,o="";for(s=1;s<Cmd.argv.length;++s)o+=Cmd.argv[s]+" ";try{o=encodeURIComponent(o)}catch(e){return}var a=new XMLHttpRequest;a.open("HEAD","http://"+e+"/rcon/"+o),a.setRequestHeader("Authorization","Basic "+t),a.send()}else Con.Print("You must set 'rcon_password' before\nissuing an rcon command.\n")},CL.ClearState=function(){var e;for(!0!==SV.server.active&&(Con.DPrint("Clearing memory\n"),Mod.ClearAll(),CL.cls.signon=0),CL.state={movemessages:0,cmd:{forwardmove:0,sidemove:0,upmove:0},stats:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],items:0,item_gettime:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],faceanimtime:0,cshifts:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],mviewangles:[[0,0,0],[0,0,0]],viewangles:[0,0,0],mvelocity:[[0,0,0],[0,0,0]],velocity:[0,0,0],punchangle:[0,0,0],idealpitch:0,pitchvel:0,driftmove:0,laststop:0,crouch:0,intermission:0,completed_time:0,mtime:[0,0],time:0,oldtime:0,last_received_message:0,viewentity:0,num_statics:0,viewent:{num:-1,origin:[0,0,0],angles:[0,0,0],skinnum:0},cdtrack:0,looptrack:0},CL.cls.message.cursize=0,CL.entities=[],CL.dlights=[],e=0;e<=31;++e)CL.dlights[e]={radius:0,die:0};for(CL.lightstyle=[],e=0;e<=63;++e)CL.lightstyle[e]="";for(CL.beams=[],e=0;e<=23;++e)CL.beams[e]={endtime:0}},CL.Disconnect=function(){S.StopAllSounds(),!0===CL.cls.demoplayback?CL.StopPlayback():CL.cls.state===CL.active.connected&&(!0===CL.cls.demorecording&&CL.Stop_f(),Con.DPrint("Sending clc_disconnect\n"),CL.cls.message.cursize=0,MSG.WriteByte(CL.cls.message,Protocol.clc.disconnect),NET.SendUnreliableMessage(CL.cls.netcon,CL.cls.message),CL.cls.message.cursize=0,NET.Close(CL.cls.netcon),CL.cls.state=CL.active.disconnected,!0===SV.server.active&&Host.ShutdownServer()),CL.cls.demoplayback=CL.cls.timedemo=!1,CL.cls.signon=0},CL.Connect=function(e){CL.cls.netcon=e,Con.DPrint("CL.Connect: connected to "+CL.host+"\n"),CL.cls.demonum=-1,CL.cls.state=CL.active.connected,CL.cls.signon=0},CL.EstablishConnection=function(e){if(!0!==CL.cls.demoplayback){CL.Disconnect(),CL.host=e;var t=NET.Connect(e);null==t&&Host.Error("CL.EstablishConnection: connect failed\n"),CL.Connect(t)}},CL.SignonReply=function(){switch(Con.DPrint("CL.SignonReply: "+CL.cls.signon+"\n"),CL.cls.signon){case 1:return MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd),void MSG.WriteString(CL.cls.message,"prespawn");case 2:return MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd),MSG.WriteString(CL.cls.message,'name "'+CL.name.string+'"\n'),MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd),MSG.WriteString(CL.cls.message,"color "+(CL.color.value>>4)+" "+(15&CL.color.value)+"\n"),MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd),void MSG.WriteString(CL.cls.message,"spawn "+CL.cls.spawnparms);case 3:return MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd),void MSG.WriteString(CL.cls.message,"begin");case 4:SCR.EndLoadingPlaque()}},CL.NextDemo=function(){if(-1!==CL.cls.demonum){if(SCR.BeginLoadingPlaque(),CL.cls.demonum>=CL.cls.demos.length){if(0===CL.cls.demos.length)return Con.Print("No demos listed with startdemos\n"),void(CL.cls.demonum=-1);CL.cls.demonum=0}Cmd.text="playdemo "+CL.cls.demos[CL.cls.demonum++]+"\n"+Cmd.text}},CL.PrintEntities_f=function(){var e,t;for(e=0;e<CL.entities.length;++e)t=CL.entities[e],e<=9?Con.Print("  "+e+":"):e<=99?Con.Print(" "+e+":"):Con.Print(e+":"),null!=t.model?Con.Print(t.model.name+(t.frame<=9?": ":":")+t.frame+"  ("+t.origin[0].toFixed(1)+","+t.origin[1].toFixed(1)+","+t.origin[2].toFixed(1)+") ["+t.angles[0].toFixed(1)+" "+t.angles[1].toFixed(1)+" "+t.angles[2].toFixed(1)+"]\n"):Con.Print("EMPTY\n")},CL.AllocDlight=function(e){var t,s;if(0!==e)for(t=0;t<=31;++t)if(CL.dlights[t].key===e){s=CL.dlights[t];break}if(null==s){for(t=0;t<=31;++t)if(CL.dlights[t].die<CL.state.time){s=CL.dlights[t];break}null==s&&(s=CL.dlights[0])}return s.origin=[0,0,0],s.radius=0,s.die=0,s.decay=0,s.minlight=0,s.key=e,s},CL.DecayLights=function(){var e,t,s=CL.state.time-CL.state.oldtime;for(e=0;e<=31;++e)(t=CL.dlights[e]).die<CL.state.time||0===t.radius||(t.radius-=s*t.decay,t.radius<0&&(t.radius=0))},CL.LerpPoint=function(){var e=CL.state.mtime[0]-CL.state.mtime[1];if(0===e||0!==CL.nolerp.value||!0===CL.cls.timedemo||!0===SV.server.active)return CL.state.time=CL.state.mtime[0],1;e>.1&&(CL.state.mtime[1]=CL.state.mtime[0]-.1,e=.1);var t=(CL.state.time-CL.state.mtime[1])/e;return t<0?(t<-.01&&(CL.state.time=CL.state.mtime[1]),0):t>1?(t>1.01&&(CL.state.time=CL.state.mtime[0]),1):t},CL.RelinkEntities=function(){var e,t,s,o,a=CL.LerpPoint(),n=[];if(CL.numvisedicts=0,CL.state.velocity[0]=CL.state.mvelocity[1][0]+a*(CL.state.mvelocity[0][0]-CL.state.mvelocity[1][0]),CL.state.velocity[1]=CL.state.mvelocity[1][1]+a*(CL.state.mvelocity[0][1]-CL.state.mvelocity[1][1]),CL.state.velocity[2]=CL.state.mvelocity[1][2]+a*(CL.state.mvelocity[0][2]-CL.state.mvelocity[1][2]),!0===CL.cls.demoplayback)for(e=0;e<=2;++e)(o=CL.state.mviewangles[0][e]-CL.state.mviewangles[1][e])>180?o-=360:o<-180&&(o+=360),CL.state.viewangles[e]=CL.state.mviewangles[1][e]+a*o;var i,r,c=Vec.Anglemod(100*CL.state.time),l=[];for(e=1;e<CL.entities.length;++e)if(null!=(i=CL.entities[e]).model)if(i.msgtime===CL.state.mtime[0]){if(l[0]=i.origin[0],l[1]=i.origin[1],l[2]=i.origin[2],!0===i.forcelink)Vec.Copy(i.msg_origins[0],i.origin),Vec.Copy(i.msg_angles[0],i.angles);else{for(s=a,t=0;t<=2;++t)n[t]=i.msg_origins[0][t]-i.msg_origins[1][t],(n[t]>100||n[t]<-100)&&(s=1);for(t=0;t<=2;++t)i.origin[t]=i.msg_origins[1][t]+s*n[t],(o=i.msg_angles[0][t]-i.msg_angles[1][t])>180?o-=360:o<-180&&(o+=360),i.angles[t]=i.msg_angles[1][t]+s*o}if(0!=(i.model.flags&Mod.flags.rotate)&&(i.angles[1]=c),0!=(i.effects&Mod.effects.brightfield)&&R.EntityParticles(i),0!=(i.effects&Mod.effects.muzzleflash)){r=CL.AllocDlight(e);var C=[];Vec.AngleVectors(i.angles,C),r.origin=[i.origin[0]+18*C[0],i.origin[1]+18*C[1],i.origin[2]+16+18*C[2]],r.radius=200+32*Math.random(),r.minlight=32,r.die=CL.state.time+.1}0!=(i.effects&Mod.effects.brightlight)&&((r=CL.AllocDlight(e)).origin=[i.origin[0],i.origin[1],i.origin[2]+16],r.radius=400+32*Math.random(),r.die=CL.state.time+.001),0!=(i.effects&Mod.effects.dimlight)&&((r=CL.AllocDlight(e)).origin=[i.origin[0],i.origin[1],i.origin[2]+16],r.radius=200+32*Math.random(),r.die=CL.state.time+.001),0!=(i.model.flags&Mod.flags.gib)?R.RocketTrail(l,i.origin,2):0!=(i.model.flags&Mod.flags.zomgib)?R.RocketTrail(l,i.origin,4):0!=(i.model.flags&Mod.flags.tracer)?R.RocketTrail(l,i.origin,3):0!=(i.model.flags&Mod.flags.tracer2)?R.RocketTrail(l,i.origin,5):0!=(i.model.flags&Mod.flags.rocket)?(R.RocketTrail(l,i.origin,0),(r=CL.AllocDlight(e)).origin=[i.origin[0],i.origin[1],i.origin[2]],r.radius=200,r.die=CL.state.time+.01):0!=(i.model.flags&Mod.flags.grenade)?R.RocketTrail(l,i.origin,1):0!=(i.model.flags&Mod.flags.tracer3)&&R.RocketTrail(l,i.origin,6),i.forcelink=!1,e===CL.state.viewentity&&0===Chase.active.value||(CL.visedicts[CL.numvisedicts++]=i)}else i.model=null},CL.ReadFromServer=function(){var e;for(CL.state.oldtime=CL.state.time,CL.state.time+=Host.frametime;(-1===(e=CL.GetMessage())&&Host.Error("CL.ReadFromServer: lost server connection"),0!==e)&&(CL.state.last_received_message=Host.realtime,CL.ParseServerMessage(),CL.cls.state===CL.active.connected););0!==CL.shownet.value&&Con.Print("\n"),CL.RelinkEntities(),CL.UpdateTEnts()},CL.SendCmd=function(){CL.cls.state===CL.active.connected&&(4===CL.cls.signon&&(CL.BaseMove(),IN.Move(),CL.SendMove()),!0!==CL.cls.demoplayback?0!==CL.cls.message.cursize&&(!0===NET.CanSendMessage(CL.cls.netcon)?(-1===NET.SendMessage(CL.cls.netcon,CL.cls.message)&&Host.Error("CL.SendCmd: lost server connection"),CL.cls.message.cursize=0):Con.DPrint("CL.SendCmd: can't send\n")):CL.cls.message.cursize=0)},CL.Init=function(){CL.ClearState(),CL.InitInput(),CL.InitTEnts(),CL.name=Cvar.RegisterVariable("_cl_name","player",!0),CL.color=Cvar.RegisterVariable("_cl_color","0",!0),CL.upspeed=Cvar.RegisterVariable("cl_upspeed","200"),CL.forwardspeed=Cvar.RegisterVariable("cl_forwardspeed","400",!0),CL.backspeed=Cvar.RegisterVariable("cl_backspeed","400",!0),CL.sidespeed=Cvar.RegisterVariable("cl_sidespeed","350"),CL.movespeedkey=Cvar.RegisterVariable("cl_movespeedkey","2.0"),CL.yawspeed=Cvar.RegisterVariable("cl_yawspeed","140"),CL.pitchspeed=Cvar.RegisterVariable("cl_pitchspeed","150"),CL.anglespeedkey=Cvar.RegisterVariable("cl_anglespeedkey","1.5"),CL.shownet=Cvar.RegisterVariable("cl_shownet","0"),CL.nolerp=Cvar.RegisterVariable("cl_nolerp","0"),CL.lookspring=Cvar.RegisterVariable("lookspring","0",!0),CL.lookstrafe=Cvar.RegisterVariable("lookstrafe","0",!0),CL.sensitivity=Cvar.RegisterVariable("sensitivity","3",!0),CL.m_pitch=Cvar.RegisterVariable("m_pitch","0.022",!0),CL.m_yaw=Cvar.RegisterVariable("m_yaw","0.022",!0),CL.m_forward=Cvar.RegisterVariable("m_forward","1",!0),CL.m_side=Cvar.RegisterVariable("m_side","0.8",!0),CL.rcon_password=Cvar.RegisterVariable("rcon_password",""),CL.rcon_address=Cvar.RegisterVariable("rcon_address",""),Cmd.AddCommand("entities",CL.PrintEntities_f),Cmd.AddCommand("disconnect",CL.Disconnect),Cmd.AddCommand("record",CL.Record_f),Cmd.AddCommand("stop",CL.Stop_f),Cmd.AddCommand("playdemo",CL.PlayDemo_f),Cmd.AddCommand("timedemo",CL.TimeDemo_f),Cmd.AddCommand("rcon",CL.Rcon_f)},CL.svc_strings=["bad","nop","disconnect","updatestat","version","setview","sound","time","print","stufftext","setangle","serverinfo","lightstyle","updatename","updatefrags","clientdata","stopsound","updatecolors","particle","damage","spawnstatic","OBSOLETE spawnbinary","spawnbaseline","temp_entity","setpause","signonnum","centerprint","killedmonster","foundsecret","spawnstaticsound","intermission","finale","cdtrack","sellscreen","cutscene"],CL.EntityNum=function(e){if(e<CL.entities.length)return CL.entities[e];for(;CL.entities.length<=e;)CL.entities[CL.entities.length]={num:e,update_type:0,baseline:{origin:[0,0,0],angles:[0,0,0],modelindex:0,frame:0,colormap:0,skin:0,effects:0},msgtime:0,msg_origins:[[0,0,0],[0,0,0]],origin:[0,0,0],msg_angles:[[0,0,0],[0,0,0]],angles:[0,0,0],frame:0,syncbase:0,effects:0,skinnum:0,visframe:0,dlightframe:0,dlightbits:0};return CL.entities[e]},CL.ParseStartSoundPacket=function(){var e=MSG.ReadByte(),t=0!=(1&e)?MSG.ReadByte():255,s=0!=(2&e)?.015625*MSG.ReadByte():1,o=MSG.ReadShort(),a=MSG.ReadByte(),n=o>>3;o&=7;var i=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()];S.StartSound(n,o,CL.state.sound_precache[a],i,t/255,s)},CL.lastmsg=0,CL.KeepaliveMessage=function(){if(!0!==SV.server.active&&!0!==CL.cls.demoplayback){var e,t=NET.message.cursize,s=new Uint8Array(8192);for(s.set(new Uint8Array(NET.message.data,0,t));;){switch(e=CL.GetMessage()){case 0:break;case 1:Host.Error("CL.KeepaliveMessage: received a message");case 2:MSG.ReadByte()!==Protocol.svc.nop&&Host.Error("CL.KeepaliveMessage: datagram wasn't a nop");default:Host.Error("CL.KeepaliveMessage: CL.GetMessage failed")}if(0===e)break}NET.message.cursize=t,new Uint8Array(NET.message.data,0,t).set(s.subarray(0,t));var o=Sys.FloatTime();o-CL.lastmsg<5||(CL.lastmsg=o,Con.Print("--\x3e client to server keepalive\n"),MSG.WriteByte(CL.cls.message,Protocol.clc.nop),NET.SendMessage(CL.cls.netcon,CL.cls.message),CL.cls.message.cursize=0)}},CL.ParseServerInfo=function(){Con.DPrint("Serverinfo packet received.\n"),CL.ClearState();var e=MSG.ReadLong();if(e===Protocol.version)if(CL.state.maxclients=MSG.ReadByte(),CL.state.maxclients<=0||CL.state.maxclients>16)Con.Print("Bad maxclients ("+CL.state.maxclients+") from server\n");else{for(CL.state.scores=[],e=0;e<CL.state.maxclients;++e)CL.state.scores[e]={name:"",entertime:0,frags:0,colors:0};var t;CL.state.gametype=MSG.ReadByte(),CL.state.levelname=MSG.ReadString(),Con.Print("\n\n\n\n"),Con.Print(""+CL.state.levelname+"\n");var s,o=[];for(s=1;0!==(t=MSG.ReadString()).length;++s)o[s]=t;var a,n=[];for(a=1;0!==(t=MSG.ReadString()).length;++a)n[a]=t;for(CL.state.model_precache=[],e=1;e<s;++e){if(CL.state.model_precache[e]=Mod.ForName(o[e]),null==CL.state.model_precache[e])return void Con.Print("Model "+o[e]+" not found\n");CL.KeepaliveMessage()}for(CL.state.sound_precache=[],e=1;e<a;++e)CL.state.sound_precache[e]=S.PrecacheSound(n[e]),CL.KeepaliveMessage();CL.state.worldmodel=CL.state.model_precache[1],CL.EntityNum(0).model=CL.state.worldmodel,R.NewMap(),Host.noclip_anglehack=!1}else Con.Print("Server returned version "+e+", not "+Protocol.version+"\n")},CL.ParseUpdate=function(e){3===CL.cls.signon&&(CL.cls.signon=4,CL.SignonReply()),0!=(e&Protocol.u.morebits)&&(e+=MSG.ReadByte()<<8);var t=CL.EntityNum(0!=(e&Protocol.u.longentity)?MSG.ReadShort():MSG.ReadByte()),s=t.msgtime!==CL.state.mtime[1];t.msgtime=CL.state.mtime[0];var o=CL.state.model_precache[0!=(e&Protocol.u.model)?MSG.ReadByte():t.baseline.modelindex];o!==t.model&&(t.model=o,null!=o?t.syncbase=!0===o.random?Math.random():0:s=!0),t.frame=0!=(e&Protocol.u.frame)?MSG.ReadByte():t.baseline.frame,t.colormap=0!=(e&Protocol.u.colormap)?MSG.ReadByte():t.baseline.colormap,t.colormap>CL.state.maxclients&&Sys.Error("i >= cl.maxclients"),t.skinnum=0!=(e&Protocol.u.skin)?MSG.ReadByte():t.baseline.skin,t.effects=0!=(e&Protocol.u.effects)?MSG.ReadByte():t.baseline.effects,Vec.Copy(t.msg_origins[0],t.msg_origins[1]),Vec.Copy(t.msg_angles[0],t.msg_angles[1]),t.msg_origins[0][0]=0!=(e&Protocol.u.origin1)?MSG.ReadCoord():t.baseline.origin[0],t.msg_angles[0][0]=0!=(e&Protocol.u.angle1)?MSG.ReadAngle():t.baseline.angles[0],t.msg_origins[0][1]=0!=(e&Protocol.u.origin2)?MSG.ReadCoord():t.baseline.origin[1],t.msg_angles[0][1]=0!=(e&Protocol.u.angle2)?MSG.ReadAngle():t.baseline.angles[1],t.msg_origins[0][2]=0!=(e&Protocol.u.origin3)?MSG.ReadCoord():t.baseline.origin[2],t.msg_angles[0][2]=0!=(e&Protocol.u.angle3)?MSG.ReadAngle():t.baseline.angles[2],0!=(e&Protocol.u.nolerp)&&(t.forcelink=!0),!0===s&&(Vec.Copy(t.msg_origins[0],t.origin),Vec.Copy(t.origin,t.msg_origins[1]),Vec.Copy(t.msg_angles[0],t.angles),Vec.Copy(t.angles,t.msg_angles[1]),t.forcelink=!0)},CL.ParseBaseline=function(e){e.baseline.modelindex=MSG.ReadByte(),e.baseline.frame=MSG.ReadByte(),e.baseline.colormap=MSG.ReadByte(),e.baseline.skin=MSG.ReadByte(),e.baseline.origin[0]=MSG.ReadCoord(),e.baseline.angles[0]=MSG.ReadAngle(),e.baseline.origin[1]=MSG.ReadCoord(),e.baseline.angles[1]=MSG.ReadAngle(),e.baseline.origin[2]=MSG.ReadCoord(),e.baseline.angles[2]=MSG.ReadAngle()},CL.ParseClientdata=function(e){var t,s;for(CL.state.viewheight=0!=(e&Protocol.su.viewheight)?MSG.ReadChar():Protocol.default_viewheight,CL.state.idealpitch=0!=(e&Protocol.su.idealpitch)?MSG.ReadChar():0,CL.state.mvelocity[1]=[CL.state.mvelocity[0][0],CL.state.mvelocity[0][1],CL.state.mvelocity[0][2]],t=0;t<=2;++t)0!=(e&Protocol.su.punch1<<t)?CL.state.punchangle[t]=MSG.ReadChar():CL.state.punchangle[t]=0,0!=(e&Protocol.su.velocity1<<t)?CL.state.mvelocity[0][t]=16*MSG.ReadChar():CL.state.mvelocity[0][t]=0;if(t=MSG.ReadLong(),CL.state.items!==t){for(s=0;s<=31;++s)0!=(t>>>s&1)&&0==(CL.state.items>>>s&1)&&(CL.state.item_gettime[s]=CL.state.time);CL.state.items=t}CL.state.onground=0!=(e&Protocol.su.onground),CL.state.inwater=0!=(e&Protocol.su.inwater),CL.state.stats[Def.stat.weaponframe]=0!=(e&Protocol.su.weaponframe)?MSG.ReadByte():0,CL.state.stats[Def.stat.armor]=0!=(e&Protocol.su.armor)?MSG.ReadByte():0,CL.state.stats[Def.stat.weapon]=0!=(e&Protocol.su.weapon)?MSG.ReadByte():0,CL.state.stats[Def.stat.health]=MSG.ReadShort(),CL.state.stats[Def.stat.ammo]=MSG.ReadByte(),CL.state.stats[Def.stat.shells]=MSG.ReadByte(),CL.state.stats[Def.stat.nails]=MSG.ReadByte(),CL.state.stats[Def.stat.rockets]=MSG.ReadByte(),CL.state.stats[Def.stat.cells]=MSG.ReadByte(),!0===COM.standard_quake?CL.state.stats[Def.stat.activeweapon]=MSG.ReadByte():CL.state.stats[Def.stat.activeweapon]=1<<MSG.ReadByte()},CL.ParseStatic=function(){var e={num:-1,update_type:0,baseline:{origin:[],angles:[]},msgtime:0,msg_origins:[[0,0,0],[0,0,0]],msg_angles:[[0,0,0],[0,0,0]],syncbase:0,visframe:0,dlightframe:0,dlightbits:0,leafs:[]};CL.static_entities[CL.state.num_statics++]=e,CL.ParseBaseline(e),e.model=CL.state.model_precache[e.baseline.modelindex],e.frame=e.baseline.frame,e.skinnum=e.baseline.skin,e.effects=e.baseline.effects,e.origin=[e.baseline.origin[0],e.baseline.origin[1],e.baseline.origin[2]],e.angles=[e.baseline.angles[0],e.baseline.angles[1],e.baseline.angles[2]],R.currententity=e,R.emins=[e.origin[0]+e.model.mins[0],e.origin[1]+e.model.mins[1],e.origin[2]+e.model.mins[2]],R.emaxs=[e.origin[0]+e.model.maxs[0],e.origin[1]+e.model.maxs[1],e.origin[2]+e.model.maxs[2]],R.SplitEntityOnNode(CL.state.worldmodel.nodes[0])},CL.ParseStaticSound=function(){var e=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],t=MSG.ReadByte(),s=MSG.ReadByte(),o=MSG.ReadByte();S.StaticSound(CL.state.sound_precache[t],e,s/255,o)},CL.Shownet=function(e){2===CL.shownet.value&&Con.Print((MSG.readcount<=99?MSG.readcount<=9?"  ":" ":"")+(MSG.readcount-1)+":"+e+"\n")},CL.ParseServerMessage=function(){var e,t;for(1===CL.shownet.value?Con.Print(NET.message.cursize+" "):2===CL.shownet.value&&Con.Print("------------------\n"),CL.state.onground=!1,MSG.BeginReading();;){if(!0===MSG.badread&&Host.Error("CL.ParseServerMessage: Bad server message"),-1===(e=MSG.ReadByte()))return void CL.Shownet("END OF MESSAGE");if(0==(128&e)){switch(CL.Shownet("svc_"+CL.svc_strings[e]),e){case Protocol.svc.nop:continue;case Protocol.svc.time:CL.state.mtime[1]=CL.state.mtime[0],CL.state.mtime[0]=MSG.ReadFloat();continue;case Protocol.svc.clientdata:CL.ParseClientdata(MSG.ReadShort());continue;case Protocol.svc.version:(t=MSG.ReadLong())!==Protocol.version&&Host.Error("CL.ParseServerMessage: Server is protocol "+t+" instead of "+Protocol.version+"\n");continue;case Protocol.svc.disconnect:Host.EndGame("Server disconnected\n");case Protocol.svc.print:Con.Print(MSG.ReadString());continue;case Protocol.svc.centerprint:SCR.CenterPrint(MSG.ReadString());continue;case Protocol.svc.stufftext:Cmd.text+=MSG.ReadString();continue;case Protocol.svc.damage:V.ParseDamage();continue;case Protocol.svc.serverinfo:CL.ParseServerInfo(),SCR.recalc_refdef=!0;continue;case Protocol.svc.setangle:CL.state.viewangles[0]=MSG.ReadAngle(),CL.state.viewangles[1]=MSG.ReadAngle(),CL.state.viewangles[2]=MSG.ReadAngle();continue;case Protocol.svc.setview:CL.state.viewentity=MSG.ReadShort();continue;case Protocol.svc.lightstyle:(t=MSG.ReadByte())>=64&&Sys.Error("svc_lightstyle > MAX_LIGHTSTYLES"),CL.lightstyle[t]=MSG.ReadString();continue;case Protocol.svc.sound:CL.ParseStartSoundPacket();continue;case Protocol.svc.stopsound:t=MSG.ReadShort(),S.StopSound(t>>3,7&t);continue;case Protocol.svc.updatename:(t=MSG.ReadByte())>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatename > MAX_SCOREBOARD"),CL.state.scores[t].name=MSG.ReadString();continue;case Protocol.svc.updatefrags:(t=MSG.ReadByte())>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatefrags > MAX_SCOREBOARD"),CL.state.scores[t].frags=MSG.ReadShort();continue;case Protocol.svc.updatecolors:(t=MSG.ReadByte())>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatecolors > MAX_SCOREBOARD"),CL.state.scores[t].colors=MSG.ReadByte();continue;case Protocol.svc.particle:R.ParseParticleEffect();continue;case Protocol.svc.spawnbaseline:CL.ParseBaseline(CL.EntityNum(MSG.ReadShort()));continue;case Protocol.svc.spawnstatic:CL.ParseStatic();continue;case Protocol.svc.temp_entity:CL.ParseTEnt();continue;case Protocol.svc.setpause:CL.state.paused=0!==MSG.ReadByte(),!0===CL.state.paused?CDAudio.Pause():CDAudio.Resume();continue;case Protocol.svc.signonnum:(t=MSG.ReadByte())<=CL.cls.signon&&Host.Error("Received signon "+t+" when at "+CL.cls.signon),CL.cls.signon=t,CL.SignonReply();continue;case Protocol.svc.killedmonster:++CL.state.stats[Def.stat.monsters];continue;case Protocol.svc.foundsecret:++CL.state.stats[Def.stat.secrets];continue;case Protocol.svc.updatestat:(t=MSG.ReadByte())>=32&&Sys.Error("svc_updatestat: "+t+" is invalid"),CL.state.stats[t]=MSG.ReadLong();continue;case Protocol.svc.spawnstaticsound:CL.ParseStaticSound();continue;case Protocol.svc.cdtrack:CL.state.cdtrack=MSG.ReadByte(),MSG.ReadByte(),!0!==CL.cls.demoplayback&&!0!==CL.cls.demorecording||-1===CL.cls.forcetrack?CDAudio.Play(CL.state.cdtrack,!0):CDAudio.Play(CL.cls.forcetrack,!0);continue;case Protocol.svc.intermission:CL.state.intermission=1,CL.state.completed_time=CL.state.time,SCR.recalc_refdef=!0;continue;case Protocol.svc.finale:CL.state.intermission=2,CL.state.completed_time=CL.state.time,SCR.recalc_refdef=!0,SCR.CenterPrint(MSG.ReadString());continue;case Protocol.svc.cutscene:CL.state.intermission=3,CL.state.completed_time=CL.state.time,SCR.recalc_refdef=!0,SCR.CenterPrint(MSG.ReadString());continue;case Protocol.svc.sellscreen:Cmd.ExecuteString("help");continue}Host.Error("CL.ParseServerMessage: Illegible server message\n")}else CL.Shownet("fast update"),CL.ParseUpdate(127&e)}},CL.temp_entities=[],CL.InitTEnts=function(){CL.sfx_wizhit=S.PrecacheSound("wizard/hit.wav"),CL.sfx_knighthit=S.PrecacheSound("hknight/hit.wav"),CL.sfx_tink1=S.PrecacheSound("weapons/tink1.wav"),CL.sfx_ric1=S.PrecacheSound("weapons/ric1.wav"),CL.sfx_ric2=S.PrecacheSound("weapons/ric2.wav"),CL.sfx_ric3=S.PrecacheSound("weapons/ric3.wav"),CL.sfx_r_exp3=S.PrecacheSound("weapons/r_exp3.wav")},CL.ParseBeam=function(e){var t,s,o=MSG.ReadShort(),a=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],n=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()];for(t=0;t<=23;++t)if((s=CL.beams[t]).entity===o)return s.model=e,s.endtime=CL.state.time+.2,s.start=[a[0],a[1],a[2]],void(s.end=[n[0],n[1],n[2]]);for(t=0;t<=23;++t)if(!(null!=(s=CL.beams[t]).model&&s.endtime>=CL.state.time))return s.entity=o,s.model=e,s.endtime=CL.state.time+.2,s.start=[a[0],a[1],a[2]],void(s.end=[n[0],n[1],n[2]]);Con.Print("beam list overflow!\n")},CL.ParseTEnt=function(){var e=MSG.ReadByte();switch(e){case Protocol.te.lightning1:return void CL.ParseBeam(Mod.ForName("progs/bolt.mdl",!0));case Protocol.te.lightning2:return void CL.ParseBeam(Mod.ForName("progs/bolt2.mdl",!0));case Protocol.te.lightning3:return void CL.ParseBeam(Mod.ForName("progs/bolt3.mdl",!0));case Protocol.te.beam:return void CL.ParseBeam(Mod.ForName("progs/beam.mdl",!0))}var t,s=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()];switch(e){case Protocol.te.wizspike:return R.RunParticleEffect(s,Vec.origin,20,20),void S.StartSound(-1,0,CL.sfx_wizhit,s,1,1);case Protocol.te.knightspike:return R.RunParticleEffect(s,Vec.origin,226,20),void S.StartSound(-1,0,CL.sfx_knighthit,s,1,1);case Protocol.te.spike:return void R.RunParticleEffect(s,Vec.origin,0,10);case Protocol.te.superspike:case Protocol.te.gunshot:return void R.RunParticleEffect(s,Vec.origin,0,20);case Protocol.te.explosion:return R.ParticleExplosion(s),(t=CL.AllocDlight(0)).origin=[s[0],s[1],s[2]],t.radius=350,t.die=CL.state.time+.5,t.decay=300,void S.StartSound(-1,0,CL.sfx_r_exp3,s,1,1);case Protocol.te.tarexplosion:return R.BlobExplosion(s),void S.StartSound(-1,0,CL.sfx_r_exp3,s,1,1);case Protocol.te.lavasplash:return void R.LavaSplash(s);case Protocol.te.teleport:return void R.TeleportSplash(s);case Protocol.te.explosion2:var o=MSG.ReadByte(),a=MSG.ReadByte();return R.ParticleExplosion2(s,o,a),(t=CL.AllocDlight(0)).origin=[s[0],s[1],s[2]],t.radius=350,t.die=CL.state.time+.5,t.decay=300,void S.StartSound(-1,0,CL.sfx_r_exp3,s,1,1)}Sys.Error("CL.ParseTEnt: bad type")},CL.NewTempEntity=function(){var e={frame:0,syncbase:0,skinnum:0};return CL.temp_entities[CL.num_temp_entities++]=e,CL.visedicts[CL.numvisedicts++]=e,e},CL.UpdateTEnts=function(){CL.num_temp_entities=0;var e,t,s,o,a,n,i=[],r=[];for(e=0;e<=23;++e)if(!(null==(t=CL.beams[e]).model||t.endtime<CL.state.time))for(t.entity===CL.state.viewentity&&Vec.Copy(CL.entities[CL.state.viewentity].origin,t.start),i[0]=t.end[0]-t.start[0],i[1]=t.end[1]-t.start[1],i[2]=t.end[2]-t.start[2],0===i[0]&&0===i[1]?(s=0,o=i[2]>0?90:270):((s=180*Math.atan2(i[1],i[0])/Math.PI>>0)<0&&(s+=360),(o=180*Math.atan2(i[2],Math.sqrt(i[0]*i[0]+i[1]*i[1]))/Math.PI>>0)<0&&(o+=360)),r[0]=t.start[0],r[1]=t.start[1],r[2]=t.start[2],0!==(a=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]))&&(i[0]/=a,i[1]/=a,i[2]/=a);a>0;)(n=CL.NewTempEntity()).origin=[r[0],r[1],r[2]],n.model=t.model,n.angles=[o,s,360*Math.random()],r[0]+=30*i[0],r[1]+=30*i[1],r[2]+=30*i[2],a-=30};

			// Cmd.js
			Cmd={},Cmd.alias=[],Cmd.Wait_f=function(){Cmd.wait=!0},Cmd.text="",Cmd.Execute=function(){for(var n,d="",t=!1;0!==Cmd.text.length;)if(n=Cmd.text.charCodeAt(0),Cmd.text=Cmd.text.substring(1),34!==n)if(!1===t&&59===n||10===n){if(0===d.length)continue;if(Cmd.ExecuteString(d),!0===Cmd.wait)return void(Cmd.wait=!1);d=""}else d+=String.fromCharCode(n);else t=!t,d+='"';Cmd.text=""},Cmd.StuffCmds_f=function(){var n,d,t=!1,m="";for(n=0;n<COM.argv.length;++n)if(d=COM.argv[n].charCodeAt(0),!0!==t)43===d&&(t=!0,m+=COM.argv[n].substring(1)+" ");else{if(43===d){m+="\n"+COM.argv[n].substring(1)+" ";continue}if(45===d){t=!1,m+="\n";continue}m+=COM.argv[n]+" "}0!==m.length&&(Cmd.text=m+"\n"+Cmd.text)},Cmd.Exec_f=function(){if(2===Cmd.argv.length){var n=COM.LoadTextFile(Cmd.argv[1]);null!=n?(Con.Print("execing "+Cmd.argv[1]+"\n"),Cmd.text=n+Cmd.text):Con.Print("couldn't exec "+Cmd.argv[1]+"\n")}else Con.Print("exec <filename> : execute a script file\n")},Cmd.Echo_f=function(){var n;for(n=1;n<Cmd.argv.length;++n)Con.Print(Cmd.argv[n]+" ");Con.Print("\n")},Cmd.Alias_f=function(){var n;if(Cmd.argv.length<=1)for(Con.Print("Current alias commands:\n"),n=0;n<Cmd.alias.length;++n)Con.Print(Cmd.alias[n].name+" : "+Cmd.alias[n].value+"\n");var d,t=Cmd.argv[1],m="";for(n=0;n<Cmd.alias.length&&Cmd.alias[n].name!==t;++n);for(d=2;d<Cmd.argv.length;++d)m+=Cmd.argv[d],d!==Cmd.argv.length&&(m+=" ");Cmd.alias[n]={name:t,value:m+"\n"}},Cmd.argv=[],Cmd.functions=[],Cmd.Init=function(){Cmd.AddCommand("stuffcmds",Cmd.StuffCmds_f),Cmd.AddCommand("exec",Cmd.Exec_f),Cmd.AddCommand("echo",Cmd.Echo_f),Cmd.AddCommand("alias",Cmd.Alias_f),Cmd.AddCommand("cmd",Cmd.ForwardToServer),Cmd.AddCommand("wait",Cmd.Wait_f)},Cmd.TokenizeString=function(n){var d,t;for(Cmd.argv=[];;){for(d=0;d<n.length&&!((t=n.charCodeAt(d))>32||10===t);++d);if(1===Cmd.argv.length&&(Cmd.args=n.substring(d)),10===n.charCodeAt(d)||d>=n.length)return;if(null==(n=COM.Parse(n)))return;Cmd.argv[Cmd.argv.length]=COM.token}},Cmd.AddCommand=function(n,d){var t;for(t=0;t<Cvar.vars.length;++t)if(Cvar.vars[t].name===n)return void Con.Print("Cmd.AddCommand: "+n+" already defined as a var\n");for(t=0;t<Cmd.functions.length;++t)if(Cmd.functions[t].name===n)return void Con.Print("Cmd.AddCommand: "+n+" already defined\n");Cmd.functions[Cmd.functions.length]={name:n,command:d}},Cmd.CompleteCommand=function(n){var d;if(0!==n.length)for(d=0;d<Cmd.functions.length;++d)if(Cmd.functions[d].name.substring(0,n.length)===n)return Cmd.functions[d].name},Cmd.ExecuteString=function(n,d){if(Cmd.client=d,Cmd.TokenizeString(n),0!==Cmd.argv.length){var t,m=Cmd.argv[0].toLowerCase();for(t=0;t<Cmd.functions.length;++t)if(Cmd.functions[t].name===m)return void Cmd.functions[t].command();for(t=0;t<Cmd.alias.length;++t)if(Cmd.alias[t].name===m)return void(Cmd.text=Cmd.alias[t].value+Cmd.text);!0!==Cvar.Command()&&Con.Print('Unknown command "'+m+'"\n')}},Cmd.ForwardToServer=function(){if(CL.cls.state===CL.active.connected){if(!0!==CL.cls.demoplayback){var n=String.fromCharCode(Protocol.clc.stringcmd);"cmd"!==Cmd.argv[0].toLowerCase()&&(n+=Cmd.argv[0]+" "),Cmd.argv.length>=2?n+=Cmd.args:n+="\n",MSG.WriteString(CL.cls.message,n)}}else Con.Print("Can't \""+Cmd.argv[0]+'", not connected\n')};

			// COM.js MODIFIED
			COM={},COM.argv=[],COM.standard_quake=!0,COM.DefaultExtension=function(e,r){var t,n;for(t=e.length-1;t>=0&&47!==(n=e.charCodeAt(t));--t)if(46===n)return e;return e+r},COM.Parse=function(e){COM.token="";var r,t=0;if(0!==e.length){for(var n=!0;!0===n;){for(n=!1;;){if(t>=e.length)return;if((r=e.charCodeAt(t))>32)break;++t}if(47===r&&47==e.charCodeAt(t+1)){for(;!(t>=e.length||10===e.charCodeAt(t));)++t;n=!0}}if(34===r)for(++t;;){if(r=e.charCodeAt(t),++t>=e.length||34===r)return e.substring(t);COM.token+=String.fromCharCode(r)}for(;!(t>=e.length||r<=32);)COM.token+=String.fromCharCode(r),++t,r=e.charCodeAt(t);return e.substring(t)}},COM.CheckParm=function(e){var r;for(r=1;r<COM.argv.length;++r)if(COM.argv[r]===e)return r},COM.CheckRegistered=function(){var e=COM.LoadFile("gfx/pop.lmp");if(null!=e){var r,t=new Uint8Array(e),n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,102,0,0,0,0,0,0,0,102,0,0,0,0,0,0,102,0,0,0,0,0,0,0,0,0,103,0,0,0,0,102,101,0,0,0,0,0,0,0,0,0,101,102,0,0,99,101,97,0,0,0,0,0,0,0,0,0,97,101,99,0,100,101,97,0,0,0,0,0,0,0,0,0,97,101,100,0,100,101,100,0,0,100,105,105,105,100,0,0,100,101,100,0,99,101,104,98,0,0,100,104,100,0,0,98,104,101,99,0,0,101,103,105,99,0,100,103,100,0,99,105,103,101,0,0,0,98,102,103,105,106,104,103,104,106,105,103,102,98,0,0,0,0,98,101,102,102,102,102,102,102,102,101,98,0,0,0,0,0,0,0,98,99,100,102,100,99,98,0,0,0,0,0,0,0,0,0,0,0,98,102,98,0,0,0,0,0,0,0,0,0,0,0,0,0,97,102,97,0,0,0,0,0,0,0,0,0,0,0,0,0,0,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0];for(r=0;r<256;++r)t[r]!==n[r]&&Sys.Error("Corrupted data file.");Cvar.Set("registered","1"),Con.Print("Playing registered version.\n")}else Con.Print("Playing shareware version.\n")},COM.InitArgv=function(e){var r;for(COM.cmdline=(e.join(" ")+" ").substring(0,256),r=0;r<e.length;++r)COM.argv[r]=e[r];null!=COM.CheckParm("-safe")&&(COM.argv[COM.argv.length]="-nosound",COM.argv[COM.argv.length]="-nocdaudio",COM.argv[COM.argv.length]="-nomouse"),null!=COM.CheckParm("-rogue")?(COM.rogue=!0,COM.standard_quake=!1):null!=COM.CheckParm("-hipnotic")&&(COM.hipnotic=!0,COM.standard_quake=!1)},COM.Init=function(){"http:"!==document.location.protocol&&"https:"!==document.location.protocol&&Sys.Error("Protocol is "+document.location.protocol+", not http: or https:");var e=new ArrayBuffer(2),r=new Uint8Array(e);r[0]=1,r[1]=0,1===new Uint16Array(e)[0]?COM.LittleLong=function(e){return e}:COM.LittleLong=function(e){return(e>>>24)+((16711680&e)>>>8)+((65280&e)<<8>>>0)+(e<<24>>>0)},COM.registered=Cvar.RegisterVariable("registered","0"),Cvar.RegisterVariable("cmdline",COM.cmdline,!1,!0),Cmd.AddCommand("path",COM.Path_f),COM.InitFilesystem(),COM.CheckRegistered()},COM.searchpaths=[],COM.Path_f=function(){Con.Print("Current search path:\n");var e,r,t=COM.searchpaths.length;for(t=COM.searchpaths.length-1;t>=0;--t){for(e=(r=COM.searchpaths[t]).pack.length-1;e>=0;--e)Con.Print(r.filename+"Quake1Game"+e+".pak ("+r.pack[e].length+" files)\n");Con.Print(r.filename+"\n")}},COM.WriteFile=function(e,r,t){e=e.toLowerCase();var n,a=[];for(n=0;n<t;++n)a[n]=String.fromCharCode(r[n]);try{localStorage.setItem("Quake."+COM.searchpaths[COM.searchpaths.length-1].filename+"/"+e,a.join(""))}catch(r){return void Sys.Print("COM.WriteFile: failed on "+e+"\n")}return Sys.Print("COM.WriteFile: "+e+"\n"),!0},COM.WriteTextFile=function(e,r){e=e.toLowerCase();try{localStorage.setItem("Quake."+COM.searchpaths[COM.searchpaths.length-1].filename+"/"+e,r)}catch(r){return void Sys.Print("COM.WriteTextFile: failed on "+e+"\n")}return Sys.Print("COM.WriteTextFile: "+e+"\n"),!0},COM.LoadFile=function(e){e=e.toLowerCase();var r,t,n,a,i,o,s,l,C=new XMLHttpRequest;for(C.overrideMimeType("text/plain; charset=x-user-defined"),Draw.BeginDisc(),r=COM.searchpaths.length-1;r>=0;--r){if(i=(a=COM.searchpaths[r]).filename+"/"+e,null!=(l=localStorage.getItem("Quake."+i)))return Sys.Print("FindFile: "+i+"\n"),Draw.EndDisc(),Q.strmem(l);for(t=a.pack.length-1;t>=0;--t)for(o=a.pack[t],n=0;n<o.length;++n)if((s=o[n]).name===e){if(0===s.filelen)return Draw.EndDisc(),new ArrayBuffer(0);if(C.open("GET",a.filename+"Quake1Game"+t+".pak",!1),C.setRequestHeader("Range","bytes="+s.filepos+"-"+(s.filepos+s.filelen-1)),C.send(),C.status>=200&&C.status<=299&&C.responseText.length===s.filelen)return Sys.Print("PackFile: "+a.filename+"Quake1Game"+t+".pak : "+e+"\n"),Draw.EndDisc(),Q.strmem(C.responseText);break}if(C.open("GET",i,!1),C.send(),C.status>=200&&C.status<=299)return Sys.Print("FindFile: "+i+"\n"),Draw.EndDisc(),Q.strmem(C.responseText)}Sys.Print("FindFile: can't find "+e+"\n"),Draw.EndDisc()},COM.LoadTextFile=function(e){var r=COM.LoadFile(e);if(null!=r){var t,n=new Uint8Array(r),a=[];for(t=0;t<n.length;++t)13!==n[t]&&(a[a.length]=String.fromCharCode(n[t]));return a.join("")}},COM.LoadPackFile=function(e){var r=new XMLHttpRequest;if(r.overrideMimeType("text/plain; charset=x-user-defined"),r.open("GET",e,!1),r.setRequestHeader("Range","bytes=0-11"),r.send(),!(r.status<=199||r.status>=300||12!==r.responseText.length)){var t=new DataView(Q.strmem(r.responseText));1262698832!==t.getUint32(0,!0)&&Sys.Error(e+" is not a packfile");var n=t.getUint32(4,!0),a=t.getUint32(8,!0),i=a>>6;339!==i&&(COM.modified=!0);var o=[];if(0!==i){if(r.open("GET",e,!1),r.setRequestHeader("Range","bytes="+n+"-"+(n+a-1)),r.send(),r.status<=199||r.status>=300||r.responseText.length!==a)return;var s,l=Q.strmem(r.responseText);for(32981!==CRC.Block(new Uint8Array(l))&&(COM.modified=!0),s=0;s<i;++s)o[o.length]={name:Q.memstr(new Uint8Array(l,s<<6,56)).toLowerCase(),filepos:new DataView(l).getUint32(56+(s<<6),!0),filelen:new DataView(l).getUint32(60+(s<<6),!0)}}return Con.Print("Added packfile "+e+" ("+i+" files)\n"),o}},COM.AddGameDirectory=function(e){for(var r,t={filename:e,pack:[]},n=0;null!=(r=COM.LoadPackFile(e+"Quake1Game"+n+".pak"));)t.pack[t.pack.length]=r,++n;COM.searchpaths[COM.searchpaths.length]=t},COM.InitFilesystem=function(){var e,r;null!=(e=COM.CheckParm("-basedir"))&&(r=COM.argv[e+1]),null!=r?COM.AddGameDirectory(r):COM.AddGameDirectory(""),!0===COM.rogue?COM.AddGameDirectory("rogue"):!0===COM.hipnotic&&COM.AddGameDirectory("hipnotic"),null!=(e=COM.CheckParm("-game"))&&null!=(r=COM.argv[e+1])&&(COM.modified=!0,COM.AddGameDirectory(r)),COM.gamedir=[COM.searchpaths[COM.searchpaths.length-1]]};

			// Console.js
			Con={},Con.backscroll=0,Con.current=0,Con.text=[],Con.ToggleConsole_f=function(){if(SCR.EndLoadingPlaque(),Key.dest.value===Key.dest.console)return CL.cls.state!==CL.active.connected?void M.Menu_Main_f():(Key.dest.value=Key.dest.game,Key.edit_line="",void(Key.history_line=Key.lines.length));Key.dest.value=Key.dest.console},Con.Clear_f=function(){Con.backscroll=0,Con.current=0,Con.text=[]},Con.ClearNotify=function(){var e=Con.text.length-4;for(e<0&&(e=0);e<Con.text.length;++e)Con.text[e].time=0},Con.MessageMode_f=function(){Key.dest.value=Key.dest.message,Key.team_message=!1},Con.MessageMode2_f=function(){Key.dest.value=Key.dest.message,Key.team_message=!0},Con.Init=function(){Con.debuglog=null!=COM.CheckParm("-condebug"),!0===Con.debuglog&&COM.WriteTextFile("qconsole.log",""),Con.Print("Console initialized.\n"),Con.notifytime=Cvar.RegisterVariable("con_notifytime","3"),Cmd.AddCommand("toggleconsole",Con.ToggleConsole_f),Cmd.AddCommand("messagemode",Con.MessageMode_f),Cmd.AddCommand("messagemode2",Con.MessageMode2_f),Cmd.AddCommand("clear",Con.Clear_f)},Con.Print=function(e){if(!0===Con.debuglog){var t=COM.LoadTextFile("qconsole.log");null!=t&&((t+=e).length>=32768&&(t=t.substring(t.length-16384)),COM.WriteTextFile("qconsole.log",t))}Con.backscroll=0;var n,o=0;for(e.charCodeAt(0)<=2&&(o=128,1===e.charCodeAt(0)&&S.LocalSound(Con.sfx_talk),e=e.substring(1)),n=0;n<e.length;++n)null==Con.text[Con.current]&&(Con.text[Con.current]={text:"",time:Host.realtime}),10!==e.charCodeAt(n)?Con.text[Con.current].text+=String.fromCharCode(e.charCodeAt(n)+o):Con.text.length>=1024?(Con.text=Con.text.slice(-512),Con.current=Con.text.length):++Con.current},Con.DPrint=function(e){0!==Host.developer.value&&Con.Print(e)},Con.DrawInput=function(){if(Key.dest.value===Key.dest.console||!0===Con.forcedup){var e="]"+Key.edit_line+String.fromCharCode(10+(4*Host.realtime&1)),t=(VID.width>>3)-2;e.length>=t&&(e=e.substring(1+e.length-t)),Draw.String(8,Con.vislines-16,e)}},Con.DrawNotify=function(){var e=(VID.width>>3)-2,t=Con.text.length-4,n=0;for(t<0&&(t=0);t<Con.text.length;++t)Host.realtime-Con.text[t].time>Con.notifytime.value||(Draw.String(8,n,Con.text[t].text.substring(0,e)),n+=8);Key.dest.value===Key.dest.message&&Draw.String(8,n,"say: "+Key.chat_buffer+String.fromCharCode(10+(4*Host.realtime&1)))},Con.DrawConsole=function(e){if(!(e<=0)){e=Math.floor(e*VID.height*.005),Draw.ConsoleBackground(e),Con.vislines=e;var t,n,o,C,l=(VID.width>>3)-2,r=e-16;for(n=Con.text.length-1-Con.backscroll;n>=0&&(0===Con.text[n].text.length?r-=8:r-=Math.ceil(Con.text[n].text.length/l)<<3,--n,!(r<=0)););for(++n;n<Con.text.length-Con.backscroll;++n)if(C=Con.text[n].text,0!==(t=Math.ceil(C.length/l)))for(o=0;o<t;++o)Draw.String(8,r,C.substr(o*l,l)),r+=8;else r+=8;Con.DrawInput()}};

			// CRC.js
			CRC={},CRC.table=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],CRC.Block=function(C){var t,e=65535;for(t=0;t<C.length;++t)e=e<<8&65535^CRC.table[e>>8^C[t]];return e};

			// Cvar.js
			Cvar={},Cvar.vars=[],Cvar.FindVar=function(r){var a;for(a=0;a<Cvar.vars.length;++a)if(Cvar.vars[a].name===r)return Cvar.vars[a]},Cvar.CompleteVariable=function(r){var a;if(0!==r.length)for(a=0;a<Cvar.vars.length;++a)if(Cvar.vars[a].name.substring(0,r.length)===r)return Cvar.vars[a].name},Cvar.Set=function(r,a){var n,v,e;for(n=0;n<Cvar.vars.length;++n)if((v=Cvar.vars[n]).name===r)return v.string!==a&&(e=!0),v.string=a,v.value=Q.atof(a),void(!0===v.server&&!0===e&&!0===SV.server.active&&Host.BroadcastPrint('"'+v.name+'" changed to "'+v.string+'"\n'));Con.Print("Cvar.Set: variable "+r+" not found\n")},Cvar.SetValue=function(r,a){Cvar.Set(r,a.toFixed(6))},Cvar.RegisterVariable=function(r,a,n,v){var e;for(e=0;e<Cvar.vars.length;++e)if(Cvar.vars[e].name===r)return void Con.Print("Can't register variable "+r+", allready defined\n");return Cvar.vars[Cvar.vars.length]={name:r,string:a,archive:n,server:v,value:Q.atof(a)},Cvar.vars[Cvar.vars.length-1]},Cvar.Command=function(){var r=Cvar.FindVar(Cmd.argv[0]);if(null!=r)return Cmd.argv.length<=1?(Con.Print('"'+r.name+'" is "'+r.string+'"\n'),!0):(Cvar.Set(r.name,Cmd.argv[1]),!0)},Cvar.WriteVariables=function(){var r,a,n=[];for(r=0;r<Cvar.vars.length;++r)!0===(a=Cvar.vars[r]).archive&&(n[n.length]=a.name+' "'+a.string+'"\n');return n.join("")};

			// Def.js
			Def={},Def.webquake_version=54,Def.timedate="Exe: 13:00:49 Aug 10 2017\n",Def.max_edicts=600,Def.stat={health:0,frags:1,weapon:2,ammo:3,armor:4,weaponframe:5,shells:6,nails:7,rockets:8,cells:9,activeweapon:10,totalsecrets:11,totalmonsters:12,secrets:13,monsters:14},Def.it={shotgun:1,super_shotgun:2,nailgun:4,super_nailgun:8,grenade_launcher:16,rocket_launcher:32,lightning:64,super_lightning:128,shells:256,nails:512,rockets:1024,cells:2048,axe:4096,armor1:8192,armor2:16384,armor3:32768,superhealth:65536,key1:131072,key2:262144,invisibility:524288,invulnerability:1048576,suit:2097152,quad:4194304},Def.rit={shells:128,nails:256,rockets:512,cells:1024,axe:2048,lava_nailgun:4096,lava_super_nailgun:8192,multi_grenade:16384,multi_rocket:32768,plasma_gun:65536,armor1:8388608,armor2:16777216,armor3:33554432,lava_nails:67108864,plasma_ammo:134217728,multi_rockets:268435456,shield:536870912,antigrav:1073741824,superhealth:2147483648},Def.hit={proximity_gun_bit:16,mjolnir_bit:7,laser_cannon_bit:23,proximity_gun:65536,mjolnir:128,laser_cannon:8388608,wetsuit:33554432,empathy_shields:67108864};

			// Draw.js MODIFIED
			Draw={},Draw.CharToConback=function(a,r){var t,e,n=(a>>4<<10)+((15&a)<<3);for(t=0;t<8;++t){for(e=0;e<8;++e)0!==Draw.chars[n+e]&&(Draw.conback.data[r+e]=96+Draw.chars[n+e]);n+=128,r+=320}},Draw.Init=function(){var a;Draw.chars=new Uint8Array(W.GetLumpName("CONCHARS"));var r=new ArrayBuffer(65536),t=new Uint32Array(r);for(a=0;a<16384;++a)0!==Draw.chars[a]&&(t[a]=COM.LittleLong(VID.d_8to24table[Draw.chars[a]]+4278190080));Draw.char_texture=gl.createTexture(),GL.Bind(0,Draw.char_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(r)),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),Draw.conback={};var e=COM.LoadFile("gfx/conback.lmp");null==e&&Sys.Error("Couldn't load gfx/conback.lmp"),Draw.conback.width=320,Draw.conback.height=200,Draw.conback.data=new Uint8Array(e,8,64e3);for(a=0;a<"1.09".length;++a)Draw.CharToConback("1.09".charCodeAt(a),59829-("1.09".length-a<<3),186);Draw.conback.texnum=GL.LoadPicTexture(Draw.conback),Draw.loading=Draw.CachePic("loading"),Draw.loadingElem=document.getElementById("loading"),Draw.loadingElem.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAAAYCAYAAAAVpXQNAAAKWklEQVRogc1aq5bkOhI0K2BgICAgYCBgYGBgIGAg0MDAYIBBgwUFCjYosPCC+oABCxcOvHA/MRfYIYey5Jrp6b17LvDxS49UZigyJLsKvZHQG3kbu5dH6NuX96/K/6ysrnddJlnj+Lepf9bGq3Z/d/x/hf9etaHLfeboXCNV6I3Mo5M1jrLGMXV+XSb5eJ/lukzpwP3Z+VXZV+U/3ufsnb7/O9THmf30vxz/X+2/M/tL5X9m38f7LGvwG4AGb+QWe1mDlzV4eaxR1uAlDlbW4CW02/MlOFnCATQct9g/gU8/x/Ut9nKLvVyXKbu+z2P2jMuX2jh7xnX1PT9/da+fnz3TfZT6PrOpVO9367/yxa/4qeSvzB7gYjru8S60fgMQHj7WKP+5DXKfx1Tx432WJTgZvBGUfRs7iYPdALWXexu7dD2PG9jm0ckt9hvDqXI4wxjQ4jy6VB5l5tFJ6G1qA/1yHZTj89vYZU64xV7iYKVzjWDi8BhQNw42nXW7GBc/ZxtDb9O49Zjn0WXjPnvGbep7HvvvlGXbUeZt7E7bhV1//nGVH9/GDESDNzuAJpcCyQwER2aDi2M6M0qBZDiyBB4YCadpYxEcDiqDhwPO5TioS3AJkGgjDjbZGXqbyjDTxsFmNuE5tzF4I6G3T7MTIF6CS+9fgYcBXnqm7WI7MHk/W1aDluOqJzVPZPj4scY0AdHe4I1UofWJjrp2c1Jr6+SsZNAutu7zKE19kaqqsuNyqbYUVpgVABLfYzDsQC4D1mPwMFiYHQAKPQu1owFqHPw+Djb1xcDUfWhwMHs81pixtw5mibVKz84AgXc89l8ty+CBPWfg0b4CYw/eSOeaHECg8sEbsU2dDmYfNgCO8uYirqkSmMBcJcospRhOnZoucdznMYGvlJ/PqFkzA5ixqqrUFjss6QDVv9YFaPc+j0m34cyTR2uFszZT2Z/oD80ipfZLQNLtnNlznw8NpNPpLfYZLmxTJ10cWr8x0GONiXlsU0tr66fZy0Y81ijDXtbWtXhzyRhCgwcpjZENWtROH2wtTX2Rut5YjQF0uVRS15W4ppLB1hm7MVMwaAEMZktN3bAFiwTNrji4jn4HdtbBbepLdlRVJZ1rUjkweunQEgDt1nWVysBHWm7cYp98iQP23edxIwDTZO/hq4yN4iidaxI2wEBJA3Wukfs8yhJcKhh68yQuOZ3BAIBnsPVTIEspA4EFCBkcg61TMJr6IlPbyGONmQORIrw5Bs19I83wXgXatk2d9XFG6+hHA+SxxsQy93mUj/dZprbJ2uR2AbbHGsWZJitzn8cM5Pc5B603l6dUyGkL5V3z3NYt9jK1BzBcU2X+xhjv87hNGm9ksLU402QTII99K63diAWSZw37Mp5nAzYVS3lbU/5gt4DAia9WEKXrTM2rICzepL0GvTID3WqHA+SsrW6xl9CbVIYDjnHrGY563hjxBnXNsXigMggAAwTB50BhtjvTpPdZKo1j8idkQe+bzE+ZH/fyU9tkdpV8CTtht9aLAM3ijzHqCbX5sZWutRlrbymMRKoWUjrg3ODUNikg0FEoy3lYC0+dw3nAcCJmX0lgL2GbgYN1MuyzAnU1oyzBZcwwj06mdgtiVVWi98CYIdPY9kBhfLx1gHSQZnGTp7N8srlsfGCEAxAusTlYuK6rJyAdjO0yAMFmjNc2dWJxnohYmPDEAaNypijpTWb1xxoPDaTZo7T/AQPQAIMHgcBKpiS+9TXuoQsGu+mpwZsMQAwcBjP3jZSmNcjgNwYJvUnpL/QmA9EZA2GC4OBAge3gaAAIwbdNndIdgo33ADoHBuM5+vOpLeid0G8MgQkJUHLA0Xdr68S4YDutF7VY5+uS7tVZKfn3FYCYkbo2V/fJKbvz1rAt6zjdlQ6Nbmaet7FLs50ZjBkF11v/R2DafWazk5BSuL37PD5pF81caxzFG5PKwSbNiF1r5bpMOyA3P2B1mrPFc7rXE4vfZexOjAQgsf8ZAFVVbVswe1/LPrE56FpDaoGv9SFnH2agBCBeTpdS2Bp8Ag+E9TEAl2aC1jpnO6UYKJbC3lxk8CZzGjMQdA2L+oyB9nMmPOOYGGbZWUiDKkt/3qTd2DOG1fogWwD4A2xoe2M7WwQErz7ZXqQcpEWuh/FAPDObwWYsFBj42MJgu7GK1gsF2H2GA32f7QOVGAhUXUIkgofVGNOfFs1og5fAYIttsDnFY9NS536ctQYabJ20EfcxtY1clykFBdqjxEKagab22DwDA7EvMJs3W+rEWIs3EgebNA76YgDxyomDb5s6BRj1F28SmKCzNpAeDIS9Lu1Lb46lud5Kgd18sP/O0lfanJxczkBxsNtutGtEpzUtNMEAAE9LnUMH8b6E1i5YWuaCNQcEv9c6hQVnq1IMa4F5dPJY49MnAzAVgwjBS/S8g4JTmAb0Y40Senswwh5sbM7pFDaosT1pOpWSNJBmf5RbCNgA6ntvMwbCNsd9HuX7dX5K5YdNLk1czTSvAJQ+pmqwPNZY/AzwlEJIrCGArPRRj4Wi1iVgBYDIm4s0l+e9Je73ctnaaHdHYh+LRfnUNvKPt/ZZ3wT/lFqQHpxpFICOpT87E6us0NuUUsA+6a8EKq81UMmfb2OXNAvkAmwBkN73ialZgwG9xiP9wUcop0W0TncMbK1D42DlnyH/QJ2JaBw/vo3y5x/XbBOvtBt6tg/EAgt7NnAi51oeDC9rMXOaets7YdbD7jQAghSC99hvKdmlczkHHctfFpR4x+kDNuuNPywAPt7nFFD4wZtLWlIfqSxfSLAGZFZhf7OPtE2cWo/V5gE0Z5rE+hxPBg+PL/syv3/i+PFtlH//cZd/vR37TsVlPIzVeoYHjJnJAeBgfb9ujrR1WahNbZPSJjMRnPT9OqdZB8bAu8ca5eN9zvZR+D3O0D5asII9UAYHpwu0z3ZgTCU7cNbik9kDbeHMQEMZtoElA581kLgd9M1A+n6dk+0sC0oMBOCF3j5poce0/buFmN1in6ewJbhNxe/CERoCKyEwCTtQHzwYXY7v0+4n/f6gZ512hn7/s+0C3aZOGaU2ddD0M/0BWO/YlvrHWHENAGltURoDC239jieMXnCc+Y0XM/PoMgBhEaL7X4LbtNSOi6a+HFlI7wPpr65YQfFymgf9armHpbHWMdgSePoarpyphRx0gu4fz8+2DUrO5xxf+o2Bnc02rCH/APxqHByos8077cPP1uev+CX2033xc0gKCGj+NsnjXcP+zWtP8VhsrIFSGAr2vkng6doDMGyMnrX63xmuow3htkr3LBx13/h14hb77G/In/X71fqfsft32vlq/d/x3zy6bLGh/2MKrc/+I+rc8XEWLBxa/7yMx9d4/M7B+0F8j2VcGsh0BIHLldJDqb1fOYpp7hP9frX+r9j91Xb+H/4DeFxTpZWbBisAhPvBG+laK12b/64bWr99jee/zfAVGs/4HV/zvS6jz6V6pXel66y9Fr+Vtp/u96v1P2P3Z9r5av1P+2/f9/HmUuwPzDJ4k10X222t/BfmEbxEIPI7vQAAAABJRU5ErkJggg==",document.body.style.backgroundImage='url("'+Draw.PicToDataURL(Draw.PicFromWad("BACKTILE"))+'")',GL.CreateProgram("Fill",["uOrtho"],[["aPosition",gl.FLOAT,2],["aColor",gl.UNSIGNED_BYTE,4,!0]],[]),GL.CreateProgram("Pic",["uOrtho"],[["aPosition",gl.FLOAT,2],["aTexCoord",gl.FLOAT,2]],["tTexture"]),GL.CreateProgram("PicTranslate",["uOrtho","uTop","uBottom"],[["aPosition",gl.FLOAT,2],["aTexCoord",gl.FLOAT,2]],["tTexture","tTrans"])},Draw.Char=function(a,r,t){GL.StreamDrawTexturedQuad(a,r,8,8,.0625*(15&t),.0625*(t>>4),.0625*(1+(15&t)),.0625*(1+(t>>4)))},Draw.Character=function(a,r,t){var e=GL.UseProgram("Pic",!0);GL.Bind(e.tTexture,Draw.char_texture,!0),Draw.Char(a,r,t)},Draw.String=function(a,r,t){var e=GL.UseProgram("Pic",!0);GL.Bind(e.tTexture,Draw.char_texture,!0);for(var n=0;n<t.length;++n)Draw.Char(a,r,t.charCodeAt(n)),a+=8},Draw.StringWhite=function(a,r,t){var e=GL.UseProgram("Pic",!0);GL.Bind(e.tTexture,Draw.char_texture,!0);for(var n=0;n<t.length;++n)Draw.Char(a,r,t.charCodeAt(n)+128),a+=8},Draw.PicFromWad=function(a){var r=W.GetLumpName(a),t={},e=new DataView(r,0,8);return t.width=e.getUint32(0,!0),t.height=e.getUint32(4,!0),t.data=new Uint8Array(r,8,t.width*t.height),t.texnum=GL.LoadPicTexture(t),t},Draw.CachePic=function(a){a="gfx/"+a+".lmp";var r=COM.LoadFile(a);null==r&&Sys.Error("Draw.CachePic: failed to load "+a);var t={},e=new DataView(r,0,8);return t.width=e.getUint32(0,!0),t.height=e.getUint32(4,!0),t.data=new Uint8Array(r,8,t.width*t.height),t.texnum=GL.LoadPicTexture(t),t},Draw.Pic=function(a,r,t){var e=GL.UseProgram("Pic",!0);GL.Bind(e.tTexture,t.texnum,!0),GL.StreamDrawTexturedQuad(a,r,t.width,t.height,0,0,1,1)},Draw.PicTranslate=function(a,r,t,e,n){GL.StreamFlush();var i=GL.UseProgram("PicTranslate");GL.Bind(i.tTexture,t.texnum),GL.Bind(i.tTrans,t.translate);var o=VID.d_8to24table[e],g=1/191.25;gl.uniform3f(i.uTop,(255&o)*g,(o>>8&255)*g,(o>>16)*g),o=VID.d_8to24table[n],gl.uniform3f(i.uBottom,(255&o)*g,(o>>8&255)*g,(o>>16)*g),GL.StreamDrawTexturedQuad(a,r,t.width,t.height,0,0,1,1),GL.StreamFlush()},Draw.ConsoleBackground=function(a){var r=GL.UseProgram("Pic",!0);GL.Bind(r.tTexture,Draw.conback.texnum,!0),GL.StreamDrawTexturedQuad(0,a-VID.height,VID.width,VID.height,0,0,1,1)},Draw.Fill=function(a,r,t,e,n){GL.UseProgram("Fill",!0);var i=VID.d_8to24table[n];GL.StreamDrawColoredQuad(a,r,t,e,255&i,i>>8&255,i>>16,255)},Draw.FadeScreen=function(){GL.UseProgram("Fill",!0);GL.StreamDrawColoredQuad(0,0,VID.width,VID.height,0,0,0,204)},Draw.BeginDisc=function(){null!=Draw.loadingElem&&(Draw.loadingElem.style.left=(VID.width-Draw.loading.width>>1)+"px",Draw.loadingElem.style.top=(VID.height-Draw.loading.height>>1)+"px",Draw.loadingElem.style.display="inline-block")},Draw.EndDisc=function(){null!=Draw.loadingElem&&(Draw.loadingElem.style.display="none")},Draw.PicToDataURL=function(a){var r=document.createElement("canvas");r.width=a.width,r.height=a.height;var t,e=r.getContext("2d"),n=e.createImageData(a.width,a.height),i=new ArrayBuffer(n.data.length),o=new Uint32Array(i);for(t=0;t<a.data.length;++t)o[t]=COM.LittleLong(VID.d_8to24table[a.data[t]]+4278190080);return n.data.set(new Uint8Array(i)),e.putImageData(n,0,0),r.toDataURL()};

			// ED.js
			ED={},ED.ClearEdict=function(e){var t;for(t=0;t<PR.entityfields;++t)e.v_int[t]=0;e.free=!1},ED.Alloc=function(){var e,t;for(e=SV.svs.maxclients+1;e<SV.server.num_edicts;++e)if(!0===(t=SV.server.edicts[e]).free&&(t.freetime<2||SV.server.time-t.freetime>.5))return ED.ClearEdict(t),t;return e===Def.max_edicts&&Sys.Error("ED.Alloc: no free edicts"),t=SV.server.edicts[SV.server.num_edicts++],ED.ClearEdict(t),t},ED.Free=function(e){SV.UnlinkEdict(e),e.free=!0,e.v_int[PR.entvars.model]=0,e.v_float[PR.entvars.takedamage]=0,e.v_float[PR.entvars.modelindex]=0,e.v_float[PR.entvars.colormap]=0,e.v_float[PR.entvars.skin]=0,e.v_float[PR.entvars.frame]=0,ED.SetVector(e,PR.entvars.origin,Vec.origin),ED.SetVector(e,PR.entvars.angles,Vec.origin),e.v_float[PR.entvars.nextthink]=-1,e.v_float[PR.entvars.solid]=0,e.freetime=SV.server.time},ED.GlobalAtOfs=function(e){var t,n;for(t=0;t<PR.globaldefs.length;++t)if((n=PR.globaldefs[t]).ofs===e)return n},ED.FieldAtOfs=function(e){var t,n;for(t=0;t<PR.fielddefs.length;++t)if((n=PR.fielddefs[t]).ofs===e)return n},ED.FindField=function(e){var t,n;for(n=0;n<PR.fielddefs.length;++n)if(t=PR.fielddefs[n],PR.GetString(t.name)===e)return t},ED.FindGlobal=function(e){var t,n;for(n=0;n<PR.globaldefs.length;++n)if(t=PR.globaldefs[n],PR.GetString(t.name)===e)return t},ED.FindFunction=function(e){var t;for(t=0;t<PR.functions.length;++t)if(PR.GetString(PR.functions[t].name)===e)return t},ED.Print=function(e){var t,n,r,i;if(!0!==e.free){for(Con.Print("\nEDICT "+e.num+":\n"),t=1;t<PR.fielddefs.length;++t)if(n=PR.fielddefs[t],95!==(r=PR.GetString(n.name)).charCodeAt(r.length-2)){if(i=n.ofs,0===e.v_int[i]){if(3!=(32767&n.type))continue;if(0===e.v_int[i+1]&&0===e.v_int[i+2])continue}for(;r.length<=14;)r+=" ";Con.Print(r+PR.ValueString(n.type,e.v,i)+"\n")}}else Con.Print("FREE\n")},ED.PrintEdicts=function(){var e;if(!0===SV.server.active)for(Con.Print(SV.server.num_edicts+" entities\n"),e=0;e<SV.server.num_edicts;++e)ED.Print(SV.server.edicts[e])},ED.PrintEdict_f=function(){if(!0===SV.server.active){var e=Q.atoi(Cmd.argv[1]);e>=0&&e<SV.server.num_edicts&&ED.Print(SV.server.edicts[e])}},ED.Count=function(){if(!0===SV.server.active){var e,t,n=0,r=0,i=0,o=0;for(e=0;e<SV.server.num_edicts;++e)!0!==(t=SV.server.edicts[e]).free&&(++n,0!==t.v_float[PR.entvars.solid]&&++i,0!==t.v_int[PR.entvars.model]&&++r,t.v_float[PR.entvars.movetype]===SV.movetype.step&&++o);var a=SV.server.num_edicts;Con.Print("num_edicts:"+(a<=9?"  ":a<=99?" ":"")+a+"\n"),Con.Print("active    :"+(n<=9?"  ":n<=99?" ":"")+n+"\n"),Con.Print("view      :"+(r<=9?"  ":r<=99?" ":"")+r+"\n"),Con.Print("touch     :"+(i<=9?"  ":i<=99?" ":"")+i+"\n"),Con.Print("step      :"+(o<=9?"  ":o<=99?" ":"")+o+"\n")}},ED.ParseGlobals=function(e){for(var t,n;;){if(e=COM.Parse(e),125===COM.token.charCodeAt(0))return;null==e&&Sys.Error("ED.ParseGlobals: EOF without closing brace"),t=COM.token,null==(e=COM.Parse(e))&&Sys.Error("ED.ParseGlobals: EOF without closing brace"),125===COM.token.charCodeAt(0)&&Sys.Error("ED.ParseGlobals: closing brace without data"),null!=(n=ED.FindGlobal(t))?!0!==ED.ParseEpair(PR.globals,n,COM.token)&&Host.Error("ED.ParseGlobals: parse error"):Con.Print("'"+t+"' is not a global\n")}},ED.NewString=function(e){var t,n,r=[];for(t=0;t<e.length;++t)92===(n=e.charCodeAt(t))&&t<e.length-1?(++t,r[r.length]=110===e.charCodeAt(t)?"\n":"\\"):r[r.length]=String.fromCharCode(n);return PR.NewString(r.join(""),e.length+1)},ED.ParseEpair=function(e,t,n){var r,i,o=new Float32Array(e),a=new Int32Array(e);switch(32767&t.type){case PR.etype.ev_string:return a[t.ofs]=ED.NewString(n),!0;case PR.etype.ev_float:return o[t.ofs]=Q.atof(n),!0;case PR.etype.ev_vector:return i=n.split(" "),o[t.ofs]=Q.atof(i[0]),o[t.ofs+1]=Q.atof(i[1]),o[t.ofs+2]=Q.atof(i[2]),!0;case PR.etype.ev_entity:return a[t.ofs]=Q.atoi(n),!0;case PR.etype.ev_field:return null==(r=ED.FindField(n))?void Con.Print("Can't find field "+n+"\n"):(a[t.ofs]=r.ofs,!0);case PR.etype.ev_function:if(null==(r=ED.FindFunction(n)))return void Con.Print("Can't find function "+n+"\n");a[t.ofs]=r}return!0},ED.ParseEdict=function(e,t){var n,r,i,o,a,s;if(t!==SV.server.edicts[0])for(n=0;n<PR.entityfields;++n)t.v_int[n]=0;for(;e=COM.Parse(e),125!==COM.token.charCodeAt(0);){for(null==e&&Sys.Error("ED.ParseEdict: EOF without closing brace"),"angle"===COM.token?(COM.token="angles",i=!0):(i=!1,"light"===COM.token&&(COM.token="light_lev")),a=COM.token.length;a>0&&32===COM.token.charCodeAt(a-1);--a);o=COM.token.substring(0,a),null==(e=COM.Parse(e))&&Sys.Error("ED.ParseEdict: EOF without closing brace"),125===COM.token.charCodeAt(0)&&Sys.Error("ED.ParseEdict: closing brace without data"),r=!0,95!==o.charCodeAt(0)&&(null!=(s=ED.FindField(o))?(1==i&&(COM.token="0 "+COM.token+" 0"),!0!==ED.ParseEpair(t.v,s,COM.token)&&Host.Error("ED.ParseEdict: parse error")):Con.Print("'"+o+"' is not a field\n"))}return!0!==r&&(t.free=!0),e},ED.LoadFromFile=function(e){var t,n,r,i=0;for(PR.globals_float[PR.globalvars.time]=SV.server.time;null!=(e=COM.Parse(e));){if(123!==COM.token.charCodeAt(0)&&Sys.Error("ED.LoadFromFile: found "+COM.token+" when expecting {"),t=null==t?SV.server.edicts[0]:ED.Alloc(),e=ED.ParseEdict(e,t),n=t.v_float[PR.entvars.spawnflags]>>0,0!==Host.deathmatch.value){if(0!=(2048&n)){ED.Free(t),++i;continue}}else if(0===Host.current_skill&&0!=(256&n)||1===Host.current_skill&&0!=(512&n)||Host.current_skill>=2&&0!=(1024&n)){ED.Free(t),++i;continue}0!==t.v_int[PR.entvars.classname]?null!=(r=ED.FindFunction(PR.GetString(t.v_int[PR.entvars.classname])))?(PR.globals_int[PR.globalvars.self]=t.num,PR.ExecuteProgram(r)):(Con.Print("No spawn function for:\n"),ED.Print(t),ED.Free(t)):(Con.Print("No classname for:\n"),ED.Print(t),ED.Free(t))}Con.DPrint(i+" entities inhibited\n")},ED.Vector=function(e,t){return[e.v_float[t],e.v_float[t+1],e.v_float[t+2]]},ED.SetVector=function(e,t,n){e.v_float[t]=n[0],e.v_float[t+1]=n[1],e.v_float[t+2]=n[2]};

			// GL.js
			GL={},GL.textures=[],GL.currenttextures=[],GL.programs=[],GL.Bind=function(r,e,t){GL.currenttextures[r]!==e&&(!0===t&&GL.StreamFlush(),GL.activetexture!==r&&(GL.activetexture=r,gl.activeTexture(gl.TEXTURE0+r)),GL.currenttextures[r]=e,gl.bindTexture(gl.TEXTURE_2D,e))},GL.TextureMode_f=function(){var r;if(Cmd.argv.length<=1){for(r=0;r<GL.modes.length;++r)if(GL.filter_min===GL.modes[r][1])return void Con.Print(GL.modes[r][0]+"\n");Con.Print("current filter is unknown???\n")}else{var e=Cmd.argv[1].toUpperCase();for(r=0;r<GL.modes.length&&GL.modes[r][0]!==e;++r);if(r!==GL.modes.length)for(GL.filter_min=GL.modes[r][1],GL.filter_max=GL.modes[r][2],r=0;r<GL.textures.length;++r)GL.Bind(0,GL.textures[r].texnum),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max);else Con.Print("bad filter name\n")}},GL.ortho=[0,0,0,0,0,0,0,0,0,0,1e-5,0,-1,1,0,1],GL.Set2D=function(){var r,e;for(gl.viewport(0,0,VID.width*SCR.devicePixelRatio>>0,VID.height*SCR.devicePixelRatio>>0),GL.UnbindProgram(),r=0;r<GL.programs.length;++r)null!=(e=GL.programs[r]).uOrtho&&(gl.useProgram(e.program),gl.uniformMatrix4fv(e.uOrtho,!1,GL.ortho));gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND)},GL.ResampleTexture=function(r,e,t,a,i){var o,l,n,L=new ArrayBuffer(a*i),g=new Uint8Array(L),m=e/a,G=t/i,s=0;for(l=0;l<i;++l){for(o=Math.floor(l*G)*e,n=0;n<a;++n)g[s+n]=r[o+Math.floor(n*m)];s+=a}return g},GL.Upload=function(r,e,t){var a=e,i=t;0==(e&e-1)&&0==(t&t-1)||(--a,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,++a,--i,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,++i),a>GL.maxtexturesize&&(a=GL.maxtexturesize),i>GL.maxtexturesize&&(i=GL.maxtexturesize),a===e&&i===t||(r=GL.ResampleTexture(r,e,t,a,i));var o,l=new ArrayBuffer(a*i<<2),n=new Uint32Array(l);for(o=a*i-1;o>=0;--o)n[o]=COM.LittleLong(VID.d_8to24table[r[o]]+4278190080),r[o]>=224&&(n[o]&=16777215);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,i,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(l)),gl.generateMipmap(gl.TEXTURE_2D),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max)},GL.LoadTexture=function(r,e,t,a){var i,o;if(0!==r.length)for(o=0;o<GL.textures.length;++o)if((i=GL.textures[o]).identifier===r)return e===i.width&&t===i.height||Sys.Error("GL.LoadTexture: cache mismatch"),i;var l=e,n=t;return 0==(e&e-1)&&0==(t&t-1)||(--l,l|=l>>1,l|=l>>2,l|=l>>4,l|=l>>8,l|=l>>16,++l,--n,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,++n),l>GL.maxtexturesize&&(l=GL.maxtexturesize),n>GL.maxtexturesize&&(n=GL.maxtexturesize),0===(l>>=GL.picmip.value)&&(l=1),0===(n>>=GL.picmip.value)&&(n=1),l===e&&n===t||(a=GL.ResampleTexture(a,e,t,l,n)),i={texnum:gl.createTexture(),identifier:r,width:e,height:t},GL.Bind(0,i.texnum),GL.Upload(a,l,n),GL.textures[GL.textures.length]=i,i},GL.LoadPicTexture=function(r){var e=r.data,t=r.width,a=r.height;0==(r.width&r.width-1)&&0==(r.height&r.height-1)||(--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t,--a,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,++a),t>GL.maxtexturesize&&(t=GL.maxtexturesize),a>GL.maxtexturesize&&(a=GL.maxtexturesize),t===r.width&&a===r.height||(e=GL.ResampleTexture(e,r.width,r.height,t,a));var i=gl.createTexture();GL.Bind(0,i);var o,l=new ArrayBuffer(t*a<<2),n=new Uint32Array(l);for(o=t*a-1;o>=0;--o)255!==e[o]&&(n[o]=COM.LittleLong(VID.d_8to24table[e[o]]+4278190080));return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(l)),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),i},GL.CreateProgram=function(r,e,t,a){var i=gl.createProgram(),o={identifier:r,program:i,attribs:[]},l=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(l,document.getElementById("vsh"+r).text),gl.compileShader(l),!0!==gl.getShaderParameter(l,gl.COMPILE_STATUS)&&Sys.Error("Error compiling shader: "+gl.getShaderInfoLog(l));var n=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(n,document.getElementById("fsh"+r).text),gl.compileShader(n),!0!==gl.getShaderParameter(n,gl.COMPILE_STATUS)&&Sys.Error("Error compiling shader: "+gl.getShaderInfoLog(n)),gl.attachShader(i,l),gl.attachShader(i,n),gl.linkProgram(i),!0!==gl.getProgramParameter(i,gl.LINK_STATUS)&&Sys.Error("Error linking program: "+gl.getProgramInfoLog(i)),gl.useProgram(i);for(var L=0;L<e.length;++L)o[e[L]]=gl.getUniformLocation(i,e[L]);o.vertexSize=0,o.attribBits=0;for(L=0;L<t.length;++L){var g=t[L],m={name:g[0],location:gl.getAttribLocation(i,g[0]),type:g[1],components:g[2],normalized:!0===g[3],offset:o.vertexSize};o.attribs[L]=m,o[m.name]=m,m.type===gl.FLOAT?o.vertexSize+=4*m.components:m.type===gl.BYTE||m.type===gl.UNSIGNED_BYTE?o.vertexSize+=4:Sys.Error("Unknown vertex attribute type"),o.attribBits|=1<<m.location}for(L=0;L<a.length;++L)o[a[L]]=L,gl.uniform1i(gl.getUniformLocation(i,a[L]),L);return GL.programs[GL.programs.length]=o,o},GL.UseProgram=function(r,e){var t=GL.currentProgram;if(null!=t){if(t.identifier===r)return t;!0===e&&GL.StreamFlush()}for(var a=null,i=0;i<GL.programs.length;++i)if(GL.programs[i].identifier===r){a=GL.programs[i];break}if(null==a)return null;var o=a.attribBits,l=0;null!=t&&(o&=~t.attribBits,l=t.attribBits&~a.attribBits),GL.currentProgram=a,gl.useProgram(a.program);for(var n=0;0!==o||0!==l;++n){var L=1<<n;0!=(o&L)?gl.enableVertexAttribArray(n):0!=(l&L)&&gl.disableVertexAttribArray(n),o&=~L,l&=~L}return a},GL.UnbindProgram=function(){if(null!=GL.currentProgram){var r;for(GL.StreamFlush(),r=0;r<GL.currentProgram.attribs.length;++r)gl.disableVertexAttribArray(GL.currentProgram.attribs[r].location);GL.currentProgram=null}},GL.identity=[1,0,0,0,1,0,0,0,1],GL.RotationMatrix=function(r,e,t){r*=Math.PI/-180,e*=Math.PI/180,t*=Math.PI/180;var a=Math.sin(r),i=Math.cos(r),o=Math.sin(e),l=Math.cos(e),n=Math.sin(t),L=Math.cos(t);return[l*i,o*i,-a,-o*L+l*a*n,l*L+o*a*n,i*n,-o*-n+l*a*L,l*-n+o*a*L,i*L]},GL.StreamFlush=function(){if(0!==GL.streamArrayVertexCount){var r=GL.currentProgram;if(null!=r){gl.bindBuffer(gl.ARRAY_BUFFER,GL.streamBuffer),gl.bufferSubData(gl.ARRAY_BUFFER,GL.streamBufferPosition,GL.streamArrayBytes.subarray(0,GL.streamArrayPosition));for(var e=r.attribs,t=0;t<e.length;++t){var a=e[t];gl.vertexAttribPointer(a.location,a.components,a.type,a.normalized,r.vertexSize,GL.streamBufferPosition+a.offset)}gl.drawArrays(gl.TRIANGLES,0,GL.streamArrayVertexCount),GL.streamBufferPosition+=GL.streamArrayPosition}GL.streamArrayPosition=0,GL.streamArrayVertexCount=0}},GL.StreamGetSpace=function(r){var e=GL.currentProgram;if(null!=e){var t=r*e.vertexSize;GL.streamBufferPosition+GL.streamArrayPosition+t>GL.streamArray.byteLength&&(GL.StreamFlush(),GL.streamBufferPosition=0),GL.streamArrayVertexCount+=r}},GL.StreamWriteFloat=function(r){GL.streamArrayView.setFloat32(GL.streamArrayPosition,r,!0),GL.streamArrayPosition+=4},GL.StreamWriteFloat2=function(r,e){var t=GL.streamArrayView,a=GL.streamArrayPosition;t.setFloat32(a,r,!0),t.setFloat32(a+4,e,!0),GL.streamArrayPosition+=8},GL.StreamWriteFloat3=function(r,e,t){var a=GL.streamArrayView,i=GL.streamArrayPosition;a.setFloat32(i,r,!0),a.setFloat32(i+4,e,!0),a.setFloat32(i+8,t,!0),GL.streamArrayPosition+=12},GL.StreamWriteFloat4=function(r,e,t,a){var i=GL.streamArrayView,o=GL.streamArrayPosition;i.setFloat32(o,r,!0),i.setFloat32(o+4,e,!0),i.setFloat32(o+8,t,!0),i.setFloat32(o+12,a,!0),GL.streamArrayPosition+=16},GL.StreamWriteUByte4=function(r,e,t,a){var i=GL.streamArrayView,o=GL.streamArrayPosition;i.setUint8(o,r),i.setUint8(o+1,e),i.setUint8(o+2,t),i.setUint8(o+3,a),GL.streamArrayPosition+=4},GL.StreamDrawTexturedQuad=function(r,e,t,a,i,o,l,n){var L=r+t,g=e+a;GL.StreamGetSpace(6),GL.StreamWriteFloat4(r,e,i,o),GL.StreamWriteFloat4(r,g,i,n),GL.StreamWriteFloat4(L,e,l,o),GL.StreamWriteFloat4(L,e,l,o),GL.StreamWriteFloat4(r,g,i,n),GL.StreamWriteFloat4(L,g,l,n)},GL.StreamDrawColoredQuad=function(r,e,t,a,i,o,l,n){var L=r+t,g=e+a;GL.StreamGetSpace(6),GL.StreamWriteFloat2(r,e),GL.StreamWriteUByte4(i,o,l,n),GL.StreamWriteFloat2(r,g),GL.StreamWriteUByte4(i,o,l,n),GL.StreamWriteFloat2(L,e),GL.StreamWriteUByte4(i,o,l,n),GL.StreamWriteFloat2(L,e),GL.StreamWriteUByte4(i,o,l,n),GL.StreamWriteFloat2(r,g),GL.StreamWriteUByte4(i,o,l,n),GL.StreamWriteFloat2(L,g),GL.StreamWriteUByte4(i,o,l,n)},GL.Init=function(){VID.mainwindow=document.getElementById("mainwindow");try{gl=VID.mainwindow.getContext("webgl")||VID.mainwindow.getContext("experimental-webgl")}catch(r){}null==gl&&Sys.Error("Unable to initialize WebGL. Your browser may not support it."),GL.maxtexturesize=gl.getParameter(gl.MAX_TEXTURE_SIZE),gl.clearColor(0,0,0,0),gl.cullFace(gl.FRONT),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE),GL.modes=[["GL_NEAREST",gl.NEAREST,gl.NEAREST],["GL_LINEAR",gl.LINEAR,gl.LINEAR],["GL_NEAREST_MIPMAP_NEAREST",gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST],["GL_LINEAR_MIPMAP_NEAREST",gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR],["GL_NEAREST_MIPMAP_LINEAR",gl.NEAREST_MIPMAP_LINEAR,gl.NEAREST],["GL_LINEAR_MIPMAP_LINEAR",gl.LINEAR_MIPMAP_LINEAR,gl.LINEAR]],GL.filter_min=gl.LINEAR_MIPMAP_NEAREST,GL.filter_max=gl.LINEAR,GL.picmip=Cvar.RegisterVariable("gl_picmip","0"),Cmd.AddCommand("gl_texturemode",GL.TextureMode_f),GL.streamArray=new ArrayBuffer(8192),GL.streamArrayBytes=new Uint8Array(GL.streamArray),GL.streamArrayPosition=0,GL.streamArrayVertexCount=0,GL.streamArrayView=new DataView(GL.streamArray),GL.streamBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,GL.streamBuffer),gl.bufferData(gl.ARRAY_BUFFER,GL.streamArray.byteLength,gl.DYNAMIC_DRAW),GL.streamBufferPosition=0,VID.mainwindow.style.display="inline-block"};

			// Host.js
			Host={},Host.framecount=0,Host.EndGame=function(e){throw Con.DPrint("Host.EndGame: "+e+"\n"),-1!==CL.cls.demonum?CL.NextDemo():CL.Disconnect(),"Host.abortserver"},Host.Error=function(e){throw!0===Host.inerror&&Sys.Error("Host.Error: recursively entered"),Host.inerror=!0,SCR.EndLoadingPlaque(),Con.Print("Host.Error: "+e+"\n"),!0===SV.server.active&&Host.ShutdownServer(),CL.Disconnect(),CL.cls.demonum=-1,Host.inerror=!1,new Error("Host.abortserver")},Host.FindMaxClients=function(){SV.svs.maxclients=SV.svs.maxclientslimit=1,CL.cls.state=CL.active.disconnected,SV.svs.clients=[{num:0,message:{data:new ArrayBuffer(8e3),cursize:0,allowoverflow:!0},colors:0,old_frags:0}],Cvar.SetValue("deathmatch",0)},Host.InitLocal=function(){Host.InitCommands(),Host.framerate=Cvar.RegisterVariable("host_framerate","0"),Host.speeds=Cvar.RegisterVariable("host_speeds","0"),Host.ticrate=Cvar.RegisterVariable("sys_ticrate","0.05"),Host.serverprofile=Cvar.RegisterVariable("serverprofile","0"),Host.fraglimit=Cvar.RegisterVariable("fraglimit","0",!1,!0),Host.timelimit=Cvar.RegisterVariable("timelimit","0",!1,!0),Host.teamplay=Cvar.RegisterVariable("teamplay","0",!1,!0),Host.samelevel=Cvar.RegisterVariable("samelevel","0"),Host.noexit=Cvar.RegisterVariable("noexit","0",!1,!0),Host.skill=Cvar.RegisterVariable("skill","1"),Host.developer=Cvar.RegisterVariable("developer","0"),Host.deathmatch=Cvar.RegisterVariable("deathmatch","0"),Host.coop=Cvar.RegisterVariable("coop","0"),Host.pausable=Cvar.RegisterVariable("pausable","1"),Host.temp1=Cvar.RegisterVariable("temp1","0"),Host.FindMaxClients()},Host.ClientPrint=function(e){MSG.WriteByte(Host.client.message,Protocol.svc.print),MSG.WriteString(Host.client.message,e)},Host.BroadcastPrint=function(e){var t,n;for(t=0;t<SV.svs.maxclients;++t)!0===(n=SV.svs.clients[t]).active&&!0===n.spawned&&(MSG.WriteByte(n.message,Protocol.svc.print),MSG.WriteString(n.message,e))},Host.DropClient=function(e){var t=Host.client;if(!0!==e){if(!0===NET.CanSendMessage(t.netconnection)&&(MSG.WriteByte(t.message,Protocol.svc.disconnect),NET.SendMessage(t.netconnection,t.message)),null!=t.edict&&!0===t.spawned){var n=PR.globals_int[PR.globalvars.self];PR.globals_int[PR.globalvars.self]=t.edict.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientDisconnect]),PR.globals_int[PR.globalvars.self]=n}Sys.Print("Client "+SV.GetClientName(t)+" removed\n")}NET.Close(t.netconnection),t.netconnection=null,t.active=!1,SV.SetClientName(t,""),t.old_frags=-999999,--NET.activeconnections;var a,o=t.num;for(a=0;a<SV.svs.maxclients;++a)!0===(t=SV.svs.clients[a]).active&&(MSG.WriteByte(t.message,Protocol.svc.updatename),MSG.WriteByte(t.message,o),MSG.WriteByte(t.message,0),MSG.WriteByte(t.message,Protocol.svc.updatefrags),MSG.WriteByte(t.message,o),MSG.WriteShort(t.message,0),MSG.WriteByte(t.message,Protocol.svc.updatecolors),MSG.WriteByte(t.message,o),MSG.WriteByte(t.message,0))},Host.ShutdownServer=function(e){if(!0===SV.server.active){SV.server.active=!1,CL.cls.state===CL.active.connected&&CL.Disconnect();var t,n,a=Sys.FloatTime();do{for(t=0,n=0;n<SV.svs.maxclients;++n)Host.client=SV.svs.clients[n],!0===Host.client.active&&0!==Host.client.message.cursize&&(!0!==NET.CanSendMessage(Host.client.netconnection)?(NET.GetMessage(Host.client.netconnection),++t):(NET.SendMessage(Host.client.netconnection,Host.client.message),Host.client.message.cursize=0));if(Sys.FloatTime()-a>3)break}while(0!==t);var o={data:new ArrayBuffer(4),cursize:1};for(new Uint8Array(o.data)[0]=Protocol.svc.disconnect,0!==(t=NET.SendToAll(o))&&Con.Print("Host.ShutdownServer: NET.SendToAll failed for "+t+" clients\n"),n=0;n<SV.svs.maxclients;++n)Host.client=SV.svs.clients[n],!0===Host.client.active&&Host.DropClient(e)}},Host.WriteConfiguration=function(){COM.WriteTextFile("config.cfg",Key.WriteBindings()+Cvar.WriteVariables())},Host.ServerFrame=function(){PR.globals_float[PR.globalvars.frametime]=Host.frametime,SV.server.datagram.cursize=0,SV.CheckForNewClients(),SV.RunClients(),!0!==SV.server.paused&&(SV.svs.maxclients>=2||Key.dest.value===Key.dest.game)&&SV.Physics(),SV.SendClientMessages()},Host.time3=0,Host._Frame=function(){if(Math.random(),Host.realtime=Sys.FloatTime(),Host.frametime=Host.realtime-Host.oldrealtime,Host.oldrealtime=Host.realtime,Host.framerate.value>0?Host.frametime=Host.framerate.value:Host.frametime>.1?Host.frametime=.1:Host.frametime<.001&&(Host.frametime=.001),CL.cls.state===CL.active.connecting)return NET.CheckForResend(),void SCR.UpdateScreen();var e,t,n,a,o,s;Cmd.Execute(),CL.SendCmd(),!0===SV.server.active&&Host.ServerFrame(),CL.cls.state===CL.active.connected&&CL.ReadFromServer(),0!==Host.speeds.value&&(e=Sys.FloatTime()),SCR.UpdateScreen(),0!==Host.speeds.value&&(t=Sys.FloatTime()),4===CL.cls.signon?(S.Update(R.refdef.vieworg,R.vpn,R.vright,R.vup),CL.DecayLights()):S.Update(Vec.origin,Vec.origin,Vec.origin,Vec.origin),CDAudio.Update(),0!==Host.speeds.value&&(n=1e3*(e-Host.time3),Host.time3=Sys.FloatTime(),a=1e3*(t-e),o=1e3*(Host.time3-t),s=Math.floor(n+a+o),Con.Print((s<=99?s<=9?"  ":" ":"")+s+" tot "+(n<100?n<10?"  ":" ":"")+Math.floor(n)+" server "+(a<100?a<10?"  ":" ":"")+Math.floor(a)+" gfx "+(o<100?o<10?"  ":" ":"")+Math.floor(o)+" snd\n")),!0===Host.startdemos&&(CL.NextDemo(),Host.startdemos=!1),++Host.framecount},Host.timetotal=0,Host.timecount=0,Host.Frame=function(){if(0!==Host.serverprofile.value){var e=Sys.FloatTime();if(Host._Frame(),Host.timetotal+=Sys.FloatTime()-e,!(++Host.timecount<=999)){var t=1e3*Host.timetotal/Host.timecount>>0;Host.timecount=0,Host.timetotal=0;var n,a=0;for(n=0;n<SV.svs.maxclients;++n)!0===SV.svs.clients[n].active&&++a;Con.Print("serverprofile: "+(a<=9?" ":"")+a+" clients "+(t<=9?" ":"")+t+" msec\n")}}else Host._Frame()},Host.Init=function(){Host.oldrealtime=Sys.FloatTime(),Cmd.Init(),V.Init(),Chase.Init(),COM.Init(),Host.InitLocal(),W.LoadWadFile("gfx.wad"),Key.Init(),Con.Init(),PR.Init(),Mod.Init(),NET.Init(),SV.Init(),Con.Print(Def.timedate),VID.Init(),Draw.Init(),SCR.Init(),R.Init(),S.Init(),M.Init(),CDAudio.Init(),Sbar.Init(),CL.Init(),IN.Init(),Cmd.text="exec quake.rc\n"+Cmd.text,Host.initialized=!0,Sys.Print("========Quake Initialized=========\n");try{if(null!=parent.saveGameToUpload){var e=COM.DefaultExtension("s0",".sav");COM.WriteTextFile(e,parent.saveGameToUpload)}}catch(e){}},Host.Shutdown=function(){!0!==Host.isdown?(Host.isdown=!0,Host.WriteConfiguration(),CDAudio.Stop(),NET.Shutdown(),S.StopAllSounds(),IN.Shutdown()):Sys.Print("recursive shutdown\n")},Host.Quit_f=function(){Key.dest.value===Key.dest.console?Sys.Quit():M.Menu_Quit_f()},Host.Status_f=function(){var e,t,n,a,o,s,r,i;if(!0!==Cmd.client){if(!0!==SV.server.active)return void Cmd.ForwardToServer();e=Con.Print}else e=SV.ClientPrint;for(e("host:    "+NET.hostname.string+"\n"),e("version: 1.09\n"),e("map:     "+PR.GetString(PR.globals_int[PR.globalvars.mapname])+"\n"),e("players: "+NET.activeconnections+" active ("+SV.svs.maxclients+" max)\n\n"),t=0;t<SV.svs.maxclients;++t)if(!0===(n=SV.svs.clients[t]).active){for(1===(o=n.edict.v_float[PR.entvars.frags].toFixed(0)).length?o="  "+o:2===o.length&&(o=" "+o),0!==(r=(i=NET.time-n.netconnection.connecttime>>0)/60>>0)?(i-=60*r,0!==(s=r/60>>0)&&(r-=60*s)):s=0,a="#"+(t+1)+" ",t<=8&&(a+=" "),a+=SV.GetClientName(n);a.length<=21;)a+=" ";a+=o+"  ",s<=9&&(a+=" "),a+=s+":",r<=9&&(a+="0"),a+=r+":",i<=9&&(a+="0"),e(a+i+"\n"),e("   "+n.netconnection.address+"\n")}},Host.God_f=function(){!0===Cmd.client?0===PR.globals_float[PR.globalvars.deathmatch]&&(SV.player.v_float[PR.entvars.flags]^=SV.fl.godmode,0==(SV.player.v_float[PR.entvars.flags]&SV.fl.godmode)?Host.ClientPrint("godmode OFF\n"):Host.ClientPrint("godmode ON\n")):Cmd.ForwardToServer()},Host.Notarget_f=function(){!0===Cmd.client?0===PR.globals_float[PR.globalvars.deathmatch]&&(SV.player.v_float[PR.entvars.flags]^=SV.fl.notarget,0==(SV.player.v_float[PR.entvars.flags]&SV.fl.notarget)?Host.ClientPrint("notarget OFF\n"):Host.ClientPrint("notarget ON\n")):Cmd.ForwardToServer()},Host.Noclip_f=function(){if(!0===Cmd.client){if(0===PR.globals_float[PR.globalvars.deathmatch]){if(SV.player.v_float[PR.entvars.movetype]!==SV.movetype.noclip)return Host.noclip_anglehack=!0,SV.player.v_float[PR.entvars.movetype]=SV.movetype.noclip,void Host.ClientPrint("noclip ON\n");Host.noclip_anglehack=!1,SV.player.v_float[PR.entvars.movetype]=SV.movetype.walk,Host.ClientPrint("noclip OFF\n")}}else Cmd.ForwardToServer()},Host.Fly_f=function(){if(!0===Cmd.client){if(0===PR.globals_float[PR.globalvars.deathmatch]){if(SV.player.v_float[PR.entvars.movetype]!==SV.movetype.fly)return SV.player.v_float[PR.entvars.movetype]=SV.movetype.fly,void Host.ClientPrint("flymode ON\n");SV.player.v_float[PR.entvars.movetype]=SV.movetype.walk,Host.ClientPrint("flymode OFF\n")}}else Cmd.ForwardToServer()},Host.Ping_f=function(){var e,t,n,a;if(!0===Cmd.client){for(Host.ClientPrint("Client ping times:\n"),e=0;e<SV.svs.maxclients;++e)if(!0===(t=SV.svs.clients[e]).active){for(n=0,a=0;a<=15;++a)n+=t.ping_times[a];1===(n=(62.5*n).toFixed(0)).length?n="   "+n:2===n.length?n="  "+n:3===n.length&&(n=" "+n),Host.ClientPrint(n+" "+SV.GetClientName(t)+"\n")}}else Cmd.ForwardToServer()},Host.Map_f=function(){if(Cmd.argv.length<=1)Con.Print("USAGE: map <map>\n");else if(!0!==Cmd.client&&(CL.cls.demonum=-1,CL.Disconnect(),Host.ShutdownServer(),Key.dest.value=Key.dest.game,SCR.BeginLoadingPlaque(),SV.svs.serverflags=0,SV.SpawnServer(Cmd.argv[1]),!0===SV.server.active)){var e;for(CL.cls.spawnparms="",e=2;e<Cmd.argv.length;++e)CL.cls.spawnparms+=Cmd.argv[e]+" ";Cmd.ExecuteString("connect local")}},Host.Changelevel_f=function(){2===Cmd.argv.length?!0===SV.server.active&&!0!==CL.cls.demoplayback?(SV.SaveSpawnparms(),SV.SpawnServer(Cmd.argv[1])):Con.Print("Only the server may changelevel\n"):Con.Print("changelevel <levelname> : continue game on a new level\n")},Host.Restart_f=function(){!0!==CL.cls.demoplayback&&!0===SV.server.active&&!0!==Cmd.client&&SV.SpawnServer(PR.GetString(PR.globals_int[PR.globalvars.mapname]))},Host.Reconnect_f=function(){SCR.BeginLoadingPlaque(),CL.cls.signon=0},Host.Connect_f=function(){CL.cls.demonum=-1,!0===CL.cls.demoplayback&&(CL.StopPlayback(),CL.Disconnect()),CL.EstablishConnection(Cmd.argv[1]),CL.cls.signon=0},Host.SavegameComment=function(){var e,t=CL.state.levelname.replace(/\s/gm,"_");for(e=CL.state.levelname.length;e<=21;++e)t+="_";t+="kills:";var n=CL.state.stats[Def.stat.monsters].toString();return 2===n.length?t+="_":1===n.length&&(t+="__"),t+=n+"/",2===(n=CL.state.stats[Def.stat.totalmonsters].toString()).length?t+="_":1===n.length&&(t+="__"),(t+=n)+"____"},Host.Savegame_f=function(){if(!0!==Cmd.client)if(!0===SV.server.active)if(0===CL.state.intermission)if(1===SV.svs.maxclients)if(2===Cmd.argv.length)if(-1===Cmd.argv[1].indexOf("..")){var e=SV.svs.clients[0];if(!0===e.active&&e.edict.v_float[PR.entvars.health]<=0)Con.Print("Can't savegame with a dead player\n");else{var t,n,a,o,s,r,i,l=["5\n"+Host.SavegameComment()+"\n"];for(t=0;t<=15;++t)l[l.length]=e.spawn_parms[t].toFixed(6)+"\n";for(l[l.length]=Host.current_skill+"\n"+PR.GetString(PR.globals_int[PR.globalvars.mapname])+"\n"+SV.server.time.toFixed(6)+"\n",t=0;t<=63;++t)0!==SV.server.lightstyles[t].length?l[l.length]=SV.server.lightstyles[t]+"\n":l[l.length]="m\n";for(l[l.length]="{\n",t=0;t<PR.globaldefs.length;++t)0!=(32768&(a=(n=PR.globaldefs[t]).type))&&((a&=32767)!==PR.etype.ev_string&&a!==PR.etype.ev_float&&a!==PR.etype.entity||(l[l.length]='"'+PR.GetString(n.name)+'" "'+PR.UglyValueString(a,PR.globals,n.ofs)+'"\n'));for(l[l.length]="}\n",t=0;t<SV.server.num_edicts;++t)if(!0!==(o=SV.server.edicts[t]).free){for(l[l.length]="{\n",s=1;s<PR.fielddefs.length;++s)if(n=PR.fielddefs[s],95!==(r=PR.GetString(n.name)).charCodeAt(r.length-2)){if(a=32767&n.type,i=n.ofs,0===o.v_int[i]){if(3!==a)continue;if(0===o.v_int[i+1]&&0===o.v_int[i+2])continue}l[l.length]='"'+r+'" "'+PR.UglyValueString(a,o.v,n.ofs)+'"\n'}l[l.length]="}\n"}else l[l.length]="{\n}\n";r=COM.DefaultExtension(Cmd.argv[1],".sav"),Con.Print("Saving game to "+r+"...\n"),!0===COM.WriteTextFile(r,l.join(""))?Con.Print("done.\n"):Con.Print("ERROR: couldn't open.\n")}}else Con.Print("Relative pathnames are not allowed.\n");else Con.Print("save <savename> : save a game\n");else Con.Print("Can't save multiplayer games.\n");else Con.Print("Can't save in intermission.\n");else Con.Print("Not playing a local game.\n")},Host.Loadgame_f=function(){if(!0!==Cmd.client)if(2===Cmd.argv.length){CL.cls.demonum=-1;var e=COM.DefaultExtension(Cmd.argv[1],".sav");Con.Print("Loading game from "+e+"...\n");var t=COM.LoadTextFile(e);if(null!=t){t=t.split("\n");var n=parseFloat(t[0]);if(5===n){var a=[];for(l=0;l<=15;++l)a[l]=parseFloat(t[2+l]);Host.current_skill=parseFloat(t[18])+.1>>0,Cvar.SetValue("skill",Host.current_skill);var o=parseFloat(t[20]);if(CL.Disconnect(),SV.SpawnServer(t[19]),!0===SV.server.active){for(SV.server.paused=!0,SV.server.loadgame=!0,l=0;l<=63;++l)SV.server.lightstyles[l]=t[21+l];var s,r,i,l;for("{"!==t[85]&&Sys.Error("First token isn't a brace"),l=86;l<t.length;++l){if("}"===t[l]){++l;break}r=(s=t[l].split('"'))[1],null!=(i=ED.FindGlobal(r))?!0!==ED.ParseEpair(PR.globals,i,s[3])&&Host.Error("Host.Loadgame_f: parse error"):Con.Print("'"+r+"' is not a global\n")}t[t.length]="";for(var m,v,d=0,c=t.slice(l).join("\n");null!=(c=COM.Parse(c));){for(123!==COM.token.charCodeAt(0)&&Sys.Error("Host.Loadgame_f: found "+COM.token+" when expecting {"),m=SV.server.edicts[d++],v=0;v<PR.entityfields;++v)m.v_int[v]=0;m.free=!1,c=ED.ParseEdict(c,m),!0!==m.free&&SV.LinkEdict(m)}SV.server.num_edicts=d,SV.server.time=o;var f=SV.svs.clients[0];for(f.spawn_parms=[],l=0;l<=15;++l)f.spawn_parms[l]=a[l];CL.EstablishConnection("local"),Host.Reconnect_f()}else Con.Print("Couldn't load map\n")}else Con.Print("Savegame is version "+n+", not 5\n")}else Con.Print("ERROR: couldn't open.\n")}else Con.Print("load <savename> : load a game\n")},Host.Name_f=function(){if(Cmd.argv.length<=1)Con.Print('"name" is "'+CL.name.string+'"\n');else{var e;if(e=2===Cmd.argv.length?Cmd.argv[1].substring(0,15):Cmd.args.substring(0,15),!0!==Cmd.client)return Cvar.Set("_cl_name",e),void(CL.cls.state===CL.active.connected&&Cmd.ForwardToServer());var t=SV.GetClientName(Host.client);0!==t.length&&"unconnected"!==t&&t!==e&&Con.Print(t+" renamed to "+e+"\n"),SV.SetClientName(Host.client,e);var n=SV.server.reliable_datagram;MSG.WriteByte(n,Protocol.svc.updatename),MSG.WriteByte(n,Host.client.num),MSG.WriteString(n,e)}},Host.Version_f=function(){Con.Print("Version 1.09\n"),Con.Print(Def.timedate)},Host.Say=function(e){if(!0===Cmd.client){if(!(Cmd.argv.length<=1)){var t=Host.client,n=Cmd.args;34===n.charCodeAt(0)&&(n=n.substring(1,n.length-1)),text=""+SV.GetClientName(t)+": ";var a,o=62-text.length;for(n.length>o&&(n=n.substring(0,o)),text+=n+"\n",o=0;o<SV.svs.maxclients;++o)!0===(a=SV.svs.clients[o]).active&&!0===a.spawned&&(0!==Host.teamplay.value&&!0===e&&a.v_float[PR.entvars.team]!==t.v_float[PR.entvars.team]||(Host.client=a,Host.ClientPrint(text)));Host.client=t,Sys.Print(text.substring(1))}}else Cmd.ForwardToServer()},Host.Say_Team_f=function(){Host.Say(!0)},Host.Tell_f=function(){if(!0===Cmd.client){if(!(Cmd.argv.length<=2)){var e=SV.GetClientName(Host.client)+": ",t=Cmd.args;34===t.charCodeAt(0)&&(t=t.substring(1,t.length-1));var n=62-e.length;t.length>n&&(t=t.substring(0,n)),e+=t+"\n";var a,o=Host.client;for(n=0;n<SV.svs.maxclients;++n)if(!0===(a=SV.svs.clients[n]).active&&!0===a.spawned&&SV.GetClientName(a).toLowerCase()===Cmd.argv[1].toLowerCase()){Host.client=a,Host.ClientPrint(e);break}Host.client=o}}else Cmd.ForwardToServer()},Host.Color_f=function(){if(Cmd.argv.length<=1)Con.Print('"color" is "'+(CL.color.value>>4)+" "+(15&CL.color.value)+'"\ncolor <0-13> [0-13]\n');else{var e,t;2===Cmd.argv.length?e=t=(15&Q.atoi(Cmd.argv[1]))>>>0:(e=(15&Q.atoi(Cmd.argv[1]))>>>0,t=(15&Q.atoi(Cmd.argv[2]))>>>0),e>=14&&(e=13),t>=14&&(t=13);var n=(e<<4)+t;if(!0!==Cmd.client)return Cvar.SetValue("_cl_color",n),void(CL.cls.state===CL.active.connected&&Cmd.ForwardToServer());Host.client.colors=n,Host.client.edict.v_float[PR.entvars.team]=t+1;var a=SV.server.reliable_datagram;MSG.WriteByte(a,Protocol.svc.updatecolors),MSG.WriteByte(a,Host.client.num),MSG.WriteByte(a,n)}},Host.Kill_f=function(){!0===Cmd.client?SV.player.v_float[PR.entvars.health]<=0?Host.ClientPrint("Can't suicide -- allready dead!\n"):(PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=SV.player.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientKill])):Cmd.ForwardToServer()},Host.Pause_f=function(){!0===Cmd.client?0!==Host.pausable.value?(SV.server.paused=!SV.server.paused,Host.BroadcastPrint(SV.GetClientName(Host.client)+(!0===SV.server.paused?" paused the game\n":" unpaused the game\n")),MSG.WriteByte(SV.server.reliable_datagram,Protocol.svc.setpause),MSG.WriteByte(SV.server.reliable_datagram,!0===SV.server.paused?1:0)):Host.ClientPrint("Pause not allowed.\n"):Cmd.ForwardToServer()},Host.PreSpawn_f=function(){if(!0===Cmd.client){var e=Host.client;!0!==e.spawned?(SZ.Write(e.message,new Uint8Array(SV.server.signon.data),SV.server.signon.cursize),MSG.WriteByte(e.message,Protocol.svc.signonnum),MSG.WriteByte(e.message,2),e.sendsignon=!0):Con.Print("prespawn not valid -- allready spawned\n")}else Con.Print("prespawn is not valid from the console\n")},Host.Spawn_f=function(){if(!0===Cmd.client){var e=Host.client;if(!0!==e.spawned){var t,n=e.edict;if(!0===SV.server.loadgame)SV.server.paused=!1;else{for(t=0;t<PR.entityfields;++t)n.v_int[t]=0;for(n.v_float[PR.entvars.colormap]=n.num,n.v_float[PR.entvars.team]=1+(15&e.colors),n.v_int[PR.entvars.netname]=PR.netnames+(e.num<<5),t=0;t<=15;++t)PR.globals_float[PR.globalvars.parms+t]=e.spawn_parms[t];PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=n.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientConnect]),Sys.FloatTime()-e.netconnection.connecttime<=SV.server.time&&Sys.Print(SV.GetClientName(e)+" entered the game\n"),PR.ExecuteProgram(PR.globals_int[PR.globalvars.PutClientInServer])}var a=e.message;for(a.cursize=0,MSG.WriteByte(a,Protocol.svc.time),MSG.WriteFloat(a,SV.server.time),t=0;t<SV.svs.maxclients;++t)e=SV.svs.clients[t],MSG.WriteByte(a,Protocol.svc.updatename),MSG.WriteByte(a,t),MSG.WriteString(a,SV.GetClientName(e)),MSG.WriteByte(a,Protocol.svc.updatefrags),MSG.WriteByte(a,t),MSG.WriteShort(a,e.old_frags),MSG.WriteByte(a,Protocol.svc.updatecolors),MSG.WriteByte(a,t),MSG.WriteByte(a,e.colors);for(t=0;t<=63;++t)MSG.WriteByte(a,Protocol.svc.lightstyle),MSG.WriteByte(a,t),MSG.WriteString(a,SV.server.lightstyles[t]);MSG.WriteByte(a,Protocol.svc.updatestat),MSG.WriteByte(a,Def.stat.totalsecrets),MSG.WriteLong(a,PR.globals_float[PR.globalvars.total_secrets]),MSG.WriteByte(a,Protocol.svc.updatestat),MSG.WriteByte(a,Def.stat.totalmonsters),MSG.WriteLong(a,PR.globals_float[PR.globalvars.total_monsters]),MSG.WriteByte(a,Protocol.svc.updatestat),MSG.WriteByte(a,Def.stat.secrets),MSG.WriteLong(a,PR.globals_float[PR.globalvars.found_secrets]),MSG.WriteByte(a,Protocol.svc.updatestat),MSG.WriteByte(a,Def.stat.monsters),MSG.WriteLong(a,PR.globals_float[PR.globalvars.killed_monsters]),MSG.WriteByte(a,Protocol.svc.setangle),MSG.WriteAngle(a,n.v_float[PR.entvars.angles]),MSG.WriteAngle(a,n.v_float[PR.entvars.angles1]),MSG.WriteAngle(a,0),SV.WriteClientdataToMessage(n,a),MSG.WriteByte(a,Protocol.svc.signonnum),MSG.WriteByte(a,3),Host.client.sendsignon=!0}else Con.Print("Spawn not valid -- allready spawned\n")}else Con.Print("spawn is not valid from the console\n")},Host.Begin_f=function(){!0===Cmd.client?Host.client.spawned=!0:Con.Print("begin is not valid from the console\n")},Host.Kick_f=function(){if(!0!==Cmd.client){if(!0!==SV.server.active)return void Cmd.ForwardToServer()}else if(0!==PR.globals_float[PR.globalvars.deathmatch])return;if(!(Cmd.argv.length<=1)){var e,t,n=Host.client,a=Cmd.argv[1].toLowerCase();if(Cmd.argv.length>=3&&"#"===a){if((e=Q.atoi(Cmd.argv[2])-1)<0||e>=SV.svs.maxclients)return;if(!0!==SV.svs.clients[e].active)return;Host.client=SV.svs.clients[e],t=!0}else for(e=0;e<SV.svs.maxclients&&(Host.client=SV.svs.clients[e],!0!==Host.client.active||SV.GetClientName(Host.client).toLowerCase()!==a);++e);if(e>=SV.svs.maxclients)Host.client=n;else if(Host.client!==n){var o,s;if(!0!==Cmd.client)o=CL.name.string;else{if(Host.client===n)return;o=SV.GetClientName(n)}if(Cmd.argv.length>=3&&(s=COM.Parse(Cmd.args)),null!=s){var r=0;if(!0===t){for(++r;r<s.length&&32===s.charCodeAt(r);++r);r+=Cmd.argv[2].length}for(;r<s.length&&32===s.charCodeAt(r);++r);Host.ClientPrint("Kicked by "+o+": "+s.substring(r)+"\n")}else Host.ClientPrint("Kicked by "+o+"\n");Host.DropClient(),Host.client=n}}},Host.Give_f=function(){if(!0===Cmd.client){if(0===PR.globals_float[PR.globalvars.deathmatch]&&!(Cmd.argv.length<=1)){var e=Cmd.argv[1].charCodeAt(0),t=SV.player;if(e>=48&&e<=57)return!0!==COM.hipnotic?void(e>=50&&(t.v_float[PR.entvars.items]|=Def.it.shotgun<<e-50)):54===e?void(97===Cmd.argv[1].charCodeAt(1)?t.v_float[PR.entvars.items]|=Def.hit.proximity_gun:t.v_float[PR.entvars.items]|=Def.it.grenade_launcher):void(57===e?t.v_float[PR.entvars.items]|=Def.hit.laser_cannon:48===e?t.v_float[PR.entvars.items]|=Def.hit.mjolnir:e>=50&&(t.v_float[PR.entvars.items]|=Def.it.shotgun<<e-50));var n=Q.atoi(Cmd.argv[2]);if(104!==e)if(!0===COM.rogue)switch(e){case 115:return null!=PR.entvars.ammo_shells1&&(t.v_float[PR.entvars.ammo_shells1]=n),void(t.v_float[PR.entvars.ammo_shells]=n);case 110:return void(null!=PR.entvars.ammo_nails1&&(t.v_float[PR.entvars.ammo_nails1]=n,t.v_float[PR.entvars.weapon]<=Def.it.lightning&&(t.v_float[PR.entvars.ammo_nails]=n)));case 108:return void(null!=PR.entvars.ammo_lava_nails&&(t.v_float[PR.entvars.ammo_lava_nails]=n,t.v_float[PR.entvars.weapon]>Def.it.lightning&&(t.v_float[PR.entvars.ammo_nails]=n)));case 114:return void(null!=PR.entvars.ammo_rockets1&&(t.v_float[PR.entvars.ammo_rockets1]=n,t.v_float[PR.entvars.weapon]<=Def.it.lightning&&(t.v_float[PR.entvars.ammo_rockets]=n)));case 109:return void(null!=PR.entvars.ammo_multi_rockets&&(t.v_float[PR.entvars.ammo_multi_rockets]=n,t.v_float[PR.entvars.weapon]>Def.it.lightning&&(t.v_float[PR.entvars.ammo_rockets]=n)));case 99:return void(null!=PR.entvars.ammo_cells1&&(t.v_float[PR.entvars.ammo_cells1]=n,t.v_float[PR.entvars.weapon]<=Def.it.lightning&&(t.v_float[PR.entvars.ammo_cells]=n)));case 112:null!=PR.entvars.ammo_plasma&&(t.v_float[PR.entvars.ammo_plasma]=n,t.v_float[PR.entvars.weapon]>Def.it.lightning&&(t.v_float[PR.entvars.ammo_cells]=n))}else switch(e){case 115:return void(t.v_float[PR.entvars.ammo_shells]=n);case 110:return void(t.v_float[PR.entvars.ammo_nails]=n);case 114:return void(t.v_float[PR.entvars.ammo_rockets]=n);case 99:t.v_float[PR.entvars.ammo_cells]=n}else t.v_float[PR.entvars.health]=n}}else Cmd.ForwardToServer()},Host.FindViewthing=function(){var e,t;if(!0===SV.server.active)for(e=0;e<SV.server.num_edicts;++e)if(t=SV.server.edicts[e],"viewthing"===PR.GetString(t.v_int[PR.entvars.classname]))return t;Con.Print("No viewthing on map\n")},Host.Viewmodel_f=function(){if(2===Cmd.argv.length&&null!=Host.FindViewthing()){var e=Mod.ForName(Cmd.argv[1]);null!=e?(ent.v_float[PR.entvars.frame]=0,CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0]=e):Con.Print("Can't load "+Cmd.argv[1]+"\n")}},Host.Viewframe_f=function(){var e=Host.FindViewthing();if(null!=e){var t=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0],n=Q.atoi(Cmd.argv[1]);n>=t.frames.length&&(n=t.frames.length-1),e.v_float[PR.entvars.frame]=n}},Host.Viewnext_f=function(){var e=Host.FindViewthing();if(null!=e){var t=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0],n=1+(ent.v_float[PR.entvars.frame]>>0);n>=t.frames.length&&(n=t.frames.length-1),e.v_float[PR.entvars.frame]=n,Con.Print("frame "+n+": "+t.frames[n].name+"\n")}},Host.Viewprev_f=function(){var e=Host.FindViewthing();if(null!=e){var t=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0],n=(ent.v_float[PR.entvars.frame]>>0)-1;n<0&&(n=0),e.v_float[PR.entvars.frame]=n,Con.Print("frame "+n+": "+t.frames[n].name+"\n")}},Host.Startdemos_f=function(){var e;for(Con.Print(Cmd.argv.length-1+" demo(s) in loop\n"),CL.cls.demos=[],e=1;e<Cmd.argv.length;++e)CL.cls.demos[e-1]=Cmd.argv[e];-1!==CL.cls.demonum&&!0!==CL.cls.demoplayback?(CL.cls.demonum=0,0!==Host.framecount?CL.NextDemo():Host.startdemos=!0):CL.cls.demonum=-1},Host.Demos_f=function(){-1===CL.cls.demonum&&(CL.cls.demonum=1),CL.Disconnect(),CL.NextDemo()},Host.Stopdemo_f=function(){!0===CL.cls.demoplayback&&(CL.StopPlayback(),CL.Disconnect())},Host.InitCommands=function(){Cmd.AddCommand("status",Host.Status_f),Cmd.AddCommand("quit",Host.Quit_f),Cmd.AddCommand("god",Host.God_f),Cmd.AddCommand("notarget",Host.Notarget_f),Cmd.AddCommand("fly",Host.Fly_f),Cmd.AddCommand("map",Host.Map_f),Cmd.AddCommand("restart",Host.Restart_f),Cmd.AddCommand("changelevel",Host.Changelevel_f),Cmd.AddCommand("connect",Host.Connect_f),Cmd.AddCommand("reconnect",Host.Reconnect_f),Cmd.AddCommand("name",Host.Name_f),Cmd.AddCommand("noclip",Host.Noclip_f),Cmd.AddCommand("version",Host.Version_f),Cmd.AddCommand("say",Host.Say),Cmd.AddCommand("say_team",Host.Say_Team_f),Cmd.AddCommand("tell",Host.Tell_f),Cmd.AddCommand("color",Host.Color_f),Cmd.AddCommand("kill",Host.Kill_f),Cmd.AddCommand("pause",Host.Pause_f),Cmd.AddCommand("spawn",Host.Spawn_f),Cmd.AddCommand("begin",Host.Begin_f),Cmd.AddCommand("prespawn",Host.PreSpawn_f),Cmd.AddCommand("kick",Host.Kick_f),Cmd.AddCommand("ping",Host.Ping_f),Cmd.AddCommand("load",Host.Loadgame_f),Cmd.AddCommand("save",Host.Savegame_f),Cmd.AddCommand("give",Host.Give_f),Cmd.AddCommand("startdemos",Host.Startdemos_f),Cmd.AddCommand("demos",Host.Demos_f),Cmd.AddCommand("stopdemo",Host.Stopdemo_f),Cmd.AddCommand("viewmodel",Host.Viewmodel_f),Cmd.AddCommand("viewframe",Host.Viewframe_f),Cmd.AddCommand("viewnext",Host.Viewnext_f),Cmd.AddCommand("viewprev",Host.Viewprev_f),Cmd.AddCommand("mcache",Mod.Print)};

			// IN.js
			IN={},IN.mouse_x=0,IN.mouse_y=0,IN.old_mouse_x=0,IN.old_mouse_y=0,IN.StartupMouse=function(){if(IN.m_filter=Cvar.RegisterVariable("m_filter","1"),null==COM.CheckParm("-nomouse")){if(null!=VID.mainwindow.requestPointerLock)IN.movementX="movementX",IN.movementY="movementY",IN.pointerLockElement="pointerLockElement",IN.requestPointerLock="requestPointerLock",IN.pointerlockchange="onpointerlockchange";else if(null!=VID.mainwindow.webkitRequestPointerLock)IN.movementX="webkitMovementX",IN.movementY="webkitMovementY",IN.pointerLockElement="webkitPointerLockElement",IN.requestPointerLock="webkitRequestPointerLock",IN.pointerlockchange="onwebkitpointerlockchange";else{if(null==VID.mainwindow.mozRequestPointerLock)return;IN.movementX="mozMovementX",IN.movementY="mozMovementY",IN.pointerLockElement="mozPointerLockElement",IN.requestPointerLock="mozRequestPointerLock",IN.pointerlockchange="onmozpointerlockchange"}VID.mainwindow.onclick=IN.onclick,document.onmousemove=IN.onmousemove,document[IN.pointerlockchange]=IN.onpointerlockchange,IN.mouse_avail=!0}},IN.Init=function(){IN.StartupMouse()},IN.Shutdown=function(){!0===IN.mouse_avail&&(VID.mainwindow.onclick=null,document.onmousemove=null,document[IN.pointerlockchange]=null)},IN.MouseMove=function(){if(!0===IN.mouse_avail){var e,o;0!==IN.m_filter.value?(e=.5*(IN.mouse_x+IN.old_mouse_x),o=.5*(IN.mouse_y+IN.old_mouse_y)):(e=IN.mouse_x,o=IN.mouse_y),IN.old_mouse_x=IN.mouse_x,IN.old_mouse_y=IN.mouse_y,e*=CL.sensitivity.value,o*=CL.sensitivity.value;var n=1&CL.kbuttons[CL.kbutton.strafe].state,t=1&CL.kbuttons[CL.kbutton.mlook].state,m=CL.state.viewangles;0!==n||0!==CL.lookstrafe.value&&0!==t?CL.state.cmd.sidemove+=CL.m_side.value*e:m[1]-=CL.m_yaw.value*e,0!==t&&V.StopPitchDrift(),0!==t&&0===n?(m[0]+=CL.m_pitch.value*o,m[0]>80?m[0]=80:m[0]<-70&&(m[0]=-70)):0!==n&&!0===Host.noclip_anglehack?CL.state.cmd.upmove-=CL.m_forward.value*o:CL.state.cmd.forwardmove-=CL.m_forward.value*o,IN.mouse_x=IN.mouse_y=0}},IN.Move=function(){IN.MouseMove()},IN.onclick=function(){document[IN.pointerLockElement]!==this&&this[IN.requestPointerLock]()},IN.onmousemove=function(e){document[IN.pointerLockElement]===VID.mainwindow&&(IN.mouse_x+=e[IN.movementX],IN.mouse_y+=e[IN.movementY])},IN.onpointerlockchange=function(){document[IN.pointerLockElement]!==VID.mainwindow&&(Key.Event(Key.k.escape,!0),Key.Event(Key.k.escape))};

			// Key.js
			Key={},Key.k={tab:9,enter:13,escape:27,space:32,backspace:127,uparrow:128,downarrow:129,leftarrow:130,rightarrow:131,alt:132,ctrl:133,shift:134,f1:135,f2:136,f3:137,f4:138,f5:139,f6:140,f7:141,f8:142,f9:143,f10:144,f11:145,f12:146,ins:147,del:148,pgdn:149,pgup:150,home:151,end:152,pause:255,mouse1:200,mouse2:201,mouse3:202,mwheelup:239,mwheeldown:240},Key.lines=[""],Key.edit_line="",Key.history_line=1,Key.dest={game:0,console:1,message:2,menu:3,value:0},Key.bindings=[],Key.consolekeys=[],Key.shift=[],Key.down=[],Key.names=[{name:"TAB",keynum:Key.k.tab},{name:"ENTER",keynum:Key.k.enter},{name:"ESCAPE",keynum:Key.k.escape},{name:"SPACE",keynum:Key.k.space},{name:"BACKSPACE",keynum:Key.k.backspace},{name:"UPARROW",keynum:Key.k.uparrow},{name:"DOWNARROW",keynum:Key.k.downarrow},{name:"LEFTARROW",keynum:Key.k.leftarrow},{name:"RIGHTARROW",keynum:Key.k.rightarrow},{name:"ALT",keynum:Key.k.alt},{name:"CTRL",keynum:Key.k.ctrl},{name:"SHIFT",keynum:Key.k.shift},{name:"F1",keynum:Key.k.f1},{name:"F2",keynum:Key.k.f2},{name:"F3",keynum:Key.k.f3},{name:"F4",keynum:Key.k.f4},{name:"F5",keynum:Key.k.f5},{name:"F6",keynum:Key.k.f6},{name:"F7",keynum:Key.k.f7},{name:"F8",keynum:Key.k.f8},{name:"F9",keynum:Key.k.f9},{name:"F10",keynum:Key.k.f10},{name:"F11",keynum:Key.k.f11},{name:"F12",keynum:Key.k.f12},{name:"INS",keynum:Key.k.ins},{name:"DEL",keynum:Key.k.del},{name:"PGDN",keynum:Key.k.pgdn},{name:"PGUP",keynum:Key.k.pgup},{name:"HOME",keynum:Key.k.home},{name:"END",keynum:Key.k.end},{name:"MOUSE1",keynum:Key.k.mouse1},{name:"MOUSE2",keynum:Key.k.mouse2},{name:"MOUSE3",keynum:Key.k.mouse3},{name:"PAUSE",keynum:Key.k.pause},{name:"MWHEELUP",keynum:Key.k.mwheelup},{name:"MWHEELDOWN",keynum:Key.k.mwheeldown},{name:"SEMICOLON",keynum:59}],Key.Console=function(e){if(e===Key.k.enter)return Cmd.text+=Key.edit_line+"\n",Con.Print("]"+Key.edit_line+"\n"),Key.lines[Key.lines.length]=Key.edit_line,Key.edit_line="",void(Key.history_line=Key.lines.length);if(e!==Key.k.tab){if(e!==Key.k.backspace&&e!==Key.k.leftarrow){if(e===Key.k.uparrow)return--Key.history_line<0&&(Key.history_line=0),void(Key.edit_line=Key.lines[Key.history_line]);if(e===Key.k.downarrow){if(Key.history_line>=Key.lines.length)return;return++Key.history_line>=Key.lines.length?(Key.history_line=Key.lines.length,void(Key.edit_line="")):void(Key.edit_line=Key.lines[Key.history_line])}return e===Key.k.pgup?(Con.backscroll+=2,void(Con.backscroll>Con.text.length&&(Con.backscroll=Con.text.length))):e===Key.k.pgdn?(Con.backscroll-=2,void(Con.backscroll<0&&(Con.backscroll=0))):e===Key.k.home?(Con.backscroll=Con.text.length-10,void(Con.backscroll<0&&(Con.backscroll=0))):void(e!==Key.k.end?e<32||e>127||(Key.edit_line+=String.fromCharCode(e)):Con.backscroll=0)}Key.edit_line.length>0&&(Key.edit_line=Key.edit_line.substring(0,Key.edit_line.length-1))}else{var n=Cmd.CompleteCommand(Key.edit_line);if(null==n&&(n=Cvar.CompleteVariable(Key.edit_line)),null==n)return;Key.edit_line=n+" "}},Key.chat_buffer="",Key.Message=function(e){return e===Key.k.enter?(!0===Key.team_message?Cmd.text+='say_team "'+Key.chat_buffer+'"\n':Cmd.text+='say "'+Key.chat_buffer+'"\n',Key.dest.value=Key.dest.game,void(Key.chat_buffer="")):e===Key.k.escape?(Key.dest.value=Key.dest.game,void(Key.chat_buffer="")):void(e<32||e>127||(e!==Key.k.backspace?Key.chat_buffer.length>=31||(Key.chat_buffer=Key.chat_buffer+String.fromCharCode(e)):0!==Key.chat_buffer.length&&(Key.chat_buffer=Key.chat_buffer.substring(0,Key.chat_buffer.length-1))))},Key.StringToKeynum=function(e){if(1===e.length)return e.charCodeAt(0);var n;for(e=e.toUpperCase(),n=0;n<Key.names.length;++n)if(Key.names[n].name===e)return Key.names[n].keynum},Key.KeynumToString=function(e){if(e>32&&e<127)return String.fromCharCode(e);var n;for(n=0;n<Key.names.length;++n)if(Key.names[n].keynum===e)return Key.names[n].name;return"<UNKNOWN KEYNUM>"},Key.Unbind_f=function(){if(2===Cmd.argv.length){var e=Key.StringToKeynum(Cmd.argv[1]);null!=e?Key.bindings[e]=null:Con.Print('"'+Cmd.argv[1]+"\" isn't a valid key\n")}else Con.Print("unbind <key> : remove commands from a key\n")},Key.Unbindall_f=function(){Key.bindings=[]},Key.Bind_f=function(){var e=Cmd.argv.length;if(2===e||3===e){var n=Key.StringToKeynum(Cmd.argv[1]);if(null!=n)if(2!==e){var y,K=Cmd.argv[2];for(y=3;y<e;++y)K+=" "+Cmd.argv[y];Key.bindings[n]=K}else null!=Key.bindings[n]?Con.Print('"'+Cmd.argv[1]+'" = "'+Key.bindings[n]+'"\n'):Con.Print('"'+Cmd.argv[1]+'" is not bound\n');else Con.Print('"'+Cmd.argv[1]+"\" isn't a valid key\n")}else Con.Print("bind <key> [command] : attach a command to a key\n")},Key.WriteBindings=function(){var e,n=[];for(e=0;e<Key.bindings.length;++e)null!=Key.bindings[e]&&(n[n.length]='bind "'+Key.KeynumToString(e)+'" "'+Key.bindings[e]+'"\n');return n.join("")},Key.Init=function(){var e;for(e=32;e<128;++e)Key.consolekeys[e]=!0;for(Key.consolekeys[Key.k.enter]=!0,Key.consolekeys[Key.k.tab]=!0,Key.consolekeys[Key.k.leftarrow]=!0,Key.consolekeys[Key.k.rightarrow]=!0,Key.consolekeys[Key.k.uparrow]=!0,Key.consolekeys[Key.k.downarrow]=!0,Key.consolekeys[Key.k.backspace]=!0,Key.consolekeys[Key.k.home]=!0,Key.consolekeys[Key.k.end]=!0,Key.consolekeys[Key.k.pgup]=!0,Key.consolekeys[Key.k.pgdn]=!0,Key.consolekeys[Key.k.shift]=!0,Key.consolekeys[96]=!1,Key.consolekeys[126]=!1,e=0;e<256;++e)Key.shift[e]=e;for(e=97;e<=122;++e)Key.shift[e]=e-32;Key.shift[49]=33,Key.shift[50]=64,Key.shift[51]=35,Key.shift[52]=36,Key.shift[53]=37,Key.shift[54]=94,Key.shift[55]=38,Key.shift[56]=42,Key.shift[57]=40,Key.shift[48]=41,Key.shift[45]=95,Key.shift[61]=43,Key.shift[43]=60,Key.shift[46]=62,Key.shift[47]=63,Key.shift[59]=58,Key.shift[39]=34,Key.shift[91]=123,Key.shift[93]=125,Key.shift[96]=126,Key.shift[92]=124,Cmd.AddCommand("bind",Key.Bind_f),Cmd.AddCommand("unbind",Key.Unbind_f),Cmd.AddCommand("unbindall",Key.Unbindall_f)},Key.Event=function(e,n){if(CL.cls.state!==CL.active.connecting&&(!0!==n||e===Key.k.backspace||e===Key.k.pause||!0!==Key.down[e]))if(Key.down[e]=n,e===Key.k.shift&&(Key.shift_down=n),e!==Key.k.escape){var y;if(!0!==n)return null!=(y=Key.bindings[e])&&43===y.charCodeAt(0)&&(Cmd.text+="-"+y.substring(1)+" "+e+"\n"),void(Key.shift[e]!==e&&null!=(y=Key.bindings[Key.shift[e]])&&43===y.charCodeAt(0)&&(Cmd.text+="-"+y.substring(1)+" "+e+"\n"));!0!==CL.cls.demoplayback||!0!==Key.consolekeys[e]||Key.dest.value!==Key.dest.game?Key.dest.value===Key.dest.menu&&(e===Key.k.escape||e>=Key.k.f1&&e<=Key.k.f12)||Key.dest.value===Key.dest.console&&!0!==Key.consolekeys[e]||Key.dest.value===Key.dest.game&&(!0!==Con.forcedup||!0!==Key.consolekeys[e])?null!=(y=Key.bindings[e])&&(43===y.charCodeAt(0)?Cmd.text+=y+" "+e+"\n":Cmd.text+=y+"\n"):(!0===Key.shift_down&&(e=Key.shift[e]),Key.dest.value===Key.dest.message?Key.Message(e):Key.dest.value===Key.dest.menu?M.Keydown(e):Key.Console(e)):M.ToggleMenu_f()}else{if(!0!==n)return;Key.dest.value===Key.dest.message?Key.Message(e):Key.dest.value===Key.dest.menu?M.Keydown(e):M.ToggleMenu_f()}};

			// M.js MODIFIED
			M={},M.state={none:0,main:1,singleplayer:2,load:3,save:4,multiplayer:5,options:6,keys:7,help:8,quit:9,value:0},M.DrawCharacter=function(e,a,r){Draw.Character(e+(VID.width>>1)-160,a+(VID.height>>1)-100,r)},M.Print=function(e,a,r){Draw.StringWhite(e+(VID.width>>1)-160,a+(VID.height>>1)-100,r)},M.PrintWhite=function(e,a,r){Draw.String(e+(VID.width>>1)-160,a+(VID.height>>1)-100,r)},M.DrawPic=function(e,a,r){Draw.Pic(e+(VID.width>>1)-160,a+(VID.height>>1)-100,r)},M.DrawPicTranslate=function(e,a,r,t,n){Draw.PicTranslate(e+(VID.width>>1)-160,a+(VID.height>>1)-100,r,t,n)},M.DrawTextBox=function(e,a,r,t){var n,o,u,i;for(o=a,M.DrawPic(e,o,M.box_tl),u=0;u<t;++u)M.DrawPic(e,o+=8,M.box_ml);for(M.DrawPic(e,o+8,M.box_bl),n=e+8;r>0;){for(o=a,M.DrawPic(n,a,M.box_tm),i=M.box_mm,u=0;u<t;++u)M.DrawPic(n,o+=8,i),0===u&&(i=M.box_mm2);M.DrawPic(n,o+8,M.box_bm),r-=2,n+=16}for(o=a,M.DrawPic(n,o,M.box_tr),u=0;u<t;++u)M.DrawPic(n,o+=8,M.box_mr);M.DrawPic(n,o+8,M.box_br)},M.ToggleMenu_f=function(){if(M.entersound=!0,Key.dest.value===Key.dest.menu)return M.state.value!==M.state.main?void M.Menu_Main_f():(Key.dest.value=Key.dest.game,void(M.state.value=M.state.none));M.Menu_Main_f()},M.main_cursor=0,M.main_items=5,M.Menu_Main_f=function(){Key.dest.value!==Key.dest.menu&&(M.save_demonum=CL.cls.demonum,CL.cls.demonum=-1),Key.dest.value=Key.dest.menu,M.state.value=M.state.main,M.entersound=!0},M.Main_Draw=function(){M.DrawPic(16,4,M.qplaque),M.DrawPic(160-(M.ttl_main.width>>1),4,M.ttl_main),M.DrawPic(72,32,M.mainmenu),M.DrawPic(54,32+20*M.main_cursor,M.menudot[Math.floor(10*Host.realtime)%6])},M.Main_Key=function(e){switch(e){case Key.k.escape:return Key.dest.value=Key.dest.game,M.state.value=M.state.none,CL.cls.demonum=M.save_demonum,void(-1!==CL.cls.demonum&&!0!==CL.cls.demoplayback&&CL.cls.state!==CL.active.connected&&CL.NextDemo());case Key.k.downarrow:return S.LocalSound(M.sfx_menu1),void(++M.main_cursor>=M.main_items&&(M.main_cursor=0));case Key.k.uparrow:return S.LocalSound(M.sfx_menu1),void(--M.main_cursor<0&&(M.main_cursor=M.main_items-1));case Key.k.enter:switch(M.entersound=!0,M.main_cursor){case 0:return void M.Menu_SinglePlayer_f();case 1:return void M.Menu_MultiPlayer_f();case 2:return void M.Menu_Options_f();case 3:return void M.Menu_Help_f();case 4:M.Menu_Quit_f()}}},M.singleplayer_cursor=0,M.singleplayer_items=3,M.Menu_SinglePlayer_f=function(){Key.dest.value=Key.dest.menu,M.state.value=M.state.singleplayer,M.entersound=!0},M.SinglePlayer_Draw=function(){M.DrawPic(16,4,M.qplaque),M.DrawPic(160-(M.ttl_sgl.width>>1),4,M.ttl_sgl),M.DrawPic(72,32,M.sp_menu),M.DrawPic(54,32+20*M.singleplayer_cursor,M.menudot[Math.floor(10*Host.realtime)%6])},M.SinglePlayer_Key=function(e){switch(e){case Key.k.escape:return void M.Menu_Main_f();case Key.k.downarrow:return S.LocalSound(M.sfx_menu1),void(++M.singleplayer_cursor>=M.singleplayer_items&&(M.singleplayer_cursor=0));case Key.k.uparrow:return S.LocalSound(M.sfx_menu1),void(--M.singleplayer_cursor<0&&(M.singleplayer_cursor=M.singleplayer_items-1));case Key.k.enter:switch(M.entersound=!0,M.singleplayer_cursor){case 0:return!0===SV.server.active&&(Cmd.text+="disconnect\n"),Key.dest.value=Key.dest.game,void(Cmd.text+="maxplayers 1\nmap start\n");case 1:return void M.Menu_Load_f();case 2:M.Menu_Save_f()}}},M.load_cursor=0,M.max_savegames=12,M.filenames=[],M.loadable=[],M.removable=[],M.ScanSaves=function(){var e,a,r,t,n,o,u=COM.searchpaths,i="Quake."+COM.gamedir[0].filename+"/s";for(COM.searchpaths=COM.gamedir,e=0;e<M.max_savegames;++e){if(null!=(a=localStorage.getItem(i+e+".sav")))M.removable[e]=!0;else if(M.removable[e]=!1,null==(a=COM.LoadTextFile("s"+e+".sav"))){M.filenames[e]="--- UNUSED SLOT ---",M.loadable[e]=!1;continue}for(r=0;r<a.length;++r)if(10===(o=a.charCodeAt(r))){++r;break}for(t=[],n=0;n<=39&&13!==(o=a.charCodeAt(r+n));++n)t[n]=95===o?" ":String.fromCharCode(o);M.filenames[e]=t.join(""),M.loadable[e]=!0}COM.searchpaths=u},M.Menu_Load_f=function(){M.entersound=!0,M.state.value=M.state.load,Key.dest.value=Key.dest.menu,M.ScanSaves()},M.Menu_Save_f=function(){!0===SV.server.active&&0===CL.state.intermission&&1===SV.svs.maxclients&&(M.entersound=!0,M.state.value=M.state.save,Key.dest.value=Key.dest.menu,M.ScanSaves())},M.Load_Draw=function(){var e;for(M.DrawPic(160-(M.p_load.width>>1),4,M.p_load),e=0;e<M.max_savegames;++e)M.Print(16,32+(e<<3),M.filenames[e]);M.DrawCharacter(8,32+(M.load_cursor<<3),12+(4*Host.realtime&1))},M.Save_Draw=function(){var e;for(M.DrawPic(160-(M.p_save.width>>1),4,M.p_save),e=0;e<M.max_savegames;++e)M.Print(16,32+(e<<3),M.filenames[e]);M.DrawCharacter(8,32+(M.load_cursor<<3),12+(4*Host.realtime&1))},M.Load_Key=function(e){switch(e){case Key.k.escape:return void M.Menu_SinglePlayer_f();case Key.k.enter:if(S.LocalSound(M.sfx_menu2),!0!==M.loadable[M.load_cursor])return;return M.state.value=M.state.none,Key.dest.value=Key.dest.game,SCR.BeginLoadingPlaque(),void(Cmd.text+="load s"+M.load_cursor+"\n");case Key.k.uparrow:case Key.k.leftarrow:return S.LocalSound(M.sfx_menu1),void(--M.load_cursor<0&&(M.load_cursor=M.max_savegames-1));case Key.k.downarrow:case Key.k.rightarrow:return S.LocalSound(M.sfx_menu1),void(++M.load_cursor>=M.max_savegames&&(M.load_cursor=0));case Key.k.del:if(!0!==M.removable[M.load_cursor])return;if(!0!==confirm("Delete selected game?"))return;localStorage.removeItem("Quake."+COM.gamedir[0].filename+"/s"+M.load_cursor+".sav"),M.ScanSaves()}},M.Save_Key=function(e){switch(e){case Key.k.escape:return void M.Menu_SinglePlayer_f();case Key.k.enter:return M.state.value=M.state.none,Key.dest.value=Key.dest.game,void(Cmd.text+="save s"+M.load_cursor+"\n");case Key.k.uparrow:case Key.k.leftarrow:return S.LocalSound(M.sfx_menu1),void(--M.load_cursor<0&&(M.load_cursor=M.max_savegames-1));case Key.k.downarrow:case Key.k.rightarrow:return S.LocalSound(M.sfx_menu1),void(++M.load_cursor>=M.max_savegames&&(M.load_cursor=0));case Key.k.del:if(!0!==M.removable[M.load_cursor])return;if(!0!==confirm("Delete selected game?"))return;localStorage.removeItem("Quake."+COM.gamedir[0].filename+"/s"+M.load_cursor+".sav"),M.ScanSaves()}},M.multiplayer_cursor=0,M.multiplayer_cursor_table=[56,72,96,120,156],M.multiplayer_joinname="",M.multiplayer_items=5,M.Menu_MultiPlayer_f=function(){Key.dest.value=Key.dest.menu,M.state.value=M.state.multiplayer,M.entersound=!0,M.multiplayer_myname=CL.name.string,M.multiplayer_top=M.multiplayer_oldtop=CL.color.value>>4,M.multiplayer_bottom=M.multiplayer_oldbottom=15&CL.color.value},M.MultiPlayer_Draw=function(){M.DrawPic(16,4,M.qplaque),M.DrawPic(160-(M.p_multi.width>>1),4,M.p_multi),M.Print(64,40,"Join game at:"),M.DrawTextBox(72,48,22,1),M.Print(80,56,M.multiplayer_joinname.substring(M.multiplayer_joinname.length-21)),M.Print(64,72,"Your name"),M.DrawTextBox(160,64,16,1),M.Print(168,72,M.multiplayer_myname),M.Print(64,96,"Shirt color"),M.Print(64,120,"Pants color"),M.DrawTextBox(64,148,14,1),M.Print(72,156,"Accept Changes"),M.DrawPic(160,80,M.bigbox),M.DrawPicTranslate(172,88,M.menuplyr,(M.multiplayer_top<<4)+(M.multiplayer_top>=8?4:11),(M.multiplayer_bottom<<4)+(M.multiplayer_bottom>=8?4:11)),M.DrawCharacter(56,M.multiplayer_cursor_table[M.multiplayer_cursor],12+(4*Host.realtime&1)),0===M.multiplayer_cursor?M.DrawCharacter(M.multiplayer_joinname.length<=20?80+(M.multiplayer_joinname.length<<3):248,56,10+(4*Host.realtime&1)):1===M.multiplayer_cursor&&M.DrawCharacter(168+(M.multiplayer_myname.length<<3),72,10+(4*Host.realtime&1)),!0!==WEBS.available&&M.PrintWhite(52,172,"No Communications Available")},M.MultiPlayer_Key=function(e){switch(e===Key.k.escape&&M.Menu_Main_f(),e){case Key.k.uparrow:return S.LocalSound(M.sfx_menu1),void(--M.multiplayer_cursor<0&&(M.multiplayer_cursor=M.multiplayer_items-1));case Key.k.downarrow:return S.LocalSound(M.sfx_menu1),void(++M.multiplayer_cursor>=M.multiplayer_items&&(M.multiplayer_cursor=0));case Key.k.leftarrow:return void(2===M.multiplayer_cursor?(--M.multiplayer_top<0&&(M.multiplayer_top=13),S.LocalSound(M.sfx_menu3)):3===M.multiplayer_cursor&&(--M.multiplayer_bottom<0&&(M.multiplayer_bottom=13),S.LocalSound(M.sfx_menu3)));case Key.k.rightarrow:if(2===M.multiplayer_cursor)M.multiplayer_top<=12?++M.multiplayer_top:M.multiplayer_top=0;else{if(3!==M.multiplayer_cursor)return;M.multiplayer_bottom<=12?++M.multiplayer_bottom:M.multiplayer_bottom=0}return void S.LocalSound(M.sfx_menu3);case Key.k.enter:switch(M.multiplayer_cursor){case 0:if(S.LocalSound(M.sfx_menu2),!0!==WEBS.available)return;return Key.dest.value=Key.dest.game,M.state.value=M.state.none,Cmd.text+='connect "',"ws://"!==M.multiplayer_joinname.substring(0,5)&&(Cmd.text+="ws://"),void(Cmd.text+=M.multiplayer_joinname+'"\n');case 2:return S.LocalSound(M.sfx_menu3),void(M.multiplayer_top<=12?++M.multiplayer_top:M.multiplayer_top=0);case 3:return S.LocalSound(M.sfx_menu3),void(M.multiplayer_bottom<=12?++M.multiplayer_bottom:M.multiplayer_bottom=0);case 4:CL.name.string!==M.multiplayer_myname&&(Cmd.text+='name "'+M.multiplayer_myname+'"\n'),M.multiplayer_top===M.multiplayer_oldtop&&M.multiplayer_bottom===M.multiplayer_oldbottom||(M.multiplayer_oldtop=M.multiplayer_top,M.multiplayer_oldbottom=M.multiplayer_bottom,Cmd.text+="color "+M.multiplayer_top+" "+M.multiplayer_bottom+"\n"),M.entersound=!0}return;case Key.k.backspace:return 0===M.multiplayer_cursor?void(0!==M.multiplayer_joinname.length&&(M.multiplayer_joinname=M.multiplayer_joinname.substring(0,M.multiplayer_joinname.length-1))):void(1===M.multiplayer_cursor&&0!==M.multiplayer_myname.length&&(M.multiplayer_myname=M.multiplayer_myname.substring(0,M.multiplayer_myname.length-1)))}e<32||e>127||(0!==M.multiplayer_cursor?1===M.multiplayer_cursor&&M.multiplayer_myname.length<=14&&(M.multiplayer_myname+=String.fromCharCode(e)):M.multiplayer_joinname+=String.fromCharCode(e))},M.options_cursor=0,M.options_items=11,M.Menu_Options_f=function(){Key.dest.value=Key.dest.menu,M.state.value=M.state.options,M.entersound=!0},M.AdjustSliders=function(e){switch(S.LocalSound(M.sfx_menu3),M.options_cursor){case 3:return SCR.viewsize.value+=10*e,SCR.viewsize.value<30?SCR.viewsize.value=30:SCR.viewsize.value>120&&(SCR.viewsize.value=120),void Cvar.SetValue("viewsize",SCR.viewsize.value);case 4:return V.gamma.value-=.05*e,V.gamma.value<.5?V.gamma.value=.5:V.gamma.value>1&&(V.gamma.value=1),void Cvar.SetValue("gamma",V.gamma.value);case 5:return CL.sensitivity.value+=.5*e,CL.sensitivity.value<1?CL.sensitivity.value=1:CL.sensitivity.value>11&&(CL.sensitivity.value=11),void Cvar.SetValue("sensitivity",CL.sensitivity.value);case 6:return S.bgmvolume.value+=.1*e,S.bgmvolume.value<0?S.bgmvolume.value=0:S.bgmvolume.value>1&&(S.bgmvolume.value=1),void Cvar.SetValue("bgmvolume",S.bgmvolume.value);case 7:return S.volume.value+=.1*e,S.volume.value<0?S.volume.value=0:S.volume.value>1&&(S.volume.value=1),void Cvar.SetValue("volume",S.volume.value);case 8:return CL.forwardspeed.value>200?(Cvar.SetValue("cl_forwardspeed",200),void Cvar.SetValue("cl_backspeed",200)):(Cvar.SetValue("cl_forwardspeed",400),void Cvar.SetValue("cl_backspeed",400));case 9:return void Cvar.SetValue("m_pitch",-CL.m_pitch.value);case 10:return void Cvar.SetValue("lookspring",0!==CL.lookspring.value?0:1);case 11:Cvar.SetValue("lookstrafe",0!==CL.lookstrafe.value?0:1)}},M.DrawSlider=function(e,a,r){r<0?r=0:r>1&&(r=1),M.DrawCharacter(e-8,a,128),M.DrawCharacter(e,a,129),M.DrawCharacter(e+8,a,129),M.DrawCharacter(e+16,a,129),M.DrawCharacter(e+24,a,129),M.DrawCharacter(e+32,a,129),M.DrawCharacter(e+40,a,129),M.DrawCharacter(e+48,a,129),M.DrawCharacter(e+56,a,129),M.DrawCharacter(e+64,a,129),M.DrawCharacter(e+72,a,129),M.DrawCharacter(e+80,a,130),M.DrawCharacter(e+Math.floor(72*r),a,131)},M.Options_Draw=function(){M.DrawPic(16,4,M.qplaque),M.DrawPic(160-(M.p_option.width>>1),4,M.p_option),M.Print(48,32,"Customize controls"),M.Print(88,40,"Go to console"),M.Print(56,48,"Reset to defaults"),M.Print(104,56,"Screen size"),M.DrawSlider(220,56,(SCR.viewsize.value-30)/90),M.Print(112,64,"Brightness"),M.DrawSlider(220,64,2*(1-V.gamma.value)),M.Print(104,72,"Mouse Speed"),M.DrawSlider(220,72,(CL.sensitivity.value-1)/10),M.Print(72,80,"CD Music Volume"),M.DrawSlider(220,80,S.bgmvolume.value),M.Print(96,88,"Sound Volume"),M.DrawSlider(220,88,S.volume.value),M.Print(112,96,"Always Run"),M.Print(220,96,CL.forwardspeed.value>200?"on":"off"),M.Print(96,104,"Invert Mouse"),M.Print(220,104,CL.m_pitch.value<0?"on":"off"),M.Print(112,112,"Lookspring"),M.Print(220,112,0!==CL.lookspring.value?"on":"off"),M.Print(112,120,"Lookstrafe"),M.Print(220,120,0!==CL.lookstrafe.value?"on":"off"),M.DrawCharacter(200,32+(M.options_cursor<<3),12+(4*Host.realtime&1))},M.Options_Key=function(e){switch(e){case Key.k.escape:return void M.Menu_Main_f();case Key.k.enter:switch(M.entersound=!0,M.options_cursor){case 0:return void M.Menu_Keys_f();case 1:return M.state.value=M.state.none,void Con.ToggleConsole_f();case 2:return void(Cmd.text+="exec default.cfg\n");default:M.AdjustSliders(1)}return;case Key.k.uparrow:return S.LocalSound(M.sfx_menu1),void(--M.options_cursor<0&&(M.options_cursor=M.options_items-1));case Key.k.downarrow:return S.LocalSound(M.sfx_menu1),void(++M.options_cursor>=M.options_items&&(M.options_cursor=0));case Key.k.leftarrow:return void M.AdjustSliders(-1);case Key.k.rightarrow:M.AdjustSliders(1)}},M.bindnames=[["+attack","attack"],["impulse 10","change weapon"],["+jump","jump / swim up"],["+forward","walk forward"],["+back","backpedal"],["+left","turn left"],["+right","turn right"],["+speed","run"],["+moveleft","step left"],["+moveright","step right"],["+strafe","sidestep"],["+lookup","look up"],["+lookdown","look down"],["centerview","center view"],["+mlook","mouse look"],["+klook","keyboard look"],["+moveup","swim up"],["+movedown","swim down"]],M.keys_cursor=0,M.Menu_Keys_f=function(){Key.dest.value=Key.dest.menu,M.state.value=M.state.keys,M.entersound=!0},M.FindKeysForCommand=function(e){var a,r=[];for(a=0;a<Key.bindings.length;++a)if(Key.bindings[a]===e&&(r[r.length]=a,2===r.length))return r;return r},M.UnbindCommand=function(e){var a;for(a=0;a<Key.bindings.length;++a)Key.bindings[a]===e&&delete Key.bindings[a]},M.Keys_Draw=function(){M.DrawPic(160-(M.ttl_cstm.width>>1),4,M.ttl_cstm),!0===M.bind_grab?(M.Print(12,32,"Press a key or button for this action"),M.DrawCharacter(130,48+(M.keys_cursor<<3),61)):(M.Print(18,32,"Enter to change, backspace to clear"),M.DrawCharacter(130,48+(M.keys_cursor<<3),12+(4*Host.realtime&1)));var e,a,r,t=48;for(e=0;e<M.bindnames.length;++e)M.Print(16,t,M.bindnames[e][1]),null==(a=M.FindKeysForCommand(M.bindnames[e][0]))[0]?M.Print(140,t,"???"):(r=Key.KeynumToString(a[0]),null!=a[1]&&(r+=" or "+Key.KeynumToString(a[1])),M.Print(140,t,r)),t+=8},M.Keys_Key=function(e){if(!0===M.bind_grab)return S.LocalSound(M.sfx_menu1),e!==Key.k.escape&&96!==e&&(Cmd.text='bind "'+Key.KeynumToString(e)+'" "'+M.bindnames[M.keys_cursor][0]+'"\n'+Cmd.text),void(M.bind_grab=!1);switch(e){case Key.k.escape:return void M.Menu_Options_f();case Key.k.leftarrow:case Key.k.uparrow:return S.LocalSound(M.sfx_menu1),void(--M.keys_cursor<0&&(M.keys_cursor=M.bindnames.length-1));case Key.k.downarrow:case Key.k.rightarrow:return S.LocalSound(M.sfx_menu1),void(++M.keys_cursor>=M.bindnames.length&&(M.keys_cursor=0));case Key.k.enter:return S.LocalSound(M.sfx_menu2),null!=M.FindKeysForCommand(M.bindnames[M.keys_cursor][0])[1]&&M.UnbindCommand(M.bindnames[M.keys_cursor][0]),void(M.bind_grab=!0);case Key.k.backspace:case Key.k.del:S.LocalSound(M.sfx_menu2),M.UnbindCommand(M.bindnames[M.keys_cursor][0])}},M.num_help_pages=6,M.Menu_Help_f=function(){Key.dest.value=Key.dest.menu,M.state.value=M.state.help,M.entersound=!0,M.help_page=0},M.Help_Draw=function(){M.DrawPic(0,0,M.help_pages[M.help_page])},M.Help_Key=function(e){switch(e){case Key.k.escape:return void M.Menu_Main_f();case Key.k.uparrow:case Key.k.rightarrow:return M.entersound=!0,void(++M.help_page>=M.num_help_pages&&(M.help_page=0));case Key.k.downarrow:case Key.k.leftarrow:M.entersound=!0,--M.help_page<0&&(M.help_page=M.num_help_pages-1)}},M.quitMessage=[["  Are you gonna quit","  this game just like","   everything else?",""],[" Milord, methinks that","   thou art a lowly"," quitter. Is this true?",""],[" Do I need to bust your","  face open for trying","        to quit?",""],[" Man, I oughta smack you","   for trying to quit!","     Press Y to get","      smacked out."],[" Press Y to quit like a","   big loser in life.","  Press N to stay proud","    and successful!"],["   If you press Y to","  quit, I will summon","  Satan all over your","      hard drive!"],["  Um, Asmodeus dislikes"," his children trying to"," quit. Press Y to return","   to your Tinkertoys."],["  If you quit now, I'll","  throw a blanket-party","   for you next time!",""]],M.Menu_Quit_f=function(){M.state.value!==M.state.quit&&(M.wasInMenus=Key.dest.value===Key.dest.menu,Key.dest.value=Key.dest.menu,M.quit_prevstate=M.state.value,M.state.value=M.state.quit,M.entersound=!0,M.msgNumber=Math.floor(Math.random()*M.quitMessage.length))},M.Quit_Draw=function(){!0===M.wasInMenus&&(M.state.value=M.quit_prevstate,M.recursiveDraw=!0,M.Draw(),M.state.value=M.state.quit),M.DrawTextBox(56,76,24,4),M.Print(64,84,M.quitMessage[M.msgNumber][0]),M.Print(64,92,M.quitMessage[M.msgNumber][1]),M.Print(64,100,M.quitMessage[M.msgNumber][2]),M.Print(64,108,M.quitMessage[M.msgNumber][3])},M.Quit_Key=function(e){switch(e){case Key.k.escape:case 110:!0===M.wasInMenus?(M.state.value=M.quit_prevstate,M.entersound=!0):(Key.dest.value=Key.dest.game,M.state.value=M.state.none);break;case 121:Key.dest.value=Key.dest.console,Host.Quit_f()}},M.Init=function(){Cmd.AddCommand("togglemenu",M.ToggleMenu_f),Cmd.AddCommand("menu_main",M.Menu_Main_f),Cmd.AddCommand("menu_singleplayer",M.Menu_SinglePlayer_f),Cmd.AddCommand("menu_load",M.Menu_Load_f),Cmd.AddCommand("menu_save",M.Menu_Save_f),Cmd.AddCommand("menu_multiplayer",M.Menu_MultiPlayer_f),Cmd.AddCommand("menu_setup",M.Menu_MultiPlayer_f),Cmd.AddCommand("menu_options",M.Menu_Options_f),Cmd.AddCommand("menu_keys",M.Menu_Keys_f),Cmd.AddCommand("help",M.Menu_Help_f),Cmd.AddCommand("menu_quit",M.Menu_Quit_f),M.sfx_menu1=S.PrecacheSound("misc/menu1.wav"),M.sfx_menu2=S.PrecacheSound("misc/menu2.wav"),M.sfx_menu3=S.PrecacheSound("misc/menu3.wav"),M.box_tl=Draw.CachePic("box_tl"),M.box_ml=Draw.CachePic("box_ml"),M.box_bl=Draw.CachePic("box_bl"),M.box_tm=Draw.CachePic("box_tm"),M.box_mm=Draw.CachePic("box_mm"),M.box_mm2=Draw.CachePic("box_mm2"),M.box_bm=Draw.CachePic("box_bm"),M.box_tr=Draw.CachePic("box_tr"),M.box_mr=Draw.CachePic("box_mr"),M.box_br=Draw.CachePic("box_br"),M.qplaque=Draw.CachePic("qplaque"),M.menudot=[Draw.CachePic("menudot1"),Draw.CachePic("menudot2"),Draw.CachePic("menudot3"),Draw.CachePic("menudot4"),Draw.CachePic("menudot5"),Draw.CachePic("menudot6")],M.ttl_main=Draw.CachePic("ttl_main"),M.mainmenu=Draw.CachePic("mainmenu"),M.ttl_sgl=Draw.CachePic("ttl_sgl"),M.sp_menu=Draw.CachePic("sp_menu"),M.p_load=Draw.CachePic("p_load"),M.p_save=Draw.CachePic("p_save"),M.p_multi=Draw.CachePic("p_multi"),M.bigbox=Draw.CachePic("bigbox"),M.menuplyr=Draw.CachePic("menuplyr");COM.LoadFile("gfx/menuplyr.lmp");var e,a,r=GL.ResampleTexture(M.menuplyr.data,M.menuplyr.width,M.menuplyr.height,64,64),t=new Uint8Array(new ArrayBuffer(16384));for(e=0;e<4096;++e)(a=r[e])>>4==1?(t[e<<2]=17*(15&a),t[1+(e<<2)]=255):a>>4==6&&(t[2+(e<<2)]=17*(15&a),t[3+(e<<2)]=255);M.menuplyr.translate=gl.createTexture(),GL.Bind(0,M.menuplyr.translate),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,64,64,0,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),M.p_option=Draw.CachePic("p_option"),M.ttl_cstm=Draw.CachePic("ttl_cstm"),M.help_pages=[Draw.CachePic("help0"),Draw.CachePic("help1"),Draw.CachePic("help2"),Draw.CachePic("help3"),Draw.CachePic("help4"),Draw.CachePic("help5")]},M.Draw=function(){if(M.state.value!==M.state.none&&Key.dest.value===Key.dest.menu){switch(!0!==M.recursiveDraw?0!==SCR.con_current?Draw.ConsoleBackground(VID.height):Draw.FadeScreen():M.recursiveDraw=!1,M.state.value){case M.state.main:M.Main_Draw();break;case M.state.singleplayer:M.SinglePlayer_Draw();break;case M.state.load:M.Load_Draw();break;case M.state.save:M.Save_Draw();break;case M.state.multiplayer:M.MultiPlayer_Draw();break;case M.state.options:M.Options_Draw();break;case M.state.keys:M.Keys_Draw();break;case M.state.help:M.Help_Draw();break;case M.state.quit:M.Quit_Draw()}!0===M.entersound&&(S.LocalSound(M.sfx_menu2),M.entersound=!1)}},M.Keydown=function(e){switch(M.state.value){case M.state.main:return void M.Main_Key(e);case M.state.singleplayer:return void M.SinglePlayer_Key(e);case M.state.load:return void M.Load_Key(e);case M.state.save:return void M.Save_Key(e);case M.state.multiplayer:return void M.MultiPlayer_Key(e);case M.state.options:return void M.Options_Key(e);case M.state.keys:return void M.Keys_Key(e);case M.state.help:return void M.Help_Key(e);case M.state.quit:M.Quit_Key(e)}};

			// Mod.js
			Mod={},Mod.effects={brightfield:1,muzzleflash:2,brightlight:4,dimlight:8},Mod.type={brush:0,sprite:1,alias:2},Mod.flags={rocket:1,grenade:2,gib:4,rotate:8,tracer:16,zomgib:32,tracer2:64,tracer3:128},Mod.version={brush:29,sprite:1,alias:6},Mod.known=[],Mod.Init=function(){var e;for(Mod.novis=[],e=0;e<1024;++e)Mod.novis[e]=255;for(Mod.filledcolor=0,e=0;e<=255;++e)if(0===VID.d_8to24table[e]){Mod.filledcolor=e;break}},Mod.PointInLeaf=function(e,o){null==o&&Sys.Error("Mod.PointInLeaf: bad model"),null==o.nodes&&Sys.Error("Mod.PointInLeaf: bad model");for(var d,t=o.nodes[0];;){if(t.contents<0)return t;d=t.plane.normal,t=e[0]*d[0]+e[1]*d[1]+e[2]*d[2]-t.plane.dist>0?t.children[0]:t.children[1]}},Mod.DecompressVis=function(e,o){var d,t,l=[],a=o.leafs.length+7>>3;if(null==o.visdata){for(;a>=0;--a)l[t++]=255;return l}for(t=0;t<a;)if(0===o.visdata[e]){for(d=o.visdata[e+1];d>0;--d)l[t++]=0;e+=2}else l[t++]=o.visdata[e++];return l},Mod.LeafPVS=function(e,o){return e===o.leafs[0]?Mod.novis:Mod.DecompressVis(e.visofs,o)},Mod.ClearAll=function(){var e,o;for(e=0;e<Mod.known.length;++e)(o=Mod.known[e]).type===Mod.type.brush&&(null!=o.cmds&&gl.deleteBuffer(o.cmds),Mod.known[e]={name:o.name,needload:!0})},Mod.FindName=function(e){var o;for(0===e.length&&Sys.Error("Mod.FindName: NULL name"),o=0;o<Mod.known.length;++o)if(null!=Mod.known[o]&&Mod.known[o].name===e)return Mod.known[o];for(o=0;o<=Mod.known.length;++o)if(null==Mod.known[o])return Mod.known[o]={name:e,needload:!0},Mod.known[o]},Mod.LoadModel=function(e,o){if(!0!==e.needload)return e;var d=COM.LoadFile(e.name);if(null!=d){switch(Mod.loadmodel=e,e.needload=!1,new DataView(d).getUint32(0,!0)){case 1330660425:Mod.LoadAliasModel(d);break;case 1347634249:Mod.LoadSpriteModel(d);break;default:Mod.LoadBrushModel(d)}return e}!0===o&&Sys.Error("Mod.LoadModel: "+e.name+" not found")},Mod.ForName=function(e,o){return Mod.LoadModel(Mod.FindName(e),o)},Mod.lump={entities:0,planes:1,textures:2,vertexes:3,visibility:4,nodes:5,texinfo:6,faces:7,lighting:8,clipnodes:9,leafs:10,marksurfaces:11,edges:12,surfedges:13,models:14},Mod.contents={empty:-1,solid:-2,water:-3,slime:-4,lava:-5,sky:-6,origin:-7,clip:-8,current_0:-9,current_90:-10,current_180:-11,current_270:-12,current_up:-13,current_down:-14},Mod.LoadTextures=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.textures<<3),!0);o.getUint32(8+(Mod.lump.textures<<3),!0);Mod.loadmodel.textures=[];var t,l,a,n,i,r,s,m,M=o.getUint32(d,!0),g=d+4;for(t=0;t<M;++t)l=o.getInt32(g,!0),g+=4,-1!==l?(l+=d,"sky"===(a={name:Q.memstr(new Uint8Array(e,l,16)),width:o.getUint32(l+16,!0),height:o.getUint32(l+20,!0)}).name.substring(0,3).toLowerCase()?(R.InitSky(new Uint8Array(e,l+o.getUint32(l+24,!0),32768)),a.texturenum=R.solidskytexture,R.skytexturenum=t,a.sky=!0):(n=GL.LoadTexture(a.name,a.width,a.height,new Uint8Array(e,l+o.getUint32(l+24,!0),a.width*a.height)),a.texturenum=n.texnum,42===a.name.charCodeAt(0)&&(a.turbulent=!0)),Mod.loadmodel.textures[t]=a):Mod.loadmodel.textures[t]=R.notexture_mip;for(t=0;t<M;++t)if(43===(a=Mod.loadmodel.textures[t]).name.charCodeAt(0)&&48===a.name.charCodeAt(1)){for(m=a.name.substring(2),a.anims=[t],a.alternate_anims=[],i=0;i<M;++i)43===(r=Mod.loadmodel.textures[i]).name.charCodeAt(0)&&r.name.substring(2)===m&&48!==(s=r.name.charCodeAt(1))&&(s>=49&&s<=57?(a.anims[s-48]=i,r.anim_base=t,r.anim_frame=s-48):(s>=97&&(s-=32),s>=65&&s<=74?(a.alternate_anims[s-65]=i,r.anim_base=t,r.anim_frame=s-65):Sys.Error("Bad animating texture "+a.name)));for(i=0;i<a.anims.length;++i)null==a.anims[i]&&Sys.Error("Missing frame "+i+" of "+a.name);for(i=0;i<a.alternate_anims.length;++i)null==a.alternate_anims[i]&&Sys.Error("Missing frame "+i+" of "+a.name);Mod.loadmodel.textures[t]=a}Mod.loadmodel.textures[Mod.loadmodel.textures.length]=R.notexture_mip},Mod.LoadLighting=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.lighting<<3),!0),t=o.getUint32(8+(Mod.lump.lighting<<3),!0);0!==t&&(Mod.loadmodel.lightdata=new Uint8Array(new ArrayBuffer(t)),Mod.loadmodel.lightdata.set(new Uint8Array(e,d,t)))},Mod.LoadVisibility=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.visibility<<3),!0),t=o.getUint32(8+(Mod.lump.visibility<<3),!0);0!==t&&(Mod.loadmodel.visdata=new Uint8Array(new ArrayBuffer(t)),Mod.loadmodel.visdata.set(new Uint8Array(e,d,t)))},Mod.LoadEntities=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.entities<<3),!0),t=o.getUint32(8+(Mod.lump.entities<<3),!0);Mod.loadmodel.entities=Q.memstr(new Uint8Array(e,d,t))},Mod.LoadVertexes=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.vertexes<<3),!0),t=o.getUint32(8+(Mod.lump.vertexes<<3),!0);t%12!=0&&Sys.Error("Mod.LoadVisibility: funny lump size in "+Mod.loadmodel.name);var l,a=t/12;for(Mod.loadmodel.vertexes=[],l=0;l<a;++l)Mod.loadmodel.vertexes[l]=[o.getFloat32(d,!0),o.getFloat32(d+4,!0),o.getFloat32(d+8,!0)],d+=12},Mod.LoadSubmodels=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.models<<3),!0),t=o.getUint32(8+(Mod.lump.models<<3),!0)>>6;0===t&&Sys.Error("Mod.LoadSubmodels: funny lump size in "+Mod.loadmodel.name),Mod.loadmodel.submodels=[],Mod.loadmodel.mins=[o.getFloat32(d,!0)-1,o.getFloat32(d+4,!0)-1,o.getFloat32(d+8,!0)-1],Mod.loadmodel.maxs=[o.getFloat32(d+12,!0)+1,o.getFloat32(d+16,!0)+1,o.getFloat32(d+20,!0)+1],Mod.loadmodel.hulls[0].firstclipnode=o.getUint32(d+36,!0),Mod.loadmodel.hulls[1].firstclipnode=o.getUint32(d+40,!0),Mod.loadmodel.hulls[2].firstclipnode=o.getUint32(d+44,!0),d+=64;var l,a,n=Mod.loadmodel.hulls[0].clipnodes;for(l=1;l<t;++l)(a=Mod.FindName("*"+l)).needload=!1,a.type=Mod.type.brush,a.submodel=!0,a.mins=[o.getFloat32(d,!0)-1,o.getFloat32(d+4,!0)-1,o.getFloat32(d+8,!0)-1],a.maxs=[o.getFloat32(d+12,!0)+1,o.getFloat32(d+16,!0)+1,o.getFloat32(d+20,!0)+1],a.origin=[o.getFloat32(d+24,!0),o.getFloat32(d+28,!0),o.getFloat32(d+32,!0)],a.hulls=[{clipnodes:n,firstclipnode:o.getUint32(d+36,!0),lastclipnode:Mod.loadmodel.nodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[0,0,0],clip_maxs:[0,0,0]},{clipnodes:Mod.loadmodel.clipnodes,firstclipnode:o.getUint32(d+40,!0),lastclipnode:Mod.loadmodel.clipnodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[-16,-16,-24],clip_maxs:[16,16,32]},{clipnodes:Mod.loadmodel.clipnodes,firstclipnode:o.getUint32(d+44,!0),lastclipnode:Mod.loadmodel.clipnodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[-32,-32,-24],clip_maxs:[32,32,64]}],a.textures=Mod.loadmodel.textures,a.lightdata=Mod.loadmodel.lightdata,a.faces=Mod.loadmodel.faces,a.firstface=o.getUint32(d+56,!0),a.numfaces=o.getUint32(d+60,!0),Mod.loadmodel.submodels[l-1]=a,d+=64},Mod.LoadEdges=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.edges<<3),!0),t=o.getUint32(8+(Mod.lump.edges<<3),!0);0!=(3&t)&&Sys.Error("Mod.LoadEdges: funny lump size in "+Mod.loadmodel.name);var l,a=t>>2;for(Mod.loadmodel.edges=[],l=0;l<a;++l)Mod.loadmodel.edges[l]=[o.getUint16(d,!0),o.getUint16(d+2,!0)],d+=4},Mod.LoadTexinfo=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.texinfo<<3),!0),t=o.getUint32(8+(Mod.lump.texinfo<<3),!0);t%40!=0&&Sys.Error("Mod.LoadTexinfo: funny lump size in "+Mod.loadmodel.name);var l,a,n=t/40;for(Mod.loadmodel.texinfo=[],l=0;l<n;++l)(a={vecs:[[o.getFloat32(d,!0),o.getFloat32(d+4,!0),o.getFloat32(d+8,!0),o.getFloat32(d+12,!0)],[o.getFloat32(d+16,!0),o.getFloat32(d+20,!0),o.getFloat32(d+24,!0),o.getFloat32(d+28,!0)]],texture:o.getUint32(d+32,!0),flags:o.getUint32(d+36,!0)}).texture>=Mod.loadmodel.textures.length&&(a.texture=Mod.loadmodel.textures.length-1,a.flags=0),Mod.loadmodel.texinfo[l]=a,d+=40},Mod.LoadFaces=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.faces<<3),!0),t=o.getUint32(8+(Mod.lump.faces<<3),!0);t%20!=0&&Sys.Error("Mod.LoadFaces: funny lump size in "+Mod.loadmodel.name);var l,a,n,i,r,s,m,M,g,u,f=t/20;for(Mod.loadmodel.firstface=0,Mod.loadmodel.numfaces=f,Mod.loadmodel.faces=[],l=0;l<f;++l){for(a=new Uint8Array(e,d+12,4),n={plane:Mod.loadmodel.planes[o.getUint16(d,!0)],firstedge:o.getUint16(d+4,!0),numedges:o.getUint16(d+8,!0),texinfo:o.getUint16(d+10,!0),styles:[],lightofs:o.getInt32(d+16,!0)},255!==a[0]&&(n.styles[0]=a[0]),255!==a[1]&&(n.styles[1]=a[1]),255!==a[2]&&(n.styles[2]=a[2]),255!==a[3]&&(n.styles[3]=a[3]),i=[999999,999999],r=[-99999,-99999],M=Mod.loadmodel.texinfo[n.texinfo],n.texture=M.texture,s=0;s<n.numedges;++s)g=(m=Mod.loadmodel.surfedges[n.firstedge+s])>=0?Mod.loadmodel.vertexes[Mod.loadmodel.edges[m][0]]:Mod.loadmodel.vertexes[Mod.loadmodel.edges[-m][1]],(u=Vec.DotProduct(g,M.vecs[0])+M.vecs[0][3])<i[0]&&(i[0]=u),u>r[0]&&(r[0]=u),(u=Vec.DotProduct(g,M.vecs[1])+M.vecs[1][3])<i[1]&&(i[1]=u),u>r[1]&&(r[1]=u);n.texturemins=[16*Math.floor(i[0]/16),16*Math.floor(i[1]/16)],n.extents=[16*Math.ceil(r[0]/16)-n.texturemins[0],16*Math.ceil(r[1]/16)-n.texturemins[1]],!0===Mod.loadmodel.textures[M.texture].turbulent?n.turbulent=!0:!0===Mod.loadmodel.textures[M.texture].sky&&(n.sky=!0),Mod.loadmodel.faces[l]=n,d+=20}},Mod.SetParent=function(e,o){e.parent=o,e.contents<0||(Mod.SetParent(e.children[0],e),Mod.SetParent(e.children[1],e))},Mod.LoadNodes=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.nodes<<3),!0),t=o.getUint32(8+(Mod.lump.nodes<<3),!0);0!==t&&t%24==0||Sys.Error("Mod.LoadNodes: funny lump size in "+Mod.loadmodel.name);var l,a,n=t/24;for(Mod.loadmodel.nodes=[],l=0;l<n;++l)Mod.loadmodel.nodes[l]={num:l,contents:0,planenum:o.getUint32(d,!0),children:[o.getInt16(d+4,!0),o.getInt16(d+6,!0)],mins:[o.getInt16(d+8,!0),o.getInt16(d+10,!0),o.getInt16(d+12,!0)],maxs:[o.getInt16(d+14,!0),o.getInt16(d+16,!0),o.getInt16(d+18,!0)],firstface:o.getUint16(d+20,!0),numfaces:o.getUint16(d+22,!0),cmds:[]},d+=24;for(l=0;l<n;++l)(a=Mod.loadmodel.nodes[l]).plane=Mod.loadmodel.planes[a.planenum],a.children[0]>=0?a.children[0]=Mod.loadmodel.nodes[a.children[0]]:a.children[0]=Mod.loadmodel.leafs[-1-a.children[0]],a.children[1]>=0?a.children[1]=Mod.loadmodel.nodes[a.children[1]]:a.children[1]=Mod.loadmodel.leafs[-1-a.children[1]];Mod.SetParent(Mod.loadmodel.nodes[0])},Mod.LoadLeafs=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.leafs<<3),!0),t=o.getUint32(8+(Mod.lump.leafs<<3),!0);t%28!=0&&Sys.Error("Mod.LoadLeafs: funny lump size in "+Mod.loadmodel.name);var l,a,n=t/28;for(Mod.loadmodel.leafs=[],l=0;l<n;++l)a={num:l,contents:o.getInt32(d,!0),visofs:o.getInt32(d+4,!0),mins:[o.getInt16(d+8,!0),o.getInt16(d+10,!0),o.getInt16(d+12,!0)],maxs:[o.getInt16(d+14,!0),o.getInt16(d+16,!0),o.getInt16(d+18,!0)],firstmarksurface:o.getUint16(d+20,!0),nummarksurfaces:o.getUint16(d+22,!0),ambient_level:[o.getUint8(d+24),o.getUint8(d+25),o.getUint8(d+26),o.getUint8(d+27)],cmds:[],skychain:0,waterchain:0},Mod.loadmodel.leafs[l]=a,d+=28},Mod.LoadClipnodes=function(e){var o,d=new DataView(e),t=d.getUint32(4+(Mod.lump.clipnodes<<3),!0),l=d.getUint32(8+(Mod.lump.clipnodes<<3),!0)>>3;for(Mod.loadmodel.clipnodes=[],Mod.loadmodel.hulls=[],Mod.loadmodel.hulls[1]={clipnodes:Mod.loadmodel.clipnodes,firstclipnode:0,lastclipnode:l-1,planes:Mod.loadmodel.planes,clip_mins:[-16,-16,-24],clip_maxs:[16,16,32]},Mod.loadmodel.hulls[2]={clipnodes:Mod.loadmodel.clipnodes,firstclipnode:0,lastclipnode:l-1,planes:Mod.loadmodel.planes,clip_mins:[-32,-32,-24],clip_maxs:[32,32,64]},o=0;o<l;++o)Mod.loadmodel.clipnodes[o]={planenum:d.getUint32(t,!0),children:[d.getInt16(t+4,!0),d.getInt16(t+6,!0)]},t+=8},Mod.MakeHull0=function(){var e,o,d,t,l=[],a={clipnodes:l,lastclipnode:Mod.loadmodel.nodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[0,0,0],clip_maxs:[0,0,0]};for(d=0;d<Mod.loadmodel.nodes.length;++d)t={planenum:(e=Mod.loadmodel.nodes[d]).planenum,children:[]},o=e.children[0],t.children[0]=o.contents<0?o.contents:o.num,o=e.children[1],t.children[1]=o.contents<0?o.contents:o.num,l[d]=t;Mod.loadmodel.hulls[0]=a},Mod.LoadMarksurfaces=function(e){var o,d,t=new DataView(e),l=t.getUint32(4+(Mod.lump.marksurfaces<<3),!0),a=t.getUint32(8+(Mod.lump.marksurfaces<<3),!0)>>1;for(Mod.loadmodel.marksurfaces=[],o=0;o<a;++o)(d=t.getUint16(l+(o<<1),!0))>Mod.loadmodel.faces.length&&Sys.Error("Mod.LoadMarksurfaces: bad surface number"),Mod.loadmodel.marksurfaces[o]=d},Mod.LoadSurfedges=function(e){var o,d=new DataView(e),t=d.getUint32(4+(Mod.lump.surfedges<<3),!0),l=d.getUint32(8+(Mod.lump.surfedges<<3),!0)>>2;for(Mod.loadmodel.surfedges=[],o=0;o<l;++o)Mod.loadmodel.surfedges[o]=d.getInt32(t+(o<<2),!0)},Mod.LoadPlanes=function(e){var o=new DataView(e),d=o.getUint32(4+(Mod.lump.planes<<3),!0),t=o.getUint32(8+(Mod.lump.planes<<3),!0);t%20!=0&&Sys.Error("Mod.LoadPlanes: funny lump size in "+Mod.loadmodel.name);var l,a,n=t/20;for(Mod.loadmodel.planes=[],l=0;l<n;++l)(a={normal:[o.getFloat32(d,!0),o.getFloat32(d+4,!0),o.getFloat32(d+8,!0)],dist:o.getFloat32(d+12,!0),type:o.getUint32(d+16,!0),signbits:0}).normal[0]<0&&++a.signbits,a.normal[1]<0&&(a.signbits+=2),a.normal[2]<0&&(a.signbits+=4),Mod.loadmodel.planes[l]=a,d+=20},Mod.LoadBrushModel=function(e){Mod.loadmodel.type=Mod.type.brush;var o=new DataView(e).getUint32(0,!0);o!==Mod.version.brush&&Sys.Error("Mod.LoadBrushModel: "+Mod.loadmodel.name+" has wrong version number ("+o+" should be "+Mod.version.brush+")"),Mod.LoadVertexes(e),Mod.LoadEdges(e),Mod.LoadSurfedges(e),Mod.LoadTextures(e),Mod.LoadLighting(e),Mod.LoadPlanes(e),Mod.LoadTexinfo(e),Mod.LoadFaces(e),Mod.LoadMarksurfaces(e),Mod.LoadVisibility(e),Mod.LoadLeafs(e),Mod.LoadNodes(e),Mod.LoadClipnodes(e),Mod.MakeHull0(),Mod.LoadEntities(e),Mod.LoadSubmodels(e);var d,t,l=[0,0,0],a=[0,0,0];for(d=0;d<Mod.loadmodel.vertexes.length;++d)(t=Mod.loadmodel.vertexes[d])[0]<l[0]?l[0]=t[0]:t[0]>a[0]&&(a[0]=t[0]),t[1]<l[1]?l[1]=t[1]:t[1]>a[1]&&(a[1]=t[1]),t[2]<l[2]?l[2]=t[2]:t[2]>a[2]&&(a[2]=t[2]);Mod.loadmodel.radius=Vec.Length([Math.abs(l[0])>Math.abs(a[0])?Math.abs(l[0]):Math.abs(a[0]),Math.abs(l[1])>Math.abs(a[1])?Math.abs(l[1]):Math.abs(a[1]),Math.abs(l[2])>Math.abs(a[2])?Math.abs(l[2]):Math.abs(a[2])])},Mod.TranslatePlayerSkin=function(e,o){512===Mod.loadmodel.skinwidth&&256===Mod.loadmodel.skinheight||(e=GL.ResampleTexture(e,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight,512,256));var d,t,l=new Uint8Array(new ArrayBuffer(524288));for(d=0;d<131072;++d)(t=e[d])>>4==1?(l[d<<2]=17*(15&t),l[1+(d<<2)]=255):t>>4==6&&(l[2+(d<<2)]=17*(15&t),l[3+(d<<2)]=255);o.playertexture=gl.createTexture(),GL.Bind(0,o.playertexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,512,256,0,gl.RGBA,gl.UNSIGNED_BYTE,l),gl.generateMipmap(gl.TEXTURE_2D),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max)},Mod.FloodFillSkin=function(e){var o=e[0];if(o!==Mod.filledcolor){var d,t,l,a,n=Mod.loadmodel.skinwidth,i=Mod.loadmodel.skinheight,r=[[0,0]];for(d=1;d>0;)l=(t=r[--d])[0],e[(a=t[1])*n+l]=Mod.filledcolor,l>0&&e[a*n+l-1]===o&&(r[d++]=[l-1,a]),l<n-1&&e[a*n+l+1]===o&&(r[d++]=[l+1,a]),a>0&&e[(a-1)*n+l]===o&&(r[d++]=[l,a-1]),a<i-1&&e[(a+1)*n+l]===o&&(r[d++]=[l,a+1])}},Mod.LoadAllSkins=function(e,o){Mod.loadmodel.skins=[];var d,t,l,a,n,i=new DataView(e),r=Mod.loadmodel.skinwidth*Mod.loadmodel.skinheight;for(d=0;d<Mod.loadmodel.numskins;++d)if(o+=4,0===i.getUint32(o-4,!0))n=new Uint8Array(e,o,r),Mod.FloodFillSkin(n),Mod.loadmodel.skins[d]={group:!1,texturenum:GL.LoadTexture(Mod.loadmodel.name+"_"+d,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight,n)},!0===Mod.loadmodel.player&&Mod.TranslatePlayerSkin(new Uint8Array(e,o,r),Mod.loadmodel.skins[d]),o+=r;else{for(l={group:!0,skins:[]},a=i.getUint32(o,!0),o+=4,t=0;t<a;++t)l.skins[t]={interval:i.getFloat32(o,!0)},l.skins[t].interval<=0&&Sys.Error("Mod.LoadAllSkins: interval<=0"),o+=4;for(t=0;t<a;++t)n=new Uint8Array(e,o,r),Mod.FloodFillSkin(n),l.skins[t].texturenum=GL.LoadTexture(Mod.loadmodel.name+"_"+d+"_"+t,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight,n),!0===Mod.loadmodel.player&&Mod.TranslatePlayerSkin(new Uint8Array(e,o,r),l.skins[t]),o+=r;Mod.loadmodel.skins[d]=l}return o},Mod.LoadAllFrames=function(e,o){Mod.loadmodel.frames=[];var d,t,l,a,n,i,r=new DataView(e);for(d=0;d<Mod.loadmodel.numframes;++d)if(o+=4,0===r.getUint32(o-4,!0)){for(a={group:!1,bboxmin:[r.getUint8(o),r.getUint8(o+1),r.getUint8(o+2)],bboxmax:[r.getUint8(o+4),r.getUint8(o+5),r.getUint8(o+6)],name:Q.memstr(new Uint8Array(e,o+8,16)),v:[]},o+=24,t=0;t<Mod.loadmodel.numverts;++t)a.v[t]={v:[r.getUint8(o),r.getUint8(o+1),r.getUint8(o+2)],lightnormalindex:r.getUint8(o+3)},o+=4;Mod.loadmodel.frames[d]=a}else{for(n={group:!0,bboxmin:[r.getUint8(o+4),r.getUint8(o+5),r.getUint8(o+6)],bboxmax:[r.getUint8(o+8),r.getUint8(o+9),r.getUint8(o+10)],frames:[]},i=r.getUint32(o,!0),o+=12,t=0;t<i;++t)n.frames[t]={interval:r.getFloat32(o,!0)},n.frames[t].interval<=0&&Sys.Error("Mod.LoadAllFrames: interval<=0"),o+=4;for(t=0;t<i;++t)for((a=n.frames[t]).bboxmin=[r.getUint8(o),r.getUint8(o+1),r.getUint8(o+2)],a.bboxmax=[r.getUint8(o+4),r.getUint8(o+5),r.getUint8(o+6)],a.name=Q.memstr(new Uint8Array(e,o+8,16)),a.v=[],o+=24,l=0;l<Mod.loadmodel.numverts;++l)a.v[l]={v:[r.getUint8(o),r.getUint8(o+1),r.getUint8(o+2)],lightnormalindex:r.getUint8(o+3)},o+=4;Mod.loadmodel.frames[d]=n}},Mod.LoadAliasModel=function(e){var o,d,t,l;Mod.loadmodel.type=Mod.type.alias,Mod.loadmodel.player="progs/player.mdl"===Mod.loadmodel.name;var a=new DataView(e),n=a.getUint32(4,!0);n!==Mod.version.alias&&Sys.Error(Mod.loadmodel.name+" has wrong version number ("+n+" should be "+Mod.version.alias+")"),Mod.loadmodel.scale=[a.getFloat32(8,!0),a.getFloat32(12,!0),a.getFloat32(16,!0)],Mod.loadmodel.scale_origin=[a.getFloat32(20,!0),a.getFloat32(24,!0),a.getFloat32(28,!0)],Mod.loadmodel.boundingradius=a.getFloat32(32,!0),Mod.loadmodel.numskins=a.getUint32(48,!0),0===Mod.loadmodel.numskins&&Sys.Error("model "+Mod.loadmodel.name+" has no skins"),Mod.loadmodel.skinwidth=a.getUint32(52,!0),Mod.loadmodel.skinheight=a.getUint32(56,!0),Mod.loadmodel.numverts=a.getUint32(60,!0),0===Mod.loadmodel.numverts&&Sys.Error("model "+Mod.loadmodel.name+" has no vertices"),Mod.loadmodel.numtris=a.getUint32(64,!0),0===Mod.loadmodel.numtris&&Sys.Error("model "+Mod.loadmodel.name+" has no triangles"),Mod.loadmodel.numframes=a.getUint32(68,!0),0===Mod.loadmodel.numframes&&Sys.Error("model "+Mod.loadmodel.name+" has no frames"),Mod.loadmodel.random=1===a.getUint32(72,!0),Mod.loadmodel.flags=a.getUint32(76,!0),Mod.loadmodel.mins=[-16,-16,-16],Mod.loadmodel.maxs=[16,16,16];var i=Mod.LoadAllSkins(e,84);for(Mod.loadmodel.stverts=[],o=0;o<Mod.loadmodel.numverts;++o)Mod.loadmodel.stverts[o]={onseam:0!==a.getUint32(i,!0),s:a.getUint32(i+4,!0),t:a.getUint32(i+8,!0)},i+=12;for(Mod.loadmodel.triangles=[],o=0;o<Mod.loadmodel.numtris;++o)Mod.loadmodel.triangles[o]={facesfront:0!==a.getUint32(i,!0),vertindex:[a.getUint32(i+4,!0),a.getUint32(i+8,!0),a.getUint32(i+12,!0)]},i+=16;Mod.LoadAllFrames(e,i);var r,s,m,M,g=[];for(o=0;o<Mod.loadmodel.numtris;++o)if(!0!==(r=Mod.loadmodel.triangles[o]).facesfront)for(d=0;d<3;++d)!0===(s=Mod.loadmodel.stverts[r.vertindex[d]]).onseam?g[g.length]=(s.s+Mod.loadmodel.skinwidth/2+.5)/Mod.loadmodel.skinwidth:g[g.length]=(s.s+.5)/Mod.loadmodel.skinwidth,g[g.length]=(s.t+.5)/Mod.loadmodel.skinheight;else s=Mod.loadmodel.stverts[r.vertindex[0]],g[g.length]=(s.s+.5)/Mod.loadmodel.skinwidth,g[g.length]=(s.t+.5)/Mod.loadmodel.skinheight,s=Mod.loadmodel.stverts[r.vertindex[1]],g[g.length]=(s.s+.5)/Mod.loadmodel.skinwidth,g[g.length]=(s.t+.5)/Mod.loadmodel.skinheight,s=Mod.loadmodel.stverts[r.vertindex[2]],g[g.length]=(s.s+.5)/Mod.loadmodel.skinwidth,g[g.length]=(s.t+.5)/Mod.loadmodel.skinheight;for(o=0;o<Mod.loadmodel.numframes;++o)if(!0!==(m=Mod.loadmodel.frames[o]).group)for((M=m).cmdofs=g.length<<2,d=0;d<Mod.loadmodel.numtris;++d)for(r=Mod.loadmodel.triangles[d],t=0;t<3;++t)(s=M.v[r.vertindex[t]]).lightnormalindex>=162&&Sys.Error("lightnormalindex >= NUMVERTEXNORMALS"),g[g.length]=s.v[0]*Mod.loadmodel.scale[0]+Mod.loadmodel.scale_origin[0],g[g.length]=s.v[1]*Mod.loadmodel.scale[1]+Mod.loadmodel.scale_origin[1],g[g.length]=s.v[2]*Mod.loadmodel.scale[2]+Mod.loadmodel.scale_origin[2],g[g.length]=R.avertexnormals[s.lightnormalindex][0],g[g.length]=R.avertexnormals[s.lightnormalindex][1],g[g.length]=R.avertexnormals[s.lightnormalindex][2];else for(d=0;d<m.frames.length;++d)for((M=m.frames[d]).cmdofs=g.length<<2,t=0;t<Mod.loadmodel.numtris;++t)for(r=Mod.loadmodel.triangles[t],l=0;l<3;++l)(s=M.v[r.vertindex[l]]).lightnormalindex>=162&&Sys.Error("lightnormalindex >= NUMVERTEXNORMALS"),g[g.length]=s.v[0]*Mod.loadmodel.scale[0]+Mod.loadmodel.scale_origin[0],g[g.length]=s.v[1]*Mod.loadmodel.scale[1]+Mod.loadmodel.scale_origin[1],g[g.length]=s.v[2]*Mod.loadmodel.scale[2]+Mod.loadmodel.scale_origin[2],g[g.length]=R.avertexnormals[s.lightnormalindex][0],g[g.length]=R.avertexnormals[s.lightnormalindex][1],g[g.length]=R.avertexnormals[s.lightnormalindex][2];Mod.loadmodel.cmds=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,Mod.loadmodel.cmds),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(g),gl.STATIC_DRAW)},Mod.LoadSpriteFrame=function(e,o,d,t){var l,a=new DataView(o);t.origin=[a.getInt32(d,!0),-a.getInt32(d+4,!0)],t.width=a.getUint32(d+8,!0),t.height=a.getUint32(d+12,!0);var n,i=t.width*t.height;for(l=0;l<GL.textures.length;++l)if((n=GL.textures[l]).identifier===e)return width===n.width&&height===n.height||Sys.Error("Mod.LoadSpriteFrame: cache mismatch"),t.texturenum=n.texnum,d+16+t.width*t.height;var r=new Uint8Array(o,d+16,i),s=t.width,m=t.height;0==(t.width&t.width-1)&&0==(t.height&t.height-1)||(--s,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,++s,--m,m|=m>>1,m|=m>>2,m|=m>>4,m|=m>>8,m|=m>>16,++m),s>GL.maxtexturesize&&(s=GL.maxtexturesize),m>GL.maxtexturesize&&(m=GL.maxtexturesize),s===t.width&&m===t.height||(i=s*m,r=GL.ResampleTexture(r,t.width,t.height,s,m));var M=new ArrayBuffer(i<<2),g=new Uint32Array(M);for(l=0;l<i;++l)255!==r[l]&&(g[l]=COM.LittleLong(VID.d_8to24table[r[l]]+4278190080));return n={texnum:gl.createTexture(),identifier:e,width:t.width,height:t.height},GL.Bind(0,n.texnum),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,s,m,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(M)),gl.generateMipmap(gl.TEXTURE_2D),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max),GL.textures[GL.textures.length]=n,t.texturenum=n.texnum,d+16+t.width*t.height},Mod.LoadSpriteModel=function(e){Mod.loadmodel.type=Mod.type.sprite;var o=new DataView(e),d=o.getUint32(4,!0);d!==Mod.version.sprite&&Sys.Error(Mod.loadmodel.name+" has wrong version number ("+d+" should be "+Mod.version.sprite+")"),Mod.loadmodel.oriented=3===o.getUint32(8,!0),Mod.loadmodel.boundingradius=o.getFloat32(12,!0),Mod.loadmodel.width=o.getUint32(16,!0),Mod.loadmodel.height=o.getUint32(20,!0),Mod.loadmodel.numframes=o.getUint32(24,!0),0===Mod.loadmodel.numframes&&Sys.Error("model "+Mod.loadmodel.name+" has no frames"),Mod.loadmodel.random=1===o.getUint32(32,!0),Mod.loadmodel.mins=[-.5*Mod.loadmodel.width,-.5*Mod.loadmodel.width,-.5*Mod.loadmodel.height],Mod.loadmodel.maxs=[.5*Mod.loadmodel.width,.5*Mod.loadmodel.width,.5*Mod.loadmodel.height],Mod.loadmodel.frames=[];var t,l,a,n,i,r=36;for(t=0;t<Mod.loadmodel.numframes;++t)if(r+=4,0===o.getUint32(r-4,!0))a={group:!1},Mod.loadmodel.frames[t]=a,r=Mod.LoadSpriteFrame(Mod.loadmodel.name+"_"+t+"_"+l,e,r,a);else{for(n={group:!0,frames:[]},Mod.loadmodel.frames[t]=n,i=o.getUint32(r,!0),r+=4,l=0;l<i;++l)n.frames[l]={interval:o.getFloat32(r,!0)},n.frames[l].interval<=0&&Sys.Error("Mod.LoadSpriteModel: interval<=0"),r+=4;for(l=0;l<i;++l)r=Mod.LoadSpriteFrame(Mod.loadmodel.name+"_"+t+"_"+l,e,r,n.frames[l])}},Mod.Print=function(){var e;for(Con.Print("Cached models:\n"),e=0;e<Mod.known.length;++e)Con.Print(Mod.known[e].name+"\n")};

			// MSG.js
			MSG={},MSG.WriteChar=function(e,t){new DataView(e.data).setInt8(SZ.GetSpace(e,1),t)},MSG.WriteByte=function(e,t){new DataView(e.data).setUint8(SZ.GetSpace(e,1),t)},MSG.WriteShort=function(e,t){new DataView(e.data).setInt16(SZ.GetSpace(e,2),t,!0)},MSG.WriteLong=function(e,t){new DataView(e.data).setInt32(SZ.GetSpace(e,4),t,!0)},MSG.WriteFloat=function(e,t){new DataView(e.data).setFloat32(SZ.GetSpace(e,4),t,!0)},MSG.WriteString=function(e,t){null!=t&&SZ.Write(e,new Uint8Array(Q.strmem(t)),t.length),MSG.WriteChar(e,0)},MSG.WriteCoord=function(e,t){MSG.WriteShort(e,8*t)},MSG.WriteAngle=function(e,t){MSG.WriteByte(e,256/360*(t>>0)&255)},MSG.BeginReading=function(){MSG.readcount=0,MSG.badread=!1},MSG.ReadChar=function(){if(MSG.readcount>=NET.message.cursize)return MSG.badread=!0,-1;var e=new Int8Array(NET.message.data,MSG.readcount,1)[0];return++MSG.readcount,e},MSG.ReadByte=function(){if(MSG.readcount>=NET.message.cursize)return MSG.badread=!0,-1;var e=new Uint8Array(NET.message.data,MSG.readcount,1)[0];return++MSG.readcount,e},MSG.ReadShort=function(){if(MSG.readcount+2>NET.message.cursize)return MSG.badread=!0,-1;var e=new DataView(NET.message.data).getInt16(MSG.readcount,!0);return MSG.readcount+=2,e},MSG.ReadLong=function(){if(MSG.readcount+4>NET.message.cursize)return MSG.badread=!0,-1;var e=new DataView(NET.message.data).getInt32(MSG.readcount,!0);return MSG.readcount+=4,e},MSG.ReadFloat=function(){if(MSG.readcount+4>NET.message.cursize)return MSG.badread=!0,-1;var e=new DataView(NET.message.data).getFloat32(MSG.readcount,!0);return MSG.readcount+=4,e},MSG.ReadString=function(){var e,t,a=[];for(e=0;e<2048&&!((t=MSG.ReadByte())<=0);++e)a[e]=String.fromCharCode(t);return a.join("")},MSG.ReadCoord=function(){return.125*MSG.ReadShort()},MSG.ReadAngle=function(){return 1.40625*MSG.ReadChar()};

			// NET.js
			NET={},NET.activeSockets=[],NET.message={data:new ArrayBuffer(8192),cursize:0},NET.activeconnections=0,NET.NewQSocket=function(){var e;for(e=0;e<NET.activeSockets.length&&!0!==NET.activeSockets[e].disconnected;++e);return NET.activeSockets[e]={connecttime:NET.time,lastMessageTime:NET.time,driver:NET.driverlevel,address:"UNSET ADDRESS"},NET.activeSockets[e]},NET.Connect=function(e){if(NET.time=Sys.FloatTime(),"local"===e)return NET.driverlevel=0,Loop.Connect(e);var n,t;for(NET.driverlevel=1;NET.driverlevel<NET.drivers.length;++NET.driverlevel)if(!0===(n=NET.drivers[NET.driverlevel]).initialized){if(0===(t=n.Connect(e)))throw CL.cls.state=CL.active.connecting,Con.Print("trying...\n"),NET.start_time=NET.time,NET.reps=0,"NET.Connect";if(null!=t)return t}},NET.CheckForResend=function(){NET.time=Sys.FloatTime();var e=NET.drivers[NET.newsocket.driver];NET.reps<=2?NET.time-NET.start_time>=2.5*(NET.reps+1)&&(Con.Print("still trying...\n"),++NET.reps):3===NET.reps&&NET.time-NET.start_time>=10&&(NET.Close(NET.newsocket),CL.cls.state=CL.active.disconnected,Con.Print("No Response\n"),Host.Error("NET.CheckForResend: connect failed\n"));var n=e.CheckForResend();1===n?(NET.newsocket.disconnected=!1,CL.Connect(NET.newsocket)):-1===n&&(NET.newsocket.disconnected=!1,NET.Close(NET.newsocket),CL.cls.state=CL.active.disconnected,Con.Print("Network Error\n"),Host.Error("NET.CheckForResend: connect failed\n"))},NET.CheckNewConnections=function(){var e,n;for(NET.time=Sys.FloatTime(),NET.driverlevel=0;NET.driverlevel<NET.drivers.length;++NET.driverlevel)if(!0===(e=NET.drivers[NET.driverlevel]).initialized&&null!=(n=e.CheckNewConnections()))return n},NET.Close=function(e){null!=e&&!0!==e.disconnected&&(NET.time=Sys.FloatTime(),NET.drivers[e.driver].Close(e),e.disconnected=!0)},NET.GetMessage=function(e){if(null==e)return-1;if(!0===e.disconnected)return Con.Print("NET.GetMessage: disconnected socket\n"),-1;NET.time=Sys.FloatTime();var n=NET.drivers[e.driver].GetMessage(e);if(0!==e.driver)if(0===n){if(NET.time-e.lastMessageTime>NET.messagetimeout.value)return NET.Close(e),-1}else n>0&&(e.lastMessageTime=NET.time);return n},NET.SendMessage=function(e,n){return null==e?-1:!0===e.disconnected?(Con.Print("NET.SendMessage: disconnected socket\n"),-1):(NET.time=Sys.FloatTime(),NET.drivers[e.driver].SendMessage(e,n))},NET.SendUnreliableMessage=function(e,n){return null==e?-1:!0===e.disconnected?(Con.Print("NET.SendUnreliableMessage: disconnected socket\n"),-1):(NET.time=Sys.FloatTime(),NET.drivers[e.driver].SendUnreliableMessage(e,n))},NET.CanSendMessage=function(e){if(null!=e&&!0!==e.disconnected)return NET.time=Sys.FloatTime(),NET.drivers[e.driver].CanSendMessage(e)},NET.SendToAll=function(e){var n,t=0,i=[],s=[];for(n=0;n<SV.svs.maxclients;++n)Host.client=SV.svs.clients[n],null!=Host.client.netconnection&&(!0===Host.client.active?0!==Host.client.netconnection.driver?(++t,i[n]=s[n]=!1):(NET.SendMessage(Host.client.netconnection,e),i[n]=s[n]=!0):i[n]=s[n]=!0);for(var r=Sys.FloatTime();0!==t;){for(t=0,n=0;n<SV.svs.maxclients;++n)Host.client=SV.svs.clients[n],!0===i[n]?!0!==s[n]&&(!0===NET.CanSendMessage(Host.client.netconnection)?s[n]=!0:NET.GetMessage(Host.client.netconnection),++t):(!0===NET.CanSendMessage(Host.client.netconnection)?(i[n]=!0,NET.SendMessage(Host.client.netconnection,e)):NET.GetMessage(Host.client.netconnection),++t);if(Sys.FloatTime()-r>5)return t}return t},NET.Init=function(){for(NET.time=Sys.FloatTime(),NET.messagetimeout=Cvar.RegisterVariable("net_messagetimeout","300"),NET.hostname=Cvar.RegisterVariable("hostname","UNNAMED"),NET.drivers=[Loop,WEBS],NET.driverlevel=0;NET.driverlevel<NET.drivers.length;++NET.driverlevel)NET.drivers[NET.driverlevel].initialized=NET.drivers[NET.driverlevel].Init()},NET.Shutdown=function(){for(NET.time=Sys.FloatTime(),i=0;i<NET.activeSockets.length;++i)NET.Close(NET.activeSockets[i])};

			// NET_Loop.js
			Loop={},Loop.Init=function(){return!0},Loop.Connect=function(e){if("local"===e)return Loop.localconnectpending=!0,null==Loop.client&&(Loop.client=NET.NewQSocket(),Loop.client.receiveMessage=new Uint8Array(new ArrayBuffer(8192)),Loop.client.address="localhost"),Loop.client.receiveMessageLength=0,Loop.client.canSend=!0,null==Loop.server&&(Loop.server=NET.NewQSocket(),Loop.server.receiveMessage=new Uint8Array(new ArrayBuffer(8192)),Loop.server.address="LOCAL"),Loop.server.receiveMessageLength=0,Loop.server.canSend=!0,Loop.client.driverdata=Loop.server,Loop.server.driverdata=Loop.client,Loop.client},Loop.CheckNewConnections=function(){if(!0===Loop.localconnectpending)return Loop.localconnectpending=!1,Loop.server.receiveMessageLength=0,Loop.server.canSend=!0,Loop.client.receiveMessageLength=0,Loop.client.canSend=!0,Loop.server},Loop.GetMessage=function(e){if(0===e.receiveMessageLength)return 0;var r,n=e.receiveMessage[0],o=e.receiveMessage[1]+(e.receiveMessage[2]<<8);if(o>NET.message.data.byteLength&&Sys.Error("Loop.GetMessage: overflow"),NET.message.cursize=o,new Uint8Array(NET.message.data).set(e.receiveMessage.subarray(3,o+3)),e.receiveMessageLength-=o,e.receiveMessageLength>=4)for(r=0;r<e.receiveMessageLength;++r)e.receiveMessage[r]=e.receiveMessage[o+3+r];return e.receiveMessageLength-=3,null!=e.driverdata&&1===n&&(e.driverdata.canSend=!0),n},Loop.SendMessage=function(e,r){if(null==e.driverdata)return-1;var n=e.driverdata.receiveMessageLength;e.driverdata.receiveMessageLength+=r.cursize+3,e.driverdata.receiveMessageLength>8192&&Sys.Error("Loop.SendMessage: overflow");var o=e.driverdata.receiveMessage;return o[n]=1,o[n+1]=255&r.cursize,o[n+2]=r.cursize>>8,o.set(new Uint8Array(r.data,0,r.cursize),n+3),e.canSend=!1,1},Loop.SendUnreliableMessage=function(e,r){if(null==e.driverdata)return-1;var n=e.driverdata.receiveMessageLength;e.driverdata.receiveMessageLength+=r.cursize+3,e.driverdata.receiveMessageLength>8192&&Sys.Error("Loop.SendMessage: overflow");var o=e.driverdata.receiveMessage;return o[n]=2,o[n+1]=255&r.cursize,o[n+2]=r.cursize>>8,o.set(new Uint8Array(r.data,0,r.cursize),n+3),1},Loop.CanSendMessage=function(e){if(null!=e.driverdata)return e.canSend},Loop.Close=function(e){null!=e.driverdata&&(e.driverdata.driverdata=null),e.receiveMessageLength=0,e.canSend=!1,e===Loop.client?Loop.client=null:Loop.server=null};

			// NET_WEBS.js
			WEBS={},WEBS.Init=function(){if(null!=window.WebSocket&&"https:"!==document.location.protocol)return WEBS.available=!0,!0},WEBS.Connect=function(e){if(!(e.length<=5)&&47!==e.charCodeAt(5)&&"ws://"===e.substring(0,5)){e="ws://"+e.split("/")[2];var r=NET.NewQSocket();r.disconnected=!0,r.receiveMessage=[],r.address=e;try{r.driverdata=new WebSocket(e,"quake")}catch(e){return}return r.driverdata.data_socket=r,r.driverdata.binaryType="arraybuffer",r.driverdata.onerror=WEBS.OnError,r.driverdata.onmessage=WEBS.OnMessage,NET.newsocket=r,0}},WEBS.CheckNewConnections=function(){},WEBS.GetMessage=function(e){if(null==e.driverdata)return-1;if(1!==e.driverdata.readyState)return-1;if(0===e.receiveMessage.length)return 0;var r=e.receiveMessage.shift();return NET.message.cursize=r.length-1,new Uint8Array(NET.message.data).set(r.subarray(1)),r[0]},WEBS.SendMessage=function(e,r){if(null==e.driverdata)return-1;if(1!==e.driverdata.readyState)return-1;var t=new ArrayBuffer(r.cursize+1),a=new Uint8Array(t);return a[0]=1,a.set(new Uint8Array(r.data,0,r.cursize),1),e.driverdata.send(t),1},WEBS.SendUnreliableMessage=function(e,r){if(null==e.driverdata)return-1;if(1!==e.driverdata.readyState)return-1;var t=new ArrayBuffer(r.cursize+1),a=new Uint8Array(t);return a[0]=2,a.set(new Uint8Array(r.data,0,r.cursize),1),e.driverdata.send(t),1},WEBS.CanSendMessage=function(e){if(null!=e.driverdata)return 1===e.driverdata.readyState||void 0},WEBS.Close=function(e){null!=e.driverdata&&e.driverdata.close(1e3)},WEBS.CheckForResend=function(){return 1===NET.newsocket.driverdata.readyState?1:0!==NET.newsocket.driverdata.readyState?-1:void 0},WEBS.OnError=function(){NET.Close(this.data_socket)},WEBS.OnMessage=function(e){var r=e.data;"string"!=typeof r&&(r.byteLength>8e3||this.data_socket.receiveMessage.push(new Uint8Array(r)))};

			// PF.js
			PF={},PF.VarString=function(t){var a,l="";for(a=t;a<PR.argc;++a)l+=PR.GetString(PR.globals_int[4+3*a]);return l},PF.error=function(){Con.Print("======SERVER ERROR in "+PR.GetString(PR.xfunction.name)+"\n"+PF.VarString(0)+"\n"),ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]),Host.Error("Program error")},PF.objerror=function(){Con.Print("======OBJECT ERROR in "+PR.GetString(PR.xfunction.name)+"\n"+PF.VarString(0)+"\n"),ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]),Host.Error("Program error")},PF.makevectors=function(){var t,a=[],l=[],e=[];for(Vec.AngleVectors([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],a,l,e),t=0;t<=2;++t)PR.globals_float[PR.globalvars.v_forward+t]=a[t],PR.globals_float[PR.globalvars.v_right+t]=l[t],PR.globals_float[PR.globalvars.v_up+t]=e[t]},PF.setorigin=function(){var t=SV.server.edicts[PR.globals_int[4]];t.v_float[PR.entvars.origin]=PR.globals_float[7],t.v_float[PR.entvars.origin1]=PR.globals_float[8],t.v_float[PR.entvars.origin2]=PR.globals_float[9],SV.LinkEdict(t)},PF.SetMinMaxSize=function(t,a,l){(a[0]>l[0]||a[1]>l[1]||a[2]>l[2])&&PR.RunError("backwards mins/maxs"),ED.SetVector(t,PR.entvars.mins,a),ED.SetVector(t,PR.entvars.maxs,l),t.v_float[PR.entvars.size]=l[0]-a[0],t.v_float[PR.entvars.size1]=l[1]-a[1],t.v_float[PR.entvars.size2]=l[2]-a[2],SV.LinkEdict(t)},PF.setsize=function(){PF.SetMinMaxSize(SV.server.edicts[PR.globals_int[4]],[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],[PR.globals_float[10],PR.globals_float[11],PR.globals_float[12]])},PF.setmodel=function(){var t,a=SV.server.edicts[PR.globals_int[4]],l=PR.GetString(PR.globals_int[7]);for(t=0;t<SV.server.model_precache.length&&SV.server.model_precache[t]!==l;++t);t===SV.server.model_precache.length&&PR.RunError("no precache: "+l+"\n"),a.v_int[PR.entvars.model]=PR.globals_int[7],a.v_float[PR.entvars.modelindex]=t;var e=SV.server.models[t];null!=e?PF.SetMinMaxSize(a,e.mins,e.maxs):PF.SetMinMaxSize(a,Vec.origin,Vec.origin)},PF.bprint=function(){Host.BroadcastPrint(PF.VarString(0))},PF.sprint=function(){var t=PR.globals_int[4];if(t<=0||t>SV.svs.maxclients)Con.Print("tried to sprint to a non-client\n");else{var a=SV.svs.clients[t-1];MSG.WriteByte(a.message,Protocol.svc.print),MSG.WriteString(a.message,PF.VarString(1))}},PF.centerprint=function(){var t=PR.globals_int[4];if(t<=0||t>SV.svs.maxclients)Con.Print("tried to sprint to a non-client\n");else{var a=SV.svs.clients[t-1];MSG.WriteByte(a.message,Protocol.svc.centerprint),MSG.WriteString(a.message,PF.VarString(1))}},PF.normalize=function(){var t=[PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]];Vec.Normalize(t),PR.globals_float[1]=t[0],PR.globals_float[2]=t[1],PR.globals_float[3]=t[2]},PF.vlen=function(){PR.globals_float[1]=Math.sqrt(PR.globals_float[4]*PR.globals_float[4]+PR.globals_float[5]*PR.globals_float[5]+PR.globals_float[6]*PR.globals_float[6])},PF.vectoyaw=function(){var t=PR.globals_float[4],a=PR.globals_float[5];if(0!==t||0!==a){var l=180*Math.atan2(a,t)/Math.PI>>0;l<0&&(l+=360),PR.globals_float[1]=l}else PR.globals_float[1]=0},PF.vectoangles=function(){PR.globals_float[3]=0;var t=[PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]];if(0===t[0]&&0===t[1])return PR.globals_float[1]=t[2]>0?90:270,void(PR.globals_float[2]=0);var a=180*Math.atan2(t[1],t[0])/Math.PI>>0;a<0&&(a+=360);var l=180*Math.atan2(t[2],Math.sqrt(t[0]*t[0]+t[1]*t[1]))/Math.PI>>0;l<0&&(l+=360),PR.globals_float[1]=l,PR.globals_float[2]=a},PF.random=function(){PR.globals_float[1]=Math.random()},PF.particle=function(){SV.StartParticle([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],PR.globals_float[10]>>0,PR.globals_float[13]>>0)},PF.ambientsound=function(){var t,a=PR.GetString(PR.globals_int[7]);for(t=0;t<SV.server.sound_precache.length&&SV.server.sound_precache[t]!==a;++t);if(t!==SV.server.sound_precache.length){var l=SV.server.signon;MSG.WriteByte(l,Protocol.svc.spawnstaticsound),MSG.WriteCoord(l,PR.globals_float[4]),MSG.WriteCoord(l,PR.globals_float[5]),MSG.WriteCoord(l,PR.globals_float[6]),MSG.WriteByte(l,t),MSG.WriteByte(l,255*PR.globals_float[10]),MSG.WriteByte(l,64*PR.globals_float[13])}else Con.Print("no precache: "+a+"\n")},PF.sound=function(){SV.StartSound(SV.server.edicts[PR.globals_int[4]],PR.globals_float[7]>>0,PR.GetString(PR.globals_int[10]),255*PR.globals_float[13]>>0,PR.globals_float[16])},PF.breakstatement=function(){Con.Print("break statement\n")},PF.traceline=function(){var t=SV.Move([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],Vec.origin,Vec.origin,[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],PR.globals_float[10]>>0,SV.server.edicts[PR.globals_int[13]]);PR.globals_float[PR.globalvars.trace_allsolid]=!0===t.allsolid?1:0,PR.globals_float[PR.globalvars.trace_startsolid]=!0===t.startsolid?1:0,PR.globals_float[PR.globalvars.trace_fraction]=t.fraction,PR.globals_float[PR.globalvars.trace_inwater]=!0===t.inwater?1:0,PR.globals_float[PR.globalvars.trace_inopen]=!0===t.inopen?1:0,PR.globals_float[PR.globalvars.trace_endpos]=t.endpos[0],PR.globals_float[PR.globalvars.trace_endpos1]=t.endpos[1],PR.globals_float[PR.globalvars.trace_endpos2]=t.endpos[2];var a=t.plane;PR.globals_float[PR.globalvars.trace_plane_normal]=a.normal[0],PR.globals_float[PR.globalvars.trace_plane_normal1]=a.normal[1],PR.globals_float[PR.globalvars.trace_plane_normal2]=a.normal[2],PR.globals_float[PR.globalvars.trace_plane_dist]=a.dist,PR.globals_int[PR.globalvars.trace_ent]=null!=t.ent?t.ent.num:0},PF.newcheckclient=function(t){t<=0?t=1:t>SV.svs.maxclients&&(t=SV.svs.maxclients);var a,l=1;for(t!==SV.svs.maxclients&&(l+=t);(l===SV.svs.maxclients+1&&(l=1),a=SV.server.edicts[l],l!==t)&&(!0===a.free||(a.v_float[PR.entvars.health]<=0||0!=(a.v_float[PR.entvars.flags]&SV.fl.notarget)));++l);return PF.checkpvs=Mod.LeafPVS(Mod.PointInLeaf([a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.view_ofs],a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.view_ofs1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.view_ofs2]],SV.server.worldmodel),SV.server.worldmodel),l},PF.checkclient=function(){SV.server.time-SV.server.lastchecktime>=.1&&(SV.server.lastcheck=PF.newcheckclient(SV.server.lastcheck),SV.server.lastchecktime=SV.server.time);var t=SV.server.edicts[SV.server.lastcheck];if(!0===t.free||t.v_float[PR.entvars.health]<=0)PR.globals_int[1]=0;else{var a=SV.server.edicts[PR.globals_int[PR.globalvars.self]],l=Mod.PointInLeaf([a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.view_ofs],a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.view_ofs1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.view_ofs2]],SV.server.worldmodel).num-1;l<0||0==(PF.checkpvs[l>>3]&1<<(7&l))?PR.globals_int[1]=0:PR.globals_int[1]=t.num}},PF.stuffcmd=function(){var t=PR.globals_int[4];(t<=0||t>SV.svs.maxclients)&&PR.RunError("Parm 0 not a client");var a=SV.svs.clients[t-1];MSG.WriteByte(a.message,Protocol.svc.stufftext),MSG.WriteString(a.message,PR.GetString(PR.globals_int[7]))},PF.localcmd=function(){Cmd.text+=PR.GetString(PR.globals_int[4])},PF.cvar=function(){var t=Cvar.FindVar(PR.GetString(PR.globals_int[4]));PR.globals_float[1]=null!=t?t.value:0},PF.cvar_set=function(){Cvar.Set(PR.GetString(PR.globals_int[4]),PR.GetString(PR.globals_int[7]))},PF.findradius=function(){var t,a,l=0,e=[PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],o=[],r=PR.globals_float[7];for(t=1;t<SV.server.num_edicts;++t)!0!==(a=SV.server.edicts[t]).free&&a.v_float[PR.entvars.solid]!==SV.solid.not&&(o[0]=e[0]-(a.v_float[PR.entvars.origin]+.5*(a.v_float[PR.entvars.mins]+a.v_float[PR.entvars.maxs])),o[1]=e[1]-(a.v_float[PR.entvars.origin1]+.5*(a.v_float[PR.entvars.mins1]+a.v_float[PR.entvars.maxs1])),o[2]=e[2]-(a.v_float[PR.entvars.origin2]+.5*(a.v_float[PR.entvars.mins2]+a.v_float[PR.entvars.maxs2])),Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2])>r||(a.v_int[PR.entvars.chain]=l,l=t));PR.globals_int[1]=l},PF.dprint=function(){Con.DPrint(PF.VarString(0))},PF.ftos=function(){var t=PR.globals_float[4];t===Math.floor(t)?PR.TempString(t.toString()):PR.TempString(t.toFixed(1)),PR.globals_int[1]=PR.string_temp},PF.fabs=function(){PR.globals_float[1]=Math.abs(PR.globals_float[4])},PF.vtos=function(){PR.TempString(PR.globals_float[4].toFixed(1)+" "+PR.globals_float[5].toFixed(1)+" "+PR.globals_float[6].toFixed(1)),PR.globals_int[1]=PR.string_temp},PF.Spawn=function(){PR.globals_int[1]=ED.Alloc().num},PF.Remove=function(){ED.Free(SV.server.edicts[PR.globals_int[4]])},PF.Find=function(){var t,a=PR.globals_int[4],l=PR.globals_int[7],e=PR.GetString(PR.globals_int[10]);for(++a;a<SV.server.num_edicts;++a)if(!0!==(t=SV.server.edicts[a]).free&&PR.GetString(t.v_int[l])===e)return void(PR.globals_int[1]=t.num);PR.globals_int[1]=0},PF.MoveToGoal=function(){var t=SV.server.edicts[PR.globals_int[PR.globalvars.self]];if(0!=(t.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+SV.fl.swim)){var a=SV.server.edicts[t.v_int[PR.entvars.goalentity]],l=PR.globals_float[4];0!==t.v_int[PR.entvars.enemy]&&!0===SV.CloseEnough(t,a,l)||(Math.random()>=.75||!0!==SV.StepDirection(t,t.v_float[PR.entvars.ideal_yaw],l))&&SV.NewChaseDir(t,a,l)}else PR.globals_float[1]=0},PF.precache_file=function(){PR.globals_int[1]=PR.globals_int[4]},PF.precache_sound=function(){var t,a=PR.GetString(PR.globals_int[4]);for(PR.globals_int[1]=PR.globals_int[4],PR.CheckEmptyString(a),t=0;t<SV.server.sound_precache.length;++t)if(SV.server.sound_precache[t]===a)return;SV.server.sound_precache[t]=a},PF.precache_model=function(){!0!==SV.server.loading&&PR.RunError("PF.Precache_*: Precache can only be done in spawn functions");var t,a=PR.GetString(PR.globals_int[4]);for(PR.globals_int[1]=PR.globals_int[4],PR.CheckEmptyString(a),t=0;t<SV.server.model_precache.length;++t)if(SV.server.model_precache[t]===a)return;SV.server.model_precache[t]=a,SV.server.models[t]=Mod.ForName(a,!0)},PF.coredump=function(){ED.PrintEdicts()},PF.traceon=function(){PR.trace=!0},PF.traceoff=function(){PR.trace=!1},PF.eprint=function(){ED.Print(SV.server.edicts[PR.globals_float[4]])},PF.walkmove=function(){var t=SV.server.edicts[PR.globals_int[PR.globalvars.self]];if(0!=(t.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+SV.fl.swim)){var a=PR.globals_float[4]*Math.PI/180,l=PR.globals_float[7],e=PR.xfunction;PR.globals_float[1]=SV.movestep(t,[Math.cos(a)*l,Math.sin(a)*l],!0),PR.xfunction=e,PR.globals_int[PR.globalvars.self]=t.num}else PR.globals_float[1]=0},PF.droptofloor=function(){var t=SV.server.edicts[PR.globals_int[PR.globalvars.self]],a=SV.Move(ED.Vector(t,PR.entvars.origin),ED.Vector(t,PR.entvars.mins),ED.Vector(t,PR.entvars.maxs),[t.v_float[PR.entvars.origin],t.v_float[PR.entvars.origin1],t.v_float[PR.entvars.origin2]-256],0,t);1!==a.fraction&&!0!==a.allsolid?(ED.SetVector(t,PR.entvars.origin,a.endpos),SV.LinkEdict(t),t.v_float[PR.entvars.flags]|=SV.fl.onground,t.v_int[PR.entvars.groundentity]=a.ent.num,PR.globals_float[1]=1):PR.globals_float[1]=0},PF.lightstyle=function(){var t,a,l=PR.globals_float[4]>>0,e=PR.GetString(PR.globals_int[7]);if(SV.server.lightstyles[l]=e,!0!==SV.server.loading)for(t=0;t<SV.svs.maxclients;++t)!0!==(a=SV.svs.clients[t]).active&&!0!==a.spawned||(MSG.WriteByte(a.message,Protocol.svc.lightstyle),MSG.WriteByte(a.message,l),MSG.WriteString(a.message,e))},PF.rint=function(){var t=PR.globals_float[4];PR.globals_float[1]=(t>=0?t+.5:t-.5)>>0},PF.floor=function(){PR.globals_float[1]=Math.floor(PR.globals_float[4])},PF.ceil=function(){PR.globals_float[1]=Math.ceil(PR.globals_float[4])},PF.checkbottom=function(){PR.globals_float[1]=SV.CheckBottom(SV.server.edicts[PR.globals_int[4]])},PF.pointcontents=function(){PR.globals_float[1]=SV.PointContents([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]])},PF.nextent=function(){var t;for(t=PR.globals_int[4]+1;t<SV.server.num_edicts;++t)if(!0!==SV.server.edicts[t].free)return void(PR.globals_int[1]=t);PR.globals_int[1]=0},PF.aim=function(){var t=SV.server.edicts[PR.globals_int[4]],a=[t.v_float[PR.entvars.origin],t.v_float[PR.entvars.origin1],t.v_float[PR.entvars.origin2]+20],l=[PR.globals_float[PR.globalvars.v_forward],PR.globals_float[PR.globalvars.v_forward1],PR.globals_float[PR.globalvars.v_forward2]],e=[a[0]+2048*l[0],a[1]+2048*l[1],a[2]+2048*l[2]],o=SV.Move(a,Vec.origin,Vec.origin,e,0,t);if(null!=o.ent&&o.ent.v_float[PR.entvars.takedamage]===SV.damage.aim&&(0===Host.teamplay.value||t.v_float[PR.entvars.team]<=0||t.v_float[PR.entvars.team]!==o.ent.v_float[PR.entvars.team]))return PR.globals_float[1]=l[0],PR.globals_float[2]=l[1],void(PR.globals_float[3]=l[2]);var r,n,s,i,P=[l[0],l[1],l[2]],v=SV.aim.value;e=[];for(n=1;n<SV.server.num_edicts;++n)(s=SV.server.edicts[n]).v_float[PR.entvars.takedamage]===SV.damage.aim&&s!==t&&(0!==Host.teamplay.value&&t.v_float[PR.entvars.team]>0&&t.v_float[PR.entvars.team]===s.v_float[PR.entvars.team]||(e[0]=s.v_float[PR.entvars.origin]+.5*(s.v_float[PR.entvars.mins]+s.v_float[PR.entvars.maxs]),e[1]=s.v_float[PR.entvars.origin1]+.5*(s.v_float[PR.entvars.mins1]+s.v_float[PR.entvars.maxs1]),e[2]=s.v_float[PR.entvars.origin2]+.5*(s.v_float[PR.entvars.mins2]+s.v_float[PR.entvars.maxs2]),l[0]=e[0]-a[0],l[1]=e[1]-a[1],l[2]=e[2]-a[2],Vec.Normalize(l),(i=l[0]*P[0]+l[1]*P[1]+l[2]*P[2])<v||(o=SV.Move(a,Vec.origin,Vec.origin,e,0,t)).ent===s&&(v=i,r=s)));if(null!=r)return l[0]=r.v_float[PR.entvars.origin]-t.v_float[PR.entvars.origin],l[1]=r.v_float[PR.entvars.origin1]-t.v_float[PR.entvars.origin1],l[2]=r.v_float[PR.entvars.origin2]-t.v_float[PR.entvars.origin2],i=l[0]*P[0]+l[1]*P[1]+l[2]*P[2],e[0]=P[0]*i,e[1]=P[1]*i,e[2]=l[2],Vec.Normalize(e),PR.globals_float[1]=e[0],PR.globals_float[2]=e[1],void(PR.globals_float[3]=e[2]);PR.globals_float[1]=P[0],PR.globals_float[2]=P[1],PR.globals_float[3]=P[2]},PF.changeyaw=function(){var t=SV.server.edicts[PR.globals_int[PR.globalvars.self]],a=Vec.Anglemod(t.v_float[PR.entvars.angles1]),l=t.v_float[PR.entvars.ideal_yaw];if(a!==l){var e=l-a;l>a?e>=180&&(e-=360):e<=-180&&(e+=360);var o=t.v_float[PR.entvars.yaw_speed];e>0?e>o&&(e=o):e<-o&&(e=-o),t.v_float[PR.entvars.angles1]=Vec.Anglemod(a+e)}},PF.WriteDest=function(){switch(PR.globals_float[4]>>0){case 0:return SV.server.datagram;case 1:var t=PR.globals_int[PR.globalvars.msg_entity];return(t<=0||t>SV.svs.maxclients)&&PR.RunError("WriteDest: not a client"),SV.svs.clients[t-1].message;case 2:return SV.server.reliable_datagram;case 3:return SV.server.signon}PR.RunError("WriteDest: bad destination")},PF.WriteByte=function(){MSG.WriteByte(PF.WriteDest(),PR.globals_float[7])},PF.WriteChar=function(){MSG.WriteChar(PF.WriteDest(),PR.globals_float[7])},PF.WriteShort=function(){MSG.WriteShort(PF.WriteDest(),PR.globals_float[7])},PF.WriteLong=function(){MSG.WriteLong(PF.WriteDest(),PR.globals_float[7])},PF.WriteAngle=function(){MSG.WriteAngle(PF.WriteDest(),PR.globals_float[7])},PF.WriteCoord=function(){MSG.WriteCoord(PF.WriteDest(),PR.globals_float[7])},PF.WriteString=function(){MSG.WriteString(PF.WriteDest(),PR.GetString(PR.globals_int[7]))},PF.WriteEntity=function(){MSG.WriteShort(PF.WriteDest(),PR.globals_int[7])},PF.makestatic=function(){var t=SV.server.edicts[PR.globals_int[4]],a=SV.server.signon;MSG.WriteByte(a,Protocol.svc.spawnstatic),MSG.WriteByte(a,SV.ModelIndex(PR.GetString(t.v_int[PR.entvars.model]))),MSG.WriteByte(a,t.v_float[PR.entvars.frame]),MSG.WriteByte(a,t.v_float[PR.entvars.colormap]),MSG.WriteByte(a,t.v_float[PR.entvars.skin]),MSG.WriteCoord(a,t.v_float[PR.entvars.origin]),MSG.WriteAngle(a,t.v_float[PR.entvars.angles]),MSG.WriteCoord(a,t.v_float[PR.entvars.origin1]),MSG.WriteAngle(a,t.v_float[PR.entvars.angles1]),MSG.WriteCoord(a,t.v_float[PR.entvars.origin2]),MSG.WriteAngle(a,t.v_float[PR.entvars.angles2]),ED.Free(t)},PF.setspawnparms=function(){var t=PR.globals_int[4];(t<=0||t>SV.svs.maxclients)&&PR.RunError("Entity is not a client");var a=SV.svs.clients[t-1].spawn_parms;for(t=0;t<=15;++t)PR.globals_float[PR.globalvars.parms+t]=a[t]},PF.changelevel=function(){!0!==SV.svs.changelevel_issued&&(SV.svs.changelevel_issued=!0,Cmd.text+="changelevel "+PR.GetString(PR.globals_int[4])+"\n")},PF.Fixme=function(){PR.RunError("unimplemented builtin")},PF.builtin=[PF.Fixme,PF.makevectors,PF.setorigin,PF.setmodel,PF.setsize,PF.Fixme,PF.breakstatement,PF.random,PF.sound,PF.normalize,PF.error,PF.objerror,PF.vlen,PF.vectoyaw,PF.Spawn,PF.Remove,PF.traceline,PF.checkclient,PF.Find,PF.precache_sound,PF.precache_model,PF.stuffcmd,PF.findradius,PF.bprint,PF.sprint,PF.dprint,PF.ftos,PF.vtos,PF.coredump,PF.traceon,PF.traceoff,PF.eprint,PF.walkmove,PF.Fixme,PF.droptofloor,PF.lightstyle,PF.rint,PF.floor,PF.ceil,PF.Fixme,PF.checkbottom,PF.pointcontents,PF.Fixme,PF.fabs,PF.aim,PF.cvar,PF.localcmd,PF.nextent,PF.particle,PF.changeyaw,PF.Fixme,PF.vectoangles,PF.WriteByte,PF.WriteChar,PF.WriteShort,PF.WriteLong,PF.WriteCoord,PF.WriteAngle,PF.WriteString,PF.WriteEntity,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.MoveToGoal,PF.precache_file,PF.makestatic,PF.changelevel,PF.Fixme,PF.cvar_set,PF.centerprint,PF.ambientsound,PF.precache_model,PF.precache_sound,PF.precache_file,PF.setspawnparms];

			// PR.js
			PR={},PR.etype={ev_void:0,ev_string:1,ev_float:2,ev_vector:3,ev_entity:4,ev_field:5,ev_function:6,ev_pointer:7},PR.op={done:0,mul_f:1,mul_v:2,mul_fv:3,mul_vf:4,div_f:5,add_f:6,add_v:7,sub_f:8,sub_v:9,eq_f:10,eq_v:11,eq_s:12,eq_e:13,eq_fnc:14,ne_f:15,ne_v:16,ne_s:17,ne_e:18,ne_fnc:19,le:20,ge:21,lt:22,gt:23,load_f:24,load_v:25,load_s:26,load_ent:27,load_fld:28,load_fnc:29,address:30,store_f:31,store_v:32,store_s:33,store_ent:34,store_fld:35,store_fnc:36,storep_f:37,storep_v:38,storep_s:39,storep_ent:40,storep_fld:41,storep_fnc:42,ret:43,not_f:44,not_v:45,not_s:46,not_ent:47,not_fnc:48,jnz:49,jz:50,call0:51,call1:52,call2:53,call3:54,call4:55,call5:56,call6:57,call7:58,call8:59,state:60,jump:61,and:62,or:63,bitand:64,bitor:65},PR.version=6,PR.globalvars={self:28,other:29,world:30,time:31,frametime:32,force_retouch:33,mapname:34,deathmatch:35,coop:36,teamplay:37,serverflags:38,total_secrets:39,total_monsters:40,found_secrets:41,killed_monsters:42,parms:43,v_forward:59,v_forward1:60,v_forward2:61,v_up:62,v_up1:63,v_up2:64,v_right:65,v_right1:66,v_right2:67,trace_allsolid:68,trace_startsolid:69,trace_fraction:70,trace_endpos:71,trace_endpos1:72,trace_endpos2:73,trace_plane_normal:74,trace_plane_normal1:75,trace_plane_normal2:76,trace_plane_dist:77,trace_ent:78,trace_inopen:79,trace_inwater:80,msg_entity:81,main:82,StartFrame:83,PlayerPreThink:84,PlayerPostThink:85,ClientKill:86,ClientConnect:87,PutClientInServer:88,ClientDisconnect:89,SetNewParms:90,SetChangeParms:91},PR.entvars={modelindex:0,absmin:1,absmin1:2,absmin2:3,absmax:4,absmax1:5,absmax2:6,ltime:7,movetype:8,solid:9,origin:10,origin1:11,origin2:12,oldorigin:13,oldorigin1:14,oldorigin2:15,velocity:16,velocity1:17,velocity2:18,angles:19,angles1:20,angles2:21,avelocity:22,avelocity1:23,avelocity2:24,punchangle:25,punchangle1:26,punchangle2:27,classname:28,model:29,frame:30,skin:31,effects:32,mins:33,mins1:34,mins2:35,maxs:36,maxs1:37,maxs2:38,size:39,size1:40,size2:41,touch:42,use:43,think:44,blocked:45,nextthink:46,groundentity:47,health:48,frags:49,weapon:50,weaponmodel:51,weaponframe:52,currentammo:53,ammo_shells:54,ammo_nails:55,ammo_rockets:56,ammo_cells:57,items:58,takedamage:59,chain:60,deadflag:61,view_ofs:62,view_ofs1:63,view_ofs2:64,button0:65,button1:66,button2:67,impulse:68,fixangle:69,v_angle:70,v_angle1:71,v_angle2:72,idealpitch:73,netname:74,enemy:75,flags:76,colormap:77,team:78,max_health:79,teleport_time:80,armortype:81,armorvalue:82,waterlevel:83,watertype:84,ideal_yaw:85,yaw_speed:86,aiment:87,goalentity:88,spawnflags:89,target:90,targetname:91,dmg_take:92,dmg_save:93,dmg_inflictor:94,owner:95,movedir:96,movedir1:97,movedir2:98,message:99,sounds:100,noise:101,noise1:102,noise2:103,noise3:104},PR.progheader_crc=5927,PR.CheckEmptyString=function(t){var a=t.charCodeAt(0);(!0===Q.isNaN(a)||a<=32)&&PR.RunError("Bad string")},PR.ValueString=function(t,a,o){var e=new Float32Array(a),l=new Int32Array(a);switch(t&=32767){case PR.etype.ev_string:return PR.GetString(l[o]);case PR.etype.ev_entity:return"entity "+l[o];case PR.etype.ev_function:return PR.GetString(PR.functions[l[o]].name)+"()";case PR.etype.ev_field:var n=ED.FieldAtOfs(l[o]);return null!=n?"."+PR.GetString(n.name):".";case PR.etype.ev_void:return"void";case PR.etype.ev_float:return e[o].toFixed(1);case PR.etype.ev_vector:return"'"+e[o].toFixed(1)+" "+e[o+1].toFixed(1)+" "+e[o+2].toFixed(1)+"'";case PR.etype.ev_pointer:return"pointer"}return"bad type "+t},PR.UglyValueString=function(t,a,o){var e=new Float32Array(a),l=new Int32Array(a);switch(t&=32767){case PR.etype.ev_string:return PR.GetString(l[o]);case PR.etype.ev_entity:return l[o].toString();case PR.etype.ev_function:return PR.GetString(PR.functions[l[o]].name);case PR.etype.ev_field:var n=ED.FieldAtOfs(l[o]);return null!=n?PR.GetString(n.name):"";case PR.etype.ev_void:return"void";case PR.etype.ev_float:return e[o].toFixed(6);case PR.etype.ev_vector:return e[o].toFixed(6)+" "+e[o+1].toFixed(6)+" "+e[o+2].toFixed(6)}return"bad type "+t},PR.GlobalString=function(t){var a,o=ED.GlobalAtOfs(t);for(a=null!=o?t+"("+PR.GetString(o.name)+")"+PR.ValueString(o.type,PR.globals,t):t+"(???)";a.length<=20;)a+=" ";return a},PR.GlobalStringNoContents=function(t){var a,o=ED.GlobalAtOfs(t);for(a=null!=o?t+"("+PR.GetString(o.name)+")":t+"(???)";a.length<=20;)a+=" ";return a},PR.LoadProgs=function(){var t=COM.LoadFile("progs.dat");null==t&&Sys.Error("PR.LoadProgs: couldn't load progs.dat"),Con.DPrint("Programs occupy "+(t.byteLength>>10)+"K.\n");var a,o,e=new DataView(t),l=e.getUint32(0,!0);for(l!==PR.version&&Sys.Error("progs.dat has wrong version number ("+l+" should be "+PR.version+")"),e.getUint32(4,!0)!==PR.progheader_crc&&Sys.Error("progs.dat system vars have been modified, PR.js is out of date"),PR.crc=CRC.Block(new Uint8Array(t)),PR.stack=[],PR.depth=0,PR.localstack=[],l=0;l<PR.localstack_size;++l)PR.localstack[l]=0;for(PR.localstack_used=0,a=e.getUint32(8,!0),o=e.getUint32(12,!0),PR.statements=[],l=0;l<o;++l)PR.statements[l]={op:e.getUint16(a,!0),a:e.getInt16(a+2,!0),b:e.getInt16(a+4,!0),c:e.getInt16(a+6,!0)},a+=8;for(a=e.getUint32(16,!0),o=e.getUint32(20,!0),PR.globaldefs=[],l=0;l<o;++l)PR.globaldefs[l]={type:e.getUint16(a,!0),ofs:e.getUint16(a+2,!0),name:e.getUint32(a+4,!0)},a+=8;for(a=e.getUint32(24,!0),o=e.getUint32(28,!0),PR.fielddefs=[],l=0;l<o;++l)PR.fielddefs[l]={type:e.getUint16(a,!0),ofs:e.getUint16(a+2,!0),name:e.getUint32(a+4,!0)},a+=8;for(a=e.getUint32(32,!0),o=e.getUint32(36,!0),PR.functions=[],l=0;l<o;++l)PR.functions[l]={first_statement:e.getInt32(a,!0),parm_start:e.getUint32(a+4,!0),locals:e.getUint32(a+8,!0),profile:e.getUint32(a+12,!0),name:e.getUint32(a+16,!0),file:e.getUint32(a+20,!0),numparms:e.getUint32(a+24,!0),parm_size:[e.getUint8(a+28),e.getUint8(a+29),e.getUint8(a+30),e.getUint8(a+31),e.getUint8(a+32),e.getUint8(a+33),e.getUint8(a+34),e.getUint8(a+35)]},a+=36;for(a=e.getUint32(40,!0),o=e.getUint32(44,!0),PR.strings=[],l=0;l<o;++l)PR.strings[l]=e.getUint8(a+l);for(PR.string_temp=PR.NewString("",128),PR.netnames=PR.NewString("",SV.svs.maxclients<<5),a=e.getUint32(48,!0),o=e.getUint32(52,!0),PR.globals=new ArrayBuffer(o<<2),PR.globals_float=new Float32Array(PR.globals),PR.globals_int=new Int32Array(PR.globals),l=0;l<o;++l)PR.globals_int[l]=e.getInt32(a+(l<<2),!0);PR.entityfields=e.getUint32(56,!0),PR.edict_size=96+(PR.entityfields<<2);var n,s,r=["ammo_shells1","ammo_nails1","ammo_lava_nails","ammo_rockets1","ammo_multi_rockets","ammo_cells1","ammo_plasma","gravity","items2"];for(l=0;l<r.length;++l)n=r[l],s=ED.FindField(n),PR.entvars[n]=null!=s?s.ofs:null},PR.Init=function(){Cmd.AddCommand("edict",ED.PrintEdict_f),Cmd.AddCommand("edicts",ED.PrintEdicts),Cmd.AddCommand("edictcount",ED.Count),Cmd.AddCommand("profile",PR.Profile_f),Cvar.RegisterVariable("nomonsters","0"),Cvar.RegisterVariable("gamecfg","0"),Cvar.RegisterVariable("scratch1","0"),Cvar.RegisterVariable("scratch2","0"),Cvar.RegisterVariable("scratch3","0"),Cvar.RegisterVariable("scratch4","0"),Cvar.RegisterVariable("savedgamecfg","0",!0),Cvar.RegisterVariable("saved1","0",!0),Cvar.RegisterVariable("saved2","0",!0),Cvar.RegisterVariable("saved3","0",!0),Cvar.RegisterVariable("saved4","0",!0)},PR.localstack_size=2048,PR.opnames=["DONE","MUL_F","MUL_V","MUL_FV","MUL_VF","DIV","ADD_F","ADD_V","SUB_F","SUB_V","EQ_F","EQ_V","EQ_S","EQ_E","EQ_FNC","NE_F","NE_V","NE_S","NE_E","NE_FNC","LE","GE","LT","GT","INDIRECT","INDIRECT","INDIRECT","INDIRECT","INDIRECT","INDIRECT","ADDRESS","STORE_F","STORE_V","STORE_S","STORE_ENT","STORE_FLD","STORE_FNC","STOREP_F","STOREP_V","STOREP_S","STOREP_ENT","STOREP_FLD","STOREP_FNC","RETURN","NOT_F","NOT_V","NOT_S","NOT_ENT","NOT_FNC","IF","IFNOT","CALL0","CALL1","CALL2","CALL3","CALL4","CALL5","CALL6","CALL7","CALL8","STATE","GOTO","AND","OR","BITAND","BITOR"],PR.PrintStatement=function(t){var a;if(t.op<PR.opnames.length)for(a=PR.opnames[t.op]+" ";a.length<=9;)a+=" ";else a="";t.op===PR.op.jnz||t.op===PR.op.jz?a+=PR.GlobalString(t.a)+"branch "+t.b:t.op===PR.op.jump?a+="branch "+t.a:t.op>=PR.op.store_f&&t.op<=PR.op.store_fnc?a+=PR.GlobalString(t.a)+PR.GlobalStringNoContents(t.b):(0!==t.a&&(a+=PR.GlobalString(t.a)),0!==t.b&&(a+=PR.GlobalString(t.b)),0!==t.c&&(a+=PR.GlobalStringNoContents(t.c))),Con.Print(a+"\n")},PR.StackTrace=function(){if(0!==PR.depth){var t,a;for(PR.stack[PR.depth]=[PR.xstatement,PR.xfunction];PR.depth>=0;--PR.depth)if(null!=(t=PR.stack[PR.depth][1])){for(a=PR.GetString(t.file);a.length<=11;)a+=" ";Con.Print(a+" : "+PR.GetString(t.name)+"\n")}else Con.Print("<NO FUNCTION>\n");PR.depth=0}else Con.Print("<NO STACK>\n")},PR.Profile_f=function(){if(!0===SV.server.active)for(var t,a,o,e,l,n=0;;){for(t=0,a=null,o=0;o<PR.functions.length;++o)(e=PR.functions[o]).profile>t&&(t=e.profile,a=e);if(null==a)return;if(n<10){for(l=a.profile.toString();l.length<=6;)l=" "+l;Con.Print(l+" "+PR.GetString(a.name)+"\n")}++n,a.profile=0}},PR.RunError=function(t){PR.PrintStatement(PR.statements[PR.xstatement]),PR.StackTrace(),Con.Print(t+"\n"),Host.Error("Program error")},PR.EnterFunction=function(t){PR.stack[PR.depth++]=[PR.xstatement,PR.xfunction];var a,o=t.locals;for(PR.localstack_used+o>PR.localstack_size&&PR.RunError("PR.EnterFunction: locals stack overflow\n"),a=0;a<o;++a)PR.localstack[PR.localstack_used+a]=PR.globals_int[t.parm_start+a];PR.localstack_used+=o;var e,l=t.parm_start;for(a=0;a<t.numparms;++a)for(e=0;e<t.parm_size[a];++e)PR.globals_int[l++]=PR.globals_int[4+3*a+e];return PR.xfunction=t,t.first_statement-1},PR.LeaveFunction=function(){PR.depth<=0&&Sys.Error("prog stack underflow");var t=PR.xfunction.locals;for(PR.localstack_used-=t,PR.localstack_used<0&&PR.RunError("PR.LeaveFunction: locals stack underflow\n"),--t;t>=0;--t)PR.globals_int[PR.xfunction.parm_start+t]=PR.localstack[PR.localstack_used+t];return PR.xfunction=PR.stack[--PR.depth][1],PR.stack[PR.depth][0]},PR.ExecuteProgram=function(t){(0===t||t>=PR.functions.length)&&(0!==PR.globals_int[PR.globalvars.self]&&ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]),Host.Error("PR.ExecuteProgram: NULL function"));var a=1e5;PR.trace=!1;for(var o,e,l,n,s=PR.depth,r=PR.EnterFunction(PR.functions[t]);;){switch(++r,o=PR.statements[r],0==--a&&PR.RunError("runaway loop error"),++PR.xfunction.profile,PR.xstatement=r,!0===PR.trace&&PR.PrintStatement(o),o.op){case PR.op.add_f:PR.globals_float[o.c]=PR.globals_float[o.a]+PR.globals_float[o.b];continue;case PR.op.add_v:PR.globals_float[o.c]=PR.globals_float[o.a]+PR.globals_float[o.b],PR.globals_float[o.c+1]=PR.globals_float[o.a+1]+PR.globals_float[o.b+1],PR.globals_float[o.c+2]=PR.globals_float[o.a+2]+PR.globals_float[o.b+2];continue;case PR.op.sub_f:PR.globals_float[o.c]=PR.globals_float[o.a]-PR.globals_float[o.b];continue;case PR.op.sub_v:PR.globals_float[o.c]=PR.globals_float[o.a]-PR.globals_float[o.b],PR.globals_float[o.c+1]=PR.globals_float[o.a+1]-PR.globals_float[o.b+1],PR.globals_float[o.c+2]=PR.globals_float[o.a+2]-PR.globals_float[o.b+2];continue;case PR.op.mul_f:PR.globals_float[o.c]=PR.globals_float[o.a]*PR.globals_float[o.b];continue;case PR.op.mul_v:PR.globals_float[o.c]=PR.globals_float[o.a]*PR.globals_float[o.b]+PR.globals_float[o.a+1]*PR.globals_float[o.b+1]+PR.globals_float[o.a+2]*PR.globals_float[o.b+2];continue;case PR.op.mul_fv:PR.globals_float[o.c]=PR.globals_float[o.a]*PR.globals_float[o.b],PR.globals_float[o.c+1]=PR.globals_float[o.a]*PR.globals_float[o.b+1],PR.globals_float[o.c+2]=PR.globals_float[o.a]*PR.globals_float[o.b+2];continue;case PR.op.mul_vf:PR.globals_float[o.c]=PR.globals_float[o.b]*PR.globals_float[o.a],PR.globals_float[o.c+1]=PR.globals_float[o.b]*PR.globals_float[o.a+1],PR.globals_float[o.c+2]=PR.globals_float[o.b]*PR.globals_float[o.a+2];continue;case PR.op.div_f:PR.globals_float[o.c]=PR.globals_float[o.a]/PR.globals_float[o.b];continue;case PR.op.bitand:PR.globals_float[o.c]=PR.globals_float[o.a]&PR.globals_float[o.b];continue;case PR.op.bitor:PR.globals_float[o.c]=PR.globals_float[o.a]|PR.globals_float[o.b];continue;case PR.op.ge:PR.globals_float[o.c]=PR.globals_float[o.a]>=PR.globals_float[o.b]?1:0;continue;case PR.op.le:PR.globals_float[o.c]=PR.globals_float[o.a]<=PR.globals_float[o.b]?1:0;continue;case PR.op.gt:PR.globals_float[o.c]=PR.globals_float[o.a]>PR.globals_float[o.b]?1:0;continue;case PR.op.lt:PR.globals_float[o.c]=PR.globals_float[o.a]<PR.globals_float[o.b]?1:0;continue;case PR.op.and:PR.globals_float[o.c]=0!==PR.globals_float[o.a]&&0!==PR.globals_float[o.b]?1:0;continue;case PR.op.or:PR.globals_float[o.c]=0!==PR.globals_float[o.a]||0!==PR.globals_float[o.b]?1:0;continue;case PR.op.not_f:PR.globals_float[o.c]=0===PR.globals_float[o.a]?1:0;continue;case PR.op.not_v:PR.globals_float[o.c]=0===PR.globals_float[o.a]&&0===PR.globals_float[o.a+1]&&0===PR.globals_float[o.a+2]?1:0;continue;case PR.op.not_s:0!==PR.globals_int[o.a]?PR.globals_float[o.c]=0===PR.strings[PR.globals_int[o.a]]?1:0:PR.globals_float[o.c]=1;continue;case PR.op.not_fnc:case PR.op.not_ent:PR.globals_float[o.c]=0===PR.globals_int[o.a]?1:0;continue;case PR.op.eq_f:PR.globals_float[o.c]=PR.globals_float[o.a]===PR.globals_float[o.b]?1:0;continue;case PR.op.eq_v:PR.globals_float[o.c]=PR.globals_float[o.a]===PR.globals_float[o.b]&&PR.globals_float[o.a+1]===PR.globals_float[o.b+1]&&PR.globals_float[o.a+2]===PR.globals_float[o.b+2]?1:0;continue;case PR.op.eq_s:PR.globals_float[o.c]=PR.GetString(PR.globals_int[o.a])===PR.GetString(PR.globals_int[o.b])?1:0;continue;case PR.op.eq_e:case PR.op.eq_fnc:PR.globals_float[o.c]=PR.globals_int[o.a]===PR.globals_int[o.b]?1:0;continue;case PR.op.ne_f:PR.globals_float[o.c]=PR.globals_float[o.a]!==PR.globals_float[o.b]?1:0;continue;case PR.op.ne_v:PR.globals_float[o.c]=PR.globals_float[o.a]!==PR.globals_float[o.b]||PR.globals_float[o.a+1]!==PR.globals_float[o.b+1]||PR.globals_float[o.a+2]!==PR.globals_float[o.b+2]?1:0;continue;case PR.op.ne_s:PR.globals_float[o.c]=PR.GetString(PR.globals_int[o.a])!==PR.GetString(PR.globals_int[o.b])?1:0;continue;case PR.op.ne_e:case PR.op.ne_fnc:PR.globals_float[o.c]=PR.globals_int[o.a]!==PR.globals_int[o.b]?1:0;continue;case PR.op.store_f:case PR.op.store_ent:case PR.op.store_fld:case PR.op.store_s:case PR.op.store_fnc:PR.globals_int[o.b]=PR.globals_int[o.a];continue;case PR.op.store_v:PR.globals_int[o.b]=PR.globals_int[o.a],PR.globals_int[o.b+1]=PR.globals_int[o.a+1],PR.globals_int[o.b+2]=PR.globals_int[o.a+2];continue;case PR.op.storep_f:case PR.op.storep_ent:case PR.op.storep_fld:case PR.op.storep_s:case PR.op.storep_fnc:l=PR.globals_int[o.b],SV.server.edicts[Math.floor(l/PR.edict_size)].v_int[l%PR.edict_size-96>>2]=PR.globals_int[o.a];continue;case PR.op.storep_v:e=SV.server.edicts[Math.floor(PR.globals_int[o.b]/PR.edict_size)],l=PR.globals_int[o.b]%PR.edict_size-96>>2,e.v_int[l]=PR.globals_int[o.a],e.v_int[l+1]=PR.globals_int[o.a+1],e.v_int[l+2]=PR.globals_int[o.a+2];continue;case PR.op.address:0===(e=PR.globals_int[o.a])&&!0!==SV.server.loading&&PR.RunError("assignment to world entity"),PR.globals_int[o.c]=e*PR.edict_size+96+(PR.globals_int[o.b]<<2);continue;case PR.op.load_f:case PR.op.load_fld:case PR.op.load_ent:case PR.op.load_s:case PR.op.load_fnc:PR.globals_int[o.c]=SV.server.edicts[PR.globals_int[o.a]].v_int[PR.globals_int[o.b]];continue;case PR.op.load_v:e=SV.server.edicts[PR.globals_int[o.a]],l=PR.globals_int[o.b],PR.globals_int[o.c]=e.v_int[l],PR.globals_int[o.c+1]=e.v_int[l+1],PR.globals_int[o.c+2]=e.v_int[l+2];continue;case PR.op.jz:0===PR.globals_int[o.a]&&(r+=o.b-1);continue;case PR.op.jnz:0!==PR.globals_int[o.a]&&(r+=o.b-1);continue;case PR.op.jump:r+=o.a-1;continue;case PR.op.call0:case PR.op.call1:case PR.op.call2:case PR.op.call3:case PR.op.call4:case PR.op.call5:case PR.op.call6:case PR.op.call7:case PR.op.call8:if(PR.argc=o.op-PR.op.call0,0===PR.globals_int[o.a]&&PR.RunError("NULL function"),(n=PR.functions[PR.globals_int[o.a]]).first_statement<0){(l=-n.first_statement)>=PF.builtin.length&&PR.RunError("Bad builtin call number"),PF.builtin[l]();continue}r=PR.EnterFunction(n);continue;case PR.op.done:case PR.op.ret:if(PR.globals_int[1]=PR.globals_int[o.a],PR.globals_int[2]=PR.globals_int[o.a+1],PR.globals_int[3]=PR.globals_int[o.a+2],r=PR.LeaveFunction(),PR.depth===s)return;continue;case PR.op.state:(e=SV.server.edicts[PR.globals_int[PR.globalvars.self]]).v_float[PR.entvars.nextthink]=PR.globals_float[PR.globalvars.time]+.1,e.v_float[PR.entvars.frame]=PR.globals_float[o.a],e.v_int[PR.entvars.think]=PR.globals_int[o.b];continue}PR.RunError("Bad opcode "+o.op)}},PR.GetString=function(t){for(var a=[];t<PR.strings.length&&0!==PR.strings[t];++t)a[a.length]=String.fromCharCode(PR.strings[t]);return a.join("")},PR.NewString=function(t,a){var o,e=PR.strings.length;if(t.length>=a){for(o=0;o<a-1;++o)PR.strings[PR.strings.length]=t.charCodeAt(o);return PR.strings[PR.strings.length]=0,e}for(o=0;o<t.length;++o)PR.strings[PR.strings.length]=t.charCodeAt(o);for(a-=t.length,o=0;o<a;++o)PR.strings[PR.strings.length]=0;return e},PR.TempString=function(t){var a;for(t.length>127&&(t=t.substring(0,127)),a=0;a<t.length;++a)PR.strings[PR.string_temp+a]=t.charCodeAt(a);PR.strings[PR.string_temp+t.length]=0};

			// Protocol.js
			Protocol={},Protocol.version=15,Protocol.u={morebits:1,origin1:2,origin2:4,origin3:8,angle2:16,nolerp:32,frame:64,signal:128,angle1:256,angle3:512,model:1024,colormap:2048,skin:4096,effects:8192,longentity:16384},Protocol.su={viewheight:1,idealpitch:2,punch1:4,punch2:8,punch3:16,velocity1:32,velocity2:64,velocity3:128,items:512,onground:1024,inwater:2048,weaponframe:4096,armor:8192,weapon:16384},Protocol.default_viewheight=22,Protocol.svc={nop:1,disconnect:2,updatestat:3,version:4,setview:5,sound:6,time:7,print:8,stufftext:9,setangle:10,serverinfo:11,lightstyle:12,updatename:13,updatefrags:14,clientdata:15,stopsound:16,updatecolors:17,particle:18,damage:19,spawnstatic:20,spawnbaseline:22,temp_entity:23,setpause:24,signonnum:25,centerprint:26,killedmonster:27,foundsecret:28,spawnstaticsound:29,intermission:30,finale:31,cdtrack:32,sellscreen:33,cutscene:34},Protocol.clc={nop:1,disconnect:2,move:3,stringcmd:4},Protocol.te={spike:0,superspike:1,gunshot:2,explosion:3,tarexplosion:4,lightning1:5,lightning2:6,wizspike:7,knightspike:8,lightning3:9,lavasplash:10,teleport:11,explosion2:12,beam:13};

			// Q.js
			Q={},Q.memstr=function(r){var t,e=[];for(t=0;t<r.length&&0!==r[t];++t)e[t]=String.fromCharCode(r[t]);return e.join("")},Q.strmem=function(r){var t,e=new ArrayBuffer(r.length),n=new Uint8Array(e);for(t=0;t<r.length;++t)n[t]=255&r.charCodeAt(t);return e},Q.atoi=function(r){if(null==r)return 0;var t,e,n,a,h=0;if(45===r.charCodeAt(0)?(e=-1,t=1):(e=1,t=0),n=r.charCodeAt(t),a=r.charCodeAt(t+1),48===n&&(120===a||88===a))for(t+=2;;)if((n=r.charCodeAt(t++))>=48&&n<=57)h=(h<<4)+n-48;else if(n>=97&&n<=102)h=(h<<4)+n-87;else{if(!(n>=65&&n<=70))return h*e;h=(h<<4)+n-55}if(39===n)return!0===Q.isNaN(a)?0:e*a;for(;;){if(n=r.charCodeAt(t++),!0===Q.isNaN(n)||n<=47||n>=58)return h*e;h=10*h+n-48}return 0},Q.atof=function(r){if(null==r)return 0;var t,e,n,a,h;if(45===r.charCodeAt(0)?(n=-1,t=1):(n=1,t=0),a=r.charCodeAt(t),h=r.charCodeAt(t+1),48===a&&(120===h||88===h))for(t+=2,e=0;;)if((a=r.charCodeAt(t++))>=48&&a<=57)e=16*e+a-48;else if(a>=97&&a<=102)e=16*e+a-87;else{if(!(a>=65&&a<=70))return e*n;e=16*e+a-55}return 39===a?!0===Q.isNaN(h)?0:n*h:(e=parseFloat(r),!0===Q.isNaN(e)?0:e)},Q.btoa=function(r){var t,e,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=[],h=r.length-r.length%3;for(e=0;e<h;e+=3)t=(r[e]<<16)+(r[e+1]<<8)+r[e+2],a[a.length]=n.charAt(t>>18)+n.charAt(t>>12&63)+n.charAt(t>>6&63)+n.charAt(63&t);return r.length-h==1?(t=r[h],a[a.length]=n.charAt(t>>2)+n.charAt((3&t)<<4)+"=="):r.length-h==2&&(t=(r[h]<<8)+r[h+1],a[a.length]=n.charAt(t>>10)+n.charAt(t>>4&63)+n.charAt((15&t)<<2)+"="),a.join("")};

			// R.js
			R={},R.SplitEntityOnNode=function(e){if(e.contents!==Mod.contents.solid)if(e.contents<0)R.currententity.leafs[R.currententity.leafs.length]=e.num-1;else{var t=Vec.BoxOnPlaneSide(R.emins,R.emaxs,e.plane);0!=(1&t)&&R.SplitEntityOnNode(e.children[0]),0!=(2&t)&&R.SplitEntityOnNode(e.children[1])}},R.dlightframecount=0,R.lightstylevalue=new Uint8Array(new ArrayBuffer(64)),R.AnimateLight=function(){var e;if(0===R.fullbright.value){var t=Math.floor(10*CL.state.time);for(e=0;e<64;++e)0!==CL.lightstyle[e].length?R.lightstylevalue[e]=CL.lightstyle[e].charCodeAt(t%CL.lightstyle[e].length)-97:R.lightstylevalue[e]=12}else for(e=0;e<64;++e)R.lightstylevalue[e]=12;GL.Bind(0,R.lightstyle_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,64,1,0,gl.ALPHA,gl.UNSIGNED_BYTE,R.lightstylevalue)},R.RenderDlights=function(){if(0!==R.flashblend.value){++R.dlightframecount,gl.enable(gl.BLEND);var e,t,r=GL.UseProgram("Dlight");for(gl.bindBuffer(gl.ARRAY_BUFFER,R.dlightvecs),gl.vertexAttribPointer(r.aPosition.location,3,gl.FLOAT,!1,0,0),i=0;i<=31;++i)(e=CL.dlights[i]).die<CL.state.time||0===e.radius||(Vec.Length([e.origin[0]-R.refdef.vieworg[0],e.origin[1]-R.refdef.vieworg[1],e.origin[2]-R.refdef.vieworg[2]])<.35*e.radius?(t=3e-4*e.radius,V.blend[3]+=t*(1-V.blend[3]),t/=V.blend[3],V.blend[0]=V.blend[1]*(1-t)+255*t,V.blend[1]=V.blend[1]*(1-t)+127.5*t,V.blend[2]*=1-t):(gl.uniform3fv(r.uOrigin,e.origin),gl.uniform1f(r.uRadius,e.radius),gl.drawArrays(gl.TRIANGLE_FAN,0,18)));gl.disable(gl.BLEND)}},R.MarkLights=function(e,t,r){if(!(r.contents<0)){var l=r.plane.normal,a=e.origin[0]*l[0]+e.origin[1]*l[1]+e.origin[2]*l[2]-r.plane.dist;if(a>e.radius)R.MarkLights(e,t,r.children[0]);else if(a<-e.radius)R.MarkLights(e,t,r.children[1]);else{var i,n;for(i=0;i<r.numfaces;++i)!0!==(n=CL.state.worldmodel.faces[r.firstface+i]).sky&&!0!==n.turbulent&&(n.dlightframe!==R.dlightframecount+1&&(n.dlightbits=0,n.dlightframe=R.dlightframecount+1),n.dlightbits+=t);R.MarkLights(e,t,r.children[0]),R.MarkLights(e,t,r.children[1])}}},R.PushDlights=function(){if(0===R.flashblend.value){var e;for(e=0;e<=1023;++e)R.lightmap_modified[e]=!1;var t,r,l,a,i=1;for(e=0;e<=31;++e){if((t=CL.dlights[e]).die>=CL.state.time&&0!==t.radius)for(R.MarkLights(t,i,CL.state.worldmodel.nodes[0]),r=0;r<CL.numvisedicts;++r)null!=(l=CL.visedicts[r]).model&&l.model.type===Mod.type.brush&&!0===l.model.submodel&&R.MarkLights(t,i,CL.state.worldmodel.nodes[l.model.hulls[0].firstclipnode]);i+=i}for(e=0;e<CL.state.worldmodel.faces.length;++e)(a=CL.state.worldmodel.faces[e]).dlightframe===R.dlightframecount?R.RemoveDynamicLights(a):a.dlightframe===R.dlightframecount+1&&R.AddDynamicLights(a);for(GL.Bind(0,R.dlightmap_texture),e=0;e<=1023;++e)if(!0===R.lightmap_modified[e]){for(r=1023;r>=e;--r)if(!0===R.lightmap_modified[r]){gl.texSubImage2D(gl.TEXTURE_2D,0,0,e,1024,r-e+1,gl.ALPHA,gl.UNSIGNED_BYTE,R.dlightmaps.subarray(e<<10,r+1<<10));break}break}++R.dlightframecount}},R.RecursiveLightPoint=function(e,t,r){if(e.contents<0)return-1;var l=e.plane.normal,a=t[0]*l[0]+t[1]*l[1]+t[2]*l[2]-e.plane.dist,i=r[0]*l[0]+r[1]*l[1]+r[2]*l[2]-e.plane.dist,n=a<0;if(i<0===n)return R.RecursiveLightPoint(e.children[!0===n?1:0],t,r);var o,s,g,u,f,d,m,c,h,v,L=a/(a-i),p=[t[0]+(r[0]-t[0])*L,t[1]+(r[1]-t[1])*L,t[2]+(r[2]-t[2])*L],A=R.RecursiveLightPoint(e.children[!0===n?1:0],t,p);if(A>=0)return A;if(i<0===n)return-1;for(o=0;o<e.numfaces;++o)if(!0!==(s=CL.state.worldmodel.faces[e.firstface+o]).sky&&!0!==s.turbulent&&(g=CL.state.worldmodel.texinfo[s.texinfo],u=Vec.DotProduct(p,g.vecs[0])+g.vecs[0][3],f=Vec.DotProduct(p,g.vecs[1])+g.vecs[1][3],!(u<s.texturemins[0]||f<s.texturemins[1]||(d=u-s.texturemins[0],m=f-s.texturemins[1],d>s.extents[0]||m>s.extents[1])))){if(0===s.lightofs)return 0;if(d>>=4,m>>=4,0===(c=s.lightofs))return 0;for(c+=m*(1+(s.extents[0]>>4))+d,A=0,h=(1+(s.extents[0]>>4))*(1+(s.extents[1]>>4)),v=0;v<s.styles.length;++v)A+=CL.state.worldmodel.lightdata[c]*R.lightstylevalue[s.styles[v]]*22,c+=h;return A>>8}return R.RecursiveLightPoint(e.children[!0!==n?1:0],p,r)},R.LightPoint=function(e){if(null==CL.state.worldmodel.lightdata)return 255;var t=R.RecursiveLightPoint(CL.state.worldmodel.nodes[0],e,[e[0],e[1],e[2]-2048]);return-1===t?0:t},R.visframecount=0,R.frustum=[{},{},{},{}],R.vup=[],R.vpn=[],R.vright=[],R.refdef={vrect:{},vieworg:[0,0,0],viewangles:[0,0,0]},R.CullBox=function(e,t){return 2===Vec.BoxOnPlaneSide(e,t,R.frustum[0])||(2===Vec.BoxOnPlaneSide(e,t,R.frustum[1])||(2===Vec.BoxOnPlaneSide(e,t,R.frustum[2])||(2===Vec.BoxOnPlaneSide(e,t,R.frustum[3])||void 0)))},R.DrawSpriteModel=function(e){var t=GL.UseProgram("Sprite",!0),l=e.frame;(l>=e.model.numframes||l<0)&&(Con.DPrint("R.DrawSpriteModel: no such frame "+l+"\n"),l=0);var a=e.model.frames[l];if(!0===a.group){var i,n,o,s=CL.state.time+e.syncbase;for(l=a.frames.length-1,i=a.frames[l].interval,n=s-Math.floor(s/i)*i,o=0;o<l&&!(a.frames[o].interval>n);++o);a=a.frames[o]}GL.Bind(t.tTexture,a.texturenum,!0),!0===e.model.oriented?(r=[],u=[],Vec.AngleVectors(e.angles,null,r,u)):(r=R.vright,u=R.vup);var g=e.origin,f=a.origin[0],d=a.origin[1],m=f+a.width,c=d+a.height;GL.StreamGetSpace(6),GL.StreamWriteFloat3(g[0]+f*r[0]+d*u[0],g[1]+f*r[1]+d*u[1],g[2]+f*r[2]+d*u[2]),GL.StreamWriteFloat2(0,1),GL.StreamWriteFloat3(g[0]+f*r[0]+c*u[0],g[1]+f*r[1]+c*u[1],g[2]+f*r[2]+c*u[2]),GL.StreamWriteFloat2(0,0),GL.StreamWriteFloat3(g[0]+m*r[0]+d*u[0],g[1]+m*r[1]+d*u[1],g[2]+m*r[2]+d*u[2]),GL.StreamWriteFloat2(1,1),GL.StreamWriteFloat3(g[0]+m*r[0]+d*u[0],g[1]+m*r[1]+d*u[1],g[2]+m*r[2]+d*u[2]),GL.StreamWriteFloat2(1,1),GL.StreamWriteFloat3(g[0]+f*r[0]+c*u[0],g[1]+f*r[1]+c*u[1],g[2]+f*r[2]+c*u[2]),GL.StreamWriteFloat2(0,0),GL.StreamWriteFloat3(g[0]+m*r[0]+c*u[0],g[1]+m*r[1]+c*u[1],g[2]+m*r[2]+c*u[2]),GL.StreamWriteFloat2(1,0)},R.avertexnormals=[[-.525731,0,.850651],[-.442863,.238856,.864188],[-.295242,0,.955423],[-.309017,.5,.809017],[-.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-.681718,.147621,.716567],[-.809017,.309017,.5],[-.587785,.425325,.688191],[-.850651,.525731,0],[-.864188,.442863,.238856],[-.716567,.681718,.147621],[-.688191,.587785,.425325],[-.5,.809017,.309017],[-.238856,.864188,.442863],[-.425325,.688191,.587785],[-.716567,.681718,-.147621],[-.5,.809017,-.309017],[-.525731,.850651,0],[0,.850651,-.525731],[-.238856,.864188,-.442863],[0,.955423,-.295242],[-.262866,.951056,-.16246],[0,1,0],[0,.955423,.295242],[-.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-.442863],[.262866,.951056,-.16246],[.5,.809017,-.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-.525731,0],[.955423,-.295242,0],[.864188,-.442863,.238856],[.951056,-.16246,.262866],[.809017,-.309017,.5],[.681718,-.147621,.716567],[.850651,0,.525731],[.864188,.442863,-.238856],[.809017,.309017,-.5],[.951056,.16246,-.262866],[.525731,0,-.850651],[.681718,.147621,-.716567],[.681718,-.147621,-.716567],[.850651,0,-.525731],[.809017,-.309017,-.5],[.864188,-.442863,-.238856],[.951056,-.16246,-.262866],[.147621,.716567,-.681718],[.309017,.5,-.809017],[.425325,.688191,-.587785],[.442863,.238856,-.864188],[.587785,.425325,-.688191],[.688191,.587785,-.425325],[-.147621,.716567,-.681718],[-.309017,.5,-.809017],[0,.525731,-.850651],[-.525731,0,-.850651],[-.442863,.238856,-.864188],[-.295242,0,-.955423],[-.16246,.262866,-.951056],[0,0,-1],[.295242,0,-.955423],[.16246,.262866,-.951056],[-.442863,-.238856,-.864188],[-.309017,-.5,-.809017],[-.16246,-.262866,-.951056],[0,-.850651,-.525731],[-.147621,-.716567,-.681718],[.147621,-.716567,-.681718],[0,-.525731,-.850651],[.309017,-.5,-.809017],[.442863,-.238856,-.864188],[.16246,-.262866,-.951056],[.238856,-.864188,-.442863],[.5,-.809017,-.309017],[.425325,-.688191,-.587785],[.716567,-.681718,-.147621],[.688191,-.587785,-.425325],[.587785,-.425325,-.688191],[0,-.955423,-.295242],[0,-1,0],[.262866,-.951056,-.16246],[0,-.850651,.525731],[0,-.955423,.295242],[.238856,-.864188,.442863],[.262866,-.951056,.16246],[.5,-.809017,.309017],[.716567,-.681718,.147621],[.525731,-.850651,0],[-.238856,-.864188,-.442863],[-.5,-.809017,-.309017],[-.262866,-.951056,-.16246],[-.850651,-.525731,0],[-.716567,-.681718,-.147621],[-.716567,-.681718,.147621],[-.525731,-.850651,0],[-.5,-.809017,.309017],[-.238856,-.864188,.442863],[-.262866,-.951056,.16246],[-.864188,-.442863,.238856],[-.809017,-.309017,.5],[-.688191,-.587785,.425325],[-.681718,-.147621,.716567],[-.442863,-.238856,.864188],[-.587785,-.425325,.688191],[-.309017,-.5,.809017],[-.147621,-.716567,.681718],[-.425325,-.688191,.587785],[-.16246,-.262866,.951056],[.442863,-.238856,.864188],[.16246,-.262866,.951056],[.309017,-.5,.809017],[.147621,-.716567,.681718],[0,-.525731,.850651],[.425325,-.688191,.587785],[.587785,-.425325,.688191],[.688191,-.587785,.425325],[-.955423,.295242,0],[-.951056,.16246,.262866],[-1,0,0],[-.850651,0,.525731],[-.955423,-.295242,0],[-.951056,-.16246,.262866],[-.864188,.442863,-.238856],[-.951056,.16246,-.262866],[-.809017,.309017,-.5],[-.864188,-.442863,-.238856],[-.951056,-.16246,-.262866],[-.809017,-.309017,-.5],[-.681718,.147621,-.716567],[-.681718,-.147621,-.716567],[-.850651,0,-.525731],[-.688191,.587785,-.425325],[-.587785,.425325,-.688191],[-.425325,.688191,-.587785],[-.425325,-.688191,-.587785],[-.587785,-.425325,-.688191],[-.688191,-.587785,-.425325]],R.DrawAliasModel=function(e){var t=e.model;if(!0!==R.CullBox([e.origin[0]-t.boundingradius,e.origin[1]-t.boundingradius,e.origin[2]-t.boundingradius],[e.origin[0]+t.boundingradius,e.origin[1]+t.boundingradius,e.origin[2]+t.boundingradius])){var r;if(0!==e.colormap&&!0===t.player&&0===R.nocolors.value){r=GL.UseProgram("Player");var l=4+(240&CL.state.scores[e.colormap-1].colors),a=4+((15&CL.state.scores[e.colormap-1].colors)<<4);l<=127&&(l+=7),a<=127&&(a+=7),l=VID.d_8to24table[l],a=VID.d_8to24table[a],gl.uniform3f(r.uTop,255&l,l>>8&255,l>>16),gl.uniform3f(r.uBottom,255&a,a>>8&255,a>>16)}else r=GL.UseProgram("Alias");gl.uniform3fv(r.uOrigin,e.origin),gl.uniformMatrix3fv(r.uAngles,!1,GL.RotationMatrix(e.angles[0],e.angles[1],e.angles[2]));var i,n,o=R.LightPoint(e.origin),s=o;for(e===CL.state.viewent&&o<24&&(o=s=24),d=0;d<=31;++d)(i=CL.dlights[d]).die<CL.state.time||(n=i.radius-Vec.Length([e.origin[0]-i.origin[0],e.origin[1]-i.origin[1],e.origin[1]-i.origin[1]]))>0&&(o+=n,s+=n);o>128&&(o=128),o+s>192&&(s=192-o),e.num>=1&&e.num<=CL.state.maxclients&&o<8&&(o=s=8),gl.uniform1f(r.uAmbientLight,.0078125*o),gl.uniform1f(r.uShadeLight,.0078125*s);var g,u,f,d,m=[],c=[],h=[];Vec.AngleVectors(e.angles,m,c,h),gl.uniform3fv(r.uLightVec,[Vec.DotProduct([-1,0,0],m),-Vec.DotProduct([-1,0,0],c),Vec.DotProduct([-1,0,0],h)]),R.c_alias_polys+=t.numtris;var v=CL.state.time+e.syncbase;((g=e.frame)>=t.numframes||g<0)&&(Con.DPrint("R.DrawAliasModel: no such frame "+g+"\n"),g=0);var L=t.frames[g];if(!0===L.group){for(g=L.frames.length-1,u=L.frames[g].interval,f=v-Math.floor(v/u)*u,d=0;d<g&&!(L.frames[d].interval>f);++d);L=L.frames[d]}gl.bindBuffer(gl.ARRAY_BUFFER,t.cmds),gl.vertexAttribPointer(r.aPosition.location,3,gl.FLOAT,!1,24,L.cmdofs),gl.vertexAttribPointer(r.aNormal.location,3,gl.FLOAT,!1,24,L.cmdofs+12),gl.vertexAttribPointer(r.aTexCoord.location,2,gl.FLOAT,!1,0,0),((g=e.skinnum)>=t.numskins||g<0)&&(Con.DPrint("R.DrawAliasModel: no such skin # "+g+"\n"),g=0);var p=t.skins[g];if(!0===p.group){for(g=p.skins.length-1,u=p.skins[g].interval,f=v-Math.floor(v/u)*u,d=0;d<g&&!(p.skins[d].interval>f);++d);p=p.skins[d]}GL.Bind(r.tTexture,p.texturenum.texnum),!0===t.player&&GL.Bind(r.tPlayer,p.playertexture),gl.drawArrays(gl.TRIANGLES,0,3*t.numtris)}},R.DrawEntitiesOnList=function(){if(0!==R.drawentities.value){var e,t,r,l=0!==R.novis.value?Mod.novis:Mod.LeafPVS(R.viewleaf,CL.state.worldmodel);for(e=0;e<CL.state.num_statics;++e)if(R.currententity=CL.static_entities[e],null!=R.currententity.model){for(t=0;t<R.currententity.leafs.length&&!((r=R.currententity.leafs[t])<0||0!=(l[r>>3]&1<<(7&r)));++t);if(t!==R.currententity.leafs.length)switch(R.currententity.model.type){case Mod.type.alias:R.DrawAliasModel(R.currententity);continue;case Mod.type.brush:R.DrawBrushModel(R.currententity)}}for(e=0;e<CL.numvisedicts;++e)if(R.currententity=CL.visedicts[e],null!=R.currententity.model)switch(R.currententity.model.type){case Mod.type.alias:R.DrawAliasModel(R.currententity);continue;case Mod.type.brush:R.DrawBrushModel(R.currententity)}for(GL.StreamFlush(),gl.depthMask(!1),gl.enable(gl.BLEND),e=0;e<CL.state.num_statics;++e)R.currententity=CL.static_entities[e],null!=R.currententity.model&&R.currententity.model.type===Mod.type.sprite&&R.DrawSpriteModel(R.currententity);for(e=0;e<CL.numvisedicts;++e)R.currententity=CL.visedicts[e],null!=R.currententity.model&&R.currententity.model.type===Mod.type.sprite&&R.DrawSpriteModel(R.currententity);GL.StreamFlush(),gl.disable(gl.BLEND),gl.depthMask(!0)}},R.DrawViewModel=function(){if(0!==R.drawviewmodel.value&&0===Chase.active.value&&0!==R.drawentities.value&&0==(CL.state.items&Def.it.invisibility)&&!(CL.state.stats[Def.stat.health]<=0)&&null!=CL.state.viewent.model){gl.depthRange(0,.3);var e=4*Math.tan(.82*SCR.fov.value*Math.PI/360);R.perspective[0]=4/(e*R.refdef.vrect.width/R.refdef.vrect.height),R.perspective[5]=4/e;var t=GL.UseProgram("Alias");gl.uniformMatrix4fv(t.uPerspective,!1,R.perspective),R.DrawAliasModel(CL.state.viewent),e=4*Math.tan(R.refdef.fov_y*Math.PI/360),R.perspective[0]=4/(e*R.refdef.vrect.width/R.refdef.vrect.height),R.perspective[5]=4/e,t=GL.UseProgram("Alias"),gl.uniformMatrix4fv(t.uPerspective,!1,R.perspective),gl.depthRange(0,1)}},R.PolyBlend=function(){if(0!==R.polyblend.value&&0!==V.blend[3]){GL.UseProgram("Fill",!0);var e=R.refdef.vrect;GL.StreamDrawColoredQuad(e.x,e.y,e.width,e.height,V.blend[0],V.blend[1],V.blend[2],255*V.blend[3])}},R.SetFrustum=function(){var e,t;for(R.frustum[0].normal=Vec.RotatePointAroundVector(R.vup,R.vpn,-(90-.5*R.refdef.fov_x)),R.frustum[1].normal=Vec.RotatePointAroundVector(R.vup,R.vpn,90-.5*R.refdef.fov_x),R.frustum[2].normal=Vec.RotatePointAroundVector(R.vright,R.vpn,90-.5*R.refdef.fov_y),R.frustum[3].normal=Vec.RotatePointAroundVector(R.vright,R.vpn,-(90-.5*R.refdef.fov_y)),e=0;e<=3;++e)(t=R.frustum[e]).type=5,t.dist=Vec.DotProduct(R.refdef.vieworg,t.normal),t.signbits=0,t.normal[0]<0&&(t.signbits=1),t.normal[1]<0&&(t.signbits+=2),t.normal[2]<0&&(t.signbits+=4),t.normal[3]<0&&(t.signbits+=8)},R.perspective=[0,0,0,0,0,0,0,0,0,0,-65540/65532,-1,0,0,-524288/65532,0],R.Perspective=function(){var e,t,r=[R.refdef.viewangles[0]*Math.PI/180,(R.refdef.viewangles[1]-90)*Math.PI/-180,R.refdef.viewangles[2]*Math.PI/-180],l=Math.sin(r[0]),a=Math.cos(r[0]),i=Math.sin(r[1]),n=Math.cos(r[1]),o=Math.sin(r[2]),s=Math.cos(r[2]),g=[s*n+o*l*i,a*i,-o*n+s*l*i,s*-i+o*l*n,a*n,-o*-i+s*l*n,o*a,-l,s*a];for(V.gamma.value<.5?Cvar.SetValue("gamma",.5):V.gamma.value>1&&Cvar.SetValue("gamma",1),GL.UnbindProgram(),e=0;e<GL.programs.length;++e)t=GL.programs[e],gl.useProgram(t.program),null!=t.uViewOrigin&&gl.uniform3fv(t.uViewOrigin,R.refdef.vieworg),null!=t.uViewAngles&&gl.uniformMatrix3fv(t.uViewAngles,!1,g),null!=t.uPerspective&&gl.uniformMatrix4fv(t.uPerspective,!1,R.perspective),null!=t.uGamma&&gl.uniform1f(t.uGamma,V.gamma.value)},R.SetupGL=function(){if(!0===R.dowarp)gl.bindFramebuffer(gl.FRAMEBUFFER,R.warpbuffer),gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT),gl.viewport(0,0,R.warpwidth,R.warpheight);else{var e=R.refdef.vrect,t=SCR.devicePixelRatio;gl.viewport(e.x*t>>0,(VID.height-e.height-e.y)*t>>0,e.width*t>>0,e.height*t>>0)}R.Perspective(),gl.enable(gl.DEPTH_TEST)},R.RenderScene=function(){CL.state.maxclients>=2&&Cvar.Set("r_fullbright","0"),R.AnimateLight(),Vec.AngleVectors(R.refdef.viewangles,R.vpn,R.vright,R.vup),R.viewleaf=Mod.PointInLeaf(R.refdef.vieworg,CL.state.worldmodel),V.SetContentsColor(R.viewleaf.contents),V.CalcBlend(),R.dowarp=0!==R.waterwarp.value&&R.viewleaf.contents<=Mod.contents.water,R.SetFrustum(),R.SetupGL(),R.MarkLeaves(),gl.enable(gl.CULL_FACE),R.DrawSkyBox(),R.DrawViewModel(),R.DrawWorld(),R.DrawEntitiesOnList(),gl.disable(gl.CULL_FACE),R.RenderDlights(),R.DrawParticles()},R.RenderView=function(){var e;if(gl.finish(),0!==R.speeds.value&&(e=Sys.FloatTime()),R.c_brush_verts=0,R.c_alias_polys=0,gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT),R.RenderScene(),0!==R.speeds.value){var t=Math.floor(1e3*(Sys.FloatTime()-e)),r=R.c_brush_verts/3,l=R.c_alias_polys,a=(t>=100?"":t>=10?" ":"  ")+t+" ms  ";a+=(r>=1e3?"":r>=100?" ":r>=10?"  ":"   ")+r+" wpoly ",a+=(l>=1e3?"":l>=100?" ":l>=10?"  ":"   ")+l+" epoly\n",Con.Print(a)}},R.MakeBrushModelDisplayLists=function(e){var t,r,l;null!=e.cmds&&gl.deleteBuffer(e.cmds);var a,i,n,o,s=[],g=[0,0,0,0],u=0;for(e.chains=[],t=0;t<e.textures.length;++t)if(!0!==(a=e.textures[t]).sky&&!0!==a.turbulent){for(i=[t,u,0],r=0;r<e.numfaces;++r)if((n=e.faces[e.firstface+r]).texture===t){switch(g[0]=g[1]=g[2]=g[3]=0,n.styles.length){case 4:g[3]=.015625*n.styles[3]+.0078125;case 3:g[2]=.015625*n.styles[2]+.0078125;case 2:g[1]=.015625*n.styles[1]+.0078125;case 1:g[0]=.015625*n.styles[0]+.0078125}for(i[2]+=n.verts.length,l=0;l<n.verts.length;++l)o=n.verts[l],s[s.length]=o[0],s[s.length]=o[1],s[s.length]=o[2],s[s.length]=o[3],s[s.length]=o[4],s[s.length]=o[5],s[s.length]=o[6],s[s.length]=g[0],s[s.length]=g[1],s[s.length]=g[2],s[s.length]=g[3]}0!==i[2]&&(e.chains[e.chains.length]=i,u+=i[2])}for(e.waterchain=44*u,u=0,t=0;t<e.textures.length;++t)if(!0===(a=e.textures[t]).turbulent){for(i=[t,u,0],r=0;r<e.numfaces;++r)if((n=e.faces[e.firstface+r]).texture===t)for(i[2]+=n.verts.length,l=0;l<n.verts.length;++l)o=n.verts[l],s[s.length]=o[0],s[s.length]=o[1],s[s.length]=o[2],s[s.length]=o[3],s[s.length]=o[4];0!==i[2]&&(e.chains[e.chains.length]=i,u+=i[2])}e.cmds=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,e.cmds),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(s),gl.STATIC_DRAW)},R.MakeWorldModelDisplayLists=function(e){if(null==e.cmds){var t,r,l,a,i,n,o,s,g,u=[],R=[0,0,0,0],f=0;for(t=0;t<e.textures.length;++t)if(!0!==(i=e.textures[t]).sky&&!0!==i.turbulent)for(r=0;r<e.leafs.length;++r){for(n=e.leafs[r],o=[t,f,0],l=0;l<n.nummarksurfaces;++l)if((s=e.faces[e.marksurfaces[n.firstmarksurface+l]]).texture===t){switch(R[0]=R[1]=R[2]=R[3]=0,s.styles.length){case 4:R[3]=.015625*s.styles[3]+.0078125;case 3:R[2]=.015625*s.styles[2]+.0078125;case 2:R[1]=.015625*s.styles[1]+.0078125;case 1:R[0]=.015625*s.styles[0]+.0078125}for(o[2]+=s.verts.length,a=0;a<s.verts.length;++a)g=s.verts[a],u[u.length]=g[0],u[u.length]=g[1],u[u.length]=g[2],u[u.length]=g[3],u[u.length]=g[4],u[u.length]=g[5],u[u.length]=g[6],u[u.length]=R[0],u[u.length]=R[1],u[u.length]=R[2],u[u.length]=R[3]}0!==o[2]&&(n.cmds[n.cmds.length]=o,++n.skychain,++n.waterchain,f+=o[2])}for(e.skychain=44*f,f=0,t=0;t<e.textures.length;++t)if(!0===(i=e.textures[t]).sky)for(r=0;r<e.leafs.length;++r){for(n=e.leafs[r],o=[f,0],l=0;l<n.nummarksurfaces;++l)if((s=e.faces[e.marksurfaces[n.firstmarksurface+l]]).texture===t)for(o[1]+=s.verts.length,a=0;a<s.verts.length;++a)g=s.verts[a],u[u.length]=g[0],u[u.length]=g[1],u[u.length]=g[2];0!==o[1]&&(n.cmds[n.cmds.length]=o,++n.waterchain,f+=o[1])}for(e.waterchain=e.skychain+12*f,f=0,t=0;t<e.textures.length;++t)if(!0===(i=e.textures[t]).turbulent)for(r=0;r<e.leafs.length;++r){for(n=e.leafs[r],o=[t,f,0],l=0;l<n.nummarksurfaces;++l)if((s=e.faces[e.marksurfaces[n.firstmarksurface+l]]).texture===t)for(o[2]+=s.verts.length,a=0;a<s.verts.length;++a)g=s.verts[a],u[u.length]=g[0],u[u.length]=g[1],u[u.length]=g[2],u[u.length]=g[3],u[u.length]=g[4];0!==o[2]&&(n.cmds[n.cmds.length]=o,f+=o[2])}e.cmds=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,e.cmds),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(u),gl.STATIC_DRAW)}},R.InitTextures=function(){var e,t,r=new Uint8Array(new ArrayBuffer(256));for(e=0;e<8;++e)for(t=0;t<8;++t)r[(e<<4)+t]=r[136+(e<<4)+t]=255,r[8+(e<<4)+t]=r[128+(e<<4)+t]=0;R.notexture_mip={name:"notexture",width:16,height:16,texturenum:gl.createTexture()},GL.Bind(0,R.notexture_mip.texturenum),GL.Upload(r,16,16),R.solidskytexture=gl.createTexture(),GL.Bind(0,R.solidskytexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),R.alphaskytexture=gl.createTexture(),GL.Bind(0,R.alphaskytexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),R.lightmap_texture=gl.createTexture(),GL.Bind(0,R.lightmap_texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),R.dlightmap_texture=gl.createTexture(),GL.Bind(0,R.dlightmap_texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),R.lightstyle_texture=gl.createTexture(),GL.Bind(0,R.lightstyle_texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),R.fullbright_texture=gl.createTexture(),GL.Bind(0,R.fullbright_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([255,0,0,0])),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),R.null_texture=gl.createTexture(),GL.Bind(0,R.null_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST)},R.Init=function(){R.InitTextures(),Cmd.AddCommand("timerefresh",R.TimeRefresh_f),Cmd.AddCommand("pointfile",R.ReadPointFile_f),R.waterwarp=Cvar.RegisterVariable("r_waterwarp","1"),R.fullbright=Cvar.RegisterVariable("r_fullbright","0"),R.drawentities=Cvar.RegisterVariable("r_drawentities","1"),R.drawviewmodel=Cvar.RegisterVariable("r_drawviewmodel","1"),R.novis=Cvar.RegisterVariable("r_novis","0"),R.speeds=Cvar.RegisterVariable("r_speeds","0"),R.polyblend=Cvar.RegisterVariable("gl_polyblend","1"),R.flashblend=Cvar.RegisterVariable("gl_flashblend","0"),R.nocolors=Cvar.RegisterVariable("gl_nocolors","0"),R.InitParticles(),GL.CreateProgram("Alias",["uOrigin","uAngles","uViewOrigin","uViewAngles","uPerspective","uLightVec","uGamma","uAmbientLight","uShadeLight"],[["aPosition",gl.FLOAT,3],["aNormal",gl.FLOAT,3],["aTexCoord",gl.FLOAT,2]],["tTexture"]),GL.CreateProgram("Brush",["uOrigin","uAngles","uViewOrigin","uViewAngles","uPerspective","uGamma"],[["aPosition",gl.FLOAT,3],["aTexCoord",gl.FLOAT,4],["aLightStyle",gl.FLOAT,4]],["tTexture","tLightmap","tDlight","tLightStyle"]),GL.CreateProgram("Dlight",["uOrigin","uViewOrigin","uViewAngles","uPerspective","uRadius","uGamma"],[["aPosition",gl.FLOAT,3]],[]),GL.CreateProgram("Player",["uOrigin","uAngles","uViewOrigin","uViewAngles","uPerspective","uLightVec","uGamma","uAmbientLight","uShadeLight","uTop","uBottom"],[["aPosition",gl.FLOAT,3],["aNormal",gl.FLOAT,3],["aTexCoord",gl.FLOAT,2]],["tTexture","tPlayer"]),GL.CreateProgram("Sprite",["uViewOrigin","uViewAngles","uPerspective","uGamma"],[["aPosition",gl.FLOAT,3],["aTexCoord",gl.FLOAT,2]],["tTexture"]),GL.CreateProgram("Turbulent",["uOrigin","uAngles","uViewOrigin","uViewAngles","uPerspective","uGamma","uTime"],[["aPosition",gl.FLOAT,3],["aTexCoord",gl.FLOAT,2]],["tTexture"]),GL.CreateProgram("Warp",["uOrtho","uTime"],[["aPosition",gl.FLOAT,2],["aTexCoord",gl.FLOAT,2]],["tTexture"]),R.warpbuffer=gl.createFramebuffer(),R.warptexture=gl.createTexture(),GL.Bind(0,R.warptexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),R.warprenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,R.warprenderbuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,0,0),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,R.warpbuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,R.warptexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,R.warprenderbuffer),gl.bindFramebuffer(gl.FRAMEBUFFER,null),R.dlightvecs=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,R.dlightvecs),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,-1,0,0,0,1,-.382683,0,.92388,-.707107,0,.707107,-.92388,0,.382683,-1,0,0,-.92388,0,-.382683,-.707107,0,-.707107,-.382683,0,-.92388,0,0,-1,.382683,0,-.92388,.707107,0,-.707107,.92388,0,-.382683,1,0,0,.92388,0,.382683,.707107,0,.707107,.382683,0,.92388,0,0,1]),gl.STATIC_DRAW),R.MakeSky()},R.NewMap=function(){var e;for(e=0;e<64;++e)R.lightstylevalue[e]=12;for(R.ClearParticles(),R.BuildLightmaps(),e=0;e<=1048575;++e)R.dlightmaps[e]=0;GL.Bind(0,R.dlightmap_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,1024,1024,0,gl.ALPHA,gl.UNSIGNED_BYTE,null)},R.TimeRefresh_f=function(){var e;gl.finish();var t=Sys.FloatTime();for(e=0;e<=127;++e)R.refdef.viewangles[1]=2.8125*e,R.RenderView();gl.finish();var r=Sys.FloatTime()-t;Con.Print(r.toFixed(6)+" seconds ("+(128/r).toFixed(6)+" fps)\n")},R.ptype={tracer:0,grav:1,slowgrav:2,fire:3,explode:4,explode2:5,blob:6,blob2:7},R.ramp1=[111,109,107,105,103,101,99,97],R.ramp2=[111,110,109,108,107,106,104,102],R.ramp3=[109,107,6,5,4,3],R.InitParticles=function(){var e=COM.CheckParm("-particles");for(null!=e?(R.numparticles=Q.atoi(COM.argv[e+1]),R.numparticles<512&&(R.numparticles=512)):R.numparticles=2048,R.avelocities=[],e=0;e<=161;++e)R.avelocities[e]=[2.56*Math.random(),2.56*Math.random(),2.56*Math.random()];GL.CreateProgram("Particle",["uViewOrigin","uViewAngles","uPerspective","uGamma"],[["aOrigin",gl.FLOAT,3],["aCoord",gl.FLOAT,2],["aScale",gl.FLOAT,1],["aColor",gl.UNSIGNED_BYTE,3,!0]],[])},R.EntityParticles=function(e){var t,r,l,a,i,n,o=R.AllocParticles(162);for(t=0;t<o.length;++t)r=CL.state.time*R.avelocities[t][0],l=Math.sin(r),i=Math.cos(r),r=CL.state.time*R.avelocities[t][1],a=Math.sin(r),n=Math.cos(r),R.particles[o[t]]={die:CL.state.time+.01,color:111,ramp:0,type:R.ptype.explode,org:[e.origin[0]+64*R.avertexnormals[t][0]+i*n*16,e.origin[1]+64*R.avertexnormals[t][1]+i*a*16,e.origin[2]+64*R.avertexnormals[t][2]+-16*l],vel:[0,0,0]}},R.ClearParticles=function(){var e;for(R.particles=[],e=0;e<R.numparticles;++e)R.particles[e]={die:-1}},R.ReadPointFile_f=function(){if(!0===SV.server.active){var e="maps/"+PR.GetString(PR.globals_int[PR.globalvars.mapname])+".pts",t=COM.LoadTextFile(e);if(null!=t){var r,l,a;for(Con.Print("Reading "+e+"...\n"),t=t.split("\n"),r=0;r<t.length&&3===(l=t[r].split(" ")).length;){if(++r,0===(a=R.AllocParticles(1)).length){Con.Print("Not enough free particles\n");break}R.particles[a[0]]={die:99999,color:15&-r,type:R.ptype.tracer,vel:[0,0,0],org:[Q.atof(l[0]),Q.atof(l[1]),Q.atof(l[2])]}}Con.Print(r+" points read\n")}else Con.Print("couldn't open "+e+"\n")}},R.ParseParticleEffect=function(){var e=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],t=[.0625*MSG.ReadChar(),.0625*MSG.ReadChar(),.0625*MSG.ReadChar()],r=MSG.ReadByte(),l=MSG.ReadByte();255===r?R.ParticleExplosion(e):R.RunParticleEffect(e,t,l,r)},R.ParticleExplosion=function(e){var t,r=R.AllocParticles(1024);for(t=0;t<r.length;++t)R.particles[r[t]]={die:CL.state.time+5,color:R.ramp1[0],ramp:Math.floor(4*Math.random()),type:0!=(1&t)?R.ptype.explode:R.ptype.explode2,org:[e[0]+32*Math.random()-16,e[1]+32*Math.random()-16,e[2]+32*Math.random()-16],vel:[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]}},R.ParticleExplosion2=function(e,t,r){var l,a=R.AllocParticles(512),i=0;for(l=0;l<a.length;++l)R.particles[a[l]]={die:CL.state.time+.3,color:t+i++%r,type:R.ptype.blob,org:[e[0]+32*Math.random()-16,e[1]+32*Math.random()-16,e[2]+32*Math.random()-16],vel:[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]}},R.BlobExplosion=function(e){var t,r,l=R.AllocParticles(1024);for(t=0;t<l.length;++t)(r=R.particles[l[t]]).die=CL.state.time+1+.4*Math.random(),0!=(1&t)?(r.type=R.ptype.blob,r.color=66+Math.floor(7*Math.random())):(r.type=R.ptype.blob2,r.color=150+Math.floor(7*Math.random())),r.org=[e[0]+32*Math.random()-16,e[1]+32*Math.random()-16,e[2]+32*Math.random()-16],r.vel=[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]},R.RunParticleEffect=function(e,t,r,l){var a,i=R.AllocParticles(l);for(a=0;a<i.length;++a)R.particles[i[a]]={die:CL.state.time+.6*Math.random(),color:(248&r)+Math.floor(8*Math.random()),type:R.ptype.slowgrav,org:[e[0]+16*Math.random()-8,e[1]+16*Math.random()-8,e[2]+16*Math.random()-8],vel:[15*t[0],15*t[1],15*t[2]]}},R.LavaSplash=function(e){var t,r,l,a,i=R.AllocParticles(1024),n=0,o=[];for(t=-16;t<=15;++t)for(r=-16;r<=15;++r){if(n>=i.length)return;(l=R.particles[i[n++]]).die=CL.state.time+2+.64*Math.random(),l.color=224+Math.floor(8*Math.random()),l.type=R.ptype.slowgrav,o[0]=8*(r+Math.random),o[1]=8*(t+Math.random),o[2]=256,l.org=[e[0]+o[0],e[1]+o[1],e[2]+64*Math.random()],Vec.Normalize(o),a=50+64*Math.random(),l.vel=[o[0]*a,o[1]*a,o[2]*a]}},R.TeleportSplash=function(e){var t,r,l,a,i,n=R.AllocParticles(896),o=0,s=[];for(t=-16;t<=15;t+=4)for(r=-16;r<=15;r+=4)for(l=-24;l<=31;l+=4){if(o>=n.length)return;(a=R.particles[n[o++]]).die=CL.state.time+.2+.16*Math.random(),a.color=7+Math.floor(8*Math.random()),a.type=R.ptype.slowgrav,s[0]=8*r,s[1]=8*t,s[2]=8*l,a.org=[e[0]+t+4*Math.random(),e[1]+r+4*Math.random(),e[2]+l+4*Math.random()],Vec.Normalize(s),i=50+64*Math.random(),a.vel=[s[0]*i,s[1]*i,s[2]*i]}},R.tracercount=0,R.RocketTrail=function(e,t,r){var l,a,i,n=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],o=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);if(0!==o)for(n=[n[0]/o,n[1]/o,n[2]/o],l=4===r?R.AllocParticles(Math.floor(o/6)):R.AllocParticles(Math.floor(o/3)),a=0;a<l.length;++a){switch((i=R.particles[l[a]]).vel=[0,0,0],i.die=CL.state.time+2,r){case 0:case 1:i.ramp=Math.floor(4*Math.random())+(r<<1),i.color=R.ramp3[i.ramp],i.type=R.ptype.fire,i.org=[e[0]+6*Math.random()-3,e[1]+6*Math.random()-3,e[2]+6*Math.random()-3];break;case 2:i.type=R.ptype.grav,i.color=67+Math.floor(4*Math.random()),i.org=[e[0]+6*Math.random()-3,e[1]+6*Math.random()-3,e[2]+6*Math.random()-3];break;case 3:case 5:i.die=CL.state.time+.5,i.type=R.ptype.tracer,i.color=3===r?52+((4&R.tracercount++)<<1):230+((4&R.tracercount++)<<1),i.org=[e[0],e[1],e[2]],0!=(1&R.tracercount)?(i.vel[0]=30*n[1],i.vel[2]=-30*n[0]):(i.vel[0]=-30*n[1],i.vel[2]=30*n[0]);break;case 4:i.type=R.ptype.grav,i.color=67+Math.floor(4*Math.random()),i.org=[e[0]+6*Math.random()-3,e[1]+6*Math.random()-3,e[2]+6*Math.random()-3];break;case 6:i.color=152+Math.floor(4*Math.random()),i.type=R.ptype.tracer,i.die=CL.state.time+.3,i.org=[e[0]+16*Math.random()-8,e[1]+16*Math.random()-8,e[2]+16*Math.random()-8]}e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}},R.DrawParticles=function(){GL.StreamFlush();GL.UseProgram("Particle");gl.depthMask(!1),gl.enable(gl.BLEND);for(var e,t=CL.state.time-CL.state.oldtime,r=t*SV.gravity.value*.05,l=4*t,a=[-1,-1,-1,1,1,-1,1,-1,-1,1,1,1],i=0;i<R.numparticles;++i){var n=R.particles[i];if(!(n.die<CL.state.time)){var o=VID.d_8to24table[n.color];e=(e=(n.org[0]-R.refdef.vieworg[0])*R.vpn[0]+(n.org[1]-R.refdef.vieworg[1])*R.vpn[1]+(n.org[2]-R.refdef.vieworg[2])*R.vpn[2])<20?.375:.375+.0015*e,GL.StreamGetSpace(6);for(var s=0;s<6;++s)GL.StreamWriteFloat3(n.org[0],n.org[1],n.org[2]),GL.StreamWriteFloat2(a[2*s],a[2*s+1]),GL.StreamWriteFloat(e),GL.StreamWriteUByte4(255&o,o>>8&255,o>>16,255);switch(n.org[0]+=n.vel[0]*t,n.org[1]+=n.vel[1]*t,n.org[2]+=n.vel[2]*t,n.type){case R.ptype.fire:n.ramp+=5*t,n.ramp>=6?n.die=-1:n.color=R.ramp3[Math.floor(n.ramp)],n.vel[2]+=r;continue;case R.ptype.explode:n.ramp+=10*t,n.ramp>=8?n.die=-1:n.color=R.ramp1[Math.floor(n.ramp)],n.vel[0]+=n.vel[0]*l,n.vel[1]+=n.vel[1]*l,n.vel[2]+=n.vel[2]*l-r;continue;case R.ptype.explode2:n.ramp+=15*t,n.ramp>=8?n.die=-1:n.color=R.ramp2[Math.floor(n.ramp)],n.vel[0]-=n.vel[0]*t,n.vel[1]-=n.vel[1]*t,n.vel[2]-=n.vel[2]*t+r;continue;case R.ptype.blob:n.vel[0]+=n.vel[0]*l,n.vel[1]+=n.vel[1]*l,n.vel[2]+=n.vel[2]*l-r;continue;case R.ptype.blob2:n.vel[0]+=n.vel[0]*l,n.vel[1]+=n.vel[1]*l,n.vel[2]-=r;continue;case R.ptype.grav:case R.ptype.slowgrav:n.vel[2]-=r}}}GL.StreamFlush(),gl.disable(gl.BLEND),gl.depthMask(!0)},R.AllocParticles=function(e){var t,r=[];for(t=0;t<R.numparticles;++t){if(0===e)return r;R.particles[t].die<CL.state.time&&(r[r.length]=t,--e)}return r},R.lightmap_modified=[],R.lightmaps=new Uint8Array(new ArrayBuffer(4194304)),R.dlightmaps=new Uint8Array(new ArrayBuffer(1048576)),R.AddDynamicLights=function(e){var t,r,l,a,i,n,o,s,g,u,f,d=1+(e.extents[0]>>4),m=1+(e.extents[1]>>4),c=d*m,h=CL.state.worldmodel.texinfo[e.texinfo],v=[],L=[],p=[];for(t=0;t<c;++t)p[t]=0;for(t=0;t<=31;++t)if(0!=(e.dlightbits>>>t&1)&&(r=CL.dlights[t],i=Vec.DotProduct(r.origin,e.plane.normal)-e.plane.dist,!((n=r.radius-Math.abs(i))<(o=r.minlight))))for(o=n-o,v[0]=r.origin[0]-e.plane.normal[0]*i,v[1]=r.origin[1]-e.plane.normal[1]*i,v[2]=r.origin[2]-e.plane.normal[2]*i,L[0]=Vec.DotProduct(v,h.vecs[0])+h.vecs[0][3]-e.texturemins[0],L[1]=Vec.DotProduct(v,h.vecs[1])+h.vecs[1][3]-e.texturemins[1],a=0;a<m;++a)for((g=L[1]-(a<<4))<0&&(g=-g),g=Math.floor(g),l=0;l<d;++l)(s=L[0]-(l<<4))<0&&(s=-s),(i=(s=Math.floor(s))>g?s+(g>>1):g+(s>>1))<o&&(p[a*d+l]+=Math.floor(256*(n-i)));for(t=0,a=0;a<m;++a)for(R.lightmap_modified[e.light_t+a]=!0,u=(e.light_t+a<<10)+e.light_s,l=0;l<d;++l)(f=p[t++]>>7)>255&&(f=255),R.dlightmaps[u+l]=f},R.RemoveDynamicLights=function(e){var t,r,l,a=1+(e.extents[0]>>4),i=1+(e.extents[1]>>4);for(l=0;l<i;++l)for(R.lightmap_modified[e.light_t+l]=!0,t=(e.light_t+l<<10)+e.light_s,r=0;r<a;++r)R.dlightmaps[t+r]=0},R.BuildLightMap=function(e){var t,r,l,a,i=1+(e.extents[0]>>4),n=1+(e.extents[1]>>4),o=e.lightofs;for(a=0;a<e.styles.length;++a)for(t=(e.light_t<<12)+(e.light_s<<2)+a,r=0;r<n;++r){for(l=0;l<i;++l)R.lightmaps[t+(l<<2)]=R.currentmodel.lightdata[o+l];o+=i,t+=4096}for(;a<=3;++a)for(t=(e.light_t<<12)+(e.light_s<<2)+a,r=0;r<n;++r){for(l=0;l<i;++l)R.lightmaps[t+(l<<2)]=0;t+=4096}},R.TextureAnimation=function(e){var t=0;null!=e.anim_base&&(t=e.anim_frame,e=R.currententity.model.textures[e.anim_base]);var r=e.anims;return null==r?e:(0!==R.currententity.frame&&0!==e.alternate_anims.length&&(r=e.alternate_anims),R.currententity.model.textures[r[(Math.floor(5*CL.state.time)+t)%r.length]])},R.DrawBrushModel=function(e){var t=e.model;if(!0===t.submodel){if(!0===R.CullBox([e.origin[0]+t.mins[0],e.origin[1]+t.mins[1],e.origin[2]+t.mins[2]],[e.origin[0]+t.maxs[0],e.origin[1]+t.maxs[1],e.origin[2]+t.maxs[2]]))return}else if(!0===R.CullBox([e.origin[0]-t.radius,e.origin[1]-t.radius,e.origin[2]-t.radius],[e.origin[0]+t.radius,e.origin[1]+t.radius,e.origin[2]+t.radius]))return;gl.bindBuffer(gl.ARRAY_BUFFER,t.cmds);var r,l,a,i=GL.RotationMatrix(e.angles[0],e.angles[1],e.angles[2]),n=GL.UseProgram("Brush");for(gl.uniform3fv(n.uOrigin,e.origin),gl.uniformMatrix3fv(n.uAngles,!1,i),gl.vertexAttribPointer(n.aPosition.location,3,gl.FLOAT,!1,44,0),gl.vertexAttribPointer(n.aTexCoord.location,4,gl.FLOAT,!1,44,12),gl.vertexAttribPointer(n.aLightStyle.location,4,gl.FLOAT,!1,44,28),0!==R.fullbright.value||null==t.lightdata?GL.Bind(n.tLightmap,R.fullbright_texture):GL.Bind(n.tLightmap,R.lightmap_texture),GL.Bind(n.tDlight,0===R.flashblend.value&&!0===t.submodel?R.dlightmap_texture:R.null_texture),GL.Bind(n.tLightStyle,R.lightstyle_texture),r=0;r<t.chains.length;++r)l=t.chains[r],!0!==(a=R.TextureAnimation(t.textures[l[0]])).turbulent&&(R.c_brush_verts+=l[2],GL.Bind(n.tTexture,a.texturenum),gl.drawArrays(gl.TRIANGLES,l[1],l[2]));for(n=GL.UseProgram("Turbulent"),gl.uniform3f(n.uOrigin,0,0,0),gl.uniformMatrix3fv(n.uAngles,!1,i),gl.uniform1f(n.uTime,Host.realtime%(2*Math.PI)),gl.vertexAttribPointer(n.aPosition.location,3,gl.FLOAT,!1,20,e.model.waterchain),gl.vertexAttribPointer(n.aTexCoord.location,2,gl.FLOAT,!1,20,e.model.waterchain+12),r=0;r<t.chains.length;++r)l=t.chains[r],!0===(a=t.textures[l[0]]).turbulent&&(R.c_brush_verts+=l[2],GL.Bind(n.tTexture,a.texturenum),gl.drawArrays(gl.TRIANGLES,l[1],l[2]))},R.RecursiveWorldNode=function(e){if(e.contents!==Mod.contents.solid){if(e.contents<0){if(e.markvisframe!==R.visframecount)return;return e.visframe=R.visframecount,void(e.skychain!==e.waterchain&&(R.drawsky=!0))}R.RecursiveWorldNode(e.children[0]),R.RecursiveWorldNode(e.children[1])}},R.DrawWorld=function(){var e=CL.state.worldmodel;R.currententity=CL.entities[0],gl.bindBuffer(gl.ARRAY_BUFFER,e.cmds);var t,r,l,a,i=GL.UseProgram("Brush");for(gl.uniform3f(i.uOrigin,0,0,0),gl.uniformMatrix3fv(i.uAngles,!1,GL.identity),gl.vertexAttribPointer(i.aPosition.location,3,gl.FLOAT,!1,44,0),gl.vertexAttribPointer(i.aTexCoord.location,4,gl.FLOAT,!1,44,12),gl.vertexAttribPointer(i.aLightStyle.location,4,gl.FLOAT,!1,44,28),0!==R.fullbright.value||null==e.lightdata?GL.Bind(i.tLightmap,R.fullbright_texture):GL.Bind(i.tLightmap,R.lightmap_texture),0===R.flashblend.value?GL.Bind(i.tDlight,R.dlightmap_texture):GL.Bind(i.tDlight,R.null_texture),GL.Bind(i.tLightStyle,R.lightstyle_texture),t=0;t<e.leafs.length;++t)if((l=e.leafs[t]).visframe===R.visframecount&&0!==l.skychain&&!0!==R.CullBox(l.mins,l.maxs))for(r=0;r<l.skychain;++r)a=l.cmds[r],R.c_brush_verts+=a[2],GL.Bind(i.tTexture,R.TextureAnimation(e.textures[a[0]]).texturenum),gl.drawArrays(gl.TRIANGLES,a[1],a[2]);for(i=GL.UseProgram("Turbulent"),gl.uniform3f(i.uOrigin,0,0,0),gl.uniformMatrix3fv(i.uAngles,!1,GL.identity),gl.uniform1f(i.uTime,Host.realtime%(2*Math.PI)),gl.vertexAttribPointer(i.aPosition.location,3,gl.FLOAT,!1,20,e.waterchain),gl.vertexAttribPointer(i.aTexCoord.location,2,gl.FLOAT,!1,20,e.waterchain+12),t=0;t<e.leafs.length;++t)if((l=e.leafs[t]).visframe===R.visframecount&&l.waterchain!==l.cmds.length&&!0!==R.CullBox(l.mins,l.maxs))for(r=l.waterchain;r<l.cmds.length;++r)a=l.cmds[r],R.c_brush_verts+=a[2],GL.Bind(i.tTexture,e.textures[a[0]].texturenum),gl.drawArrays(gl.TRIANGLES,a[1],a[2])},R.MarkLeaves=function(){if(R.oldviewleaf!==R.viewleaf||0!==R.novis.value){++R.visframecount,R.oldviewleaf=R.viewleaf;var e,t,r=0!==R.novis.value?Mod.novis:Mod.LeafPVS(R.viewleaf,CL.state.worldmodel);for(e=0;e<CL.state.worldmodel.leafs.length;++e)if(0!=(r[e>>3]&1<<(7&e)))for(t=CL.state.worldmodel.leafs[e+1];null!=t&&t.markvisframe!==R.visframecount;t=t.parent)t.markvisframe=R.visframecount;do{if(0!==R.novis.value)break;var l;R.refdef.vieworg[0],R.refdef.vieworg[1],R.refdef.vieworg[2];if(R.viewleaf.contents<=Mod.contents.water){if((l=Mod.PointInLeaf([R.refdef.vieworg[0],R.refdef.vieworg[1],R.refdef.vieworg[2]+16],CL.state.worldmodel)).contents<=Mod.contents.water)break}else if((l=Mod.PointInLeaf([R.refdef.vieworg[0],R.refdef.vieworg[1],R.refdef.vieworg[2]-16],CL.state.worldmodel)).contents>Mod.contents.water)break;if(l===R.viewleaf)break;for(r=Mod.LeafPVS(l,CL.state.worldmodel),e=0;e<CL.state.worldmodel.leafs.length;++e)if(0!=(r[e>>3]&1<<(7&e)))for(t=CL.state.worldmodel.leafs[e+1];null!=t&&t.markvisframe!==R.visframecount;t=t.parent)t.markvisframe=R.visframecount}while(0);R.drawsky=!1,R.RecursiveWorldNode(CL.state.worldmodel.nodes[0])}},R.AllocBlock=function(e){var t,r,l,a,i,n=1+(e.extents[0]>>4),o=1+(e.extents[1]>>4),s=1024;for(l=0;l<1024-n;++l){for(i=0,a=0;a<n&&!(R.allocated[l+a]>=s);++a)R.allocated[l+a]>i&&(i=R.allocated[l+a]);a===n&&(t=l,r=s=i)}for((s+=o)>1024&&Sys.Error("AllocBlock: full"),l=0;l<n;++l)R.allocated[t+l]=s;e.light_s=t,e.light_t=r},R.BuildSurfaceDisplayList=function(e){if(e.verts=[],!(e.numedges<=2)){var t,r,l,a,i,n,o=R.currentmodel.texinfo[e.texinfo],s=R.currentmodel.textures[o.texture];for(t=0;t<e.numedges;++t)a=[(l=(r=R.currentmodel.surfedges[e.firstedge+t])>0?R.currentmodel.vertexes[R.currentmodel.edges[r][0]]:R.currentmodel.vertexes[R.currentmodel.edges[-r][1]])[0],l[1],l[2]],!0!==e.sky&&(i=Vec.DotProduct(l,o.vecs[0])+o.vecs[0][3],n=Vec.DotProduct(l,o.vecs[1])+o.vecs[1][3],a[3]=i/s.width,a[4]=n/s.height,!0!==e.turbulent&&(a[5]=(i-e.texturemins[0]+(e.light_s<<4)+8)/16384,a[6]=(n-e.texturemins[1]+(e.light_t<<4)+8)/16384)),t>=3&&(e.verts[e.verts.length]=e.verts[0],e.verts[e.verts.length]=e.verts[e.verts.length-2]),e.verts[e.verts.length]=a}},R.BuildLightmaps=function(){var e,t,r;for(R.allocated=[],e=0;e<1024;++e)R.allocated[e]=0;for(e=1;e<CL.state.model_precache.length;++e)if(R.currentmodel=CL.state.model_precache[e],R.currentmodel.type===Mod.type.brush){if(42!==R.currentmodel.name.charCodeAt(0))for(t=0;t<R.currentmodel.faces.length;++t)!0!==(r=R.currentmodel.faces[t]).sky&&!0!==r.turbulent&&(R.AllocBlock(r),null!=R.currentmodel.lightdata&&R.BuildLightMap(r)),R.BuildSurfaceDisplayList(r);1===e?R.MakeWorldModelDisplayLists(R.currentmodel):R.MakeBrushModelDisplayLists(R.currentmodel)}GL.Bind(0,R.lightmap_texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1024,1024,0,gl.RGBA,gl.UNSIGNED_BYTE,R.lightmaps)},R.WarpScreen=function(){GL.StreamFlush(),gl.finish(),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null);var e=GL.UseProgram("Warp");GL.Bind(e.tTexture,R.warptexture),gl.uniform1f(e.uTime,Host.realtime%(2*Math.PI));var t=R.refdef.vrect;GL.StreamDrawTexturedQuad(t.x,t.y,t.width,t.height,0,1,1,0),GL.StreamFlush()},R.MakeSky=function(){var e,t,r=[0,.19509,.382683,.55557,.707107,.83147,.92388,.980785,1],l=[];for(e=0;e<7;e+=2)for(l=l.concat([0,0,1,.19509*r[e+2],.19509*r[6-e],.980785,.19509*r[e],.19509*r[8-e],.980785]),t=0;t<7;++t)l=l.concat([r[e]*r[8-t],r[8-e]*r[8-t],r[t],r[e]*r[7-t],r[8-e]*r[7-t],r[t+1],r[e+2]*r[7-t],r[6-e]*r[7-t],r[t+1],r[e]*r[8-t],r[8-e]*r[8-t],r[t],r[e+2]*r[7-t],r[6-e]*r[7-t],r[t+1],r[e+2]*r[8-t],r[6-e]*r[8-t],r[t]]);GL.CreateProgram("Sky",["uViewAngles","uPerspective","uScale","uGamma","uTime"],[["aPosition",gl.FLOAT,3]],["tSolid","tAlpha"]),GL.CreateProgram("SkyChain",["uViewOrigin","uViewAngles","uPerspective"],[["aPosition",gl.FLOAT,3]],[]),R.skyvecs=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,R.skyvecs),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(l),gl.STATIC_DRAW)},R.DrawSkyBox=function(){if(!0===R.drawsky){gl.colorMask(!1,!1,!1,!1);var e,t,r,l,a=CL.state.worldmodel,i=GL.UseProgram("SkyChain");for(gl.bindBuffer(gl.ARRAY_BUFFER,a.cmds),gl.vertexAttribPointer(i.aPosition.location,3,gl.FLOAT,!1,12,a.skychain),e=0;e<a.leafs.length;++e)if((r=a.leafs[e]).visframe===R.visframecount&&r.skychain!==r.waterchain&&!0!==R.CullBox(r.mins,r.maxs))for(t=r.skychain;t<r.waterchain;++t)l=r.cmds[t],gl.drawArrays(gl.TRIANGLES,l[0],l[1]);gl.colorMask(!0,!0,!0,!0),gl.depthFunc(gl.GREATER),gl.depthMask(!1),gl.disable(gl.CULL_FACE),i=GL.UseProgram("Sky"),gl.uniform2f(i.uTime,.125*Host.realtime%1,.03125*Host.realtime%1),GL.Bind(i.tSolid,R.solidskytexture),GL.Bind(i.tAlpha,R.alphaskytexture),gl.bindBuffer(gl.ARRAY_BUFFER,R.skyvecs),gl.vertexAttribPointer(i.aPosition.location,3,gl.FLOAT,!1,12,0),gl.uniform3f(i.uScale,2,-2,1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,2,-2,-1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,2,2,1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,2,2,-1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,-2,-2,1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,-2,-2,-1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,-2,2,1),gl.drawArrays(gl.TRIANGLES,0,180),gl.uniform3f(i.uScale,-2,2,-1),gl.drawArrays(gl.TRIANGLES,0,180),gl.enable(gl.CULL_FACE),gl.depthMask(!0),gl.depthFunc(gl.LESS)}},R.InitSky=function(e){var t,r,l,a=new ArrayBuffer(65536),i=new Uint32Array(a);for(t=0;t<128;++t)for(r=0;r<128;++r)i[(t<<7)+r]=COM.LittleLong(VID.d_8to24table[e[(t<<8)+r+128]]+4278190080);for(GL.Bind(0,R.solidskytexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(a)),gl.generateMipmap(gl.TEXTURE_2D),t=0;t<128;++t)for(r=0;r<128;++r)0!==e[l=(t<<8)+r]?i[(t<<7)+r]=COM.LittleLong(VID.d_8to24table[e[l]]+4278190080):i[(t<<7)+r]=0;GL.Bind(0,R.alphaskytexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(a)),gl.generateMipmap(gl.TEXTURE_2D)};

			// S.js
			S={},S.channels=[],S.static_channels=[],S.ambient_channels=[],S.listener_origin=[0,0,0],S.listener_forward=[0,0,0],S.listener_right=[0,0,0],S.listener_up=[0,0,0],S.known_sfx=[],S.Init=function(){Con.Print("\nSound Initialization\n"),Cmd.AddCommand("play",S.Play),Cmd.AddCommand("playvol",S.PlayVol),Cmd.AddCommand("stopsound",S.StopAllSounds),Cmd.AddCommand("soundlist",S.SoundList),S.nosound=Cvar.RegisterVariable("nosound",null!=COM.CheckParm("-nosound")?"1":"0"),S.volume=Cvar.RegisterVariable("volume","0.7",!0),S.precache=Cvar.RegisterVariable("precache","1"),S.bgmvolume=Cvar.RegisterVariable("bgmvolume","1",!0),S.ambient_level=Cvar.RegisterVariable("ambient_level","0.3"),S.ambient_fade=Cvar.RegisterVariable("ambient_fade","100"),S.started=!0;var e,n,t,o=["water1","wind2"];for(e=0;e<o.length;++e)n={sfx:S.PrecacheSound("ambience/"+o[e]+".wav"),end:0,master_vol:0},S.ambient_channels[e]=n,!0===S.LoadSound(n.sfx)&&(null!=n.sfx.cache.loopstart?null!=S.context?(t={source:S.context.createBufferSource(),gain:S.context.createGainNode()},n.nodes=t,t.source.buffer=n.sfx.cache.data,t.source.loop=!0,t.source.loopStart=n.sfx.cache.loopstart,t.source.loopEnd=t.source.buffer.length,t.source.connect(t.gain),t.gain.connect(S.context.destination)):n.audio=n.sfx.cache.data.cloneNode():Con.Print("Sound ambience/"+n.sfx.name+".wav not looped\n"));Con.sfx_talk=S.PrecacheSound("misc/talk.wav")},S.NoteOff=function(e){if(1===e.playbackState||2===e.playbackState)try{e.noteOff(0)}catch(e){}},S.NoteOn=function(e){if(0===e.playbackState||3===e.playbackState)try{e.noteOn(0)}catch(e){}},S.PrecacheSound=function(e){if(0===S.nosound.value){var n,t;for(n=0;n<S.known_sfx.length;++n)if(S.known_sfx[n].name===e){t=S.known_sfx[n];break}return n===S.known_sfx.length&&(S.known_sfx[n]={name:e},t=S.known_sfx[n]),0!==S.precache.value&&S.LoadSound(t),t}},S.PickChannel=function(e,n){var t,o;if(0!==n)for(t=0;t<S.channels.length;++t)if(null!=(o=S.channels[t])&&o.entnum===e&&(o.entchannel===n||-1===n)){o.sfx=null,null!=o.nodes?(S.NoteOff(o.nodes.source),o.nodes=null):null!=o.audio&&(o.audio.pause(),o.audio=null);break}if(0===n||t===S.channels.length)for(t=0;t<S.channels.length&&null!=(o=S.channels[t])&&null!=o.sfx;++t);return t===S.channels.length?(S.channels[t]={end:0},S.channels[t]):o},S.Spatialize=function(e){if(e.entnum===CL.state.viewentity)return e.leftvol=e.master_vol,void(e.rightvol=e.master_vol);var n=[e.origin[0]-S.listener_origin[0],e.origin[1]-S.listener_origin[1],e.origin[2]-S.listener_origin[2]],t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);0!==t&&(n[0]/=t,n[1]/=t,n[2]/=t),t*=e.dist_mult;var o=S.listener_right[0]*n[0]+S.listener_right[1]*n[1]+S.listener_right[2]*n[2];e.rightvol=e.master_vol*(1-t)*(1+o),e.rightvol<0&&(e.rightvol=0),e.leftvol=e.master_vol*(1-t)*(1-o),e.leftvol<0&&(e.leftvol=0)},S.StartSound=function(e,n,t,o,a,l){if(0===S.nosound.value&&null!=t){var i,r=S.PickChannel(e,n);if(r.origin=[o[0],o[1],o[2]],r.dist_mult=.001*l,r.master_vol=a,r.entnum=e,r.entchannel=n,S.Spatialize(r),0!==r.leftvol||0!==r.rightvol)if(!0===S.LoadSound(t))if(r.sfx=t,r.pos=0,r.end=Host.realtime+t.cache.length,null!=S.context){var s,c,u,d={source:S.context.createBufferSource(),merger1:S.context.createChannelMerger(2),splitter:S.context.createChannelSplitter(2),gain0:S.context.createGainNode(),gain1:S.context.createGainNode(),merger2:S.context.createChannelMerger(2)};for(r.nodes=d,d.source.buffer=t.cache.data,null!=t.cache.loopstart&&(d.source.loop=!0,d.source.loopStart=t.cache.loopstart,d.source.loopEnd=d.source.buffer.length),d.source.connect(d.merger1),d.source.connect(d.merger1,0,1),d.merger1.connect(d.splitter),d.splitter.connect(d.gain0,0),d.splitter.connect(d.gain1,1),(i=r.leftvol)>1&&(i=1),d.gain0.gain.value=i*S.volume.value,d.gain0.connect(d.merger2,0,0),(i=r.rightvol)>1&&(i=1),d.gain1.gain.value=i*S.volume.value,d.gain1.connect(d.merger2,0,1),d.merger2.connect(S.context.destination),s=0;s<S.channels.length;++s)if((c=S.channels[s])!==r&&c.sfx===t&&0===c.pos){if((u=.1*Math.random())>=t.cache.length){S.NoteOn(d.source);break}r.pos+=u,r.end-=u,d.source.noteGrainOn(0,u,d.source.buffer.length-u);break}S.NoteOn(d.source)}else r.audio=t.cache.data.cloneNode(),(i=.5*(r.leftvol+r.rightvol))>1&&(i=1),r.audio.volume=i*S.volume.value,r.audio.play();else r.sfx=null}},S.StopSound=function(e,n){var t,o;if(0===S.nosound.value)for(t=0;t<S.channels.length;++t)if(null!=(o=S.channels[t])&&o.entnum===e&&o.entchannel===n)return o.end=0,o.sfx=null,void(null!=o.nodes?(S.NoteOff(o.nodes.source),o.nodes=null):null!=o.audio&&(o.audio.pause(),o.audio=null))},S.StopAllSounds=function(){if(0===S.nosound.value){var e,n;for(e=0;e<S.ambient_channels.length;++e)(n=S.ambient_channels[e]).master_vol=0,null!=n.nodes?S.NoteOff(n.nodes.source):null!=n.audio&&n.audio.pause();for(e=0;e<S.channels.length;++e)null!=(n=S.channels[e])&&(null!=n.nodes?S.NoteOff(n.nodes.source):null!=n.audio&&n.audio.pause());if(S.channels=[],null!=S.context)for(e=0;e<S.static_channels.length;++e)S.NoteOff(S.static_channels[e].nodes.source);else for(e=0;e<S.static_channels.length;++e)S.static_channels[e].audio.pause();S.static_channels=[]}},S.StaticSound=function(e,n,t,o){if(0===S.nosound.value&&null!=e&&!0===S.LoadSound(e))if(null!=e.cache.loopstart){var a={sfx:e,origin:[n[0],n[1],n[2]],master_vol:t,dist_mult:15625e-9*o,end:Host.realtime+e.cache.length};if(S.static_channels[S.static_channels.length]=a,null!=S.context){var l={source:S.context.createBufferSource(),merger1:S.context.createChannelMerger(2),splitter:S.context.createChannelSplitter(2),gain0:S.context.createGainNode(),gain1:S.context.createGainNode(),merger2:S.context.createChannelMerger(2)};a.nodes=l,l.source.buffer=e.cache.data,l.source.loop=!0,l.source.loopStart=e.cache.loopstart,l.source.loopEnd=l.source.buffer.length,l.source.connect(l.merger1),l.source.connect(l.merger1,0,1),l.merger1.connect(l.splitter),l.splitter.connect(l.gain0,0),l.splitter.connect(l.gain1,1),l.gain0.connect(l.merger2,0,0),l.gain1.connect(l.merger2,0,1),l.merger2.connect(S.context.destination)}else a.audio=e.cache.data.cloneNode(),a.audio.pause()}else Con.Print("Sound "+e.name+" not looped\n")},S.SoundList=function(){var e,n,t,o,a=0;for(e=0;e<S.known_sfx.length;++e)if(null!=(t=(n=S.known_sfx[e]).cache)){for(o=t.size.toString(),a+=t.size;o.length<=5;)o=" "+o;o=null!=t.loopstart?"L"+o:" "+o,Con.Print(o+" : "+n.name+"\n")}Con.Print("Total resident: "+a+"\n")},S.LocalSound=function(e){S.StartSound(CL.state.viewentity,-1,e,Vec.origin,1,1)},S.UpdateAmbientSounds=function(){if(null!=CL.state.worldmodel){var e,n,t,o,a=Mod.PointInLeaf(S.listener_origin,CL.state.worldmodel);if(null!=a&&0!==S.ambient_level.value){for(e=0;e<S.ambient_channels.length;++e)if(null!=(n=S.ambient_channels[e]).nodes||null!=n.audio)if((t=S.ambient_level.value*a.ambient_level[e])<8&&(t=0),t/=255,n.master_vol<t?(n.master_vol+=Host.frametime*S.ambient_fade.value/255,n.master_vol>t&&(n.master_vol=t)):n.master_vol>t&&(n.master_vol-=Host.frametime*S.ambient_fade.value/255,n.master_vol<t&&(n.master_vol=t)),0!==n.master_vol)if(n.master_vol>1&&(n.master_vol=1),null!=S.context)n.nodes.gain.gain.value=n.master_vol*S.volume.value,S.NoteOn(n.nodes.source);else{if(n.audio.volume=n.master_vol*S.volume.value,o=n.sfx.cache,!0===n.audio.paused){n.audio.play(),n.end=Host.realtime+o.length;continue}if(Host.realtime>=n.end){try{n.audio.currentTime=o.loopstart}catch(e){n.end=Host.realtime;continue}n.end=Host.realtime+o.length-o.loopstart}}else null!=S.context?S.NoteOff(n.nodes.source):!0!==n.audio.paused&&n.audio.pause()}else for(e=0;e<S.ambient_channels.length;++e)(n=S.ambient_channels[e]).master_vol=0,null!=n.nodes?S.NoteOff(n.nodes.source):null!=n.audio&&!0!==n.audio.paused&&n.audio.pause()}},S.UpdateDynamicSounds=function(){var e,n,t,o;for(e=0;e<S.channels.length;++e)if(null!=(n=S.channels[e])&&null!=n.sfx){if(Host.realtime>=n.end){if(null==(t=n.sfx.cache).loopstart){n.sfx=null,n.nodes=null,n.audio=null;continue}if(null==S.context)try{n.audio.currentTime=t.loopstart}catch(e){n.end=Host.realtime;continue}n.end=Host.realtime+t.length-t.loopstart}S.Spatialize(n),null!=S.context?(n.leftvol>1&&(n.leftvol=1),n.rightvol>1&&(n.rightvol=1),n.nodes.gain0.gain.volume=n.leftvol*S.volume.value,n.nodes.gain1.gain.volume=n.rightvol*S.volume.value):((o=.5*(n.leftvol+n.rightvol))>1&&(o=1),n.audio.volume=o*S.volume.value)}},S.UpdateStaticSounds=function(){var e,n,t,o,a,l,i;for(e=0;e<S.static_channels.length;++e)S.Spatialize(S.static_channels[e]);for(e=0;e<S.static_channels.length;++e)if(0!==(t=S.static_channels[e]).leftvol||0!==t.rightvol)for(a=t.sfx,n=e+1;n<S.static_channels.length;++n)a===(o=S.static_channels[n]).sfx&&(t.leftvol+=o.leftvol,t.rightvol+=o.rightvol,o.leftvol=0,o.rightvol=0);if(null!=S.context)for(e=0;e<S.static_channels.length;++e)0!==(t=S.static_channels[e]).leftvol||0!==t.rightvol?(t.leftvol>1&&(t.leftvol=1),t.rightvol>1&&(t.rightvol=1),t.nodes.gain0.gain.value=t.leftvol*S.volume.value,t.nodes.gain1.gain.value=t.rightvol*S.volume.value,S.NoteOn(t.nodes.source)):S.NoteOff(t.nodes.source);else for(e=0;e<S.static_channels.length;++e)if((i=.5*((t=S.static_channels[e]).leftvol+t.rightvol))>1&&(i=1),0!==i)if(t.audio.volume=i*S.volume.value,l=t.sfx.cache,!0!==t.audio.paused){if(Host.realtime>=t.end)try{t.audio.currentTime=l.loopstart}catch(e){t.end=Host.realtime;continue}}else t.audio.play(),t.end=Host.realtime+l.length;else!0!==t.audio.paused&&t.audio.pause()},S.Update=function(e,n,t,o){0===S.nosound.value&&(S.listener_origin[0]=e[0],S.listener_origin[1]=e[1],S.listener_origin[2]=e[2],S.listener_forward[0]=n[0],S.listener_forward[1]=n[1],S.listener_forward[2]=n[2],S.listener_right[0]=t[0],S.listener_right[1]=t[1],S.listener_right[2]=t[2],S.listener_up[0]=o[0],S.listener_up[1]=o[1],S.listener_up[2]=o[2],S.volume.value<0?Cvar.SetValue("volume",0):S.volume.value>1&&Cvar.SetValue("volume",1),S.UpdateAmbientSounds(),S.UpdateDynamicSounds(),S.UpdateStaticSounds())},S.Play=function(){var e,n;if(0===S.nosound.value)for(e=1;e<Cmd.argv.length;++e)null!=(n=S.PrecacheSound(COM.DefaultExtension(Cmd.argv[e],".wav")))&&S.StartSound(CL.state.viewentity,0,n,S.listener_origin,1,1)},S.PlayVol=function(){var e,n;if(0===S.nosound.value)for(e=1;e<Cmd.argv.length;e+=2)null!=(n=S.PrecacheSound(COM.DefaultExtension(Cmd.argv[e],".wav")))&&S.StartSound(CL.state.viewentity,0,n,S.listener_origin,Q.atof(Cmd.argv[e+1]),1)},S.LoadSound=function(e){if(0===S.nosound.value){if(null!=e.cache)return!0;var n={},t=COM.LoadFile("sound/"+e.name);if(null!=t){var o=new DataView(t);if(1179011410===o.getUint32(0,!0)&&1163280727===o.getUint32(8,!0)){var a,l,i,r,s,c,u;for(a=12;a<t.byteLength;){switch(o.getUint32(a,!0)){case 544501094:if(1!==o.getInt16(a+8,!0))return void Con.Print("Microsoft PCM format only\n");l={channels:o.getUint16(a+10,!0),samplesPerSec:o.getUint32(a+12,!0),avgBytesPerSec:o.getUint32(a+16,!0),blockAlign:o.getUint16(a+20,!0),bitsPerSample:o.getUint16(a+22,!0)};break;case 1635017060:i=a+8,r=o.getUint32(a+4,!0);break;case 543520099:s=!0,c=o.getUint32(a+32,!0);break;case 1414744396:if(!0!==s)break;s=!1,1802658157===o.getUint32(a+28,!0)&&(u=c+o.getUint32(a+24,!0))}0!=(1&(a+=o.getUint32(a+4,!0)+8))&&++a}if(null!=l){if(null!=i){null!=c&&(n.loopstart=c*l.blockAlign/l.samplesPerSec),n.length=null!=u?u/l.samplesPerSec:r/l.avgBytesPerSec,n.size=r+44,0!=(1&n.size)&&++n.size;var d=new ArrayBuffer(n.size);return(o=new DataView(d)).setUint32(0,1179011410,!0),o.setUint32(4,n.size-8,!0),o.setUint32(8,1163280727,!0),o.setUint32(12,544501094,!0),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,l.channels,!0),o.setUint32(24,l.samplesPerSec,!0),o.setUint32(28,l.avgBytesPerSec,!0),o.setUint16(32,l.blockAlign,!0),o.setUint16(34,l.bitsPerSample,!0),o.setUint32(36,1635017060,!0),o.setUint32(40,r,!0),new Uint8Array(d,44,r).set(new Uint8Array(t,i,r)),null!=S.context?n.data=S.context.createBuffer(d,!0):n.data=new Audio("data:audio/wav;base64,"+Q.btoa(new Uint8Array(d))),e.cache=n,!0}Con.Print("Missing data chunk\n")}else Con.Print("Missing fmt chunk\n")}else Con.Print("Missing RIFF/WAVE chunks\n")}else Con.Print("Couldn't load sound/"+e.name+"\n")}};

			// Sbar.js
			Sbar={},Sbar.ShowScores=function(){Sbar.showscores=!0},Sbar.DontShowScores=function(){Sbar.showscores=!1},Sbar.Init=function(){var a;for(Sbar.nums=[[],[]],a=0;a<10;++a)Sbar.nums[0][a]=Draw.PicFromWad("NUM_"+a),Sbar.nums[1][a]=Draw.PicFromWad("ANUM_"+a);for(Sbar.nums[0][10]=Draw.PicFromWad("NUM_MINUS"),Sbar.nums[1][10]=Draw.PicFromWad("ANUM_MINUS"),Sbar.colon=Draw.PicFromWad("NUM_COLON"),Sbar.slash=Draw.PicFromWad("NUM_SLASH"),Sbar.weapons=[[Draw.PicFromWad("INV_SHOTGUN"),Draw.PicFromWad("INV_SSHOTGUN"),Draw.PicFromWad("INV_NAILGUN"),Draw.PicFromWad("INV_SNAILGUN"),Draw.PicFromWad("INV_RLAUNCH"),Draw.PicFromWad("INV_SRLAUNCH"),Draw.PicFromWad("INV_LIGHTNG")],[Draw.PicFromWad("INV2_SHOTGUN"),Draw.PicFromWad("INV2_SSHOTGUN"),Draw.PicFromWad("INV2_NAILGUN"),Draw.PicFromWad("INV2_SNAILGUN"),Draw.PicFromWad("INV2_RLAUNCH"),Draw.PicFromWad("INV2_SRLAUNCH"),Draw.PicFromWad("INV2_LIGHTNG")]],a=0;a<=4;++a)Sbar.weapons[2+a]=[Draw.PicFromWad("INVA"+(a+1)+"_SHOTGUN"),Draw.PicFromWad("INVA"+(a+1)+"_SSHOTGUN"),Draw.PicFromWad("INVA"+(a+1)+"_NAILGUN"),Draw.PicFromWad("INVA"+(a+1)+"_SNAILGUN"),Draw.PicFromWad("INVA"+(a+1)+"_RLAUNCH"),Draw.PicFromWad("INVA"+(a+1)+"_SRLAUNCH"),Draw.PicFromWad("INVA"+(a+1)+"_LIGHTNG")];for(Sbar.ammo=[Draw.PicFromWad("SB_SHELLS"),Draw.PicFromWad("SB_NAILS"),Draw.PicFromWad("SB_ROCKET"),Draw.PicFromWad("SB_CELLS")],Sbar.armor=[Draw.PicFromWad("SB_ARMOR1"),Draw.PicFromWad("SB_ARMOR2"),Draw.PicFromWad("SB_ARMOR3")],Sbar.items=[Draw.PicFromWad("SB_KEY1"),Draw.PicFromWad("SB_KEY2"),Draw.PicFromWad("SB_INVIS"),Draw.PicFromWad("SB_INVULN"),Draw.PicFromWad("SB_SUIT"),Draw.PicFromWad("SB_QUAD")],Sbar.sigil=[Draw.PicFromWad("SB_SIGIL1"),Draw.PicFromWad("SB_SIGIL2"),Draw.PicFromWad("SB_SIGIL3"),Draw.PicFromWad("SB_SIGIL4")],Sbar.faces=[],a=0;a<=4;++a)Sbar.faces[a]=[Draw.PicFromWad("FACE"+(5-a)),Draw.PicFromWad("FACE_P"+(5-a))];if(Sbar.face_invis=Draw.PicFromWad("FACE_INVIS"),Sbar.face_invuln=Draw.PicFromWad("FACE_INVUL2"),Sbar.face_invis_invuln=Draw.PicFromWad("FACE_INV2"),Sbar.face_quad=Draw.PicFromWad("FACE_QUAD"),Cmd.AddCommand("+showscores",Sbar.ShowScores),Cmd.AddCommand("-showscores",Sbar.DontShowScores),Sbar.sbar=Draw.PicFromWad("SBAR"),Sbar.ibar=Draw.PicFromWad("IBAR"),Sbar.scorebar=Draw.PicFromWad("SCOREBAR"),Sbar.ranking=Draw.CachePic("ranking"),Sbar.complete=Draw.CachePic("complete"),Sbar.inter=Draw.CachePic("inter"),Sbar.finale=Draw.CachePic("finale"),Sbar.disc=Draw.PicFromWad("DISC"),!0===COM.hipnotic){for(Sbar.h_weapons=[[Draw.PicFromWad("INV_LASER"),Draw.PicFromWad("INV_MJOLNIR"),Draw.PicFromWad("INV_GREN_PROX"),Draw.PicFromWad("INV_PROX_GREN"),Draw.PicFromWad("INV_PROX")],[Draw.PicFromWad("INV2_LASER"),Draw.PicFromWad("INV2_MJOLNIR"),Draw.PicFromWad("INV2_GREN_PROX"),Draw.PicFromWad("INV2_PROX_GREN"),Draw.PicFromWad("INV2_PROX")]],a=0;a<=4;++a)Sbar.h_weapons[2+a]=[Draw.PicFromWad("INVA"+(a+1)+"_LASER"),Draw.PicFromWad("INVA"+(a+1)+"_MJOLNIR"),Draw.PicFromWad("INVA"+(a+1)+"_GREN_PROX"),Draw.PicFromWad("INVA"+(a+1)+"_PROX_GREN"),Draw.PicFromWad("INVA"+(a+1)+"_PROX")];Sbar.hipweapons=[Def.hit.laser_cannon_bit,Def.hit.mjolnir_bit,4,Def.hit.proximity_gun_bit],Sbar.h_items=[Draw.PicFromWad("SB_WSUIT"),Draw.PicFromWad("SB_ESHLD")]}else!0===COM.rogue&&(Sbar.r_invbar=[Draw.PicFromWad("R_INVBAR1"),Draw.PicFromWad("R_INVBAR2")],Sbar.r_weapons=[Draw.PicFromWad("R_LAVA"),Draw.PicFromWad("R_SUPERLAVA"),Draw.PicFromWad("R_GREN"),Draw.PicFromWad("R_MULTIROCK"),Draw.PicFromWad("R_PLASMA")],Sbar.r_items=[Draw.PicFromWad("R_SHIELD1"),Draw.PicFromWad("R_AGRAV1")],Sbar.r_teambord=Draw.PicFromWad("R_TEAMBORD"),Sbar.r_ammo=[Draw.PicFromWad("R_AMMOLAVA"),Draw.PicFromWad("R_AMMOMULTI"),Draw.PicFromWad("R_AMMOPLASMA")])},Sbar.DrawPic=function(a,r,t){1===CL.state.gametype?Draw.Pic(a,r+VID.height-24,t):Draw.Pic(a+(VID.width>>1)-160,r+VID.height-24,t)},Sbar.DrawCharacter=function(a,r,t){1===CL.state.gametype?Draw.Character(a+4,r+VID.height-24,t):Draw.Character(a+(VID.width>>1)-156,r+VID.height-24,t)},Sbar.DrawString=function(a,r,t){1===CL.state.gametype?Draw.String(a,r+VID.height-24,t):Draw.String(a+(VID.width>>1)-160,r+VID.height-24,t)},Sbar.DrawNum=function(a,r,t,e,i){var s,o,S=t.toString();for(S.length>e?S=S.substring(S.length-e,S.length):S.length<e&&(a+=24*(e-S.length)),s=0;s<S.length;++s)o=S.charCodeAt(s),Sbar.DrawPic(a,r,Sbar.nums[i][45===o?10:o-48]),a+=24},Sbar.fragsort=[],Sbar.SortFrags=function(){var a,r,t;for(Sbar.scoreboardlines=0,a=0;a<CL.state.maxclients;++a)0!==CL.state.scores[a].name.length&&(Sbar.fragsort[Sbar.scoreboardlines++]=a);for(a=0;a<Sbar.scoreboardlines;++a)for(r=0;r<Sbar.scoreboardlines-1-a;++r)CL.state.scores[Sbar.fragsort[r]].frags<CL.state.scores[Sbar.fragsort[r+1]].frags&&(t=Sbar.fragsort[r],Sbar.fragsort[r]=Sbar.fragsort[r+1],Sbar.fragsort[r+1]=t)},Sbar.SoloScoreboard=function(){var a;Sbar.DrawString(8,4,"Monsters:    /"),a=CL.state.stats[Def.stat.monsters].toString(),Sbar.DrawString(104-(a.length<<3),4,a),a=CL.state.stats[Def.stat.totalmonsters].toString(),Sbar.DrawString(144-(a.length<<3),4,a),Sbar.DrawString(8,12,"Secrets :    /"),a=CL.state.stats[Def.stat.secrets].toString(),Sbar.DrawString(104-(a.length<<3),12,a),a=CL.state.stats[Def.stat.totalsecrets].toString(),Sbar.DrawString(144-(a.length<<3),12,a);var r=Math.floor(CL.state.time/60),t=Math.floor(CL.state.time-60*r),e=Math.floor(t/10);a=(t-10*e).toString(),Sbar.DrawString(184,4,"Time :   :"+e+a),a=r.toString(),Sbar.DrawString(256-(a.length<<3),4,a),Sbar.DrawString(232-(CL.state.levelname.length<<2),12,CL.state.levelname)},Sbar.DrawInventory=function(){var a,r;for(!0===COM.rogue?Sbar.DrawPic(0,-24,Sbar.r_invbar[CL.state.stats[Def.stat.activeweapon]>=Def.rit.lava_nailgun?0:1]):Sbar.DrawPic(0,-24,Sbar.ibar),a=0;a<=6;++a)0!=(CL.state.items&Def.it.shotgun<<a)&&(r=(r=Math.floor(10*(CL.state.time-CL.state.item_gettime[a])))>=10?CL.state.stats[Def.stat.activeweapon]===Def.it.shotgun<<a?1:0:r%5+2,Sbar.DrawPic(24*a,-16,Sbar.weapons[r][a]));if(!0===COM.hipnotic){var t=!1;for(a=0;a<=3;++a)0!=(CL.state.items&1<<Sbar.hipweapons[a])&&(r=(r=Math.floor(10*(CL.state.time-CL.state.item_gettime[a])))>=10?CL.state.stats[Def.stat.activeweapon]===1<<Sbar.hipweapons[a]?1:0:r%5+2,2===a?0!=(CL.state.items&Def.hit.proximity_gun)&&0!==r&&(t=!0,Sbar.DrawPic(96,-16,Sbar.h_weapons[r][2])):3===a?0!=(CL.state.items&Def.it.grenade_launcher)?!0!==t&&Sbar.DrawPic(96,-16,Sbar.h_weapons[r][3]):Sbar.DrawPic(96,-16,Sbar.h_weapons[r][4]):Sbar.DrawPic(176+24*a,-16,Sbar.h_weapons[r][a]))}else if(!0===COM.rogue&&CL.state.stats[Def.stat.activeweapon]>=Def.rit.lava_nailgun)for(a=0;a<=4;++a)CL.state.stats[Def.stat.activeweapon]===Def.rit.lava_nailgun<<a&&Sbar.DrawPic(24*(a+2),-16,Sbar.r_weapons[a]);for(a=0;a<=3;++a){var e=CL.state.stats[Def.stat.shells+a].toString();switch(e.length){case 1:Sbar.DrawCharacter((6*a+3<<3)-2,-24,e.charCodeAt(0)-30);continue;case 2:Sbar.DrawCharacter((6*a+2<<3)-2,-24,e.charCodeAt(0)-30),Sbar.DrawCharacter((6*a+3<<3)-2,-24,e.charCodeAt(1)-30);continue;case 3:Sbar.DrawCharacter((6*a+1<<3)-2,-24,e.charCodeAt(0)-30),Sbar.DrawCharacter((6*a+2<<3)-2,-24,e.charCodeAt(1)-30),Sbar.DrawCharacter((6*a+3<<3)-2,-24,e.charCodeAt(2)-30)}}if(!0===COM.hipnotic){for(a=2;a<=5;++a)0!=(CL.state.items&1<<17+a)&&Sbar.DrawPic(192+(a<<4),-16,Sbar.items[a]);0!=(16777216&CL.state.items)&&Sbar.DrawPic(288,-16,Sbar.h_items[0]),0!=(33554432&CL.state.items)&&Sbar.DrawPic(304,-16,Sbar.h_items[1])}else{for(a=0;a<=5;++a)0!=(CL.state.items&1<<17+a)&&Sbar.DrawPic(192+(a<<4),-16,Sbar.items[a]);if(!0===COM.rogue)0!=(536870912&CL.state.items)&&Sbar.DrawPic(288,-16,Sbar.r_items[0]),0!=(1073741824&CL.state.items)&&Sbar.DrawPic(304,-16,Sbar.r_items[1]);else for(a=0;a<=3;++a)0!=(CL.state.items>>>28+a&1)&&Sbar.DrawPic(288+(a<<3),-16,Sbar.sigil[a])}},Sbar.DrawFrags=function(){Sbar.SortFrags();var a,r,t,e,i=Sbar.scoreboardlines<=4?Sbar.scoreboardlines:4,s=23,o=1===CL.state.gametype?10:(VID.width>>1)-150,S=VID.height-47;for(a=0;a<i;++a)r=Sbar.fragsort[a],0!==(t=CL.state.scores[r]).name.length&&(Draw.Fill(o+(s<<3),S,28,4,8+(240&t.colors)),Draw.Fill(o+(s<<3),S+4,28,3,8+((15&t.colors)<<4)),e=t.frags.toString(),Sbar.DrawString(36+(s-e.length<<3),-24,e),r===CL.state.viewentity-1&&(Sbar.DrawCharacter(2+(s<<3),-24,16),Sbar.DrawCharacter(28+(s<<3),-24,17)),s+=4)},Sbar.DrawFace=function(){if(!0===COM.rogue&&1!==CL.state.maxclients&&Host.teamplay.value>=4&&Host.teamplay.value<=6){var a=CL.state.scores[CL.state.viewentity-1],r=8+(240&a.colors),t=1===CL.state.gametype?113:(VID.width>>1)-47;Sbar.DrawPic(112,0,Sbar.r_teambord),Draw.Fill(t,VID.height-21,22,9,r),Draw.Fill(t,VID.height-12,22,9,8+((15&a.colors)<<4));var e=(8===r?">>>":"   ")+a.frags;return e.length>3&&(e=e.substring(e.length-3)),void(8===r?(Sbar.DrawCharacter(109,3,e.charCodeAt(0)-30),Sbar.DrawCharacter(116,3,e.charCodeAt(1)-30),Sbar.DrawCharacter(123,3,e.charCodeAt(2)-30)):(Sbar.DrawCharacter(109,3,e.charCodeAt(0)),Sbar.DrawCharacter(116,3,e.charCodeAt(1)),Sbar.DrawCharacter(123,3,e.charCodeAt(2))))}(CL.state.items&Def.it.invisibility+Def.it.invulnerability)!==Def.it.invisibility+Def.it.invulnerability?0==(CL.state.items&Def.it.quad)?0==(CL.state.items&Def.it.invisibility)?0==(CL.state.items&Def.it.invulnerability)?Sbar.DrawPic(112,0,Sbar.faces[CL.state.stats[Def.stat.health]>=100?4:Math.floor(CL.state.stats[Def.stat.health]/20)][CL.state.time<=CL.state.faceanimtime?1:0]):Sbar.DrawPic(112,0,Sbar.face_invuln):Sbar.DrawPic(112,0,Sbar.face_invis):Sbar.DrawPic(112,0,Sbar.face_quad):Sbar.DrawPic(112,0,Sbar.face_invis_invuln)},Sbar.Draw=function(){if(!(SCR.con_current>=200)){if(Sbar.lines>24&&(Sbar.DrawInventory(),1!==CL.state.maxclients&&Sbar.DrawFrags()),!0===Sbar.showscores||CL.state.stats[Def.stat.health]<=0)return Sbar.DrawPic(0,0,Sbar.scorebar),Sbar.SoloScoreboard(),void(1===CL.state.gametype&&Sbar.DeathmatchOverlay());if(0!==Sbar.lines){Sbar.DrawPic(0,0,Sbar.sbar),!0===COM.hipnotic&&(0!=(CL.state.items&Def.it.key1)&&Sbar.DrawPic(209,3,Sbar.items[0]),0!=(CL.state.items&Def.it.key2)&&Sbar.DrawPic(209,12,Sbar.items[1]));var a=!0===COM.rogue?Def.rit:Def.it;0!=(CL.state.items&Def.it.invulnerability)?(Sbar.DrawNum(24,0,666,3,1),Sbar.DrawPic(0,0,Sbar.disc)):(Sbar.DrawNum(24,0,CL.state.stats[Def.stat.armor],3,CL.state.stats[Def.stat.armor]<=25?1:0),0!=(CL.state.items&a.armor3)?Sbar.DrawPic(0,0,Sbar.armor[2]):0!=(CL.state.items&a.armor2)?Sbar.DrawPic(0,0,Sbar.armor[1]):0!=(CL.state.items&a.armor1)&&Sbar.DrawPic(0,0,Sbar.armor[0])),Sbar.DrawFace(),Sbar.DrawNum(136,0,CL.state.stats[Def.stat.health],3,CL.state.stats[Def.stat.health]<=25?1:0),0!=(CL.state.items&a.shells)?Sbar.DrawPic(224,0,Sbar.ammo[0]):0!=(CL.state.items&a.nails)?Sbar.DrawPic(224,0,Sbar.ammo[1]):0!=(CL.state.items&a.rockets)?Sbar.DrawPic(224,0,Sbar.ammo[2]):0!=(CL.state.items&a.cells)?Sbar.DrawPic(224,0,Sbar.ammo[3]):!0===COM.rogue&&(0!=(CL.state.items&Def.rit.lava_nails)?Sbar.DrawPic(224,0,Sbar.r_ammo[0]):0!=(CL.state.items&Def.rit.plasma_ammo)?Sbar.DrawPic(224,0,Sbar.r_ammo[1]):0!=(CL.state.items&Def.rit.multi_rockets)&&Sbar.DrawPic(224,0,Sbar.r_ammo[2])),Sbar.DrawNum(248,0,CL.state.stats[Def.stat.ammo],3,CL.state.stats[Def.stat.ammo]<=10?1:0),VID.width>=512&&1===CL.state.gametype&&Sbar.MiniDeathmatchOverlay()}}},Sbar.IntermissionNumber=function(a,r,t){var e,i,s=t.toString();for(s.length>3?s=s.substring(s.length-3,s.length):s.length<3&&(a+=24*(3-s.length)),e=0;e<s.length;++e)i=s.charCodeAt(e),Draw.Pic(a,r,Sbar.nums[0][45===i?10:i-48]),a+=24},Sbar.DeathmatchOverlay=function(){Draw.Pic(VID.width-Sbar.ranking.width>>1,8,Sbar.ranking),Sbar.SortFrags();var a,r,t,e=(VID.width>>1)-80,i=40;for(a=0;a<Sbar.scoreboardlines;++a)0!==(r=CL.state.scores[Sbar.fragsort[a]]).name.length&&(Draw.Fill(e,i,40,4,8+(240&r.colors)),Draw.Fill(e,i+4,40,4,8+((15&r.colors)<<4)),t=r.frags.toString(),Draw.String(e+32-(t.length<<3),i,t),Sbar.fragsort[a]===CL.state.viewentity-1&&Draw.Character(e-8,i,12),Draw.String(e+64,i,r.name),i+=10)},Sbar.MiniDeathmatchOverlay=function(){Sbar.SortFrags();var a,r,t,e,i=Sbar.scoreboardlines,s=VID.height-Sbar.lines,o=Sbar.lines>>3;for(a=0;a<i&&Sbar.fragsort[a]!==CL.state.viewentity-1;++a);for((a=a===i?0:a-(o>>1))>i-o&&(a=i-o),a<0&&(a=0);a<i&&s<VID.height-8;++a)r=Sbar.fragsort[a],0!==(t=CL.state.scores[r]).name.length&&(Draw.Fill(324,s+1,40,3,8+(240&t.colors)),Draw.Fill(324,s+4,40,4,8+((15&t.colors)<<4)),e=t.frags.toString(),Draw.String(356-(e.length<<3),s,e),r===CL.state.viewentity-1&&(Draw.Character(324,s,16),Draw.Character(356,s,17)),Draw.String(372,s,t.name),s+=8)},Sbar.IntermissionOverlay=function(){if(1!==CL.state.gametype){Draw.Pic(64,24,Sbar.complete),Draw.Pic(0,56,Sbar.inter);var a=Math.floor(CL.state.completed_time/60);Sbar.IntermissionNumber(160,64,a);var r=Math.floor(CL.state.completed_time-60*a);Draw.Pic(234,64,Sbar.colon),Draw.Pic(246,64,Sbar.nums[0][Math.floor(r/10)]),Draw.Pic(266,64,Sbar.nums[0][Math.floor(r%10)]),Sbar.IntermissionNumber(160,104,CL.state.stats[Def.stat.secrets]),Draw.Pic(232,104,Sbar.slash),Sbar.IntermissionNumber(240,104,CL.state.stats[Def.stat.totalsecrets]),Sbar.IntermissionNumber(160,144,CL.state.stats[Def.stat.monsters]),Draw.Pic(232,144,Sbar.slash),Sbar.IntermissionNumber(240,144,CL.state.stats[Def.stat.totalmonsters])}else Sbar.DeathmatchOverlay()},Sbar.FinaleOverlay=function(){Draw.Pic(VID.width-Sbar.finale.width>>1,16,Sbar.finale)};

			// SCR.js
			SCR={},SCR.con_current=0,SCR.centerstring=[],SCR.centertime_off=0,SCR.CenterPrint=function(e){SCR.centerstring=[];var t,r,i=0;for(t=0;t<e.length;++t){if(10===e.charCodeAt(t))r=t+1;else{if(!(t-i>=40))continue;r=t}SCR.centerstring[SCR.centerstring.length]=e.substring(i,t),i=r}SCR.centerstring[SCR.centerstring.length]=e.substring(i,t),SCR.centertime_off=SCR.centertime.value,SCR.centertime_start=CL.state.time},SCR.DrawCenterString=function(){var e,t;if(SCR.centertime_off-=Host.frametime,!(SCR.centertime_off<=0&&0===CL.state.intermission||Key.dest.value!==Key.dest.game))if(e=SCR.centerstring.length<=4?Math.floor(.35*VID.height):48,CL.state.intermission){var r,i,a,n=Math.floor(SCR.printspeed.value*(CL.state.time-SCR.centertime_start));for(t=0;t<SCR.centerstring.length;++t){for(r=SCR.centerstring[t],i=VID.width-(r.length<<3)>>1,a=0;a<r.length;++a){if(Draw.Character(i,e,r.charCodeAt(a)),0==n--)return;i+=8}e+=8}}else for(t=0;t<SCR.centerstring.length;++t)Draw.String(VID.width-(SCR.centerstring[t].length<<3)>>1,e,SCR.centerstring[t]),e+=8},SCR.CalcRefdef=function(){var e,t;SCR.recalc_refdef=!1,SCR.viewsize.value<30?Cvar.Set("viewsize","30"):SCR.viewsize.value>120&&Cvar.Set("viewsize","120"),0!==CL.state.intermission?(t=!0,e=1,Sbar.lines=0):(e=SCR.viewsize.value,Sbar.lines=e>=120?0:e>=110?24:48,e>=100&&(t=!0,e=100),e*=.01);var r=R.refdef.vrect;r.width=Math.floor(VID.width*e),r.width<96&&(e=96/r.width,r.width=96),r.height=Math.floor(VID.height*e),r.height>VID.height-Sbar.lines&&(r.height=VID.height-Sbar.lines),r.x=VID.width-r.width>>1,r.y=!0===t?0:VID.height-Sbar.lines-r.height>>1,SCR.fov.value<10?Cvar.Set("fov","10"):SCR.fov.value>170&&Cvar.Set("fov","170"),.75*r.width<=r.height?(R.refdef.fov_x=SCR.fov.value,R.refdef.fov_y=360*Math.atan(r.height/(r.width/Math.tan(SCR.fov.value*Math.PI/360)))/Math.PI):(R.refdef.fov_x=360*Math.atan(r.width/(r.height/Math.tan(.82*SCR.fov.value*Math.PI/360)))/Math.PI,R.refdef.fov_y=.82*SCR.fov.value);var i=4*Math.tan(R.refdef.fov_y*Math.PI/360);R.perspective[0]=4/(i*R.refdef.vrect.width/R.refdef.vrect.height),R.perspective[5]=4/i,GL.ortho[0]=2/VID.width,GL.ortho[5]=-2/VID.height,R.warpwidth=r.width*SCR.devicePixelRatio>>0,R.warpheight=r.height*SCR.devicePixelRatio>>0,R.warpwidth>2048&&(R.warpwidth=2048),R.warpheight>2048&&(R.warpheight=2048),R.oldwarpwidth===R.warpwidth&&R.oldwarpheight===R.warpheight||(R.oldwarpwidth=R.warpwidth,R.oldwarpheight=R.warpheight,GL.Bind(0,R.warptexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,R.warpwidth,R.warpheight,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,R.warprenderbuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,R.warpwidth,R.warpheight),gl.bindRenderbuffer(gl.RENDERBUFFER,null))},SCR.SizeUp_f=function(){Cvar.SetValue("viewsize",SCR.viewsize.value+10),SCR.recalc_refdef=!0},SCR.SizeDown_f=function(){Cvar.SetValue("viewsize",SCR.viewsize.value-10),SCR.recalc_refdef=!0},SCR.Init=function(){SCR.fov=Cvar.RegisterVariable("fov","90"),SCR.viewsize=Cvar.RegisterVariable("viewsize","100",!0),SCR.conspeed=Cvar.RegisterVariable("scr_conspeed","300"),SCR.showturtle=Cvar.RegisterVariable("showturtle","0"),SCR.showpause=Cvar.RegisterVariable("showpause","1"),SCR.centertime=Cvar.RegisterVariable("scr_centertime","2"),SCR.printspeed=Cvar.RegisterVariable("scr_printspeed","8"),Cmd.AddCommand("screenshot",SCR.ScreenShot_f),Cmd.AddCommand("sizeup",SCR.SizeUp_f),Cmd.AddCommand("sizedown",SCR.SizeDown_f),SCR.net=Draw.PicFromWad("NET"),SCR.turtle=Draw.PicFromWad("TURTLE"),SCR.pause=Draw.CachePic("pause")},SCR.count=0,SCR.DrawTurtle=function(){0!==SCR.showturtle.value&&(Host.frametime<.1?SCR.count=0:++SCR.count>=3&&Draw.Pic(R.refdef.vrect.x,R.refdef.vrect.y,SCR.turtle))},SCR.DrawNet=function(){Host.realtime-CL.state.last_received_message>=.3&&!0!==CL.cls.demoplayback&&Draw.Pic(R.refdef.vrect.x,R.refdef.vrect.y,SCR.net)},SCR.DrawPause=function(){0!==SCR.showpause.value&&!0===CL.state.paused&&Draw.Pic(VID.width-SCR.pause.width>>1,VID.height-48-SCR.pause.height>>1,SCR.pause)},SCR.SetUpToDrawConsole=function(){var e;(Con.forcedup=null==CL.state.worldmodel||4!==CL.cls.signon,!0!==Con.forcedup)?(e=Key.dest.value===Key.dest.console?100:0)<SCR.con_current?(SCR.con_current-=SCR.conspeed.value*Host.frametime,e>SCR.con_current&&(SCR.con_current=e)):e>SCR.con_current&&(SCR.con_current+=SCR.conspeed.value*Host.frametime,e<SCR.con_current&&(SCR.con_current=e)):SCR.con_current=200},SCR.DrawConsole=function(){SCR.con_current>0?Con.DrawConsole(SCR.con_current):Key.dest.value!==Key.dest.game&&Key.dest.value!==Key.dest.message||Con.DrawNotify()},SCR.ScreenShot_f=function(){SCR.screenshot=!0},SCR.BeginLoadingPlaque=function(){S.StopAllSounds(),CL.cls.state===CL.active.connected&&4===CL.cls.signon&&(SCR.centertime_off=0,SCR.con_current=0,SCR.disabled_for_loading=!0,SCR.disabled_time=Host.realtime+60)},SCR.EndLoadingPlaque=function(){SCR.disabled_for_loading=!1,Con.ClearNotify()},SCR.UpdateScreen=function(){if(!0===SCR.disabled_for_loading){if(Host.realtime<=SCR.disabled_time)return;SCR.disabled_for_loading=!1,Con.Print("load failed.\n")}var e,t=document.documentElement,r=t.clientWidth<=320?320:t.clientWidth,i=t.clientHeight<=200?200:t.clientHeight;e=window.devicePixelRatio>=1?window.devicePixelRatio:1,VID.width===r&&VID.height===i&&SCR.devicePixelRatio===e&&0!==Host.framecount||(VID.width=r,VID.height=i,VID.mainwindow.width=r*e>>0,VID.mainwindow.height=i*e>>0,VID.mainwindow.style.width=r+"px",VID.mainwindow.style.height=i+"px",SCR.devicePixelRatio=e,SCR.recalc_refdef=!0),SCR.oldfov!==SCR.fov.value&&(SCR.oldfov=SCR.fov.value,SCR.recalc_refdef=!0),SCR.oldscreensize!==SCR.viewsize.value&&(SCR.oldscreensize=SCR.viewsize.value,SCR.recalc_refdef=!0),!0===SCR.recalc_refdef&&SCR.CalcRefdef(),SCR.SetUpToDrawConsole(),V.RenderView(),GL.Set2D(),!0===R.dowarp&&R.WarpScreen(),!0!==Con.forcedup&&R.PolyBlend(),CL.cls.state===CL.active.connecting?SCR.DrawConsole():1===CL.state.intermission&&Key.dest.value===Key.dest.game?Sbar.IntermissionOverlay():2===CL.state.intermission&&Key.dest.value===Key.dest.game?(Sbar.FinaleOverlay(),SCR.DrawCenterString()):3===CL.state.intermission&&Key.dest.value===Key.dest.game?SCR.DrawCenterString():(0!==V.crosshair.value&&Draw.Character(R.refdef.vrect.x+(R.refdef.vrect.width>>1)+V.crossx.value,R.refdef.vrect.y+(R.refdef.vrect.height>>1)+V.crossy.value,43),SCR.DrawNet(),SCR.DrawTurtle(),SCR.DrawPause(),SCR.DrawCenterString(),Sbar.Draw(),SCR.DrawConsole(),M.Draw()),GL.StreamFlush(),gl.disable(gl.BLEND),!0===SCR.screenshot&&(SCR.screenshot=!1,gl.finish(),open(VID.mainwindow.toDataURL("image/jpeg")))};

			// SV.js
			SV={},SV.movetype={none:0,anglenoclip:1,angleclip:2,walk:3,step:4,fly:5,toss:6,push:7,noclip:8,flymissile:9,bounce:10},SV.solid={not:0,trigger:1,bbox:2,slidebox:3,bsp:4},SV.damage={no:0,yes:1,aim:2},SV.fl={fly:1,swim:2,conveyor:4,client:8,inwater:16,monster:32,godmode:64,notarget:128,item:256,onground:512,partialground:1024,waterjump:2048,jumpreleased:4096},SV.server={num_edicts:0,datagram:{data:new ArrayBuffer(1024),cursize:0},reliable_datagram:{data:new ArrayBuffer(1024),cursize:0},signon:{data:new ArrayBuffer(8192),cursize:0}},SV.svs={},SV.Init=function(){SV.maxvelocity=Cvar.RegisterVariable("sv_maxvelocity","2000"),SV.gravity=Cvar.RegisterVariable("sv_gravity","800",!1,!0),SV.friction=Cvar.RegisterVariable("sv_friction","4",!1,!0),SV.edgefriction=Cvar.RegisterVariable("edgefriction","2"),SV.stopspeed=Cvar.RegisterVariable("sv_stopspeed","100"),SV.maxspeed=Cvar.RegisterVariable("sv_maxspeed","320",!1,!0),SV.accelerate=Cvar.RegisterVariable("sv_accelerate","10"),SV.idealpitchscale=Cvar.RegisterVariable("sv_idealpitchscale","0.8"),SV.aim=Cvar.RegisterVariable("sv_aim","0.93"),SV.nostep=Cvar.RegisterVariable("sv_nostep","0"),SV.nop={data:new ArrayBuffer(4),cursize:1},new Uint8Array(SV.nop.data)[0]=Protocol.svc.nop,SV.reconnect={data:new ArrayBuffer(128),cursize:0},MSG.WriteByte(SV.reconnect,Protocol.svc.stufftext),MSG.WriteString(SV.reconnect,"reconnect\n"),SV.InitBoxHull()},SV.StartParticle=function(e,t,a,o){var r=SV.server.datagram;if(!(r.cursize>=1009)){var n,s;for(MSG.WriteByte(r,Protocol.svc.particle),MSG.WriteCoord(r,e[0]),MSG.WriteCoord(r,e[1]),MSG.WriteCoord(r,e[2]),n=0;n<=2;++n)(s=16*t[n]>>0)>127?s=127:s<-128&&(s=-128),MSG.WriteChar(r,s);MSG.WriteByte(r,o),MSG.WriteByte(r,a)}},SV.StartSound=function(e,t,a,o,r){(o<0||o>255)&&Sys.Error("SV.StartSound: volume = "+o),(r<0||r>4)&&Sys.Error("SV.StartSound: attenuation = "+r),(t<0||t>7)&&Sys.Error("SV.StartSound: channel = "+t);var n=SV.server.datagram;if(!(n.cursize>=1009)){var s;for(s=1;s<SV.server.sound_precache.length&&a!==SV.server.sound_precache[s];++s);if(s>=SV.server.sound_precache.length)Con.Print("SV.StartSound: "+a+" not precached\n");else{var i=0;255!==o&&(i+=1),1!==r&&(i+=2),MSG.WriteByte(n,Protocol.svc.sound),MSG.WriteByte(n,i),0!=(1&i)&&MSG.WriteByte(n,o),0!=(2&i)&&MSG.WriteByte(n,Math.floor(64*r)),MSG.WriteShort(n,(e.num<<3)+t),MSG.WriteByte(n,s),MSG.WriteCoord(n,e.v_float[PR.entvars.origin]+.5*(e.v_float[PR.entvars.mins]+e.v_float[PR.entvars.maxs])),MSG.WriteCoord(n,e.v_float[PR.entvars.origin1]+.5*(e.v_float[PR.entvars.mins1]+e.v_float[PR.entvars.maxs1])),MSG.WriteCoord(n,e.v_float[PR.entvars.origin2]+.5*(e.v_float[PR.entvars.mins2]+e.v_float[PR.entvars.maxs2]))}}},SV.SendServerinfo=function(e){var t,a=e.message;for(MSG.WriteByte(a,Protocol.svc.print),MSG.WriteString(a,"\nVERSION 1.09 SERVER ("+PR.crc+" CRC)"),MSG.WriteByte(a,Protocol.svc.serverinfo),MSG.WriteLong(a,Protocol.version),MSG.WriteByte(a,SV.svs.maxclients),MSG.WriteByte(a,0===Host.coop.value&&0!==Host.deathmatch.value?1:0),MSG.WriteString(a,PR.GetString(SV.server.edicts[0].v_int[PR.entvars.message])),t=1;t<SV.server.model_precache.length;++t)MSG.WriteString(a,SV.server.model_precache[t]);for(MSG.WriteByte(a,0),t=1;t<SV.server.sound_precache.length;++t)MSG.WriteString(a,SV.server.sound_precache[t]);MSG.WriteByte(a,0),MSG.WriteByte(a,Protocol.svc.cdtrack),MSG.WriteByte(a,SV.server.edicts[0].v_float[PR.entvars.sounds]),MSG.WriteByte(a,SV.server.edicts[0].v_float[PR.entvars.sounds]),MSG.WriteByte(a,Protocol.svc.setview),MSG.WriteShort(a,e.edict.num),MSG.WriteByte(a,Protocol.svc.signonnum),MSG.WriteByte(a,1),e.sendsignon=!0,e.spawned=!1},SV.ConnectClient=function(e){var t,a,o=SV.svs.clients[e];if(!0===SV.server.loadgame)for(a=[],null==o.spawn_parms&&(o.spawn_parms=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),t=0;t<=15;++t)a[t]=o.spawn_parms[t];if(Con.DPrint("Client "+o.netconnection.address+" connected\n"),o.active=!0,o.dropasap=!1,o.last_message=0,o.cmd={forwardmove:0,sidemove:0,upmove:0},o.wishdir=[0,0,0],o.message.cursize=0,o.edict=SV.server.edicts[e+1],o.edict.v_int[PR.entvars.netname]=PR.netnames+(e<<5),SV.SetClientName(o,"unconnected"),o.colors=0,o.ping_times=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o.num_pings=0,!0!==SV.server.loadgame&&(o.spawn_parms=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),o.old_frags=0,!0===SV.server.loadgame)for(t=0;t<=15;++t)o.spawn_parms[t]=a[t];else for(PR.ExecuteProgram(PR.globals_int[PR.globalvars.SetNewParms]),t=0;t<=15;++t)o.spawn_parms[t]=PR.globals_float[PR.globalvars.parms+t];SV.SendServerinfo(o)},SV.fatpvs=[],SV.CheckForNewClients=function(){for(var e,t;;){if(null==(e=NET.CheckNewConnections()))return;for(t=0;t<SV.svs.maxclients&&!0===SV.svs.clients[t].active;++t);t===SV.svs.maxclients&&Sys.Error("SV.CheckForNewClients: no free clients"),SV.svs.clients[t].netconnection=e,SV.ConnectClient(t),++NET.activeconnections}},SV.AddToFatPVS=function(e,t){for(var a,o,r,n;;){if(t.contents<0){if(t.contents!==Mod.contents.solid)for(a=Mod.LeafPVS(t,SV.server.worldmodel),o=0;o<SV.fatbytes;++o)SV.fatpvs[o]|=a[o];return}r=t.plane.normal,(n=e[0]*r[0]+e[1]*r[1]+e[2]*r[2]-t.plane.dist)>8?t=t.children[0]:(n>=-8&&SV.AddToFatPVS(e,t.children[0]),t=t.children[1])}},SV.FatPVS=function(e){var t;for(SV.fatbytes=SV.server.worldmodel.leafs.length+31>>3,t=0;t<SV.fatbytes;++t)SV.fatpvs[t]=0;SV.AddToFatPVS(e,SV.server.worldmodel.nodes[0])},SV.WriteEntitiesToClient=function(e,t){SV.FatPVS([e.v_float[PR.entvars.origin]+e.v_float[PR.entvars.view_ofs],e.v_float[PR.entvars.origin1]+e.v_float[PR.entvars.view_ofs1],e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.view_ofs2]]);var a,o,r,n,s,i=SV.fatpvs;for(o=1;o<SV.server.num_edicts;++o){if((a=SV.server.edicts[o])!==e){if(0===a.v_float[PR.entvars.modelindex]||0===PR.strings[a.v_int[PR.entvars.model]])continue;for(r=0;r<a.leafnums.length&&0==(i[a.leafnums[r]>>3]&1<<(7&a.leafnums[r]));++r);if(r===a.leafnums.length)continue}if(t.data.byteLength-t.cursize<16)return void Con.Print("packet overflow\n");for(n=0,r=0;r<=2;++r)((s=a.v_float[PR.entvars.origin+r]-a.baseline.origin[r])<-.1||s>.1)&&(n+=Protocol.u.origin1<<r);a.v_float[PR.entvars.angles]!==a.baseline.angles[0]&&(n+=Protocol.u.angle1),a.v_float[PR.entvars.angles1]!==a.baseline.angles[1]&&(n+=Protocol.u.angle2),a.v_float[PR.entvars.angles2]!==a.baseline.angles[2]&&(n+=Protocol.u.angle3),a.v_float[PR.entvars.movetype]===SV.movetype.step&&(n+=Protocol.u.nolerp),a.baseline.colormap!==a.v_float[PR.entvars.colormap]&&(n+=Protocol.u.colormap),a.baseline.skin!==a.v_float[PR.entvars.skin]&&(n+=Protocol.u.skin),a.baseline.frame!==a.v_float[PR.entvars.frame]&&(n+=Protocol.u.frame),a.baseline.effects!==a.v_float[PR.entvars.effects]&&(n+=Protocol.u.effects),a.baseline.modelindex!==a.v_float[PR.entvars.modelindex]&&(n+=Protocol.u.model),o>=256&&(n+=Protocol.u.longentity),n>=256&&(n+=Protocol.u.morebits),MSG.WriteByte(t,n+Protocol.u.signal),0!=(n&Protocol.u.morebits)&&MSG.WriteByte(t,n>>8),0!=(n&Protocol.u.longentity)?MSG.WriteShort(t,o):MSG.WriteByte(t,o),0!=(n&Protocol.u.model)&&MSG.WriteByte(t,a.v_float[PR.entvars.modelindex]),0!=(n&Protocol.u.frame)&&MSG.WriteByte(t,a.v_float[PR.entvars.frame]),0!=(n&Protocol.u.colormap)&&MSG.WriteByte(t,a.v_float[PR.entvars.colormap]),0!=(n&Protocol.u.skin)&&MSG.WriteByte(t,a.v_float[PR.entvars.skin]),0!=(n&Protocol.u.effects)&&MSG.WriteByte(t,a.v_float[PR.entvars.effects]),0!=(n&Protocol.u.origin1)&&MSG.WriteCoord(t,a.v_float[PR.entvars.origin]),0!=(n&Protocol.u.angle1)&&MSG.WriteAngle(t,a.v_float[PR.entvars.angles]),0!=(n&Protocol.u.origin2)&&MSG.WriteCoord(t,a.v_float[PR.entvars.origin1]),0!=(n&Protocol.u.angle2)&&MSG.WriteAngle(t,a.v_float[PR.entvars.angles1]),0!=(n&Protocol.u.origin3)&&MSG.WriteCoord(t,a.v_float[PR.entvars.origin2]),0!=(n&Protocol.u.angle3)&&MSG.WriteAngle(t,a.v_float[PR.entvars.angles2])}},SV.WriteClientdataToMessage=function(e,t){if(0!==e.v_float[PR.entvars.dmg_take]||0!==e.v_float[PR.entvars.dmg_save]){var a=SV.server.edicts[e.v_int[PR.entvars.dmg_inflictor]];MSG.WriteByte(t,Protocol.svc.damage),MSG.WriteByte(t,e.v_float[PR.entvars.dmg_save]),MSG.WriteByte(t,e.v_float[PR.entvars.dmg_take]),MSG.WriteCoord(t,a.v_float[PR.entvars.origin]+.5*(a.v_float[PR.entvars.mins]+a.v_float[PR.entvars.maxs])),MSG.WriteCoord(t,a.v_float[PR.entvars.origin1]+.5*(a.v_float[PR.entvars.mins1]+a.v_float[PR.entvars.maxs1])),MSG.WriteCoord(t,a.v_float[PR.entvars.origin2]+.5*(a.v_float[PR.entvars.mins2]+a.v_float[PR.entvars.maxs2])),e.v_float[PR.entvars.dmg_take]=0,e.v_float[PR.entvars.dmg_save]=0}SV.SetIdealPitch(),0!==e.v_float[PR.entvars.fixangle]&&(MSG.WriteByte(t,Protocol.svc.setangle),MSG.WriteAngle(t,e.v_float[PR.entvars.angles]),MSG.WriteAngle(t,e.v_float[PR.entvars.angles1]),MSG.WriteAngle(t,e.v_float[PR.entvars.angles2]),e.v_float[PR.entvars.fixangle]=0);var o=Protocol.su.items+Protocol.su.weapon;e.v_float[PR.entvars.view_ofs2]!==Protocol.default_viewheight&&(o+=Protocol.su.viewheight),0!==e.v_float[PR.entvars.idealpitch]&&(o+=Protocol.su.idealpitch);var r,n=PR.entvars.items2;if(r=null!=n&&0!==e.v_float[n]?(e.v_float[PR.entvars.items]>>0)+(e.v_float[n]<<23>>>0):(e.v_float[PR.entvars.items]>>0)+(PR.globals_float[PR.globalvars.serverflags]<<28>>>0),e.v_float[PR.entvars.flags]&SV.fl.onground&&(o+=Protocol.su.onground),e.v_float[PR.entvars.waterlevel]>=2&&(o+=Protocol.su.inwater),0!==e.v_float[PR.entvars.punchangle]&&(o+=Protocol.su.punch1),0!==e.v_float[PR.entvars.velocity]&&(o+=Protocol.su.velocity1),0!==e.v_float[PR.entvars.punchangle1]&&(o+=Protocol.su.punch2),0!==e.v_float[PR.entvars.velocity1]&&(o+=Protocol.su.velocity2),0!==e.v_float[PR.entvars.punchangle2]&&(o+=Protocol.su.punch3),0!==e.v_float[PR.entvars.velocity2]&&(o+=Protocol.su.velocity3),0!==e.v_float[PR.entvars.weaponframe]&&(o+=Protocol.su.weaponframe),0!==e.v_float[PR.entvars.armorvalue]&&(o+=Protocol.su.armor),MSG.WriteByte(t,Protocol.svc.clientdata),MSG.WriteShort(t,o),0!=(o&Protocol.su.viewheight)&&MSG.WriteChar(t,e.v_float[PR.entvars.view_ofs2]),0!=(o&Protocol.su.idealpitch)&&MSG.WriteChar(t,e.v_float[PR.entvars.idealpitch]),0!=(o&Protocol.su.punch1)&&MSG.WriteChar(t,e.v_float[PR.entvars.punchangle]),0!=(o&Protocol.su.velocity1)&&MSG.WriteChar(t,.0625*e.v_float[PR.entvars.velocity]),0!=(o&Protocol.su.punch2)&&MSG.WriteChar(t,e.v_float[PR.entvars.punchangle1]),0!=(o&Protocol.su.velocity2)&&MSG.WriteChar(t,.0625*e.v_float[PR.entvars.velocity1]),0!=(o&Protocol.su.punch3)&&MSG.WriteChar(t,e.v_float[PR.entvars.punchangle2]),0!=(o&Protocol.su.velocity3)&&MSG.WriteChar(t,.0625*e.v_float[PR.entvars.velocity2]),MSG.WriteLong(t,r),0!=(o&Protocol.su.weaponframe)&&MSG.WriteByte(t,e.v_float[PR.entvars.weaponframe]),0!=(o&Protocol.su.armor)&&MSG.WriteByte(t,e.v_float[PR.entvars.armorvalue]),MSG.WriteByte(t,SV.ModelIndex(PR.GetString(e.v_int[PR.entvars.weaponmodel]))),MSG.WriteShort(t,e.v_float[PR.entvars.health]),MSG.WriteByte(t,e.v_float[PR.entvars.currentammo]),MSG.WriteByte(t,e.v_float[PR.entvars.ammo_shells]),MSG.WriteByte(t,e.v_float[PR.entvars.ammo_nails]),MSG.WriteByte(t,e.v_float[PR.entvars.ammo_rockets]),MSG.WriteByte(t,e.v_float[PR.entvars.ammo_cells]),!0===COM.standard_quake)MSG.WriteByte(t,e.v_float[PR.entvars.weapon]);else{var s,i=e.v_float[PR.entvars.weapon];for(s=0;s<=31;++s)if(0!=(i&1<<s)){MSG.WriteByte(t,s);break}}},SV.clientdatagram={data:new ArrayBuffer(1024),cursize:0},SV.SendClientDatagram=function(){var e=Host.client,t=SV.clientdatagram;if(t.cursize=0,MSG.WriteByte(t,Protocol.svc.time),MSG.WriteFloat(t,SV.server.time),SV.WriteClientdataToMessage(e.edict,t),SV.WriteEntitiesToClient(e.edict,t),t.cursize+SV.server.datagram.cursize<t.data.byteLength&&SZ.Write(t,new Uint8Array(SV.server.datagram.data),SV.server.datagram.cursize),-1!==NET.SendUnreliableMessage(e.netconnection,t))return!0;Host.DropClient(!0)},SV.UpdateToReliableMessages=function(){var e,t,a,o;for(e=0;e<SV.svs.maxclients;++e)if(Host.client=SV.svs.clients[e],Host.client.edict.v_float[PR.entvars.frags]>>=0,t=Host.client.edict.v_float[PR.entvars.frags],Host.client.old_frags!==t){for(a=0;a<SV.svs.maxclients;++a)!0===(o=SV.svs.clients[a]).active&&(MSG.WriteByte(o.message,Protocol.svc.updatefrags),MSG.WriteByte(o.message,e),MSG.WriteShort(o.message,t));Host.client.old_frags=t}for(e=0;e<SV.svs.maxclients;++e)!0===(o=SV.svs.clients[e]).active&&SZ.Write(o.message,new Uint8Array(SV.server.reliable_datagram.data),SV.server.reliable_datagram.cursize);SV.server.reliable_datagram.cursize=0},SV.SendClientMessages=function(){var e,t;for(SV.UpdateToReliableMessages(),e=0;e<SV.svs.maxclients;++e)if(Host.client=t=SV.svs.clients[e],!0===t.active){if(!0===t.spawned){if(!0!==SV.SendClientDatagram())continue}else if(!0!==t.sendsignon){Host.realtime-t.last_message>5&&(-1===NET.SendUnreliableMessage(t.netconnection,SV.nop)&&Host.DropClient(!0),t.last_message=Host.realtime);continue}if(!0!==t.message.overflowed){if(!0===t.dropasap)!0===NET.CanSendMessage(t.netconnection)&&Host.DropClient();else if(0!==t.message.cursize){if(!0!==NET.CanSendMessage(t.netconnection))continue;-1===NET.SendMessage(t.netconnection,t.message)&&Host.DropClient(!0),t.message.cursize=0,t.last_message=Host.realtime,t.sendsignon=!1}}else Host.DropClient(!0),t.message.overflowed=!1}for(e=1;e<SV.server.num_edicts;++e)SV.server.edicts[e].v_float[PR.entvars.effects]&=~Mod.effects.muzzleflash>>>0},SV.ModelIndex=function(e){if(null==e)return 0;if(0===e.length)return 0;var t;for(t=0;t<SV.server.model_precache.length;++t)if(SV.server.model_precache[t]===e)return t;Sys.Error("SV.ModelIndex: model "+e+" not precached")},SV.CreateBaseline=function(){var e,t,a,o=SV.ModelIndex("progs/player.mdl"),r=SV.server.signon;for(e=0;e<SV.server.num_edicts;++e)!0!==(t=SV.server.edicts[e]).free&&(e>SV.svs.maxclients&&0===t.v_int[PR.entvars.modelindex]||((a=t.baseline).origin=ED.Vector(t,PR.entvars.origin),a.angles=ED.Vector(t,PR.entvars.angles),a.frame=t.v_float[PR.entvars.frame]>>0,a.skin=t.v_float[PR.entvars.skin]>>0,e>0&&e<=SV.server.maxclients?(a.colormap=entnum,a.modelindex=o):(a.colormap=0,a.modelindex=SV.ModelIndex(PR.GetString(t.v_int[PR.entvars.model]))),MSG.WriteByte(r,Protocol.svc.spawnbaseline),MSG.WriteShort(r,e),MSG.WriteByte(r,a.modelindex),MSG.WriteByte(r,a.frame),MSG.WriteByte(r,a.colormap),MSG.WriteByte(r,a.skin),MSG.WriteCoord(r,a.origin[0]),MSG.WriteAngle(r,a.angles[0]),MSG.WriteCoord(r,a.origin[1]),MSG.WriteAngle(r,a.angles[1]),MSG.WriteCoord(r,a.origin[2]),MSG.WriteAngle(r,a.angles[2])))},SV.SaveSpawnparms=function(){var e,t;for(SV.svs.serverflags=PR.globals_float[PR.globalvars.serverflags],e=0;e<SV.svs.maxclients;++e)if(Host.client=SV.svs.clients[e],!0===Host.client.active)for(PR.globals_int[PR.globalvars.self]=Host.client.edict.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.SetChangeParms]),t=0;t<=15;++t)Host.client.spawn_parms[t]=PR.globals_float[PR.globalvars.parms+t]},SV.SpawnServer=function(e){var t,a;for(0===NET.hostname.string.length&&Cvar.Set("hostname","UNNAMED"),SCR.centertime_off=0,Con.DPrint("SpawnServer: "+e+"\n"),SV.svs.changelevel_issued=!1,!0===SV.server.active&&(NET.SendToAll(SV.reconnect),Cmd.ExecuteString("reconnect\n")),0!==Host.coop.value&&Cvar.SetValue("deathmatch",0),Host.current_skill=Math.floor(Host.skill.value+.5),Host.current_skill<0?Host.current_skill=0:Host.current_skill>3&&(Host.current_skill=3),Cvar.SetValue("skill",Host.current_skill),Con.DPrint("Clearing memory\n"),Mod.ClearAll(),PR.LoadProgs(),SV.server.edicts=[],t=0;t<Def.max_edicts;++t)(a={num:t,free:!1,area:{},leafnums:[],baseline:{origin:[0,0,0],angles:[0,0,0],modelindex:0,frame:0,colormap:0,skin:0,effects:0},freetime:0,v:new ArrayBuffer(PR.entityfields<<2)}).area.ent=a,a.v_float=new Float32Array(a.v),a.v_int=new Int32Array(a.v),SV.server.edicts[t]=a;for(SV.server.datagram.cursize=0,SV.server.reliable_datagram.cursize=0,SV.server.signon.cursize=0,SV.server.num_edicts=SV.svs.maxclients+1,t=0;t<SV.svs.maxclients;++t)SV.svs.clients[t].edict=SV.server.edicts[t+1];if(SV.server.loading=!0,SV.server.paused=!1,SV.server.loadgame=!1,SV.server.time=1,SV.server.lastcheck=0,SV.server.lastchecktime=0,SV.server.modelname="maps/"+e+".bsp",SV.server.worldmodel=Mod.ForName(SV.server.modelname),null==SV.server.worldmodel)return Con.Print("Couldn't spawn server "+SV.server.modelname+"\n"),void(SV.server.active=!1);for(SV.server.models=[],SV.server.models[1]=SV.server.worldmodel,SV.areanodes=[],SV.CreateAreaNode(0,SV.server.worldmodel.mins,SV.server.worldmodel.maxs),SV.server.sound_precache=[""],SV.server.model_precache=["",SV.server.modelname],t=1;t<=SV.server.worldmodel.submodels.length;++t)SV.server.model_precache[t+1]="*"+t,SV.server.models[t+1]=Mod.ForName("*"+t);for(SV.server.lightstyles=[],t=0;t<=63;++t)SV.server.lightstyles[t]="";var o=SV.server.edicts[0];for(o.v_int[PR.entvars.model]=PR.NewString(SV.server.modelname,64),o.v_float[PR.entvars.modelindex]=1,o.v_float[PR.entvars.solid]=SV.solid.bsp,o.v_float[PR.entvars.movetype]=SV.movetype.push,0!==Host.coop.value?PR.globals_float[PR.globalvars.coop]=Host.coop.value:PR.globals_float[PR.globalvars.deathmatch]=Host.deathmatch.value,PR.globals_int[PR.globalvars.mapname]=PR.NewString(e,64),PR.globals_float[PR.globalvars.serverflags]=SV.svs.serverflags,ED.LoadFromFile(SV.server.worldmodel.entities),SV.server.active=!0,SV.server.loading=!1,Host.frametime=.1,SV.Physics(),SV.Physics(),SV.CreateBaseline(),t=0;t<SV.svs.maxclients;++t)Host.client=SV.svs.clients[t],!0===Host.client.active&&(Host.client.edict.v_int[PR.entvars.netname]=PR.netnames+(t<<5),SV.SendServerinfo(Host.client));Con.DPrint("Server spawned.\n")},SV.GetClientName=function(e){return PR.GetString(PR.netnames+(e.num<<5))},SV.SetClientName=function(e,t){var a,o=PR.netnames+(e.num<<5);for(a=0;a<t.length;++a)PR.strings[o+a]=t.charCodeAt(a);PR.strings[o+a]=0},SV.CheckBottom=function(e){for(var t=[e.v_float[PR.entvars.origin]+e.v_float[PR.entvars.mins],e.v_float[PR.entvars.origin1]+e.v_float[PR.entvars.mins1],e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.mins2]],a=[e.v_float[PR.entvars.origin]+e.v_float[PR.entvars.maxs],e.v_float[PR.entvars.origin1]+e.v_float[PR.entvars.maxs1],e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.maxs2]];SV.PointContents([t[0],t[1],t[2]-1])===Mod.contents.solid&&SV.PointContents([t[0],a[1],t[2]-1])===Mod.contents.solid&&SV.PointContents([a[0],t[1],t[2]-1])===Mod.contents.solid&&SV.PointContents([a[0],a[1],t[2]-1])===Mod.contents.solid;)return!0;var o=[.5*(t[0]+a[0]),.5*(t[1]+a[1]),t[2]],r=[o[0],o[1],o[2]-36],n=SV.Move(o,Vec.origin,Vec.origin,r,1,e);if(1!==n.fraction){var s,i,l,v;for(s=i=n.endpos[2],l=0;l<=1;++l)for(v=0;v<=1;++v)if(o[0]=r[0]=0!==l?a[0]:t[0],o[1]=r[1]=0!==v?a[1]:t[1],1!==(n=SV.Move(o,Vec.origin,Vec.origin,r,1,e)).fraction&&n.endpos[2]>i&&(i=n.endpos[2]),1===n.fraction||s-n.endpos[2]>18)return;return!0}},SV.movestep=function(e,t,a){var o,r=ED.Vector(e,PR.entvars.origin),n=[],s=ED.Vector(e,PR.entvars.mins),i=ED.Vector(e,PR.entvars.maxs);if(0!=(e.v_float[PR.entvars.flags]&SV.fl.swim+SV.fl.fly)){var l,v,f=e.v_int[PR.entvars.enemy];for(l=0;l<=1;++l){if(n[0]=e.v_float[PR.entvars.origin]+t[0],n[1]=e.v_float[PR.entvars.origin1]+t[1],n[2]=e.v_float[PR.entvars.origin2],0===l&&0!==f&&((v=e.v_float[PR.entvars.origin2]-SV.server.edicts[f].v_float[PR.entvars.origin2])>40?n[2]-=8:v<30&&(n[2]+=8)),1===(o=SV.Move(ED.Vector(e,PR.entvars.origin),s,i,n,0,e)).fraction)return 0!=(e.v_float[PR.entvars.flags]&SV.fl.swim)&&SV.PointContents(o.endpos)===Mod.contents.empty?0:(e.v_float[PR.entvars.origin]=o.endpos[0],e.v_float[PR.entvars.origin1]=o.endpos[1],e.v_float[PR.entvars.origin2]=o.endpos[2],!0===a&&SV.LinkEdict(e,!0),1);if(0===f)return 0}return 0}n[0]=e.v_float[PR.entvars.origin]+t[0],n[1]=e.v_float[PR.entvars.origin1]+t[1],n[2]=e.v_float[PR.entvars.origin2]+18;var c=[n[0],n[1],n[2]-36];return!0===(o=SV.Move(n,s,i,c,0,e)).allsolid?0:!0===o.startsolid&&(n[2]-=18,!0===(o=SV.Move(n,s,i,c,0,e)).allsolid||!0===o.startsolid)?0:1===o.fraction?0==(e.v_float[PR.entvars.flags]&SV.fl.partialground)?0:(e.v_float[PR.entvars.origin]+=t[0],e.v_float[PR.entvars.origin1]+=t[1],!0===a&&SV.LinkEdict(e,!0),e.v_float[PR.entvars.flags]&=~SV.fl.onground>>>0,1):(e.v_float[PR.entvars.origin]=o.endpos[0],e.v_float[PR.entvars.origin1]=o.endpos[1],e.v_float[PR.entvars.origin2]=o.endpos[2],!0!==SV.CheckBottom(e)?0!=(e.v_float[PR.entvars.flags]&SV.fl.partialground)?(!0===a&&SV.LinkEdict(e,!0),1):(e.v_float[PR.entvars.origin]=r[0],e.v_float[PR.entvars.origin1]=r[1],e.v_float[PR.entvars.origin2]=r[2],0):(e.v_float[PR.entvars.flags]&=~SV.fl.partialground>>>0,e.v_int[PR.entvars.groundentity]=o.ent.num,!0===a&&SV.LinkEdict(e,!0),1))},SV.StepDirection=function(e,t,a){e.v_float[PR.entvars.ideal_yaw]=t,PF.changeyaw(),t*=Math.PI/180;var o=ED.Vector(e,PR.entvars.origin);if(1===SV.movestep(e,[Math.cos(t)*a,Math.sin(t)*a],!1)){var r=e.v_float[PR.entvars.angles1]-e.v_float[PR.entvars.ideal_yaw];return r>45&&r<315&&ED.SetVector(e,PR.entvars.origin,o),SV.LinkEdict(e,!0),!0}SV.LinkEdict(e,!0)},SV.NewChaseDir=function(e,t,a){var o,r,n,s=Vec.Anglemod(45*(e.v_float[PR.entvars.ideal_yaw]/45>>0)),i=Vec.Anglemod(s-180),l=t.v_float[PR.entvars.origin]-e.v_float[PR.entvars.origin],v=t.v_float[PR.entvars.origin1]-e.v_float[PR.entvars.origin1];if(r=v<-10?270:v>10?90:-1,!(-1!==(o=l>10?0:l<-10?180:-1)&&-1!==r&&(n=0===o?90===r?45:315:90===r?135:215)!==i&&!0===SV.StepDirection(e,n,a)||((Math.random()>=.25||Math.abs(v)>Math.abs(l))&&(n=o,o=r,r=n),-1!==o&&o!==i&&!0===SV.StepDirection(e,o,a)||-1!==r&&r!==i&&!0===SV.StepDirection(e,r,a)||-1!==s&&!0===SV.StepDirection(e,s,a)))){if(Math.random()>=.5){for(n=0;n<=315;n+=45)if(n!==i&&!0===SV.StepDirection(e,n,a))return}else for(n=315;n>=0;n-=45)if(n!==i&&!0===SV.StepDirection(e,n,a))return;-1!==i&&!0===SV.StepDirection(e,i,a)||(e.v_float[PR.entvars.ideal_yaw]=s,!0!==SV.CheckBottom(e)&&(e.v_float[PR.entvars.flags]|=SV.fl.partialground))}},SV.CloseEnough=function(e,t,a){var o;for(o=0;o<=2;++o){if(t.v_float[PR.entvars.absmin+o]>e.v_float[PR.entvars.absmax+o]+a)return;if(t.v_float[PR.entvars.absmax+o]<e.v_float[PR.entvars.absmin+o]-a)return}return!0},SV.CheckAllEnts=function(){var e,t;for(e=1;e<SV.server.num_edicts;++e)if(!0!==(t=SV.server.edicts[e]).free){switch(t.v_float[PR.entvars.movetype]){case SV.movetype.push:case SV.movetype.none:case SV.movetype.noclip:continue}!0===SV.TestEntityPosition(t)&&Con.Print("entity in invalid position\n")}},SV.CheckVelocity=function(e){var t,a;for(t=0;t<=2;++t)a=e.v_float[PR.entvars.velocity+t],!0===Q.isNaN(a)&&(Con.Print("Got a NaN velocity on "+PR.GetString(e.v_int[PR.entvars.classname])+"\n"),a=0),!0===Q.isNaN(e.v_float[PR.entvars.origin+t])&&(Con.Print("Got a NaN origin on "+PR.GetString(e.v_int[PR.entvars.classname])+"\n"),e.v_float[PR.entvars.origin+t]=0),a>SV.maxvelocity.value?a=SV.maxvelocity.value:a<-SV.maxvelocity.value&&(a=-SV.maxvelocity.value),e.v_float[PR.entvars.velocity+t]=a},SV.RunThink=function(e){var t=e.v_float[PR.entvars.nextthink];return t<=0||t>SV.server.time+Host.frametime||(t<SV.server.time&&(t=SV.server.time),e.v_float[PR.entvars.nextthink]=0,PR.globals_float[PR.globalvars.time]=t,PR.globals_int[PR.globalvars.self]=e.num,PR.globals_int[PR.globalvars.other]=0,PR.ExecuteProgram(e.v_int[PR.entvars.think]),!0!==e.free)},SV.Impact=function(e,t){var a=PR.globals_int[PR.globalvars.self],o=PR.globals_int[PR.globalvars.other];PR.globals_float[PR.globalvars.time]=SV.server.time,0!==e.v_int[PR.entvars.touch]&&e.v_float[PR.entvars.solid]!==SV.solid.not&&(PR.globals_int[PR.globalvars.self]=e.num,PR.globals_int[PR.globalvars.other]=t.num,PR.ExecuteProgram(e.v_int[PR.entvars.touch])),0!==t.v_int[PR.entvars.touch]&&t.v_float[PR.entvars.solid]!==SV.solid.not&&(PR.globals_int[PR.globalvars.self]=t.num,PR.globals_int[PR.globalvars.other]=e.num,PR.ExecuteProgram(t.v_int[PR.entvars.touch])),PR.globals_int[PR.globalvars.self]=a,PR.globals_int[PR.globalvars.other]=o},SV.ClipVelocity=function(e,t,a,o){var r=(e[0]*t[0]+e[1]*t[1]+e[2]*t[2])*o;a[0]=e[0]-t[0]*r,a[0]>-.1&&a[0]<.1&&(a[0]=0),a[1]=e[1]-t[1]*r,a[1]>-.1&&a[1]<.1&&(a[1]=0),a[2]=e[2]-t[2]*r,a[2]>-.1&&a[2]<.1&&(a[2]=0)},SV.FlyMove=function(e,t){var a,o,r,n,s,i,l,v=0,f=[],c=ED.Vector(e,PR.entvars.velocity),P=ED.Vector(e,PR.entvars.velocity),S=[],R=[],_=t,m=0;for(a=0;a<=3&&(0!==e.v_float[PR.entvars.velocity]||0!==e.v_float[PR.entvars.velocity1]||0!==e.v_float[PR.entvars.velocity2]);++a){if(R[0]=e.v_float[PR.entvars.origin]+_*e.v_float[PR.entvars.velocity],R[1]=e.v_float[PR.entvars.origin1]+_*e.v_float[PR.entvars.velocity1],R[2]=e.v_float[PR.entvars.origin2]+_*e.v_float[PR.entvars.velocity2],!0===(l=SV.Move(ED.Vector(e,PR.entvars.origin),ED.Vector(e,PR.entvars.mins),ED.Vector(e,PR.entvars.maxs),R,0,e)).allsolid)return ED.SetVector(e,PR.entvars.velocity,Vec.origin),3;if(l.fraction>0&&(ED.SetVector(e,PR.entvars.origin,l.endpos),P=ED.Vector(e,PR.entvars.velocity),v=0,1===l.fraction))break;if(null==l.ent&&Sys.Error("SV.FlyMove: !trace.ent"),l.plane.normal[2]>.7?(m|=1,l.ent.v_float[PR.entvars.solid]===SV.solid.bsp&&(e.v_float[PR.entvars.flags]|=SV.fl.onground,e.v_int[PR.entvars.groundentity]=l.ent.num)):0===l.plane.normal[2]&&(m|=2,SV.steptrace=l),SV.Impact(e,l.ent),!0===e.free)break;if(_-=_*l.fraction,v>=5)return ED.SetVector(e,PR.entvars.velocity,Vec.origin),3;for(f[v++]=[l.plane.normal[0],l.plane.normal[1],l.plane.normal[2]],s=0;s<v;++s){for(SV.ClipVelocity(P,f[s],S,1),i=0;i<v&&!(i!==s&&(n=f[i],S[0]*n[0]+S[1]*n[1]+S[2]*n[2]<0));++i);if(i===v)break}if(s!==v)ED.SetVector(e,PR.entvars.velocity,S);else{if(2!==v)return ED.SetVector(e,PR.entvars.velocity,Vec.origin),7;r=(o=Vec.CrossProduct(f[0],f[1]))[0]*e.v_float[PR.entvars.velocity]+o[1]*e.v_float[PR.entvars.velocity1]+o[2]*e.v_float[PR.entvars.velocity2],e.v_float[PR.entvars.velocity]=o[0]*r,e.v_float[PR.entvars.velocity1]=o[1]*r,e.v_float[PR.entvars.velocity2]=o[2]*r}if(e.v_float[PR.entvars.velocity]*c[0]+e.v_float[PR.entvars.velocity1]*c[1]+e.v_float[PR.entvars.velocity2]*c[2]<=0)return ED.SetVector(e,PR.entvars.velocity,Vec.origin),m}return m},SV.AddGravity=function(e){var t,a=PR.entvars.gravity;t=null!=a&&0!==e.v_float[a]?e.v_float[a]:1,e.v_float[PR.entvars.velocity2]-=t*SV.gravity.value*Host.frametime},SV.PushEntity=function(e,t){var a,o=[e.v_float[PR.entvars.origin]+t[0],e.v_float[PR.entvars.origin1]+t[1],e.v_float[PR.entvars.origin2]+t[2]],r=e.v_float[PR.entvars.solid];a=e.v_float[PR.entvars.movetype]===SV.movetype.flymissile?SV.move.missile:r===SV.solid.trigger||r===SV.solid.not?SV.move.nomonsters:SV.move.normal;var n=SV.Move(ED.Vector(e,PR.entvars.origin),ED.Vector(e,PR.entvars.mins),ED.Vector(e,PR.entvars.maxs),o,a,e);return ED.SetVector(e,PR.entvars.origin,n.endpos),SV.LinkEdict(e,!0),null!=n.ent&&SV.Impact(e,n.ent),n},SV.PushMove=function(e,t){if(0!==e.v_float[PR.entvars.velocity]||0!==e.v_float[PR.entvars.velocity1]||0!==e.v_float[PR.entvars.velocity2]){var a,o,r,n=[e.v_float[PR.entvars.velocity]*t,e.v_float[PR.entvars.velocity1]*t,e.v_float[PR.entvars.velocity2]*t],s=[e.v_float[PR.entvars.absmin]+n[0],e.v_float[PR.entvars.absmin1]+n[1],e.v_float[PR.entvars.absmin2]+n[2]],i=[e.v_float[PR.entvars.absmax]+n[0],e.v_float[PR.entvars.absmax1]+n[1],e.v_float[PR.entvars.absmax2]+n[2]],l=ED.Vector(e,PR.entvars.origin);e.v_float[PR.entvars.origin]+=n[0],e.v_float[PR.entvars.origin1]+=n[1],e.v_float[PR.entvars.origin2]+=n[2],e.v_float[PR.entvars.ltime]+=t,SV.LinkEdict(e);var v,f,c,P=[];for(a=1;a<SV.server.num_edicts;++a)if(!0!==(o=SV.server.edicts[a]).free&&(r=o.v_float[PR.entvars.movetype])!==SV.movetype.push&&r!==SV.movetype.none&&r!==SV.movetype.noclip){if(0==(o.v_float[PR.entvars.flags]&SV.fl.onground)||o.v_int[PR.entvars.groundentity]!==e.num){if(o.v_float[PR.entvars.absmin]>=i[0]||o.v_float[PR.entvars.absmin1]>=i[1]||o.v_float[PR.entvars.absmin2]>=i[2]||o.v_float[PR.entvars.absmax]<=s[0]||o.v_float[PR.entvars.absmax1]<=s[1]||o.v_float[PR.entvars.absmax2]<=s[2])continue;if(!0!==SV.TestEntityPosition(o))continue}if(r!==SV.movetype.walk&&(o.v_float[PR.entvars.flags]&=~SV.fl.onground>>>0),v=ED.Vector(o,PR.entvars.origin),P[P.length]=[v[0],v[1],v[2],o],e.v_float[PR.entvars.solid]=SV.solid.not,SV.PushEntity(o,n),e.v_float[PR.entvars.solid]=SV.solid.bsp,!0===SV.TestEntityPosition(o)){if(o.v_float[PR.entvars.mins]===o.v_float[PR.entvars.maxs])continue;if(o.v_float[PR.entvars.solid]===SV.solid.not||o.v_float[PR.entvars.solid]===SV.solid.trigger){o.v_float[PR.entvars.mins]=o.v_float[PR.entvars.maxs]=0,o.v_float[PR.entvars.mins1]=o.v_float[PR.entvars.maxs1]=0,o.v_float[PR.entvars.maxs2]=o.v_float[PR.entvars.mins2];continue}for(o.v_float[PR.entvars.origin]=v[0],o.v_float[PR.entvars.origin1]=v[1],o.v_float[PR.entvars.origin2]=v[2],SV.LinkEdict(o,!0),e.v_float[PR.entvars.origin]=l[0],e.v_float[PR.entvars.origin1]=l[1],e.v_float[PR.entvars.origin2]=l[2],SV.LinkEdict(e),e.v_float[PR.entvars.ltime]-=t,0!==e.v_int[PR.entvars.blocked]&&(PR.globals_int[PR.globalvars.self]=e.num,PR.globals_int[PR.globalvars.other]=o.num,PR.ExecuteProgram(e.v_int[PR.entvars.blocked])),c=0;c<P.length;++c)(f=P[c])[3].v_float[PR.entvars.origin]=f[0],f[3].v_float[PR.entvars.origin1]=f[1],f[3].v_float[PR.entvars.origin2]=f[2],SV.LinkEdict(f[3]);return}}}else e.v_float[PR.entvars.ltime]+=t},SV.Physics_Pusher=function(e){var t,a=e.v_float[PR.entvars.ltime],o=e.v_float[PR.entvars.nextthink];o<a+Host.frametime?(t=o-a)<0&&(t=0):t=Host.frametime,0!==t&&SV.PushMove(e,t),o<=a||o>e.v_float[PR.entvars.ltime]||(e.v_float[PR.entvars.nextthink]=0,PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=e.num,PR.globals_int[PR.globalvars.other]=0,PR.ExecuteProgram(e.v_int[PR.entvars.think]))},SV.CheckStuck=function(e){if(!0!==SV.TestEntityPosition(e))return e.v_float[PR.entvars.oldorigin]=e.v_float[PR.entvars.origin],e.v_float[PR.entvars.oldorigin1]=e.v_float[PR.entvars.origin1],void(e.v_float[PR.entvars.oldorigin2]=e.v_float[PR.entvars.origin2]);var t,a,o,r=ED.Vector(e,PR.entvars.origin);if(e.v_float[PR.entvars.origin]=e.v_float[PR.entvars.oldorigin],e.v_float[PR.entvars.origin1]=e.v_float[PR.entvars.oldorigin1],e.v_float[PR.entvars.origin2]=e.v_float[PR.entvars.oldorigin2],!0!==SV.TestEntityPosition(e))return Con.DPrint("Unstuck.\n"),void SV.LinkEdict(e,!0);for(t=0;t<=17;++t)for(a=-1;a<=1;++a)for(o=-1;o<=1;++o)if(e.v_float[PR.entvars.origin]=r[0]+a,e.v_float[PR.entvars.origin1]=r[1]+o,e.v_float[PR.entvars.origin2]=r[2]+t,!0!==SV.TestEntityPosition(e))return Con.DPrint("Unstuck.\n"),void SV.LinkEdict(e,!0);ED.SetVector(e,PR.entvars.origin,r),Con.DPrint("player is stuck.\n")},SV.CheckWater=function(e){var t=[e.v_float[PR.entvars.origin],e.v_float[PR.entvars.origin1],e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.mins2]+1];e.v_float[PR.entvars.waterlevel]=0,e.v_float[PR.entvars.watertype]=Mod.contents.empty;var a=SV.PointContents(t);if(!(a>Mod.contents.water))return e.v_float[PR.entvars.watertype]=a,e.v_float[PR.entvars.waterlevel]=1,t[2]=e.v_float[PR.entvars.origin2]+.5*(e.v_float[PR.entvars.mins2]+e.v_float[PR.entvars.maxs2]),(a=SV.PointContents(t))<=Mod.contents.water&&(e.v_float[PR.entvars.waterlevel]=2,t[2]=e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.view_ofs2],(a=SV.PointContents(t))<=Mod.contents.water&&(e.v_float[PR.entvars.waterlevel]=3)),e.v_float[PR.entvars.waterlevel]>1},SV.WallFriction=function(e,t){var a=[];Vec.AngleVectors(ED.Vector(e,PR.entvars.v_angle),a);var o=t.plane.normal,r=o[0]*a[0]+o[1]*a[1]+o[2]*a[2]+.5;if(!(r>=0)){r+=1;var n=o[0]*e.v_float[PR.entvars.velocity]+o[1]*e.v_float[PR.entvars.velocity1]+o[2]*e.v_float[PR.entvars.velocity2];e.v_float[PR.entvars.velocity]=(e.v_float[PR.entvars.velocity]-o[0]*n)*r,e.v_float[PR.entvars.velocity1]=(e.v_float[PR.entvars.velocity1]-o[1]*n)*r}},SV.TryUnstick=function(e,t){var a,o,r=ED.Vector(e,PR.entvars.origin),n=[2,0,0];for(a=0;a<=7;++a){switch(a){case 1:n[0]=0,n[1]=2;break;case 2:n[0]=-2,n[1]=0;break;case 3:n[0]=0,n[1]=-2;break;case 4:n[0]=2,n[1]=2;break;case 5:n[0]=-2,n[1]=2;break;case 6:n[0]=2,n[1]=-2;break;case 7:n[0]=-2,n[1]=-2}if(SV.PushEntity(e,n),e.v_float[PR.entvars.velocity]=t[0],e.v_float[PR.entvars.velocity1]=t[1],e.v_float[PR.entvars.velocity2]=0,o=SV.FlyMove(e,.1),Math.abs(r[1]-e.v_float[PR.entvars.origin1])>4||Math.abs(r[0]-e.v_float[PR.entvars.origin])>4)return o;ED.SetVector(e,PR.entvars.origin,r)}return ED.SetVector(e,PR.entvars.velocity,Vec.origin),7},SV.WalkMove=function(e){var t=e.v_float[PR.entvars.flags]&SV.fl.onground;e.v_float[PR.entvars.flags]^=t;var a=ED.Vector(e,PR.entvars.origin),o=ED.Vector(e,PR.entvars.velocity),r=SV.FlyMove(e,Host.frametime);if(0!=(2&r)&&(0!==t||0!==e.v_float[PR.entvars.waterlevel])&&e.v_float[PR.entvars.movetype]===SV.movetype.walk&&0===SV.nostep.value&&0==(SV.player.v_float[PR.entvars.flags]&SV.fl.waterjump)){var n=ED.Vector(e,PR.entvars.origin),s=ED.Vector(e,PR.entvars.velocity);ED.SetVector(e,PR.entvars.origin,a),SV.PushEntity(e,[0,0,18]),e.v_float[PR.entvars.velocity]=o[0],e.v_float[PR.entvars.velocity1]=o[1],e.v_float[PR.entvars.velocity2]=0,0!==(r=SV.FlyMove(e,Host.frametime))&&(Math.abs(a[1]-e.v_float[PR.entvars.origin1])<.03125&&Math.abs(a[0]-e.v_float[PR.entvars.origin])<.03125&&(r=SV.TryUnstick(e,o)),0!=(2&r)&&SV.WallFriction(e,SV.steptrace));var i=SV.PushEntity(e,[0,0,o[2]*Host.frametime-18]);i.plane.normal[2]>.7?e.v_float[PR.entvars.solid]===SV.solid.bsp&&(e.v_float[PR.entvars.flags]|=SV.fl.onground,e.v_int[PR.entvars.groundentity]=i.ent.num):(ED.SetVector(e,PR.entvars.origin,n),ED.SetVector(e,PR.entvars.velocity,s))}},SV.Physics_Client=function(e){if(!0===SV.svs.clients[e.num-1].active){PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=e.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.PlayerPreThink]),SV.CheckVelocity(e);var t=e.v_float[PR.entvars.movetype]>>0;if(t===SV.movetype.toss||t===SV.movetype.bounce)SV.Physics_Toss(e);else{if(!0!==SV.RunThink(e))return;switch(t){case SV.movetype.none:break;case SV.movetype.walk:!0!==SV.CheckWater(e)&&0==(e.v_float[PR.entvars.flags]&SV.fl.waterjump)&&SV.AddGravity(e),SV.CheckStuck(e),SV.WalkMove(e);break;case SV.movetype.fly:SV.FlyMove(e,Host.frametime);break;case SV.movetype.noclip:e.v_float[PR.entvars.origin]+=Host.frametime*e.v_float[PR.entvars.velocity],e.v_float[PR.entvars.origin1]+=Host.frametime*e.v_float[PR.entvars.velocity1],e.v_float[PR.entvars.origin2]+=Host.frametime*e.v_float[PR.entvars.velocity2];break;default:Sys.Error("SV.Physics_Client: bad movetype "+t)}}SV.LinkEdict(e,!0),PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=e.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.PlayerPostThink])}},SV.Physics_Noclip=function(e){!0===SV.RunThink(e)&&(e.v_float[PR.entvars.angles]+=Host.frametime*e.v_float[PR.entvars.avelocity],e.v_float[PR.entvars.angles1]+=Host.frametime*e.v_float[PR.entvars.avelocity1],e.v_float[PR.entvars.angles2]+=Host.frametime*e.v_float[PR.entvars.avelocity2],e.v_float[PR.entvars.origin]+=Host.frametime*e.v_float[PR.entvars.velocity],e.v_float[PR.entvars.origin1]+=Host.frametime*e.v_float[PR.entvars.velocity1],e.v_float[PR.entvars.origin2]+=Host.frametime*e.v_float[PR.entvars.velocity2],SV.LinkEdict(e))},SV.CheckWaterTransition=function(e){var t=SV.PointContents(ED.Vector(e,PR.entvars.origin));return 0===e.v_float[PR.entvars.watertype]?(e.v_float[PR.entvars.watertype]=t,void(e.v_float[PR.entvars.waterlevel]=1)):t<=Mod.contents.water?(e.v_float[PR.entvars.watertype]===Mod.contents.empty&&SV.StartSound(e,0,"misc/h2ohit1.wav",255,1),e.v_float[PR.entvars.watertype]=t,void(e.v_float[PR.entvars.waterlevel]=1)):(e.v_float[PR.entvars.watertype]!==Mod.contents.empty&&SV.StartSound(e,0,"misc/h2ohit1.wav",255,1),e.v_float[PR.entvars.watertype]=Mod.contents.empty,void(e.v_float[PR.entvars.waterlevel]=t))},SV.Physics_Toss=function(e){if(!0===SV.RunThink(e)&&0==(e.v_float[PR.entvars.flags]&SV.fl.onground)){SV.CheckVelocity(e);var t=e.v_float[PR.entvars.movetype];t!==SV.movetype.fly&&t!==SV.movetype.flymissile&&SV.AddGravity(e),e.v_float[PR.entvars.angles]+=Host.frametime*e.v_float[PR.entvars.avelocity],e.v_float[PR.entvars.angles1]+=Host.frametime*e.v_float[PR.entvars.avelocity1],e.v_float[PR.entvars.angles2]+=Host.frametime*e.v_float[PR.entvars.avelocity2];var a=SV.PushEntity(e,[e.v_float[PR.entvars.velocity]*Host.frametime,e.v_float[PR.entvars.velocity1]*Host.frametime,e.v_float[PR.entvars.velocity2]*Host.frametime]);if(1!==a.fraction&&!0!==e.free){var o=[];SV.ClipVelocity(ED.Vector(e,PR.entvars.velocity),a.plane.normal,o,t===SV.movetype.bounce?1.5:1),ED.SetVector(e,PR.entvars.velocity,o),a.plane.normal[2]>.7&&(e.v_float[PR.entvars.velocity2]<60||t!==SV.movetype.bounce)&&(e.v_float[PR.entvars.flags]|=SV.fl.onground,e.v_int[PR.entvars.groundentity]=a.ent.num,e.v_float[PR.entvars.velocity]=e.v_float[PR.entvars.velocity1]=e.v_float[PR.entvars.velocity2]=0,e.v_float[PR.entvars.avelocity]=e.v_float[PR.entvars.avelocity1]=e.v_float[PR.entvars.avelocity2]=0),SV.CheckWaterTransition(e)}}},SV.Physics_Step=function(e){if(0==(e.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+SV.fl.swim)){var t=e.v_float[PR.entvars.velocity2]<-.1*SV.gravity.value;SV.AddGravity(e),SV.CheckVelocity(e),SV.FlyMove(e,Host.frametime),SV.LinkEdict(e,!0),0!=(e.v_float[PR.entvars.flags]&SV.fl.onground)&&!0===t&&SV.StartSound(e,0,"demon/dland2.wav",255,1)}SV.RunThink(e),SV.CheckWaterTransition(e)},SV.Physics=function(){var e,t;for(PR.globals_int[PR.globalvars.self]=0,PR.globals_int[PR.globalvars.other]=0,PR.globals_float[PR.globalvars.time]=SV.server.time,PR.ExecuteProgram(PR.globals_int[PR.globalvars.StartFrame]),e=0;e<SV.server.num_edicts;++e)if(!0!==(t=SV.server.edicts[e]).free)if(0!==PR.globals_float[PR.globalvars.force_retouch]&&SV.LinkEdict(t,!0),e>0&&e<=SV.svs.maxclients)SV.Physics_Client(t);else{switch(t.v_float[PR.entvars.movetype]){case SV.movetype.push:SV.Physics_Pusher(t);continue;case SV.movetype.none:case SV.movetype.noclip:SV.RunThink(t);continue;case SV.movetype.step:SV.Physics_Step(t);continue;case SV.movetype.toss:case SV.movetype.bounce:case SV.movetype.fly:case SV.movetype.flymissile:SV.Physics_Toss(t);continue}Sys.Error("SV.Physics: bad movetype "+(t.v_float[PR.entvars.movetype]>>0))}0!==PR.globals_float[PR.globalvars.force_retouch]&&--PR.globals_float[PR.globalvars.force_retouch],SV.server.time+=Host.frametime},SV.SetIdealPitch=function(){var e=SV.player;if(0!=(e.v_float[PR.entvars.flags]&SV.fl.onground)){var t,a,o=e.v_float[PR.entvars.angles1]*(Math.PI/180),r=Math.sin(o),n=Math.cos(o),s=[0,0,e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.view_ofs2]],i=[0,0,s[2]-160],l=[];for(t=0;t<6;++t){if(s[0]=i[0]=e.v_float[PR.entvars.origin]+n*(t+3)*12,s[1]=i[1]=e.v_float[PR.entvars.origin1]+r*(t+3)*12,!0===(a=SV.Move(s,Vec.origin,Vec.origin,i,1,e)).allsolid||1===a.fraction)return;l[t]=s[2]-160*a.fraction}var v,f=0,c=0;for(t=1;t<6;++t)if(!((v=l[t]-l[t-1])>-.1&&v<.1)){if(0!==f&&(v-f>.1||v-f<-.1))return;++c,f=v}0!==f?c>=2&&(e.v_float[PR.entvars.idealpitch]=-f*SV.idealpitchscale.value):e.v_float[PR.entvars.idealpitch]=0}},SV.UserFriction=function(){var e=SV.player,t=e.v_float[PR.entvars.velocity],a=e.v_float[PR.entvars.velocity1],o=Math.sqrt(t*t+a*a);if(0!==o){var r=[e.v_float[PR.entvars.origin]+t/o*16,e.v_float[PR.entvars.origin1]+a/o*16,e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.mins2]],n=SV.friction.value;1===SV.Move(r,Vec.origin,Vec.origin,[r[0],r[1],r[2]-34],1,e).fraction&&(n*=SV.edgefriction.value);var s=o-Host.frametime*(o<SV.stopspeed.value?SV.stopspeed.value:o)*n;s<0&&(s=0),s/=o,e.v_float[PR.entvars.velocity]*=s,e.v_float[PR.entvars.velocity1]*=s,e.v_float[PR.entvars.velocity2]*=s}},SV.Accelerate=function(e,t){var a=SV.player,o=[e[0],e[1],e[2]],r=Vec.Normalize(o);!0===t&&r>30&&(r=30);var n=r-(a.v_float[PR.entvars.velocity]*o[0]+a.v_float[PR.entvars.velocity1]*o[1]+a.v_float[PR.entvars.velocity2]*o[2]);if(!(n<=0)){var s=SV.accelerate.value*Host.frametime*r;s>n&&(s=n),a.v_float[PR.entvars.velocity]+=s*o[0],a.v_float[PR.entvars.velocity1]+=s*o[1],a.v_float[PR.entvars.velocity2]+=s*o[2]}},SV.WaterMove=function(){var e=SV.player,t=Host.client.cmd,a=[],o=[];Vec.AngleVectors(ED.Vector(e,PR.entvars.v_angle),a,o);var r=[a[0]*t.forwardmove+o[0]*t.sidemove,a[1]*t.forwardmove+o[1]*t.sidemove,a[2]*t.forwardmove+o[2]*t.sidemove];0===t.forwardmove&&0===t.sidemove&&0===t.upmove?r[2]-=60:r[2]+=t.upmove;var n,s=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);s>SV.maxspeed.value&&(n=SV.maxspeed.value/s,r[0]*=n,r[1]*=n,r[2]*=n,s=SV.maxspeed.value),s*=.7;var i,l=Math.sqrt(e.v_float[PR.entvars.velocity]*e.v_float[PR.entvars.velocity]+e.v_float[PR.entvars.velocity1]*e.v_float[PR.entvars.velocity1]+e.v_float[PR.entvars.velocity2]*e.v_float[PR.entvars.velocity2]);if(0!==l?((i=l-Host.frametime*l*SV.friction.value)<0&&(i=0),n=i/l,e.v_float[PR.entvars.velocity]*=n,e.v_float[PR.entvars.velocity1]*=n,e.v_float[PR.entvars.velocity2]*=n):i=0,0!==s){var v=s-i;if(!(v<=0)){var f=SV.accelerate.value*s*Host.frametime;f>v&&(f=v),e.v_float[PR.entvars.velocity]+=f*(r[0]/s),e.v_float[PR.entvars.velocity1]+=f*(r[1]/s),e.v_float[PR.entvars.velocity2]+=f*(r[2]/s)}}},SV.WaterJump=function(){var e=SV.player;(SV.server.time>e.v_float[PR.entvars.teleport_time]||0===e.v_float[PR.entvars.waterlevel])&&(e.v_float[PR.entvars.flags]&=~SV.fl.waterjump>>>0,e.v_float[PR.entvars.teleport_time]=0),e.v_float[PR.entvars.velocity]=e.v_float[PR.entvars.movedir],e.v_float[PR.entvars.velocity1]=e.v_float[PR.entvars.movedir1]},SV.AirMove=function(){var e=SV.player,t=Host.client.cmd,a=[],o=[];Vec.AngleVectors(ED.Vector(e,PR.entvars.angles),a,o);var r=t.forwardmove,n=t.sidemove;SV.server.time<e.v_float[PR.entvars.teleport_time]&&r<0&&(r=0);var s=[a[0]*r+o[0]*n,a[1]*r+o[1]*n,e.v_float[PR.entvars.movetype]>>0!==SV.movetype.walk?t.upmove:0],i=[s[0],s[1],s[2]];Vec.Normalize(i)>SV.maxspeed.value&&(s[0]=i[0]*SV.maxspeed.value,s[1]=i[1]*SV.maxspeed.value,s[2]=i[2]*SV.maxspeed.value),e.v_float[PR.entvars.movetype]===SV.movetype.noclip?ED.SetVector(e,PR.entvars.velocity,s):0!=(e.v_float[PR.entvars.flags]&SV.fl.onground)?(SV.UserFriction(s),SV.Accelerate(s)):SV.Accelerate(s,!0)},SV.ClientThink=function(){var e=SV.player;if(e.v_float[PR.entvars.movetype]!==SV.movetype.none){var t=ED.Vector(e,PR.entvars.punchangle),a=Vec.Normalize(t)-10*Host.frametime;a<0&&(a=0),e.v_float[PR.entvars.punchangle]=t[0]*a,e.v_float[PR.entvars.punchangle1]=t[1]*a,e.v_float[PR.entvars.punchangle2]=t[2]*a,e.v_float[PR.entvars.health]<=0||(e.v_float[PR.entvars.angles2]=4*V.CalcRoll(ED.Vector(e,PR.entvars.angles),ED.Vector(e,PR.entvars.velocity)),0===SV.player.v_float[PR.entvars.fixangle]&&(e.v_float[PR.entvars.angles]=(e.v_float[PR.entvars.v_angle]+e.v_float[PR.entvars.punchangle])/-3,e.v_float[PR.entvars.angles1]=e.v_float[PR.entvars.v_angle1]+e.v_float[PR.entvars.punchangle1]),0!=(e.v_float[PR.entvars.flags]&SV.fl.waterjump)?SV.WaterJump():e.v_float[PR.entvars.waterlevel]>=2&&e.v_float[PR.entvars.movetype]!==SV.movetype.noclip?SV.WaterMove():SV.AirMove())}},SV.ReadClientMove=function(){var e=Host.client;e.ping_times[15&e.num_pings++]=SV.server.time-MSG.ReadFloat(),e.edict.v_float[PR.entvars.v_angle]=MSG.ReadAngle(),e.edict.v_float[PR.entvars.v_angle1]=MSG.ReadAngle(),e.edict.v_float[PR.entvars.v_angle2]=MSG.ReadAngle(),e.cmd.forwardmove=MSG.ReadShort(),e.cmd.sidemove=MSG.ReadShort(),e.cmd.upmove=MSG.ReadShort();var t=MSG.ReadByte();e.edict.v_float[PR.entvars.button0]=1&t,e.edict.v_float[PR.entvars.button2]=(2&t)>>1,0!==(t=MSG.ReadByte())&&(e.edict.v_float[PR.entvars.impulse]=t)},SV.ReadClientMessage=function(){var e,t,a,o,r=["status","god","notarget","fly","name","noclip","say","say_team","tell","color","kill","pause","spawn","begin","prespawn","kick","ping","give","ban"];do{if(-1===(e=NET.GetMessage(Host.client.netconnection)))return void Sys.Print("SV.ReadClientMessage: NET.GetMessage failed\n");if(0===e)return!0;for(MSG.BeginReading();;){if(!0!==Host.client.active)return;if(!0===MSG.badread)return void Sys.Print("SV.ReadClientMessage: badread\n");if(-1===(t=MSG.ReadChar())){e=1;break}if(t!==Protocol.clc.nop)if(t===Protocol.clc.stringcmd){for(a=MSG.ReadString(),o=0;o<r.length;++o)if(a.substring(0,r[o].length).toLowerCase()===r[o]){Cmd.ExecuteString(a,!0);break}o===r.length&&Con.DPrint(SV.GetClientName(Host.client)+" tried to "+a)}else{if(t===Protocol.clc.disconnect)return;if(t!==Protocol.clc.move)return void Sys.Print("SV.ReadClientMessage: unknown command char\n");SV.ReadClientMove()}}}while(1===e)},SV.RunClients=function(){var e;for(e=0;e<SV.svs.maxclients;++e)Host.client=SV.svs.clients[e],!0===Host.client.active&&(SV.player=Host.client.edict,!0===SV.ReadClientMessage()?!0===Host.client.spawned?SV.ClientThink():(Host.client.cmd.forwardmove=0,Host.client.cmd.sidemove=0,Host.client.cmd.upmove=0):Host.DropClient())},SV.move={normal:0,nomonsters:1,missile:2},SV.InitBoxHull=function(){var e,t,a;for(SV.box_clipnodes=[],SV.box_planes=[],SV.box_hull={clipnodes:SV.box_clipnodes,planes:SV.box_planes,firstclipnode:0,lastclipnode:5},e=0;e<=5;++e)t={},SV.box_clipnodes[e]=t,t.planenum=e,t.children=[],t.children[1&e]=Mod.contents.empty,t.children[1-(1&e)]=5!==e?e+1:Mod.contents.solid,a={},SV.box_planes[e]=a,a.type=e>>1,a.normal=[0,0,0],a.normal[e>>1]=1,a.dist=0},SV.HullForEntity=function(e,t,a,o){if(e.v_float[PR.entvars.solid]!==SV.solid.bsp)return SV.box_planes[0].dist=e.v_float[PR.entvars.maxs]-t[0],SV.box_planes[1].dist=e.v_float[PR.entvars.mins]-a[0],SV.box_planes[2].dist=e.v_float[PR.entvars.maxs1]-t[1],SV.box_planes[3].dist=e.v_float[PR.entvars.mins1]-a[1],SV.box_planes[4].dist=e.v_float[PR.entvars.maxs2]-t[2],SV.box_planes[5].dist=e.v_float[PR.entvars.mins2]-a[2],o[0]=e.v_float[PR.entvars.origin],o[1]=e.v_float[PR.entvars.origin1],o[2]=e.v_float[PR.entvars.origin2],SV.box_hull;e.v_float[PR.entvars.movetype]!==SV.movetype.push&&Sys.Error("SOLID_BSP without MOVETYPE_PUSH");var r=SV.server.models[e.v_float[PR.entvars.modelindex]>>0];null==r&&Sys.Error("MOVETYPE_PUSH with a non bsp model"),r.type!==Mod.type.brush&&Sys.Error("MOVETYPE_PUSH with a non bsp model");var n,s=a[0]-t[0];return n=s<3?r.hulls[0]:s<=32?r.hulls[1]:r.hulls[2],o[0]=n.clip_mins[0]-t[0]+e.v_float[PR.entvars.origin],o[1]=n.clip_mins[1]-t[1]+e.v_float[PR.entvars.origin1],o[2]=n.clip_mins[2]-t[2]+e.v_float[PR.entvars.origin2],n},SV.CreateAreaNode=function(e,t,a){var o={};if(SV.areanodes[SV.areanodes.length++]=o,o.trigger_edicts={},o.trigger_edicts.prev=o.trigger_edicts.next=o.trigger_edicts,o.solid_edicts={},o.solid_edicts.prev=o.solid_edicts.next=o.solid_edicts,4===e)return o.axis=-1,o.children=[],o;o.axis=a[0]-t[0]>a[1]-t[1]?0:1,o.dist=.5*(a[o.axis]+t[o.axis]);var r=[a[0],a[1],a[2]],n=[t[0],t[1],t[2]];return r[o.axis]=n[o.axis]=o.dist,o.children=[SV.CreateAreaNode(e+1,n,a),SV.CreateAreaNode(e+1,t,r)],o},SV.UnlinkEdict=function(e){null!=e.area.prev&&(e.area.prev.next=e.area.next),null!=e.area.next&&(e.area.next.prev=e.area.prev),e.area.prev=e.area.next=null},SV.TouchLinks=function(e,t){var a,o,r,n,s;for(a=t.trigger_edicts.next;a!==t.trigger_edicts;a=o)o=a.next,(r=a.ent)!==e&&0!==r.v_int[PR.entvars.touch]&&r.v_float[PR.entvars.solid]===SV.solid.trigger&&(e.v_float[PR.entvars.absmin]>r.v_float[PR.entvars.absmax]||e.v_float[PR.entvars.absmin1]>r.v_float[PR.entvars.absmax1]||e.v_float[PR.entvars.absmin2]>r.v_float[PR.entvars.absmax2]||e.v_float[PR.entvars.absmax]<r.v_float[PR.entvars.absmin]||e.v_float[PR.entvars.absmax1]<r.v_float[PR.entvars.absmin1]||e.v_float[PR.entvars.absmax2]<r.v_float[PR.entvars.absmin2]||(n=PR.globals_int[PR.globalvars.self],s=PR.globals_int[PR.globalvars.other],PR.globals_int[PR.globalvars.self]=r.num,PR.globals_int[PR.globalvars.other]=e.num,PR.globals_float[PR.globalvars.time]=SV.server.time,PR.ExecuteProgram(r.v_int[PR.entvars.touch]),PR.globals_int[PR.globalvars.self]=n,PR.globals_int[PR.globalvars.other]=s));-1!==t.axis&&(e.v_float[PR.entvars.absmax+t.axis]>t.dist&&SV.TouchLinks(e,t.children[0]),e.v_float[PR.entvars.absmin+t.axis]<t.dist&&SV.TouchLinks(e,t.children[1]))},SV.FindTouchedLeafs=function(e,t){if(t.contents!==Mod.contents.solid)if(t.contents<0){if(16===e.leafnums.length)return;e.leafnums[e.leafnums.length]=t.num-1}else{var a=Vec.BoxOnPlaneSide([e.v_float[PR.entvars.absmin],e.v_float[PR.entvars.absmin1],e.v_float[PR.entvars.absmin2]],[e.v_float[PR.entvars.absmax],e.v_float[PR.entvars.absmax1],e.v_float[PR.entvars.absmax2]],t.plane);0!=(1&a)&&SV.FindTouchedLeafs(e,t.children[0]),0!=(2&a)&&SV.FindTouchedLeafs(e,t.children[1])}},SV.LinkEdict=function(e,t){if(e!==SV.server.edicts[0]&&!0!==e.free&&(SV.UnlinkEdict(e),e.v_float[PR.entvars.absmin]=e.v_float[PR.entvars.origin]+e.v_float[PR.entvars.mins]-1,e.v_float[PR.entvars.absmin1]=e.v_float[PR.entvars.origin1]+e.v_float[PR.entvars.mins1]-1,e.v_float[PR.entvars.absmin2]=e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.mins2],e.v_float[PR.entvars.absmax]=e.v_float[PR.entvars.origin]+e.v_float[PR.entvars.maxs]+1,e.v_float[PR.entvars.absmax1]=e.v_float[PR.entvars.origin1]+e.v_float[PR.entvars.maxs1]+1,e.v_float[PR.entvars.absmax2]=e.v_float[PR.entvars.origin2]+e.v_float[PR.entvars.maxs2],0!=(e.v_float[PR.entvars.flags]&SV.fl.item)?(e.v_float[PR.entvars.absmin]-=14,e.v_float[PR.entvars.absmin1]-=14,e.v_float[PR.entvars.absmax]+=14,e.v_float[PR.entvars.absmax1]+=14):(e.v_float[PR.entvars.absmin2]-=1,e.v_float[PR.entvars.absmax2]+=1),e.leafnums=[],0!==e.v_float[PR.entvars.modelindex]&&SV.FindTouchedLeafs(e,SV.server.worldmodel.nodes[0]),e.v_float[PR.entvars.solid]!==SV.solid.not)){for(var a=SV.areanodes[0];-1!==a.axis;)if(e.v_float[PR.entvars.absmin+a.axis]>a.dist)a=a.children[0];else{if(!(e.v_float[PR.entvars.absmax+a.axis]<a.dist))break;a=a.children[1]}var o=e.v_float[PR.entvars.solid]===SV.solid.trigger?a.trigger_edicts:a.solid_edicts;e.area.next=o,e.area.prev=o.prev,e.area.prev.next=e.area,e.area.next.prev=e.area,e.area.ent=e,!0===t&&SV.TouchLinks(e,SV.areanodes[0])}},SV.HullPointContents=function(e,t,a){for(var o,r;t>=0;)(t<e.firstclipnode||t>e.lastclipnode)&&Sys.Error("SV.HullPointContents: bad node number"),o=e.clipnodes[t],t=((r=e.planes[o.planenum]).type<=2?a[r.type]-r.dist:r.normal[0]*a[0]+r.normal[1]*a[1]+r.normal[2]*a[2]-r.dist)>=0?o.children[0]:o.children[1];return t},SV.PointContents=function(e){var t=SV.HullPointContents(SV.server.worldmodel.hulls[0],0,e);return t<=Mod.contents.current_0&&t>=Mod.contents.current_down?Mod.contents.water:t},SV.TestEntityPosition=function(e){var t=ED.Vector(e,PR.entvars.origin);return SV.Move(t,ED.Vector(e,PR.entvars.mins),ED.Vector(e,PR.entvars.maxs),t,0,e).startsolid},SV.RecursiveHullCheck=function(e,t,a,o,r,n,s){if(t<0)return t!==Mod.contents.solid?(s.allsolid=!1,t===Mod.contents.empty?s.inopen=!0:s.inwater=!0):s.startsolid=!0,!0;(t<e.firstclipnode||t>e.lastclipnode)&&Sys.Error("SV.RecursiveHullCheck: bad node number");var i,l,v=e.clipnodes[t],f=e.planes[v.planenum];if(f.type<=2?(i=r[f.type]-f.dist,l=n[f.type]-f.dist):(i=f.normal[0]*r[0]+f.normal[1]*r[1]+f.normal[2]*r[2]-f.dist,l=f.normal[0]*n[0]+f.normal[1]*n[1]+f.normal[2]*n[2]-f.dist),i>=0&&l>=0)return SV.RecursiveHullCheck(e,v.children[0],a,o,r,n,s);if(i<0&&l<0)return SV.RecursiveHullCheck(e,v.children[1],a,o,r,n,s);var c=(i+(i<0?.03125:-.03125))/(i-l);c<0?c=0:c>1&&(c=1);var P=a+(o-a)*c,S=[r[0]+c*(n[0]-r[0]),r[1]+c*(n[1]-r[1]),r[2]+c*(n[2]-r[2])],R=i<0?1:0;if(!0===SV.RecursiveHullCheck(e,v.children[R],a,P,r,S,s)){if(SV.HullPointContents(e,v.children[1-R],S)!==Mod.contents.solid)return SV.RecursiveHullCheck(e,v.children[1-R],P,o,S,n,s);if(!0!==s.allsolid){for(0===R?(s.plane.normal=[f.normal[0],f.normal[1],f.normal[2]],s.plane.dist=f.dist):(s.plane.normal=[-f.normal[0],-f.normal[1],-f.normal[2]],s.plane.dist=-f.dist);SV.HullPointContents(e,e.firstclipnode,S)===Mod.contents.solid;){if((c-=.1)<0)return s.fraction=P,s.endpos=[S[0],S[1],S[2]],void Con.DPrint("backup past 0\n");P=a+(o-a)*c,S[0]=r[0]+c*(n[0]-r[0]),S[1]=r[1]+c*(n[1]-r[1]),S[2]=r[2]+c*(n[2]-r[2])}s.fraction=P,s.endpos=[S[0],S[1],S[2]]}}},SV.ClipMoveToEntity=function(e,t,a,o,r){var n={fraction:1,allsolid:!0,endpos:[r[0],r[1],r[2]],plane:{normal:[0,0,0],dist:0}},s=[],i=SV.HullForEntity(e,a,o,s);return SV.RecursiveHullCheck(i,i.firstclipnode,0,1,[t[0]-s[0],t[1]-s[1],t[2]-s[2]],[r[0]-s[0],r[1]-s[1],r[2]-s[2]],n),1!==n.fraction&&(n.endpos[0]+=s[0],n.endpos[1]+=s[1],n.endpos[2]+=s[2]),(n.fraction<1||!0===n.startsolid)&&(n.ent=e),n},SV.ClipToLinks=function(e,t){var a,o,r,n;for(a=e.solid_edicts.next;a!==e.solid_edicts;a=a.next)if((r=(o=a.ent).v_float[PR.entvars.solid])!==SV.solid.not&&o!==t.passedict&&(r===SV.solid.trigger&&Sys.Error("Trigger in clipping list"),(t.type!==SV.move.nomonsters||r===SV.solid.bsp)&&!(t.boxmins[0]>o.v_float[PR.entvars.absmax]||t.boxmins[1]>o.v_float[PR.entvars.absmax1]||t.boxmins[2]>o.v_float[PR.entvars.absmax2]||t.boxmaxs[0]<o.v_float[PR.entvars.absmin]||t.boxmaxs[1]<o.v_float[PR.entvars.absmin1]||t.boxmaxs[2]<o.v_float[PR.entvars.absmin2]||null!=t.passedict&&0!==t.passedict.v_float[PR.entvars.size]&&0===o.v_float[PR.entvars.size]))){if(!0===t.trace.allsolid)return;if(null!=t.passedict){if(SV.server.edicts[o.v_int[PR.entvars.owner]]===t.passedict)continue;if(SV.server.edicts[t.passedict.v_int[PR.entvars.owner]]===o)continue}(!0===(n=0!=(o.v_float[PR.entvars.flags]&SV.fl.monster)?SV.ClipMoveToEntity(o,t.start,t.mins2,t.maxs2,t.end):SV.ClipMoveToEntity(o,t.start,t.mins,t.maxs,t.end)).allsolid||!0===n.startsolid||n.fraction<t.trace.fraction)&&(n.ent=o,t.trace=n,!0===n.startsolid&&(t.trace.startsolid=!0))}-1!==e.axis&&(t.boxmaxs[e.axis]>e.dist&&SV.ClipToLinks(e.children[0],t),t.boxmins[e.axis]<e.dist&&SV.ClipToLinks(e.children[1],t))},SV.Move=function(e,t,a,o,r,n){var s,i={trace:SV.ClipMoveToEntity(SV.server.edicts[0],e,t,a,o),start:e,end:o,mins:t,maxs:a,type:r,passedict:n,boxmins:[],boxmaxs:[]};for(r===SV.move.missile?(i.mins2=[-15,-15,-15],i.maxs2=[15,15,15]):(i.mins2=[t[0],t[1],t[2]],i.maxs2=[a[0],a[1],a[2]]),s=0;s<=2;++s)o[s]>e[s]?(i.boxmins[s]=e[s]+i.mins2[s]-1,i.boxmaxs[s]=o[s]+i.maxs2[s]+1):(i.boxmins[s]=o[s]+i.mins2[s]-1,i.boxmaxs[s]=e[s]+i.maxs2[s]+1);return SV.ClipToLinks(SV.areanodes[0],i),i.trace};

			// Sys.js MODIFIED
			Sys={},Sys.events=["oncontextmenu","onfocus","onkeydown","onkeyup","onmousedown","onmouseup","onmousewheel","onunload","onwheel"],Sys.Quit=function(){var e;for(null!=Sys.frame&&clearInterval(Sys.frame),e=0;e<Sys.events.length;++e)window[Sys.events[e]]=null;throw Host.Shutdown(),document.body.style.cursor="auto",VID.mainwindow.style.display="none",COM.registered.value,parent.unloadContainer(),new Error},Sys.Print=function(e){null!=window.console&&console.log(e)},Sys.Error=function(e){var n;for(null!=Sys.frame&&clearInterval(Sys.frame),n=0;n<Sys.events.length;++n)window[Sys.events[n]]=null;if(!0===Host.initialized&&Host.Shutdown(),document.body.style.cursor="auto",(n=Con.text.length-25)<0&&(n=0),null!=window.console)for(;n<Con.text.length;++n)console.log(Con.text[n].text);throw alert(e),new Error(e)},Sys.FloatTime=function(){return.001*Date.now()-Sys.oldtime},window.onload=function(){var e;null!=Number.isNaN?Q.isNaN=Number.isNaN:Q.isNaN=isNaN;var n=decodeURIComponent(document.location.search),s=document.location,t=[s.href.substring(0,s.href.length-s.search.length)];if(63===n.charCodeAt(0)){var o,y="",a=!1;for(e=1;e<n.length;++e)if(!((o=n.charCodeAt(e))<32||o>127))if(34!==o)if(!1!==a||32!==o)y+=n.charAt(e);else{if(0===y.length)continue;t[t.length]=y,y=""}else a=!a;0!==y.length&&(t[t.length]=y)}COM.InitArgv(t);var c=document.documentElement;for(VID.width=c.clientWidth<=320?320:c.clientWidth,VID.height=c.clientHeight<=200?200:c.clientHeight,Sys.scantokey=[],Sys.scantokey[8]=Key.k.backspace,Sys.scantokey[9]=Key.k.tab,Sys.scantokey[13]=Key.k.enter,Sys.scantokey[16]=Key.k.shift,Sys.scantokey[17]=Key.k.ctrl,Sys.scantokey[18]=Key.k.alt,Sys.scantokey[19]=Key.k.pause,Sys.scantokey[27]=Key.k.escape,Sys.scantokey[32]=Key.k.space,Sys.scantokey[33]=Sys.scantokey[105]=Key.k.pgup,Sys.scantokey[34]=Sys.scantokey[99]=Key.k.pgdn,Sys.scantokey[35]=Sys.scantokey[97]=Key.k.end,Sys.scantokey[36]=Sys.scantokey[103]=Key.k.home,Sys.scantokey[37]=Sys.scantokey[100]=Key.k.leftarrow,Sys.scantokey[38]=Sys.scantokey[104]=Key.k.uparrow,Sys.scantokey[39]=Sys.scantokey[102]=Key.k.rightarrow,Sys.scantokey[40]=Sys.scantokey[98]=Key.k.downarrow,Sys.scantokey[45]=Sys.scantokey[96]=Key.k.ins,Sys.scantokey[46]=Sys.scantokey[110]=Key.k.del,e=48;e<=57;++e)Sys.scantokey[e]=e;for(Sys.scantokey[59]=Sys.scantokey[186]=59,Sys.scantokey[61]=Sys.scantokey[187]=61,e=65;e<=90;++e)Sys.scantokey[e]=e+32;for(Sys.scantokey[106]=42,Sys.scantokey[107]=43,Sys.scantokey[109]=Sys.scantokey[173]=Sys.scantokey[189]=45,Sys.scantokey[111]=Sys.scantokey[191]=47,e=112;e<=123;++e)Sys.scantokey[e]=e-112+Key.k.f1;for(Sys.scantokey[188]=44,Sys.scantokey[190]=46,Sys.scantokey[192]=96,Sys.scantokey[219]=91,Sys.scantokey[220]=92,Sys.scantokey[221]=93,Sys.scantokey[222]=39,Sys.oldtime=.001*Date.now(),Sys.Print("Host.Init\n"),Host.Init(),e=0;e<Sys.events.length;++e)window[Sys.events[e]]=Sys[Sys.events[e]];Sys.frame=setInterval(Host.Frame,1e3/60)},Sys.oncontextmenu=function(e){e.preventDefault()},Sys.onfocus=function(){var e;for(e=0;e<256;++e)Key.Event(e),Key.down[e]=!1},Sys.onkeydown=function(e){var n=Sys.scantokey[e.keyCode];null!=n&&(Key.Event(n,!0),e.preventDefault())},Sys.onkeyup=function(e){var n=Sys.scantokey[e.keyCode];null!=n&&(Key.Event(n),e.preventDefault())},Sys.onmousedown=function(e){var n;switch(e.which){case 1:n=Key.k.mouse1;break;case 2:n=Key.k.mouse3;break;case 3:n=Key.k.mouse2;break;default:return}Key.Event(n,!0),e.preventDefault()},Sys.onmouseup=function(e){var n;switch(e.which){case 1:n=Key.k.mouse1;break;case 2:n=Key.k.mouse3;break;case 3:n=Key.k.mouse2;break;default:return}Key.Event(n),e.preventDefault()},Sys.onmousewheel=function(e){var n=e.wheelDeltaY>0?Key.k.mwheelup:Key.k.mwheeldown;Key.Event(n,!0),Key.Event(n),e.preventDefault()},Sys.onunload=function(){Host.Shutdown()},Sys.onwheel=function(e){var n=e.deltaY<0?Key.k.mwheelup:Key.k.mwheeldown;Key.Event(n,!0),Key.Event(n),e.preventDefault()};

			// SZ.js
			SZ={},SZ.GetSpace=function(e,r){e.cursize+r>e.data.byteLength&&(!0!==e.allowoverflow&&Sys.Error("SZ.GetSpace: overflow without allowoverflow set"),r>e.byteLength&&Sys.Error("SZ.GetSpace: "+r+" is > full buffer size"),e.overflowed=!0,Con.Print("SZ.GetSpace: overflow\n"),e.cursize=0);var t=e.cursize;return e.cursize+=r,t},SZ.Write=function(e,r,t){new Uint8Array(e.data,SZ.GetSpace(e,t),t).set(r.subarray(0,t))},SZ.Print=function(e,r){var t,a,o=new Uint8Array(e.data);for(t=0!==e.cursize&&0===o[e.cursize-1]?SZ.GetSpace(e,r.length-1)-1:SZ.GetSpace(e,r.length),a=0;a<r.length;++a)o[t+a]=r.charCodeAt(a)};

			// V.js
			V={},V.dmg_time=0,V.CalcRoll=function(e,t){var i=[];Vec.AngleVectors(e,null,i);var a=t[0]*i[0]+t[1]*i[1]+t[2]*i[2],s=a<0?-1:1;return(a=Math.abs(a))<V.rollspeed.value?a*s*V.rollangle.value/V.rollspeed.value:V.rollangle.value*s},V.CalcBob=function(){if(V.bobcycle.value<=0||V.bobcycle.value>=1||V.bobup.value<=0||V.bobup.value>=1||0===V.bob.value)return 0;var e=(CL.state.time-Math.floor(CL.state.time/V.bobcycle.value)*V.bobcycle.value)/V.bobcycle.value;e=e<V.bobup.value?Math.PI*e/V.bobup.value:Math.PI+Math.PI*(e-V.bobup.value)/(1-V.bobup.value);var t=Math.sqrt(CL.state.velocity[0]*CL.state.velocity[0]+CL.state.velocity[1]*CL.state.velocity[1])*V.bob.value;return(t=.3*t+.7*t*Math.sin(e))>4?t=4:t<-7&&(t=-7),t},V.StartPitchDrift=function(){CL.state.laststop!==CL.state.time&&(!0!==CL.state.nodrift&&0!==CL.state.pitchvel||(CL.state.pitchvel=V.centerspeed.value,CL.state.nodrift=!1,CL.state.driftmove=0))},V.StopPitchDrift=function(){CL.state.laststop=CL.state.time,CL.state.nodrift=!0,CL.state.pitchvel=0},V.DriftPitch=function(){if(!0===Host.noclip_anglehack||!0!==CL.state.onground||!0===CL.cls.demoplayback)return CL.state.driftmove=0,void(CL.state.pitchvel=0);if(!0===CL.state.nodrift)return Math.abs(CL.state.cmd.forwardmove)<CL.forwardspeed.value?CL.state.driftmove=0:CL.state.driftmove+=Host.frametime,void(CL.state.driftmove>V.centermove.value&&V.StartPitchDrift());var e=CL.state.idealpitch-CL.state.viewangles[0];if(0!==e){var t=Host.frametime*CL.state.pitchvel;CL.state.pitchvel+=Host.frametime*V.centerspeed.value,e>0?(t>e&&(CL.state.pitchvel=0,t=e),CL.state.viewangles[0]+=t):e<0&&(t>-e&&(CL.state.pitchvel=0,t=-e),CL.state.viewangles[0]-=t)}else CL.state.pitchvel=0},V.cshift_empty=[130,80,50,0],V.cshift_water=[130,80,50,128],V.cshift_slime=[0,25,5,150],V.cshift_lava=[255,80,0,150],V.blend=[0,0,0,0],V.ParseDamage=function(){var e=MSG.ReadByte(),t=MSG.ReadByte(),i=CL.entities[CL.state.viewentity],a=[MSG.ReadCoord()-i.origin[0],MSG.ReadCoord()-i.origin[1],MSG.ReadCoord()-i.origin[2]];Vec.Normalize(a);var s=.5*(t+e);s<10&&(s=10),CL.state.faceanimtime=CL.state.time+.2;var r=CL.state.cshifts[CL.cshift.damage];r[3]+=3*s,r[3]<0?r[3]=0:r[3]>150&&(r[3]=150),e>t?(r[0]=200,r[1]=r[2]=100):0!==e?(r[0]=220,r[1]=r[2]=50):(r[0]=255,r[1]=r[2]=0);var l=[],o=[];Vec.AngleVectors(i.angles,l,o),V.dmg_roll=s*(a[0]*o[0]+a[1]*o[1]+a[2]*o[2])*V.kickroll.value,V.dmg_pitch=s*(a[0]*l[0]+a[1]*l[1]+a[2]*l[2])*V.kickpitch.value,V.dmg_time=V.kicktime.value},V.cshift_f=function(){var e=V.cshift_empty;e[0]=Q.atoi(Cmd.argv[1]),e[1]=Q.atoi(Cmd.argv[2]),e[2]=Q.atoi(Cmd.argv[3]),e[3]=Q.atoi(Cmd.argv[4])},V.BonusFlash_f=function(){var e=CL.state.cshifts[CL.cshift.bonus];e[0]=215,e[1]=186,e[2]=69,e[3]=50},V.SetContentsColor=function(e){switch(e){case Mod.contents.empty:case Mod.contents.solid:return void(CL.state.cshifts[CL.cshift.contents]=V.cshift_empty);case Mod.contents.lava:return void(CL.state.cshifts[CL.cshift.contents]=V.cshift_lava);case Mod.contents.slime:return void(CL.state.cshifts[CL.cshift.contents]=V.cshift_slime)}CL.state.cshifts[CL.cshift.contents]=V.cshift_water},V.CalcBlend=function(){var e=CL.state.cshifts[CL.cshift.powerup];if(0!=(CL.state.items&Def.it.quad)?(e[0]=0,e[1]=0,e[2]=255,e[3]=30):0!=(CL.state.items&Def.it.suit)?(e[0]=0,e[1]=255,e[2]=0,e[3]=20):0!=(CL.state.items&Def.it.invisibility)?(e[0]=100,e[1]=100,e[2]=100,e[3]=100):0!=(CL.state.items&Def.it.invulnerability)?(e[0]=255,e[1]=255,e[2]=0,e[3]=30):e[3]=0,CL.state.cshifts[CL.cshift.damage][3]-=150*Host.frametime,CL.state.cshifts[CL.cshift.damage][3]<0&&(CL.state.cshifts[CL.cshift.damage][3]=0),CL.state.cshifts[CL.cshift.bonus][3]-=100*Host.frametime,CL.state.cshifts[CL.cshift.bonus][3]<0&&(CL.state.cshifts[CL.cshift.bonus][3]=0),0!==V.cshiftpercent.value){var t,i,a=0,s=0,r=0,l=0;for(i=0;i<=3;++i)0!==(t=(e=CL.state.cshifts[i])[3]*V.cshiftpercent.value/25500)&&(a=a*(1-(t/=l+=t*(1-l)))+e[0]*t,s=s*(1-t)+e[1]*t,r=r*(1-t)+e[2]*t);l>1?l=1:l<0&&(l=0),V.blend[0]=a,V.blend[1]=s,V.blend[2]=r,V.blend[3]=l,V.blend[3]>1?V.blend[3]=1:V.blend[3]<0&&(V.blend[3]=0)}else V.blend[0]=V.blend[1]=V.blend[2]=V.blend[3]=0},V.CalcIntermissionRefdef=function(){var e=CL.entities[CL.state.viewentity];R.refdef.vieworg[0]=e.origin[0],R.refdef.vieworg[1]=e.origin[1],R.refdef.vieworg[2]=e.origin[2],R.refdef.viewangles[0]=e.angles[0]+Math.sin(CL.state.time*V.ipitch_cycle.value)*V.ipitch_level.value,R.refdef.viewangles[1]=e.angles[1]+Math.sin(CL.state.time*V.iyaw_cycle.value)*V.iyaw_level.value,R.refdef.viewangles[2]=e.angles[2]+Math.sin(CL.state.time*V.iroll_cycle.value)*V.iroll_level.value,CL.state.viewent.model=null},V.oldz=0,V.CalcRefdef=function(){V.DriftPitch();var e=CL.entities[CL.state.viewentity];e.angles[1]=CL.state.viewangles[1],e.angles[0]=-CL.state.viewangles[0];var t=V.CalcBob();R.refdef.vieworg[0]=e.origin[0]+.03125,R.refdef.vieworg[1]=e.origin[1]+.03125,R.refdef.vieworg[2]=e.origin[2]+CL.state.viewheight+t+.03125,R.refdef.viewangles[0]=CL.state.viewangles[0],R.refdef.viewangles[1]=CL.state.viewangles[1],R.refdef.viewangles[2]=CL.state.viewangles[2]+V.CalcRoll(CL.entities[CL.state.viewentity].angles,CL.state.velocity),V.dmg_time>0&&(0!==V.kicktime.value&&(R.refdef.viewangles[2]+=V.dmg_time/V.kicktime.value*V.dmg_roll,R.refdef.viewangles[0]-=V.dmg_time/V.kicktime.value*V.dmg_pitch),V.dmg_time-=Host.frametime),CL.state.stats[Def.stat.health]<=0&&(R.refdef.viewangles[2]=80);var i=V.idlescale.value*Math.sin(CL.state.time*V.ipitch_cycle.value)*V.ipitch_level.value,a=V.idlescale.value*Math.sin(CL.state.time*V.iyaw_cycle.value)*V.iyaw_level.value,s=V.idlescale.value*Math.sin(CL.state.time*V.iroll_cycle.value)*V.iroll_level.value;R.refdef.viewangles[0]+=i,R.refdef.viewangles[1]+=a,R.refdef.viewangles[2]+=s;var r=[],l=[],o=[];Vec.AngleVectors([-e.angles[0],e.angles[1],e.angles[2]],r,l,o),R.refdef.vieworg[0]+=V.ofsx.value*r[0]+V.ofsy.value*l[0]+V.ofsz.value*o[0],R.refdef.vieworg[1]+=V.ofsx.value*r[1]+V.ofsy.value*l[1]+V.ofsz.value*o[1],R.refdef.vieworg[2]+=V.ofsx.value*r[2]+V.ofsy.value*l[2]+V.ofsz.value*o[2],R.refdef.vieworg[0]<e.origin[0]-14?R.refdef.vieworg[0]=e.origin[0]-14:R.refdef.vieworg[0]>e.origin[0]+14&&(R.refdef.vieworg[0]=e.origin[0]+14),R.refdef.vieworg[1]<e.origin[1]-14?R.refdef.vieworg[1]=e.origin[1]-14:R.refdef.vieworg[1]>e.origin[1]+14&&(R.refdef.vieworg[1]=e.origin[1]+14),R.refdef.vieworg[2]<e.origin[2]-22?R.refdef.vieworg[2]=e.origin[2]-22:R.refdef.vieworg[2]>e.origin[2]+30&&(R.refdef.vieworg[2]=e.origin[2]+30);var n=CL.state.viewent;switch(n.angles[0]=-R.refdef.viewangles[0]-i,n.angles[1]=R.refdef.viewangles[1]-a,n.angles[2]=CL.state.viewangles[2]-s,n.origin[0]=e.origin[0]+r[0]*t*.4,n.origin[1]=e.origin[1]+r[1]*t*.4,n.origin[2]=e.origin[2]+CL.state.viewheight+r[2]*t*.4+t,SCR.viewsize.value){case 110:case 90:n.origin[2]+=1;break;case 100:n.origin[2]+=2;break;case 80:n.origin[2]+=.5}if(n.model=CL.state.model_precache[CL.state.stats[Def.stat.weapon]],n.frame=CL.state.stats[Def.stat.weaponframe],R.refdef.viewangles[0]+=CL.state.punchangle[0],R.refdef.viewangles[1]+=CL.state.punchangle[1],R.refdef.viewangles[2]+=CL.state.punchangle[2],!0===CL.state.onground&&e.origin[2]-V.oldz>0){var c=CL.state.time-CL.state.oldtime;c<0&&(c=0),V.oldz+=80*c,V.oldz>e.origin[2]?V.oldz=e.origin[2]:e.origin[2]-V.oldz>12&&(V.oldz=e.origin[2]-12),R.refdef.vieworg[2]+=V.oldz-e.origin[2],n.origin[2]+=V.oldz-e.origin[2]}else V.oldz=e.origin[2];0!==Chase.active.value&&Chase.Update()},V.RenderView=function(){!0!==Con.forcedup&&(CL.state.maxclients>=2&&(Cvar.Set("scr_ofsx","0"),Cvar.Set("scr_ofsy","0"),Cvar.Set("scr_ofsz","0")),0!==CL.state.intermission?V.CalcIntermissionRefdef():!0!==CL.state.paused&&V.CalcRefdef(),R.PushDlights(),R.RenderView())},V.Init=function(){Cmd.AddCommand("v_cshift",V.cshift_f),Cmd.AddCommand("bf",V.BonusFlash_f),Cmd.AddCommand("centerview",V.StartPitchDrift),V.centermove=Cvar.RegisterVariable("v_centermove","0.15"),V.centerspeed=Cvar.RegisterVariable("v_centerspeed","500"),V.iyaw_cycle=Cvar.RegisterVariable("v_iyaw_cycle","2"),V.iroll_cycle=Cvar.RegisterVariable("v_iroll_cycle","0.5"),V.ipitch_cycle=Cvar.RegisterVariable("v_ipitch_cycle","1"),V.iyaw_level=Cvar.RegisterVariable("v_iyaw_level","0.3"),V.iroll_level=Cvar.RegisterVariable("v_iroll_level","0.1"),V.ipitch_level=Cvar.RegisterVariable("v_ipitch_level","0.3"),V.idlescale=Cvar.RegisterVariable("v_idlescale","0"),V.crosshair=Cvar.RegisterVariable("crosshair","0",!0),V.crossx=Cvar.RegisterVariable("cl_crossx","0"),V.crossy=Cvar.RegisterVariable("cl_crossy","0"),V.cshiftpercent=Cvar.RegisterVariable("gl_cshiftpercent","100"),V.ofsx=Cvar.RegisterVariable("scr_ofsx","0"),V.ofsy=Cvar.RegisterVariable("scr_ofsy","0"),V.ofsz=Cvar.RegisterVariable("scr_ofsz","0"),V.rollspeed=Cvar.RegisterVariable("cl_rollspeed","200"),V.rollangle=Cvar.RegisterVariable("cl_rollangle","2.0"),V.bob=Cvar.RegisterVariable("cl_bob","0.02"),V.bobcycle=Cvar.RegisterVariable("cl_bobcycle","0.6"),V.bobup=Cvar.RegisterVariable("cl_bobup","0.5"),V.kicktime=Cvar.RegisterVariable("v_kicktime","0.5"),V.kickroll=Cvar.RegisterVariable("v_kickroll","0.6"),V.kickpitch=Cvar.RegisterVariable("v_kickpitch","0.6"),V.gamma=Cvar.RegisterVariable("gamma","1",!0)};

			// Vec.js
			Vec={},Vec.origin=[0,0,0],Vec.Perpendicular=function(a){var n=0,r=1;Math.abs(a[0])<r&&(n=0,r=Math.abs(a[0])),Math.abs(a[1])<r&&(n=1,r=Math.abs(a[1])),Math.abs(a[2])<r&&(n=2,r=Math.abs(a[2]));var o=[0,0,0];o[n]=1;var t=1/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e=(o[0]*a[0]+o[1]*a[1]+o[2]*a[2])*t,l=[o[0]-e*a[0]*t,o[1]-e*a[1]*t,o[2]-e*a[2]*t];return Vec.Normalize(l),l},Vec.RotatePointAroundVector=function(a,n,r){var o=Vec.Perpendicular(a),t=Vec.CrossProduct(o,a),e=[[o[0],t[0],a[0]],[o[1],t[1],a[1]],[o[2],t[2],a[2]]],l=[[e[0][0],e[1][0],e[2][0]],[e[0][1],e[1][1],e[2][1]],[e[0][2],e[1][2],e[2][2]]],c=Math.sin(r*Math.PI/180),m=Math.cos(r*Math.PI/180),s=[[m,c,0],[-c,m,0],[0,0,1]],i=Vec.ConcatRotations(Vec.ConcatRotations(e,s),l);return[i[0][0]*n[0]+i[0][1]*n[1]+i[0][2]*n[2],i[1][0]*n[0]+i[1][1]*n[1]+i[1][2]*n[2],i[2][0]*n[0]+i[2][1]*n[1]+i[2][2]*n[2]]},Vec.Anglemod=function(a){return(a%360+360)%360},Vec.BoxOnPlaneSide=function(a,n,r){if(r.type<=2)return r.dist<=a[r.type]?1:r.dist>=n[r.type]?2:3;var o,t;switch(r.signbits){case 0:o=r.normal[0]*n[0]+r.normal[1]*n[1]+r.normal[2]*n[2],t=r.normal[0]*a[0]+r.normal[1]*a[1]+r.normal[2]*a[2];break;case 1:o=r.normal[0]*a[0]+r.normal[1]*n[1]+r.normal[2]*n[2],t=r.normal[0]*n[0]+r.normal[1]*a[1]+r.normal[2]*a[2];break;case 2:o=r.normal[0]*n[0]+r.normal[1]*a[1]+r.normal[2]*n[2],t=r.normal[0]*a[0]+r.normal[1]*n[1]+r.normal[2]*a[2];break;case 3:o=r.normal[0]*a[0]+r.normal[1]*a[1]+r.normal[2]*n[2],t=r.normal[0]*n[0]+r.normal[1]*n[1]+r.normal[2]*a[2];break;case 4:o=r.normal[0]*n[0]+r.normal[1]*n[1]+r.normal[2]*a[2],t=r.normal[0]*a[0]+r.normal[1]*a[1]+r.normal[2]*n[2];break;case 5:o=r.normal[0]*a[0]+r.normal[1]*n[1]+r.normal[2]*a[2],t=r.normal[0]*n[0]+r.normal[1]*a[1]+r.normal[2]*n[2];break;case 6:o=r.normal[0]*n[0]+r.normal[1]*a[1]+r.normal[2]*a[2],t=r.normal[0]*a[0]+r.normal[1]*n[1]+r.normal[2]*n[2];break;case 7:o=r.normal[0]*a[0]+r.normal[1]*a[1]+r.normal[2]*a[2],t=r.normal[0]*n[0]+r.normal[1]*n[1]+r.normal[2]*n[2];break;default:Sys.Error("Vec.BoxOnPlaneSide: Bad signbits")}var e=0;return o>=r.dist&&(e=1),t<r.dist&&(e+=2),e},Vec.AngleVectors=function(a,n,r,o){var t;t=a[0]*Math.PI/180;var e=Math.sin(t),l=Math.cos(t);t=a[1]*Math.PI/180;var c=Math.sin(t),m=Math.cos(t);t=a[2]*Math.PI/180;var s=Math.sin(t),i=Math.cos(t);null!=n&&(n[0]=l*m,n[1]=l*c,n[2]=-e),null!=r&&(r[0]=i*c-s*e*m,r[1]=-s*e*c-i*m,r[2]=-s*l),null!=o&&(o[0]=i*e*m+s*c,o[1]=i*e*c-s*m,o[2]=i*l)},Vec.DotProduct=function(a,n){return a[0]*n[0]+a[1]*n[1]+a[2]*n[2]},Vec.Copy=function(a,n){n[0]=a[0],n[1]=a[1],n[2]=a[2]},Vec.CrossProduct=function(a,n){return[a[1]*n[2]-a[2]*n[1],a[2]*n[0]-a[0]*n[2],a[0]*n[1]-a[1]*n[0]]},Vec.Length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},Vec.Normalize=function(a){var n=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 0===n?(a[0]=a[1]=a[2]=0,0):(a[0]/=n,a[1]/=n,a[2]/=n,n)},Vec.ConcatRotations=function(a,n){return[[a[0][0]*n[0][0]+a[0][1]*n[1][0]+a[0][2]*n[2][0],a[0][0]*n[0][1]+a[0][1]*n[1][1]+a[0][2]*n[2][1],a[0][0]*n[0][2]+a[0][1]*n[1][2]+a[0][2]*n[2][2]],[a[1][0]*n[0][0]+a[1][1]*n[1][0]+a[1][2]*n[2][0],a[1][0]*n[0][1]+a[1][1]*n[1][1]+a[1][2]*n[2][1],a[1][0]*n[0][2]+a[1][1]*n[1][2]+a[1][2]*n[2][2]],[a[2][0]*n[0][0]+a[2][1]*n[1][0]+a[2][2]*n[2][0],a[2][0]*n[0][1]+a[2][1]*n[1][1]+a[2][2]*n[2][1],a[2][0]*n[0][2]+a[2][1]*n[1][2]+a[2][2]*n[2][2]]]};

			// VID.js
			VID={},VID.d_8to24table=new Uint32Array(new ArrayBuffer(1024)),VID.SetPalette=function(){var t=COM.LoadFile("gfx/palette.lmp");null==t&&Sys.Error("Couldn't load gfx/palette.lmp");var e,n=new Uint8Array(t),l=0;for(e=0;e<256;++e)VID.d_8to24table[e]=n[l]+(n[l+1]<<8)+(n[l+2]<<16),l+=3},VID.Init=function(){document.getElementById("progress").style.display="none",GL.Init(),VID.SetPalette()};

			// W.js
			W={},W.lumps=[],W.LoadWadFile=function(e){var r=COM.LoadFile(e);null==r&&Sys.Error("W.LoadWadFile: couldn't load "+e);var t=new DataView(r);843333975!==t.getUint32(0,!0)&&Sys.Error("Wad file "+e+" doesn't have WAD2 id");var n,a,i,o=t.getUint32(4,!0),l=t.getUint32(8,!0);for(n=0;n<o;++n)a=t.getUint32(l+4,!0),i=new ArrayBuffer(a),new Uint8Array(i).set(new Uint8Array(r,t.getUint32(l,!0),a)),W.lumps[Q.memstr(new Uint8Array(r,l+16,16)).toUpperCase()]=i,l+=32},W.GetLumpName=function(e){var r=W.lumps[e];return null==r&&Sys.Error("W.GetLumpName: "+e+" not found"),r};

			var CTRLS_IDLE = 0;

			function mouseChecker()
				{
				if(document.pointerLockElement==null)
					{
					goBackButtonResetIncrement();
					}
					else
					{
					goBackButtonTimerIncrement();
					}
				}

			function goBackButtonResetIncrement()
				{
				try
					{
					CTRLS_IDLE = 0;
					// SHOWS THE DOWNLOAD BUTTON
					document.getElementsByClassName("gui_download")[0].style.display = "block";
					}
					catch(err)
					{
					}
				}

			function goBackButtonTimerIncrement()
				{
				try
					{
					CTRLS_IDLE = CTRLS_IDLE + 1;
					if (CTRLS_IDLE >= 3)
						{
						// HIDES THE DOWNLOAD BUTTON
						document.getElementsByClassName("gui_download")[0].style.display = "none";
						}
					}
					catch(err)
					{
					}
				}

			function downloadSaveGame()
				{
				try
					{
					var name = COM.DefaultExtension("s0", ".sav");
					var rawReading = COM.LoadTextFile(name);
					if (rawReading.length>100)
						{
						saveString(rawReading,"s0.sav")
						}
					}
					catch(err)
					{
					}
				}

			function saveString(text, filename)
				{
				save(new Blob([text], {type:"text/plain"}), filename);
				}

			function save(blob, filename)
				{
				var link = document.createElement("a");
				link.style.display = "none";
				document.body.appendChild(link);
				link.href = URL.createObjectURL(blob);
				link.download = filename || "data.json";
				link.click();
				}

			setInterval(goBackButtonTimerIncrement, 1000);
			document.addEventListener("click", mouseChecker, false);
			document.addEventListener("dblclick", mouseChecker, false);
			document.addEventListener("mousemove", mouseChecker, false);
			document.addEventListener("pointerlockchange", mouseChecker, false);
			document.addEventListener("mozpointerlockchange", mouseChecker, false);
			document.addEventListener("webkitpointerlockchange", mouseChecker, false);
		</script>

		<script type="x-shader/x-vertex" id="vshAlias">uniform vec3 uOrigin;uniform mat3 uAngles;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;uniform vec3 uLightVec;attribute vec3 aPosition;attribute vec3 aNormal;attribute vec2 aTexCoord;varying vec2 vTexCoord;varying float vLightDot;void main(void){vec3 position = uViewAngles * (uAngles * aPosition + uOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aTexCoord;vLightDot = dot(aNormal, uLightVec);}</script>
		<script type="x-shader/x-fragment" id="fshAlias">precision mediump float;uniform float uGamma;uniform float uAmbientLight;uniform float uShadeLight;uniform sampler2D tTexture;varying vec2 vTexCoord;varying float vLightDot;void main(void){vec4 texture = texture2D(tTexture, vTexCoord);gl_FragColor = vec4(texture.rgb * mix(1.0, vLightDot * uShadeLight + uAmbientLight, texture.a), 1.0);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshBrush">uniform vec3 uOrigin;uniform mat3 uAngles;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;attribute vec3 aPosition;attribute vec4 aTexCoord;attribute vec4 aLightStyle;varying vec4 vTexCoord;varying vec4 vLightStyle;void main(void){vec3 position = uViewAngles * (uAngles * aPosition + uOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aTexCoord;vLightStyle = aLightStyle;}</script>
		<script type="x-shader/x-fragment" id="fshBrush">precision mediump float;uniform float uGamma;uniform sampler2D tTexture;uniform sampler2D tLightmap;uniform sampler2D tDlight;uniform sampler2D tLightStyle;varying vec4 vTexCoord;varying vec4 vLightStyle;void main(void){vec4 texture = texture2D(tTexture, vTexCoord.xy);gl_FragColor = vec4(texture.rgb *mix(1.0, dot(texture2D(tLightmap, vTexCoord.zw), vec4(texture2D(tLightStyle, vec2(vLightStyle.x, 0.0)).a,texture2D(tLightStyle, vec2(vLightStyle.y, 0.0)).a,texture2D(tLightStyle, vec2(vLightStyle.z, 0.0)).a,texture2D(tLightStyle, vec2(vLightStyle.w, 0.0)).a)* 43.828125) + texture2D(tDlight, vTexCoord.zw).a, texture.a), 1.0);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshCharacter">uniform vec2 uCharacter;uniform vec2 uDest;uniform mat4 uOrtho;attribute vec2 aPosition;varying vec2 vTexCoord;void main(void){gl_Position = uOrtho * vec4(aPosition * 8.0 + uDest, 0.0, 1.0);vTexCoord = (aPosition + uCharacter) * 0.0625;}</script>
		<script type="x-shader/x-fragment" id="fshCharacter">precision mediump float;uniform sampler2D tTexture;varying vec2 vTexCoord;void main(void){gl_FragColor = texture2D(tTexture, vTexCoord);}</script>
		<script type="x-shader/x-vertex" id="vshDlight">uniform vec3 uOrigin;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;uniform float uRadius;attribute vec3 aPosition;varying float vAlpha;void main(void){vec3 position = aPosition * 0.35 * uRadius + uViewAngles * (uOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vAlpha = aPosition.y * -0.2;}</script>
		<script type="x-shader/x-fragment" id="fshDlight">precision mediump float;uniform float uGamma;varying float vAlpha;void main(void){gl_FragColor = vec4(pow(1.0, uGamma), pow(0.5, uGamma), 0.0, vAlpha);}</script>
		<script type="x-shader/x-vertex" id="vshFill">uniform mat4 uOrtho;attribute vec2 aPosition;attribute vec4 aColor;varying vec4 vColor;void main(void){gl_Position = uOrtho * vec4(aPosition, 0.0, 1.0);vColor = aColor;}</script>
		<script type="x-shader/x-fragment" id="fshFill">precision mediump float;varying vec4 vColor;void main(void){gl_FragColor = vColor;}</script>
		<script type="x-shader/x-vertex" id="vshParticle">uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;uniform float uScale;attribute vec3 aOrigin;attribute vec2 aCoord;attribute float aScale;attribute vec3 aColor;varying vec2 vCoord;varying vec3 vColor;void main(void){vec2 point = aCoord * aScale;vec3 position = vec3(point.x, 0.0, point.y) + uViewAngles * (aOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vCoord = aCoord;vColor = aColor;}</script>
		<script type="x-shader/x-fragment" id="fshParticle">precision mediump float;uniform float uGamma;varying vec2 vCoord;varying vec3 vColor;void main(void){gl_FragColor = vec4(vColor, 1.0 - smoothstep(0.75, 1.0, length(vCoord)));gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshPic">uniform mat4 uOrtho;attribute vec2 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(void){gl_Position = uOrtho * vec4(aPosition, 0.0, 1.0);vTexCoord = aTexCoord;}</script>
		<script type="x-shader/x-fragment" id="fshPic">precision mediump float;uniform sampler2D tTexture;varying vec2 vTexCoord;void main(void){gl_FragColor = texture2D(tTexture, vTexCoord);}</script>
		<script type="x-shader/x-vertex" id="vshPicTranslate">uniform mat4 uOrtho;attribute vec2 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(void){gl_Position = uOrtho * vec4(aPosition, 0.0, 1.0);vTexCoord = aTexCoord;}</script>
		<script type="x-shader/x-fragment" id="fshPicTranslate">precision mediump float;uniform vec3 uTop;uniform vec3 uBottom;uniform sampler2D tTexture;uniform sampler2D tTrans;varying vec2 vTexCoord;void main(void){vec4 texture = texture2D(tTexture, vTexCoord);vec4 trans = texture2D(tTrans, vTexCoord);gl_FragColor = vec4(mix(mix(texture.rgb, uTop * trans.x, trans.y), uBottom * trans.z, trans.w), texture.a);}</script>
		<script type="x-shader/x-vertex" id="vshPlayer">uniform vec3 uOrigin;uniform mat3 uAngles;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;uniform vec3 uLightVec;attribute vec3 aPosition;attribute vec3 aNormal;attribute vec2 aTexCoord;varying vec2 vTexCoord;varying float vLightDot;void main(void){vec3 position = uViewAngles * (uAngles * aPosition + uOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aTexCoord;vLightDot = dot(aNormal, uLightVec);}</script>
		<script type="x-shader/x-fragment" id="fshPlayer">precision mediump float;uniform float uGamma;uniform float uAmbientLight;uniform float uShadeLight;uniform vec3 uTop;uniform vec3 uBottom;uniform sampler2D tTexture;uniform sampler2D tPlayer;varying vec2 vTexCoord;varying float vLightDot;void main(void){vec4 texture = texture2D(tTexture, vTexCoord);vec4 player = texture2D(tPlayer, vTexCoord);gl_FragColor = vec4(mix(mix(texture.rgb, uTop * (1.0 / 191.25) * player.x, player.y), uBottom * (1.0 / 191.25) * player.z, player.w)* mix(1.0, vLightDot * uShadeLight + uAmbientLight, texture.a), 1.0);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshSky">uniform mat3 uViewAngles;uniform mat4 uPerspective;uniform vec3 uScale;attribute vec3 aPosition;varying vec2 vTexCoord;void main(void){vec3 position = uViewAngles * (aPosition * uScale * 18918.0);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aPosition.xy * uScale.xy * 1.5;}</script>
		<script type="x-shader/x-fragment" id="fshSky">precision mediump float;uniform float uGamma;uniform vec2 uTime;uniform sampler2D tSolid;uniform sampler2D tAlpha;varying vec2 vTexCoord;void main(void){vec4 alpha = texture2D(tAlpha, vTexCoord + uTime.x);gl_FragColor = vec4(mix(texture2D(tSolid, vTexCoord + uTime.y).rgb, alpha.rgb, alpha.a), 1.0);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshSkyChain">uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;attribute vec3 aPosition;void main(void){vec3 position = uViewAngles * (aPosition - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);}</script>
		<script type="x-shader/x-fragment" id="fshSkyChain">precision mediump float;void main(void){}</script>
		<script type="x-shader/x-vertex" id="vshSprite">uniform vec4 uRect;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;attribute vec3 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(void){vec3 position = uViewAngles * (aPosition - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aTexCoord;}</script>
		<script type="x-shader/x-fragment" id="fshSprite">precision mediump float;uniform float uGamma;uniform sampler2D tTexture;varying vec2 vTexCoord;void main(void){gl_FragColor = texture2D(tTexture, vTexCoord);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshTurbulent">uniform vec3 uOrigin;uniform mat3 uAngles;uniform vec3 uViewOrigin;uniform mat3 uViewAngles;uniform mat4 uPerspective;attribute vec3 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(void){vec3 position = uViewAngles * (uAngles * aPosition + uOrigin - uViewOrigin);gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);vTexCoord = aTexCoord;}</script>
		<script type="x-shader/x-fragment" id="fshTurbulent">precision mediump float;uniform float uGamma;uniform float uTime;uniform sampler2D tTexture;varying vec2 vTexCoord;void main(void){gl_FragColor = vec4(texture2D(tTexture, vTexCoord + vec2(sin(vTexCoord.t * 3.141593 + uTime), sin(vTexCoord.s * 3.141593 + uTime)) * 0.125).rgb, 1.0);gl_FragColor.r = pow(gl_FragColor.r, uGamma);gl_FragColor.g = pow(gl_FragColor.g, uGamma);gl_FragColor.b = pow(gl_FragColor.b, uGamma);}</script>
		<script type="x-shader/x-vertex" id="vshWarp">uniform mat4 uOrtho;attribute vec2 aPosition;attribute vec2 aTexCoord;varying vec2 vTexCoord;void main(void){gl_Position = uOrtho * vec4(aPosition, 0.0, 1.0);vTexCoord = aTexCoord;}</script>
		<script type="x-shader/x-fragment" id="fshWarp">precision mediump float;uniform float uTime;uniform sampler2D tTexture;varying vec2 vTexCoord;void main(void){gl_FragColor = texture2D(tTexture, vTexCoord + vec2(sin(vTexCoord.t * 15.70796 + uTime) * 0.003125, sin(vTexCoord.s * 9.817477 + uTime) * 0.005));}</script>
	</body>
</html>